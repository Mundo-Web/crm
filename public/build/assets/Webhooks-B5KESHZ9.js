var T=Object.defineProperty;var E=(s,a,i)=>a in s?T(s,a,{enumerable:!0,configurable:!0,writable:!0,value:i}):s[a]=i;var N=(s,a,i)=>E(s,typeof a!="symbol"?a+"":a,i);import{m as y,C as M,c as R,j as e,r as m,G as h}from"./CreateReactScript-9UX3kXBD.js";import{B as D,A as F,i as A}from"./Adminto-B61UoQno.js";import{S as V,t as w}from"./index-yz4sAZmo.js";import{M as O}from"./Modal-D0pWPGeP.js";class z extends D{constructor(){super(...arguments);N(this,"path","integrations");N(this,"profile",async i=>{try{const{status:n,result:r}=await y.Fetch(`/api/${this.path}/profile`,{method:"POST",body:JSON.stringify(i)});if(!n)throw new Error((r==null?void 0:r.message)||"Ocurrio un error inesperado");return r.data??!0}catch(n){return y.Notify.add({icon:"/assets/img/logo-login.svg",title:"Error",body:n.message,type:"danger"}),!1}})}}const v=new z,B={messenger:"mdi-facebook-messenger",instagram:"mdi-instagram"},U=({service:s,icon:a,description:i,integration:n,onIntegrate:r,onUnlink:p})=>e.jsx("div",{className:"col-xxl-3 col-xl-4 col-lg-6 col-md-6 ",children:e.jsx("div",{className:"card",children:e.jsxs("div",{className:"card-body",children:[e.jsxs("div",{className:"d-flex align-items-center mb-3",children:[e.jsx("div",{className:"avatar-sm me-3",children:e.jsx("span",{className:"avatar-title bg-soft-primary rounded px-2",children:e.jsx("i",{className:`mdi ${a} font-22 text-primary`})})}),e.jsxs("div",{className:"flex-grow-1",children:[e.jsx("h4",{className:"mt-0 mb-1",children:s.toTitleCase()}),e.jsx("p",{className:"text-muted mb-0",children:i})]})]}),n!=null&&n.meta_business_name?e.jsxs("div",{className:"d-flex align-items-center justify-content-between",children:[e.jsxs("div",{className:"d-flex align-items-center",children:[e.jsx("img",{className:"avatar-sm rounded-circle me-2",src:`/api/integrations/media/${n.meta_business_profile}`,alt:n.meta_business_name,onError:o=>o.target.src=`//${h.APP_DOMAIN}/api/logo/thumbnail/null`}),e.jsxs("div",{children:[e.jsx("h5",{className:"mb-0",children:n.meta_business_name}),e.jsxs("small",{className:"text-muted",children:[n.leads_count??0," lead(s) generados"]})]})]}),e.jsx(A,{content:"Desvincular",children:e.jsx("button",{className:"btn btn-link text-danger p-0",type:"button",onClick:()=>p(n.id),children:e.jsx("i",{className:"mdi mdi-link-variant-off font-18"})})})]}):e.jsxs("button",{className:"btn btn-primary w-100",onClick:()=>r(s),children:[e.jsx("i",{className:"mdi mdi-plus me-1"}),"Integrar ",s.toTitleCase()]})]})})}),L=({service:s,setService:a,apikey:i,auth_token:n,onClose:r,onSuccess:p})=>{const o=m.useRef(null),[d,x]=m.useState(1),[j,b]=m.useState(""),[t,c]=m.useState(""),[u,g]=m.useState(null),[f,k]=m.useState(!1),[S,C]=m.useState(!1),I=async l=>{y.Clipboard.copy(l,()=>{w("Copiado al portapapeles",{icon:e.jsx("i",{className:"mdi mdi-content-copy"}),description:"El texto ha sido copiado al portapapeles"})})},P=async()=>{k(!0);const l=await v.profile({service:s,accountId:t,accessToken:j});k(!1),l&&g(l)},_=async()=>{C(!0);const l=await v.save({service:s,accountId:t,accessToken:j});C(!1),l&&(p(l),a(null))};return m.useEffect(()=>{s?(x(1),c(""),b(""),g(null),$(o.current).modal("show")):($(o.current).modal("hide"),$(".modal-backdrop").remove())},[s]),m.useEffect(()=>($(o.current).on("hidden.bs.modal",()=>{r(),a(null)}),()=>{$(o.current).off("hidden.bs.modal")}),[null]),e.jsx(O,{modalRef:o,title:`Integrar ${s==null?void 0:s.toTitleCase()}`,bodyClass:"px-3 pt-0 pb-3",hideFooter:!0,onClose:()=>a(null),isStatic:!0,children:e.jsxs("div",{id:"progressbarwizard",children:[e.jsxs("ul",{class:"nav nav-pills bg-light nav-justified form-wizard-header mb-3",children:[e.jsx("li",{class:"nav-item",children:e.jsxs("a",{href:"#account-2","data-bs-toggle":"tab","data-toggle":"tab",class:`nav-link rounded-0 pt-2 pb-2 ${d==1&&"active"}`,onClick:()=>x(1),children:[e.jsx("i",{class:"mdi mdi-application me-1"}),e.jsx("span",{class:"d-none d-sm-inline",children:"Crear Aplicación"})]})}),e.jsx("li",{class:"nav-item",children:e.jsxs("a",{href:"#profile-tab-2","data-bs-toggle":"tab","data-toggle":"tab",class:`nav-link rounded-0 pt-2 pb-2 ${d==2&&"active"}`,onClick:()=>x(2),children:[e.jsx("i",{class:"mdi mdi-key me-1"}),e.jsx("span",{class:"d-none d-sm-inline",children:"Generar Token"})]})}),e.jsx("li",{class:"nav-item",children:e.jsxs("a",{href:"#finish-2","data-bs-toggle":"tab","data-toggle":"tab",class:`nav-link rounded-0 disabled pt-2 pb-2 ${d==3&&"active"}`,disabled:!0,children:[e.jsx("i",{class:"mdi mdi-check me-1"}),e.jsx("span",{class:"d-none d-sm-inline",children:"Integración Lista"})]})})]}),e.jsxs("div",{class:"tab-content b-0 mb-0 pt-0",children:[e.jsxs("div",{class:`tab-pane ${d==1&&"active"}`,id:"account-2",children:[e.jsxs("p",{children:["Para integrar ",s==null?void 0:s.toTitleCase(),", primero debes:"]}),e.jsxs("ol",{children:[e.jsxs("li",{children:["Abrir el ",e.jsx("a",{href:"https://developers.facebook.com/apps",target:"_blank",children:"Panel de Aplicaciones de Meta"})]}),e.jsx("li",{children:"Crear una nueva aplicación o seleccionar una existente"}),e.jsxs("li",{children:['Habilitar el producto "',s==="messenger"?"Messenger":"Instagram",'"']}),e.jsx("li",{children:"Configurar los permisos necesarios"})]}),e.jsx("p",{children:"Copia y pega estos datos en la configuración de webhook de tu aplicación:"}),e.jsxs("div",{className:"form-group mb-2",children:[e.jsx("label",{className:"form-label mb-0",children:"URL de Callback:"}),e.jsxs("div",{className:"input-group",children:[e.jsx("input",{type:"text",className:"form-control",value:`${h.APP_URL}/meta/${s}/${i}`,readOnly:!0}),e.jsx("button",{type:"button",className:"btn btn-secondary",onClick:()=>I(`${h.APP_URL}/meta/${s}/${i}`),children:e.jsx("i",{className:"mdi mdi-content-copy"})})]})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{className:"form-label mb-0",children:"Token de Verificación:"}),e.jsxs("div",{className:"input-group",children:[e.jsx("input",{type:"text",className:"form-control",value:n,readOnly:!0}),e.jsx("button",{type:"button",className:"btn btn-secondary",onClick:()=>I(n),children:e.jsx("i",{className:"mdi mdi-content-copy"})})]})]})]}),e.jsxs("div",{class:`tab-pane ${d==2&&"active"}`,id:"profile-tab-2",children:[e.jsxs("p",{children:["Para obtener el Access Token y el ID de la cuenta de ",s==="messenger"?"Facebook":"Instagram",", sigue estos pasos:"]}),e.jsxs("ol",{children:[e.jsx("li",{children:"Ve a la configuración de tu aplicación en Meta Developers"}),e.jsxs("li",{children:['Navega a la sección de "',s==="messenger"?"Messenger":"Instagram",'" en el menú lateral']}),e.jsx("li",{children:"Selecciona la página/cuenta que deseas conectar y genera un token de acceso con los permisos de mensajería"})]}),e.jsxs("p",{children:["Ingresa el ID de tu ",s==="messenger"?"página de Facebook":"cuenta de Instagram"," y el token de acceso generado:"]}),e.jsxs("div",{className:"form-group mb-2",children:[e.jsx("label",{className:"form-label mb-0",children:"ID de la cuenta:"}),e.jsx("input",{type:"text",className:"form-control",value:t,onChange:l=>c(l.target.value),placeholder:"Ej: 123456789",disabled:!!u})]}),e.jsxs("div",{className:"form-group mb-3",children:[e.jsx("label",{className:"form-label mb-0",children:"Access Token:"}),e.jsx("input",{type:"text",className:"form-control",value:j,onChange:l=>b(l.target.value),placeholder:"Pega aquí tu Access Token",disabled:!!u})]}),u?e.jsxs("div",{className:"alert alert-info",children:[e.jsxs("div",{className:"d-flex align-items-center",children:[e.jsx("img",{className:"avatar-sm rounded-circle me-2",src:u.picture.data.url,alt:u.name,onError:l=>l.target.src=`//${h.APP_DOMAIN}/api/logo/thumbnail/null`}),e.jsxs("div",{children:[e.jsx("h5",{className:"mb-0",children:u.name}),e.jsxs("small",{className:"text-muted",children:["@",u.username]})]})]}),e.jsxs("div",{className:"mt-2",children:[e.jsx("i",{className:"mdi mdi-check-circle me-1"}),"Cuenta verificada exitosamente"]})]}):e.jsx("button",{type:"button",className:"btn btn-primary",onClick:P,disabled:f,children:f?e.jsxs(e.Fragment,{children:[e.jsx("i",{className:"mdi mdi-loading mdi-spin me-1"}),"Verificando..."]}):e.jsxs(e.Fragment,{children:[e.jsx("i",{className:"mdi mdi-check me-1"}),"Verificar cuenta"]})})]}),e.jsx("div",{class:`tab-pane ${d==3&&"active"}`,id:"finish-2",children:e.jsx("div",{class:"row",children:e.jsx("div",{class:"col-12",children:e.jsxs("div",{class:"text-center",children:[e.jsx("h2",{class:"mt-0",children:e.jsx("i",{class:"mdi mdi-check-all text-success"})}),e.jsx("h3",{class:"mt-0",children:"¡Todo listo!"}),e.jsxs("p",{class:"w-75 mb-2 mx-auto",children:["Has completado exitosamente la integración de tu cuenta de ",s==null?void 0:s.toTitleCase()," con ",h.APP_NAME,". Ahora podrás gestionar tus conversaciones y leads directamente desde nuestra plataforma."]}),e.jsxs("div",{class:"alert alert-success mt-3",children:[e.jsx("i",{className:"mdi mdi-rocket me-2"}),"Estás listo para empezar a generar leads y gestionar conversaciones con ",h.APP_NAME]})]})})})}),e.jsxs("ul",{class:"list-inline mb-0 wizard mt-3",children:[d>1&&e.jsx("li",{class:"prev list-inline-item",children:e.jsx("button",{type:"button",class:"btn btn-secondary",onClick:()=>x(l=>--l),children:"Anterior"})}),d==1&&e.jsx("li",{class:"next list-inline-item float-end",children:e.jsx("button",{type:"button",class:"btn btn-secondary",onClick:()=>x(l=>++l),children:"Siguiente"})}),d==2&&(u?e.jsx("li",{class:"next list-inline-item float-end",children:e.jsx("button",{type:"button",class:"btn btn-secondary",onClick:()=>_(),children:S?e.jsxs(e.Fragment,{children:[e.jsx("i",{className:"mdi mdi-spin mdi-loading me-1"}),"Integrando"]}):"Integrar"})}):e.jsx(A,{content:"Verifica la cuenta primero",children:e.jsx("li",{class:"next list-inline-item float-end",children:e.jsx("button",{type:"button",class:"btn btn-secondary",disabled:!0,children:"Integrar"})})}))]})]})]})})},W=({apikey:s,auth_token:a,integrations:i})=>{const[n,r]=m.useState(i),[p,o]=m.useState(null),d={messenger:"Integra tu página de Facebook para recibir y responder mensajes directamente desde Atalaya.",instagram:"Conecta tu cuenta de Instagram para gestionar mensajes directos y comentarios desde Atalaya."},x=t=>{r(c=>[...c,t])},j=async t=>{const{isConfirmed:c}=await V.fire({title:"¿Estás seguro?",text:"Esta acción desvinculará la integración. ¿Deseas continuar?",icon:"warning",showCancelButton:!0,confirmButtonText:"Sí, desvincular",cancelButtonText:"Cancelar",confirmButtonColor:"#d33",cancelButtonColor:"#3085d6"});c||result,await v.delete(t)&&(r(g=>g.filter(f=>f.id!==t)),w.success("Integración desvinculada exitosamente"))},b=n.reduce((t,c)=>(t[c.meta_service]||(t[c.meta_service]=c),t),{});return e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"container-fluid",children:e.jsx("div",{className:"row",children:Object.entries(B).map(([t,c])=>e.jsx(U,{service:t,icon:c,description:d[t],integration:b[t],onIntegrate:o,onUnlink:j},t))})}),e.jsx(L,{service:p,setService:o,apikey:s,auth_token:a,onClose:()=>o(null),onSuccess:x})]})};M((s,a)=>{R(s).render(e.jsx(F,{...a,title:"Integraciones - Webhooks",children:e.jsx(W,{...a})}))});
