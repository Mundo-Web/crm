var M=Object.defineProperty;var _=(a,n,r)=>n in a?M(a,n,{enumerable:!0,configurable:!0,writable:!0,value:r}):a[n]=r;var S=(a,n,r)=>_(a,typeof n!="symbol"?n+"":n,r);import{m as O,r as o,j as e,G as E,C as V,c as H}from"./CreateReactScript-ByDl3m9l.js";import{B as G,i as N,A as L}from"./Adminto-BksISQOY.js";import{M as F}from"./Modal-CJxY9cBG.js";import{t as y,S as z}from"./sweetalert2.esm.all-C32wHI3n.js";import{U as J}from"./UsersRest-BInVwA0W.js";import"./Logout-DquunmIv.js";class R extends G{constructor(){super(...arguments);S(this,"path","atalaya/users");S(this,"invite",async r=>{try{const{status:s,result:t}=await O.Fetch(`/api/${this.path}/invite`,{method:"POST",body:JSON.stringify(r)});if(!s)throw new Error((t==null?void 0:t.message)||"Ocurrio un error inesperado");return{status:!0,data:t.data,summary:t.summary}}catch(s){return{status:!1,message:s.message}}});S(this,"deleteInvitation",async r=>{try{const{status:s,result:t}=await O.Fetch(`/api/${this.path}/external/${r}`,{method:"DELETE"});if(!s)throw new Error((t==null?void 0:t.message)??"Ocurrio un error inesperado");return{status:!0}}catch(s){return{status:!1,message:s.message}}})}}const q=new R,A=({relative_id:a,fullname:n,email:r,match:s,setUsers:t,setInvitations:h})=>{const[u,d]=o.useState(!1),[p,b]=o.useState(!1),m=async()=>{d(!0);const{status:i,message:c,data:l,summary:g}=await q.invite({match:s,email:r});if(d(!1),!i)return y(c??"Ocurrió un error inesperado",{icon:e.jsx("i",{className:"mdi mdi-alert text-danger"})});b(!0),console.log(g),g!=null&&g.external?h(v=>v.some(w=>w.email===l.email)?v.map(w=>w.email===l.email?l:w):[...v,l]):t(v=>[...v,l])},x=i=>a?e.jsx(e.Fragment,{children:i}):e.jsx(N,{content:"Invitar usuario a Atalaya",children:i});return e.jsx("div",{className:"card border mb-0",children:e.jsxs("div",{className:"card-body p-2 d-flex align-items-center gap-2",children:[e.jsx("img",{src:`//${E.APP_DOMAIN}/api/profile/thumbnail/${a}`,className:"rounded-circle",alt:n,width:"40",height:"40"}),e.jsxs("div",{className:"flex-grow-1",children:[e.jsx("h5",{className:"mt-0 mb-1",children:n}),e.jsx("div",{className:"text-muted",children:r})]}),x(e.jsx("button",{className:"btn btn-white btn-sm rounded-pill",onClick:()=>m(),disabled:u||p,children:u?e.jsx("i",{className:"mdi mdi-loading mdi-spin"}):p?e.jsx("i",{className:"mdi mdi-email-check"}):e.jsx("i",{className:`mdi ${a?"mdi-account-plus":"mdi mdi-email-send"}`})}))]})})},K=new J,U=new R,Q=({roles:a,match:n,setUsers:r,...s})=>{var m,x;const[t,h]=o.useState(!1),u=async(i,c)=>{await K.assignRole({role:i.id,user:c.id})&&location.reload()},d=async()=>{h(!0);const{status:i,message:c}=await U.invite({match:n,email:s.email});if(h(!1),!i)return y(c??"Ocurrió un error inesperado",{icon:e.jsx("i",{className:"mdi mdi-alert text-danger"})})},p=async()=>{const{isConfirmed:i}=await z.fire({title:"¿Estás seguro?",text:`${s.name} será eliminado de la gestión de ${E.APP_NAME}. Esta acción no se puede deshacer.`,icon:"warning",showCancelButton:!0,confirmButtonColor:"#3085d6",cancelButtonColor:"#d33",confirmButtonText:"¡Sí, eliminar!",cancelButtonText:"Cancelar"});if(!i)return;const c=await U.delete(s.id);if(!c)return y(c.message??"Ocurrió un error inesperado",{icon:e.jsx("i",{className:"mdi mdi-alert text-danger"})});r(l=>l.filter(g=>g.id!==s.id))},b=((x=(m=s.service_user)==null?void 0:m.roles)==null?void 0:x[0])??{name:s.is_owner?"Owner":"Sin rol"};return e.jsx("div",{className:"card mb-0",style:{width:"360px"},children:e.jsx("div",{className:"card-body widget-user",children:e.jsxs("div",{className:"d-flex align-items-center gap-2 w-100",children:[e.jsx("div",{className:"flex-shrink-0 avatar-lg",children:e.jsx("img",{src:`//${E.APP_DOMAIN}/api/profile/thumbnail/${s.relative_id}`,className:"img-fluid rounded-circle",alt:"user"})}),e.jsxs("div",{className:"flex-grow-1",children:[e.jsxs("div",{className:"overflow-hidden",style:{width:"228px"},children:[e.jsxs("h5",{className:"mt-0 mb-1 text-truncate",children:[s.name," ",s.lastname]}),e.jsx("p",{className:"d-inline-block text-muted mb-2 font-13 text-truncate w-100",children:s.email})]}),e.jsxs("div",{className:"d-flex gap-1",children:[s.is_owner?e.jsxs("div",{className:"btn btn-white btn-sm",children:[e.jsx("i",{className:"mdi mdi-crown me-1 text-blue"}),"Owner"]}):e.jsxs("div",{className:"btn-group",children:[e.jsxs("button",{className:"btn btn-white btn-sm dropdown-toggle",type:"button","data-bs-toggle":"dropdown","aria-haspopup":"true","aria-expanded":"false",children:[b.name," ",e.jsx("i",{className:"mdi mdi-chevron-down"})]}),e.jsxs("div",{className:"dropdown-menu",children:[a.map((i,c)=>e.jsx(N,{content:`Asignar rol ${i.name}`,children:e.jsxs("a",{className:"dropdown-item",href:"#",onClick:()=>u(i,s),children:[e.jsx("i",{className:"mdi mdi-account-convert me-2"}),i.name]})},c)),e.jsx("div",{className:"dropdown-divider"}),e.jsxs("a",{className:"dropdown-item",href:"#",children:[e.jsx("i",{className:"mdi mdi-plus me-2"}),"Nuevo rol"]})]})]}),!s.invitation_accepted&&e.jsx(N,{content:"Reenviar invitación",children:e.jsx("button",{className:"btn btn-sm btn-white rounded-pill",onClick:()=>d(),disabled:t,children:t?e.jsx("i",{className:"mdi mdi-loading mdi-spin"}):e.jsx("i",{className:"mdi mdi-email-send text-primary"})})}),!s.is_owner&&e.jsx(N,{content:"Eliminar usuario",children:e.jsx("button",{className:"btn btn-sm btn-white rounded-pill",onClick:()=>p(),children:e.jsx("i",{className:"mdi mdi-delete text-danger"})})})]})]})]})})},`user-${s.id}`)},T=new R,W=({id:a,email:n,created_at:r,updated_at:s,setInvitations:t,match:h})=>{const[u,d]=o.useState(!1),p=async()=>{d(!0);const{status:m,message:x,data:i}=await T.invite({match:h,email:n});if(d(!1),!m)return y(x??"Ocurrió un error inesperado",{icon:e.jsx("i",{className:"mdi mdi-alert text-danger"})});t(c=>c.map(l=>l.email===i.email?i:l))},b=async()=>{d(!0);const{status:m,message:x}=await T.deleteInvitation(a);if(d(!1),!m)return y(x??"Ocurrió un error inesperado",{icon:e.jsx("i",{className:"mdi mdi-alert text-danger"})});t(i=>i.filter(c=>c.id!==a))};return e.jsxs("tr",{children:[e.jsx("td",{valign:"middle",children:n}),e.jsx("td",{valign:"middle",children:moment(r).subtract(5,"hours").format("lll")}),e.jsx("td",{valign:"middle",children:moment(s).subtract(5,"hours").format("lll")}),e.jsx("td",{children:e.jsxs("div",{className:"d-flex gap-1",children:[e.jsx(N,{content:"Reenviar",children:e.jsx("button",{className:"btn btn-xs btn-white waves-effect",type:"button",onClick:()=>p(),disabled:u,children:u?e.jsx("i",{className:"mdi mdi-loading mdi-spin"}):e.jsx("i",{className:"mdi mdi-email-send text-primary"})})}),e.jsx(N,{content:"Eliminar",children:e.jsx("button",{className:"btn btn-xs btn-white waves-effect",type:"button",onClick:()=>b(),disabled:u,children:e.jsx("i",{className:"mdi mdi-delete text-danger"})})})]})})]})},X=({modalRef:a,invitations:n,setInvitations:r,match:s})=>e.jsx(F,{modalRef:a,title:"Invitaciones externas",hideFooter:!0,onSubmit:t=>t.preventDefault(),size:"lg",children:e.jsx("div",{style:{minHeight:"360px"},children:e.jsxs("table",{className:"table table-sm mb-0",children:[e.jsx("thead",{className:"table-light",children:e.jsxs("tr",{children:[e.jsx("th",{children:"Correo"}),e.jsx("th",{children:"Primer envío"}),e.jsx("th",{children:"Último envío"}),e.jsx("th",{children:"Acciones"})]})}),e.jsx("tbody",{children:n.map((t,h)=>e.jsx(W,{...t,setInvitations:r,match:s},h))})]})})}),B=new R,Y=a=>{const{users:n,invitations:r,roles:s,match:t}=a,[h,u]=o.useState(n),[d,p]=o.useState(r);console.log(d);const b=o.useRef(),m=o.useRef(null),x=o.useRef(),[i,c]=o.useState([]),[l,g]=o.useState(""),[v,k]=o.useState(null),[w,C]=o.useState(!1),P=async f=>{const{data:j,summary:I}=await B.paginate({searchValue:f});C(!1),c(j),k((I==null?void 0:I.isValid)??null)},D=f=>{const j=f.target.value;g(j),m.current&&(B.controller.abort("Nothing"),clearTimeout(m.current)),c([]),C(!1),!(!j||j.length<3)&&(C(!0),m.current=setTimeout(()=>{P(j)},300))};return o.useEffect(()=>{d.length==0&&$(x.current).modal("hide")},[d]),o.useEffect(()=>()=>{m.current&&clearTimeout(m.current)},[]),e.jsx(e.Fragment,{children:e.jsxs(L,{...a,title:"Usuarios",floatEnd:e.jsxs("div",{className:"d-flex gap-2",children:[d.length>0&&e.jsx(N,{content:"Invitaciones externas",children:e.jsxs("button",{className:"btn btn-sm btn-light position-relative",onClick:()=>$(x.current).modal("show"),children:[e.jsx("i",{className:"mdi mdi-history"}),e.jsxs("span",{className:"position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger",children:[d.length,e.jsx("span",{className:"visually-hidden",children:"external invitations"})]})]})}),e.jsxs("button",{className:"btn btn-sm btn-primary",onClick:()=>$(b.current).modal("show"),children:[e.jsx("i",{className:"mdi mdi-account-plus me-1"}),"Invitar"]})]}),children:[e.jsx("div",{className:"d-flex flex-wrap align-items-center justify-content-center",style:{minHeight:"calc(100vh - 235px)",maxHeight:"max-content"},children:e.jsx("div",{className:"d-flex flex-wrap align-items-center justify-content-center gap-2",children:h.map((f,j)=>e.jsx(Q,{...f,roles:s,match:t,setUsers:u},`user-${j}`))})}),e.jsxs(F,{modalRef:b,title:"Invita usuarios",hideFooter:!0,onSubmit:f=>f.preventDefault(),onClose:()=>g(""),children:[e.jsx("input",{type:"text",className:"form-control",placeholder:"Ingresa nombre o correo",value:l,onChange:D}),l.length<3?e.jsx("div",{className:"text-center text-muted p-2 mt-2",children:"Ingresa al menos 3 caracteres"}):e.jsx(e.Fragment,{children:w?e.jsxs("div",{className:"text-center p-2 mt-2",children:[e.jsx("div",{className:"spinner-border text-primary",role:"status",children:e.jsx("span",{className:"visually-hidden",children:"Loading..."})}),e.jsx("p",{className:"mt-2 text-muted mb-0",children:"Buscando usuarios..."})]}):i.length>0||v?e.jsxs("div",{className:"d-flex flex-column gap-2 mt-2",children:[i.map((f,j)=>e.jsx(A,{...f,match:t,setUsers:u},`found-${j}`)),v===!0&&e.jsx(A,{fullname:l.split("@")[0],email:l,match:t,setUsers:u,setInvitations:p},`found-${l}`)]}):l&&e.jsx("div",{className:"card card-body p-2 mt-2 text-center mb-0",children:"No se encontraron resultados"})})]}),e.jsx(X,{modalRef:x,invitations:d,setInvitations:p,match:t})]})})};V((a,n)=>{H(a).render(e.jsx(Y,{...n}))});
