var U=Object.defineProperty;var E=(t,a,i)=>a in t?U(t,a,{enumerable:!0,configurable:!0,writable:!0,value:i}):t[a]=i;var w=(t,a,i)=>E(t,typeof a!="symbol"?a+"":a,i);import{m as B,r as d,j as e,G as y,C as T,c as P}from"./CreateReactScript-CgEuCtoy.js";import{B as _,i as v,A as F}from"./Adminto-D1MVey_P.js";import{M}from"./Modal-Dp_0-Qk7.js";import{t as S,S as D}from"./sweetalert2.esm.all-DJ5rN5x4.js";import{U as V}from"./UsersRest-CrhcffL3.js";class C extends _{constructor(){super(...arguments);w(this,"path","atalaya/users");w(this,"invite",async i=>{try{const{status:s,result:c}=await B.Fetch(`/api/${this.path}/invite`,{method:"POST",body:JSON.stringify(i)});if(!s)throw new Error((c==null?void 0:c.message)||"Ocurrio un error inesperado");return{status:!0,data:c.data}}catch(s){return{status:!1,message:s.message}}})}}const G=new C,R=({relative_id:t,fullname:a,email:i,match:s,setUsers:c})=>{const[x,p]=d.useState(!1),[o,j]=d.useState(!1),f=async()=>{p(!0);const{status:m,message:n,data:r}=await G.invite({match:s,email:i});if(p(!1),!m)return S(n??"Ocurrió un error inesperado",{icon:e.jsx("i",{className:"mdi mdi-alert text-danger"})});j(!0),r&&c(g=>[...g,r])},l=m=>t?e.jsx(e.Fragment,{children:m}):e.jsx(v,{content:"Invitar usuario a Atalaya",children:m});return e.jsx("div",{className:"card border mb-0",children:e.jsxs("div",{className:"card-body p-2 d-flex align-items-center gap-2",children:[e.jsx("img",{src:`//${y.APP_DOMAIN}/api/profile/thumbnail/${t}`,className:"rounded-circle",alt:a,width:"40",height:"40"}),e.jsxs("div",{className:"flex-grow-1",children:[e.jsx("h5",{className:"mt-0 mb-1",children:a}),e.jsx("div",{className:"text-muted",children:i})]}),l(e.jsx("button",{className:"btn btn-white btn-sm rounded-pill",onClick:()=>f(),disabled:x||o,children:x?e.jsx("i",{className:"mdi mdi-loading mdi-spin"}):o?e.jsx("i",{className:"mdi mdi-email-check"}):e.jsx("i",{className:`mdi ${t?"mdi-account-plus":"mdi mdi-email-send"}`})}))]})})},H=new V,I=new C,J=({roles:t,match:a,setUsers:i,...s})=>{var l,m;const[c,x]=d.useState(!1),p=async(n,r)=>{await H.assignRole({role:n.id,user:r.id})&&location.reload()},o=async()=>{x(!0);const{status:n,message:r}=await I.invite({match:a,email:s.email});if(x(!1),!n)return S(r??"Ocurrió un error inesperado",{icon:e.jsx("i",{className:"mdi mdi-alert text-danger"})})},j=async()=>{const{isConfirmed:n}=await D.fire({title:"¿Estás seguro?",text:`${s.name} será eliminado de la gestión de ${y.APP_NAME}. Esta acción no se puede deshacer.`,icon:"warning",showCancelButton:!0,confirmButtonColor:"#3085d6",cancelButtonColor:"#d33",confirmButtonText:"¡Sí, eliminar!",cancelButtonText:"Cancelar"});if(!n)return;const r=await I.delete(s.id);if(!r)return S(r.message??"Ocurrió un error inesperado",{icon:e.jsx("i",{className:"mdi mdi-alert text-danger"})});i(g=>g.filter(N=>N.id!==s.id))},f=((m=(l=s.service_user)==null?void 0:l.roles)==null?void 0:m[0])??{name:s.is_owner?"Owner":"Sin rol"};return e.jsx("div",{className:"card mb-0",style:{width:"360px"},children:e.jsx("div",{className:"card-body widget-user",children:e.jsxs("div",{className:"d-flex align-items-center gap-2 w-100",children:[e.jsx("div",{className:"flex-shrink-0 avatar-lg",children:e.jsx("img",{src:`//${y.APP_DOMAIN}/api/profile/thumbnail/${s.relative_id}`,className:"img-fluid rounded-circle",alt:"user"})}),e.jsxs("div",{className:"flex-grow-1",children:[e.jsxs("div",{className:"overflow-hidden",style:{width:"228px"},children:[e.jsxs("h5",{className:"mt-0 mb-1 text-truncate",children:[s.name," ",s.lastname]}),e.jsx("p",{className:"d-inline-block text-muted mb-2 font-13 text-truncate w-100",children:s.email})]}),e.jsxs("div",{className:"d-flex gap-1",children:[s.is_owner?e.jsxs("div",{className:"btn btn-white btn-sm",children:[e.jsx("i",{className:"mdi mdi-crown me-1 text-blue"}),"Owner"]}):e.jsxs("div",{className:"btn-group",children:[e.jsxs("button",{className:"btn btn-white btn-sm dropdown-toggle",type:"button","data-bs-toggle":"dropdown","aria-haspopup":"true","aria-expanded":"false",children:[f.name," ",e.jsx("i",{className:"mdi mdi-chevron-down"})]}),e.jsxs("div",{className:"dropdown-menu",children:[t.map((n,r)=>e.jsx(v,{content:`Asignar rol ${n.name}`,children:e.jsxs("a",{className:"dropdown-item",href:"#",onClick:()=>p(n,s),children:[e.jsx("i",{className:"mdi mdi-account-convert me-2"}),n.name]})},r)),e.jsx("div",{className:"dropdown-divider"}),e.jsxs("a",{className:"dropdown-item",href:"#",children:[e.jsx("i",{className:"mdi mdi-plus me-2"}),"Nuevo rol"]})]})]}),!s.invitation_accepted&&e.jsx(v,{content:"Reenviar invitación",children:e.jsx("button",{className:"btn btn-sm btn-white rounded-pill",onClick:()=>o(),disabled:c,children:c?e.jsx("i",{className:"mdi mdi-loading mdi-spin"}):e.jsx("i",{className:"mdi mdi-email-send text-primary"})})}),!s.is_owner&&e.jsx(v,{content:"Eliminar usuario",children:e.jsx("button",{className:"btn btn-sm btn-white rounded-pill",onClick:()=>j(),children:e.jsx("i",{className:"mdi mdi-delete text-danger"})})})]})]})]})})},`user-${s.id}`)},k=new C,L=t=>{const{users:a,roles:i,match:s}=t,[c,x]=d.useState(a),p=d.useRef(),o=d.useRef(null),[j,f]=d.useState([]),[l,m]=d.useState(""),[n,r]=d.useState(null),[g,N]=d.useState(!1),A=async h=>{const{data:u,summary:b}=await k.paginate({searchValue:h});N(!1),f(u),r((b==null?void 0:b.isValid)??null)},O=h=>{const u=h.target.value;m(u),o.current&&(k.controller.abort("Nothing"),clearTimeout(o.current)),f([]),N(!1),!(!u||u.length<3)&&(N(!0),o.current=setTimeout(()=>{A(u)},300))};return d.useEffect(()=>()=>{o.current&&clearTimeout(o.current)},[]),e.jsx(e.Fragment,{children:e.jsxs(F,{...t,title:"Usuarios",floatEnd:e.jsxs("button",{className:"btn btn-sm btn-primary",onClick:()=>$(p.current).modal("show"),children:[e.jsx("i",{className:"mdi mdi-account-plus me-1"}),"Invitar"]}),children:[e.jsx("div",{className:"d-flex flex-wrap align-items-center justify-content-center",style:{minHeight:"calc(100vh - 235px)",maxHeight:"max-content"},children:e.jsx("div",{className:"d-flex flex-wrap align-items-center justify-content-center gap-2",children:c.map((h,u)=>e.jsx(J,{...h,roles:i,match:s,setUsers:x},`user-${u}`))})}),e.jsxs(M,{modalRef:p,title:"Invita usuarios",hideFooter:!0,onSubmit:h=>h.preventDefault(),onClose:()=>m(""),children:[e.jsx("input",{type:"text",className:"form-control",placeholder:"Ingresa nombre o correo",value:l,onChange:O}),l.length<3?e.jsx("div",{className:"text-center text-muted p-2 mt-2",children:"Ingresa al menos 3 caracteres"}):e.jsx(e.Fragment,{children:g?e.jsxs("div",{className:"text-center p-2 mt-2",children:[e.jsx("div",{className:"spinner-border text-primary",role:"status",children:e.jsx("span",{className:"visually-hidden",children:"Loading..."})}),e.jsx("p",{className:"mt-2 text-muted mb-0",children:"Buscando usuarios..."})]}):j.length>0||n?e.jsxs("div",{className:"d-flex flex-column gap-2 mt-2",children:[j.map((h,u)=>e.jsx(R,{...h,match:s,setUsers:x},`found-${u}`)),n===!0&&e.jsx(R,{fullname:l.split("@")[0],email:l,match:s,setUsers:x},`found-${l}`)]}):l&&e.jsx("div",{className:"card card-body p-2 mt-2 text-center mb-0",children:"No se encontraron resultados"})})]})]})})};T((t,a)=>{P(t).render(e.jsx(L,{...a}))});
