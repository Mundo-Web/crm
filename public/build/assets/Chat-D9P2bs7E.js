import{j as e,G as T,r as a,C as Ae,c as Pe,L as ce}from"./CreateReactScript-DEiMbi6B.js";import{W as Te,M as Fe,u as ye,i as ae,a as He,A as Ie}from"./Adminto-Buk_sumw.js";import{L as we}from"./LeadsRest-CllnQtc1.js";import{H as ue,C as We,a as ze}from"./ClientNotesRest-BidYfNuz.js";import{w as xe,A as de}from"./ArrayJoin-6-TTvUmN.js";import"./Logout-DAQhHADr.js";import"./sweetalert2.esm.all-B5d0Dmk7.js";const Oe=({contact:s,contactDetails:d,setContactDetails:o,loading:h,theme:u})=>e.jsx("div",{className:`card-header ${u=="light"?"bg-white":"bg-light"}`,style:{cursor:"pointer"},onClick:()=>(s==null?void 0:s.id)&&o(d?null:s),children:e.jsxs("div",{className:"d-flex align-items-center",children:[!h&&s&&e.jsx("img",{src:`/api/whatsapp/profile/${s.contact_phone}`,className:"rounded-circle avatar-sm bg-light me-2",alt:s.contact_name,style:{padding:0,border:"none"},onError:c=>{c.target.src=`//${T.APP_DOMAIN}/assets/img/user-404.svg`}}),h&&e.jsx("div",{className:"placeholder-glow",children:e.jsx("div",{className:"rounded-circle avatar-sm me-2 placeholder",style:{width:36,height:36}})}),e.jsxs("div",{className:`flex-grow-1 ${h?"placeholder-glow":""}`,children:[e.jsx("h5",{className:`mt-0 mb-1 text-truncate ${h?"placeholder col-3":""}`,children:s==null?void 0:s.contact_name}),e.jsxs("p",{className:`d-block font-13 text-muted mb-0 ${h?"placeholder col-2":""}`,children:[e.jsx("i",{className:"mdi mdi-phone me-1 font-11"}),s==null?void 0:s.contact_phone]})]}),!h&&s&&e.jsx("div",{className:"ms-2",children:e.jsx("i",{className:`mdi mdi-24px mdi-chevron-double-${d?"right":"left"} text-muted`})})]})}),Ue=({fromMe:s,content:d,attachment:o,theme:h,time:u,campaign:c})=>e.jsxs("div",{className:`ctext-wrap ${s?`message-out-${h}`:`message-in-${h}`}`,style:{boxShadow:"rgba(11, 20, 26, 0.13) 0px 1px 0.5px 0px",padding:"6px 8px"},children:[c&&e.jsxs("div",{className:"rounded p-2 mb-2",style:{backgroundColor:"rgba(240, 240, 240, 0.125)",cursor:c.link?"pointer":"default",maxWidth:"240px"},onClick:()=>{c.link&&window.open(c.link,"_blank")},children:[e.jsxs("div",{className:"d-flex gap-1",style:{maxWidth:"100%"},children:[e.jsx("div",{className:"fw-bold",children:c.code}),e.jsx("div",{className:"small text-truncate",children:c.title})]}),e.jsx("small",{className:"d-block text-truncate",style:{maxWidth:300},children:c.link})]}),o&&e.jsxs(e.Fragment,{children:[e.jsx("img",{src:o.replace("/attachment:",""),className:"mb-1",alt:"attachment",style:{minWidth:"300px",width:"100%",maxWidth:"100%",minHeight:"200px",maxHeight:"300px",borderRadius:"4px",objectFit:"cover"},onError:m=>{const r=m.target;r&&r.parentNode&&(r.style.display="none")}}),e.jsx("div",{className:"d-flex justify-content-end",children:e.jsxs("a",{className:"btn btn-xs btn-light mb-1 text-nowrap d-flex text-end",href:o.replace("/attachment:",""),target:"_blank",rel:"noreferrer",download:!0,children:[e.jsx("i",{className:"mdi mdi-download me-1"}),e.jsx("span",{children:"Descargar adjunto"})]})}),!d.trim()&&e.jsx("span",{className:"time mt-0 float-end",style:{fontSize:"10px",marginLeft:"6px",marginTop:"8px !important"},children:u})]}),d.trim()&&e.jsx(ue,{className:"text-start font-14",html:xe(d+`<span class="time mt-0 float-end" style="font-size: 10px; margin-left: 6px; margin-top: 8px !important">${u}</span>`)})]}),Be=({fromMe:s,theme:d,url:o,time:h})=>{const[u,c]=a.useState(!1),[m,r]=a.useState(0),[N,l]=a.useState(0),g=a.useRef(null),j=()=>{const v=g.current;v&&(u?v.pause():v.play(),c(!u))};a.useEffect(()=>{const v=g.current;if(!v)return;const A=()=>r(Math.floor(v.duration)),k=()=>l(Math.floor(v.currentTime)),b=()=>{c(!1),l(0)};return v.addEventListener("loadedmetadata",A),v.addEventListener("timeupdate",k),v.addEventListener("ended",b),()=>{v.removeEventListener("loadedmetadata",A),v.removeEventListener("timeupdate",k),v.removeEventListener("ended",b)}},[]);const M=m?N/m*100:0,p=v=>{const A=Math.floor(v/60),k=v%60;return`${A}:${k<10?"0":""}${k}`};return e.jsxs("div",{className:`ctext-wrap d-flex align-items-start ${s?`message-out-${d}`:`message-in-${d}`}`,style:{minWidth:"240px",maxWidth:"320px",padding:"6px 8px",boxShadow:"rgba(11, 20, 26, 0.13) 0px 1px 0.5px 0px"},children:[e.jsxs("div",{className:"flex-grow-1",children:[e.jsxs("div",{className:"d-flex align-items-center mb-1",children:[e.jsx("button",{onClick:j,className:"btn btn-sm d-flex align-items-center justify-content-center rounded-circle me-2 p-0",style:{width:"32px",height:"32px",border:"none",color:d=="dark"?"#fff":"#6f8171",flexShrink:0},children:e.jsx("i",{className:`mdi mdi-${u?"pause":"play"}`,style:{fontSize:"24px"}})}),e.jsx("div",{className:"flex-grow-1",style:{height:"4px",backgroundColor:d=="dark"?"#ffffff55":"#6f817155",borderRadius:"2px",position:"relative"},children:e.jsx("div",{style:{height:"100%",width:`${M}%`,backgroundColor:d=="dark"?"#fff":"#6f8171",borderRadius:"2px",transition:"width 100ms ease"}})})]}),e.jsxs("div",{className:"d-flex justify-content-between align-items-center px-1",style:{fontSize:"10px"},children:[e.jsx("span",{children:p(m)}),e.jsx("span",{className:"time mt-0 float-end",style:{fontSize:"10px",marginLeft:"6px",marginTop:"8px !important"},children:h})]})]}),e.jsx("audio",{ref:g,src:o,preload:"metadata"})]})},Ye=({fromMe:s,theme:d,url:o,time:h,mask:u,caption:c})=>{const m=u||(o==null?void 0:o.split("/").pop()),r=()=>{const N=document.createElement("a");N.href=o,N.download=m,N.click()};return e.jsx(e.Fragment,{children:e.jsx("div",{className:`ctext-wrap d-flex align-items-start ${s?`message-out-${d}`:`message-in-${d}`}`,style:{minWidth:"240px",maxWidth:"320px",padding:"8px",boxShadow:"rgba(11, 20, 26, 0.13) 0px 1px 0.5px 0px"},children:e.jsxs("div",{className:"flex-grow-1 position-relative",children:[e.jsxs("div",{className:"d-flex align-items-center justify-content-end rounded gap-2",style:{backgroundColor:"rgba(0, 0, 0, .125)",padding:"3px 6px",cursor:"pointer",minWidth:0},onClick:r,children:[e.jsx("div",{children:e.jsx("i",{className:"mdi mdi-file-document mdi-24px"})}),e.jsx("div",{className:"flex-grow-1 text-truncate text-start",children:e.jsx("div",{className:"font-14 text-truncate",style:{overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap",maxWidth:"220px"},children:m})}),e.jsx("div",{children:e.jsx("i",{className:"mdi mdi-download mdi-24px"})})]}),e.jsx(ue,{className:`text-start font-14 ${c&&"mt-1"}`,html:xe(c+`<span class="time mt-0 float-end" style="font-size: 10px; margin-left: 6px; margin-top: 8px !important">${h}</span>`)})]})})})},qe=({fromMe:s,theme:d,url:o,time:h,caption:u})=>{const[c,m]=a.useState(!1),[r,N]=a.useState(1),[l,g]=a.useState({x:0,y:0}),j=a.useRef(null),M=()=>m(!0),p=()=>{m(!1),N(1),g({x:0,y:0})},v=k=>{k.preventDefault();const b=k.deltaY>0?-.1:.1;N(I=>Math.max(.5,Math.min(3,I+b)))},A=k=>{if(r>1){const b=j.current.getBoundingClientRect(),I=(k.clientX-b.left)/b.width*100,W=(k.clientY-b.top)/b.height*100;g({x:I,y:W})}};return e.jsxs(e.Fragment,{children:[e.jsx("div",{className:`ctext-wrap d-flex align-items-start ${s?`message-out-${d}`:`message-in-${d}`}`,style:{minWidth:"240px",maxWidth:"320px",padding:"3px",boxShadow:"rgba(11, 20, 26, 0.13) 0px 1px 0.5px 0px"},children:e.jsxs("div",{className:"flex-grow-1 position-relative",children:[e.jsx("img",{src:o,alt:"imagen",style:{width:"100%",borderRadius:"6px"},onError:k=>{k.target.src=`//${T.APP_DOMAIN}/assets/img/image-404.svg`}}),!u&&e.jsxs(e.Fragment,{children:[e.jsx("div",{onClick:M,className:"position-absolute",style:{top:0,bottom:0,right:0,left:0,background:"linear-gradient(to top, rgba(0, 0, 0, .5) 0%, transparent 12%)",cursor:"zoom-in",borderRadius:"6px"}}),e.jsx("span",{className:"position-absolute time",style:{fontSize:"10px",right:"6px",bottom:"2px",textShadow:"0 0 5px rgba(0,0,0,1)",color:d!="dark"?"#fafafa":void 0},children:h})]}),(u==null?void 0:u.trim())&&e.jsx("div",{style:{padding:"3px 5px",marginTop:"6px"},children:e.jsx(ue,{className:"text-start font-14",html:xe(u+`<span class="time mt-0 float-end" style="font-size: 10px; margin-left: 6px; margin-top: 8px !important">${h}</span>`)})})]})}),c&&e.jsx("div",{onClick:p,style:{position:"fixed",inset:0,backgroundColor:"rgba(0,0,0,0.8)",zIndex:1002,display:"flex",alignItems:"center",justifyContent:"center",cursor:"zoom-out"},children:e.jsx("img",{ref:j,src:o,alt:"imagen ampliada",onClick:k=>k.stopPropagation(),onWheel:v,onMouseMove:A,style:{maxWidth:"90vw",maxHeight:"90vh",transform:`scale(${r}) translate(${l.x}%, ${l.y}%)`,transformOrigin:"center center",transition:"transform 0.2s ease",cursor:"grab"},draggable:!1})})]})},Ke=({index:s,forceAfter:d,message:o,isLast:h=!1,fromMe:u,marginTop:c,theme:m})=>{var g;let r=((g=o.message)==null?void 0:g.replace(/\{\{.*?\}\}/gs,""))||"",N="";if(r.startsWith("/attachment:")&&(N=r.split(`
`)[0],r=r.replace(N,"")),o.role=="Form")return e.jsx("li",{children:e.jsx("div",{className:"chat-day-title mt-3 mb-0",children:e.jsx("small",{className:"title badge badge-soft-dark rounded-pill",children:r})})},s);let l=null;return r.startsWith("/audio:")?l=e.jsx(Be,{fromMe:u,theme:m,url:r.replace("/audio:","/storage/images/whatsapp/"),time:moment(o.created_at).subtract(5,"hours").format("HH:mm")}):r.startsWith("/image:")?l=e.jsx(qe,{fromMe:u,theme:m,url:r.replace("/image:","/storage/images/whatsapp/").split(`
`)[0],caption:r.split(`
`).slice(1).join(`
`)||"",time:moment(o.created_at).subtract(5,"hours").format("HH:mm")}):r.startsWith("/document:")?l=e.jsx(Ye,{fromMe:u,theme:m,url:r.replace("/document:","/storage/images/whatsapp/").split(`
`)[0],mask:o.mask,caption:r.split(`
`).slice(1).join(`
`)||"",time:moment(o.created_at).subtract(5,"hours").format("HH:mm")}):l=e.jsx(Ue,{fromMe:u,theme:m,content:r,attachment:N,time:moment(o.created_at).subtract(5,"hours").format("HH:mm"),campaign:o.campaign}),e.jsx("li",{className:`${u?"odd":""} ${c||d?"":"hide-after"}`,style:{marginBottom:h?"0px":"24px",marginTop:c?"12px":"2px"},children:e.jsx("div",{className:"message-list",children:e.jsx("div",{className:"conversation-text",children:l})})})},Ge=()=>e.jsxs("div",{className:"d-flex flex-column align-items-center justify-content-center text-center px-4",style:{height:"calc(100vh - 186px)"},children:[e.jsx("div",{className:"mb-3",children:e.jsx("i",{className:"mdi mdi-account-off-outline text-muted",style:{fontSize:"4rem"}})}),e.jsx("h5",{className:"text-muted mb-2",children:"Este contacto no existe en la empresa seleccionada"}),e.jsx("p",{className:"text-muted mb-3",children:"Por favor, elige otro contacto desde la lista o intenta refrescar la página si crees que debería estar aquí."}),e.jsxs("button",{className:"btn btn-outline-primary",onClick:()=>window.location.reload(),children:[e.jsx("i",{className:"mdi mdi-refresh me-1"}),"Refrescar página"]})]}),Ve=({theme:s})=>{const[d,o]=a.useState(3),[h,u]=a.useState([]);return a.useEffect(()=>{const c=setInterval(()=>{const m=3+Math.floor(Math.random()*5);o(m),u(Array.from({length:m},()=>Math.random()>.5))},1500);return()=>clearInterval(c)},[null]),e.jsx(e.Fragment,{children:Array.from({length:d}).map((c,m)=>{const r=1+Math.floor(Math.random()*3);return e.jsx("li",{className:h[m]?"odd":"",style:{marginBottom:m<d-1?"0px":"24px",marginTop:m>0&&h[m]===h[m-1]?"3px":"12px"},children:e.jsx("div",{className:"message-list",children:e.jsx("div",{className:"conversation-text",children:e.jsx("div",{className:`ctext-wrap ${h[m]?`message-out-${s}`:`message-in-${s}`}`,style:{boxShadow:"rgba(11, 20, 26, 0.13) 0px 1px 0.5px 0px",padding:"6px 8px",width:`${300+300*(r-1)/6}px`},children:e.jsxs("div",{className:"placeholder-glow",children:[Array.from({length:r}).map((N,l)=>e.jsx("span",{className:`placeholder ${l===r-1?"col-6 ms-0":"col-12"} `},l)),e.jsx("span",{className:"placeholder time float-end col-1",style:{fontSize:"10px",marginLeft:"6px",marginTop:"8px !important"}})]})})})})},m)})})},Je=({isOpen:s,setIsOpen:d,onTakePhoto:o})=>{const h=a.useRef(),u=a.useRef(),[c,m]=a.useState(null),r=()=>{const l=u.current,g=h.current;if(!l||!g)return;l.width=g.videoWidth,l.height=g.videoHeight,l.getContext("2d").drawImage(g,0,0),l.toBlob(M=>{o(M),d(!1)},"image/jpeg",.95)};a.useEffect(()=>{s&&c&&h.current&&(h.current.srcObject=c)},[s,c]);const N=async()=>{try{const l=await navigator.mediaDevices.getUserMedia({video:!0});m(l)}catch(l){console.error("Error accessing camera:",l)}};return a.useEffect(()=>{s?N():c&&(c.getTracks().forEach(l=>l.stop()),m(null))},[s]),s?e.jsx("div",{className:"position-fixed top-0 start-0 w-100 h-100 d-flex align-items-center justify-content-center",style:{backgroundColor:"rgba(0,0,0,0.8)",zIndex:9999},children:e.jsxs("div",{className:"card",style:{width:"90%",maxWidth:"500px"},children:[e.jsxs("div",{className:"card-header d-flex justify-content-between",bis_skin_checked:"1",children:[e.jsx("h4",{className:"header-title my-0",children:"Cámara"}),e.jsx("button",{type:"button",class:"btn-close",onClick:()=>d(!1)})]}),e.jsxs("div",{className:"card-body p-0 position-relative",children:[e.jsx("video",{ref:h,autoPlay:!0,playsInline:!0,muted:!0,className:"w-100",style:{maxHeight:"400px"}}),e.jsx("canvas",{ref:u,className:"d-none"}),e.jsx("span",{className:"position-absolute bg-white",onClick:r,style:{width:"40px",height:"40px",bottom:"24px",borderRadius:"50%",left:"50%",transform:"translateX(-50%)",cursor:"pointer"}})]})]})}):e.jsx(e.Fragment,{})},V=new Te,Ne=new Fe,Xe=new we,Qe=({leadId:s,setLeadId:d,theme:o,contactDetails:h,setContactDetails:u,defaultMessages:c})=>{const m=a.useRef(),r=a.useRef(),N=a.useRef(),l=a.useRef(),g=a.useRef(),j=a.useRef(),M=a.useRef(),[p,v]=a.useState(null),[A,k]=a.useState(!0),[b,I]=a.useState([]),[W,Q]=a.useState(!0),[C,B]=a.useState(null),[q,ne]=a.useState(null),[J,O]=a.useState(null),{socket:K}=ye(),[n,x]=a.useState(!1),[S,y]=a.useState(!1),[L,w]=a.useState(null),[H,X]=a.useState(null),[z,Y]=a.useState(""),[G,E]=a.useState(!1),[ie,he]=a.useState(null),[Z,ee]=a.useState(!1),[re,le]=a.useState(!1),[pe,ke]=a.useState(null),[st,Se]=a.useState(null),[at,Ce]=a.useState(""),oe=a.useRef(!1);a.useEffect(()=>()=>{H&&URL.revokeObjectURL(H)},[H]);const ge=(t=!0)=>{const i=M.current;i&&i.scrollTo({top:i.scrollHeight,behavior:t?"smooth":"auto"})},$e=()=>{const t=M.current;return t?t.scrollTop+t.clientHeight>=t.scrollHeight-60:!0};a.useEffect(()=>{!W&&b.length&&ge(!1)},[W,b.length]),a.useEffect(()=>{if(!(!K||!p))return K.on("message.created",t=>{if(t.wa_id!=(p==null?void 0:p.contact_phone))return;const{id:i,microtime:f}=t;I(_=>_.find(F=>F.id===i)?_.map(F=>F.id===i?{...F,...t}:F):[..._,t].sort((F,P)=>F.microtime-P.microtime));const R=b.reduce((_,D)=>Math.max(_,D.microtime),0);f>R&&Ee(f),$e()&&!oe.current&&setTimeout(()=>ge(!0),100)}),()=>{K.off("message.created")}},[K,p,b]),a.useEffect(()=>{if(W)return;const t=M.current;if(!t)return;const i=()=>{t.scrollTop===0&&(oe.current=!0,ve())};return t.addEventListener("scroll",i),()=>t.removeEventListener("scroll",i)},[M,W]),a.useEffect(()=>{const t=i=>{g.current&&!g.current.contains(i.target)&&E(!1)};return document.addEventListener("mousedown",t),()=>document.removeEventListener("mousedown",t)},[]);const Re=async()=>{try{const t=await navigator.mediaDevices.getUserMedia({audio:!0}),i=new MediaRecorder(t),f=[];i.ondataavailable=R=>f.push(R.data),i.onstop=()=>{const R=new Blob(f,{type:"audio/mp3"});w(R),X(URL.createObjectURL(R)),O("audio"),t.getTracks().forEach(_=>_.stop())},i.start(),l.current=i,y(!0)}catch(t){console.error("Error accessing microphone:",t)}},De=()=>{l.current&&l.current.state!=="inactive"&&l.current.stop(),y(!1)},fe=()=>{l.current&&l.current.state!=="inactive"&&l.current.stop(),y(!1),w(null),H&&URL.revokeObjectURL(H),X(null)},te=async t=>{if(t.preventDefault(),!p)return;const i=z.trim();if(!(!i&&!L&&!C)){if(x(!0),C){switch(J){case"audio":await V.sendAudio(p.id,L);break;case"image":await V.sendImage(p.id,C,i);break;default:await V.sendDocument(p.id,C,i);break}B(null),O(null)}else await V.send(p.id,i);Y(""),x(!1)}},Me=t=>{const i=t.target.files[0];if(!i)return;const f=i,R=i.type.startsWith("image/")?"image":i.type.startsWith("video/")?"video":"document";B(f),O(R),t.target.value=""},be=()=>z.trim()||L||C;let je=!1;const Le=async()=>{k(!0);const t=await Xe.get(s);if(k(!1),!t){v(null),u(null);return}v(t)},ve=async()=>{var _;if(!p||!s)return;const t=M.current,i=t?t.scrollHeight:0,f=b.filter(D=>D.wa_id==p.contact_phone).sort((D,U)=>D.microtime-U.microtime)[0]??{microtime:(Date.now()+5*60*60*1e3)*1e3};Q(!0);const R=await Ne.paginate({summary:{contact_phone:p.contact_phone},filter:[["microtime","<",f.microtime],"and",["wa_id","contains",p.contact_phone]],sort:[{selector:"microtime",desc:!0}],skip:0,take:40});if(Q(!1),((_=R.data)==null?void 0:_.length)>0){if(I(D=>{const U=new Set(D.map(P=>P.id));return[...(R.data??[]).filter(P=>!U.has(P.id)),...D].sort((P,se)=>P.microtime-se.microtime)}),t){const D=t.scrollHeight;t.scrollTop=D-i}oe.current=!1}},Ee=async t=>{p&&await Ne.paginate({summary:{contact_phone:p.contact_phone},filter:[["microtime","<=",t],"and",["wa_id","contains",p.contact_phone]],sort:[{selector:"microtime",desc:!0}],skip:0,take:40})};return a.useEffect(()=>{v(null),u(null),I([]),s&&Le()},[s]),a.useEffect(()=>{I([]),!(!s&&!p)&&ve()},[p,s]),a.useEffect(()=>{const t=i=>{i.key==="Escape"&&(C?B(null):(d(null),u(null)))};return window.addEventListener("keydown",t),()=>window.removeEventListener("keydown",t)},[C]),a.useEffect(()=>{if(!C)return;const t=URL.createObjectURL(C);return ne(t),()=>{URL.revokeObjectURL(t)}},[C]),!p&&!A?e.jsx(Ge,{}):(console.log(c),e.jsxs(e.Fragment,{children:[e.jsx(Oe,{contact:p,contactDetails:h,setContactDetails:u,loading:A,theme:o}),e.jsxs("div",{className:"card-body p-0 position-relative border",style:{backgroundColor:o=="light"?"rgb(245, 241, 235)":"rgb(22, 23, 23)"},children:[C?e.jsxs("section",{className:"position-relative p-4",style:{height:"calc(100vh - 260px)",zIndex:1},children:[e.jsx("i",{className:"mdi mdi-close mdi-24px position-absolute cursor-pointer",onClick:()=>B(null)}),e.jsxs("div",{className:"d-flex flex-column h-100 gap-2",children:[e.jsx("div",{className:"flex-grow-1 d-flex align-items-center justify-content-center overflow-hidden",children:J==="image"?e.jsx("img",{src:q,alt:"Adjunto",style:{maxWidth:"100%",maxHeight:"100%",objectFit:"contain"}}):e.jsxs("div",{className:"text-center",children:[e.jsx("i",{className:"mdi mdi-file-document",style:{fontSize:"48px"}}),e.jsx("div",{className:"mt-2",children:C.name||"Documento"})]})}),e.jsx("form",{className:"pt-0 conversation-input",onSubmit:te,children:e.jsxs("label",{className:`row mx-auto g-0 align-items-end p-1 ${o==="dark"?"bg-light":"bg-white"}`,htmlFor:"message-input",style:{borderRadius:"24px",maxWidth:"600px"},children:[e.jsx("div",{className:"col mt-0",children:e.jsx("textarea",{ref:m,id:"message-input",className:"form-control w-100",placeholder:"Ingrese su mensaje aquí",rows:1,style:{minHeight:"38px",maxHeight:"122px",fieldSizing:"content",resize:"none",border:"none",backgroundColor:"transparent"},disabled:n||!!L,value:z,onChange:t=>Y(t.target.value),onKeyDown:t=>{t.key==="Enter"&&!t.shiftKey&&(t.preventDefault(),be()&&te(t))}})}),e.jsx("div",{className:"col-auto mt-0",children:e.jsx("button",{type:"submit",className:"btn btn-primary btn-sm",disabled:n,style:{borderRadius:"50%",width:"38px",height:"38px",padding:0},children:n?e.jsx("i",{className:"mdi mdi-spin mdi-loading"}):e.jsx("i",{className:"mdi mdi-send"})})})]})})]})]}):e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"position-absolute",style:{top:0,right:0,bottom:0,left:0,backgroundImage:"url(/assets/img/doodles.png)",backgroundRepeat:"repeat",zIndex:0,opacity:o=="light"?1:.0625}}),e.jsxs("section",{className:"d-flex flex-column position-relative",style:{height:"calc(100vh - 260px)",zIndex:1},children:[e.jsxs("ul",{ref:M,className:"conversation-list flex-grow-1 px-3 pt-3 scroll-hidden",style:{overflowY:"auto",scrollBehavior:"smooth",position:"relative"},children:[W&&b.length===0&&e.jsx(Ve,{theme:o}),b.map((t,i)=>{const f=t.role!=="Human",R=je!==f;je=f;const _=new Date(t.microtime/1e3-5*60*60*1e3),U=new Date-_,F=Math.floor(U/(1e3*60*60*24));let P=null;F===0?P="Hoy":F===1?P="Ayer":F<=6?P=["Domingo","Lunes","Martes","Miércoles","Jueves","Viernes","Sábado"][_.getDay()]:P=`${_.getDate()}/${_.getMonth()+1}/${_.getFullYear()}`;const se=i===0||new Date(b[i-1].microtime/1e3).toDateString()!==_.toDateString();return e.jsxs(e.Fragment,{children:[se&&e.jsx("li",{className:"text-center p-0 mx-auto",style:{position:"sticky",top:0,zIndex:10,width:"max-content",marginTop:"12px",marginBottom:"12px"},children:e.jsx("span",{className:"badge",style:{width:"68px",backgroundColor:o=="dark"?"rgb(36, 38, 38)":"rgb(255, 255, 255)",color:o=="dark"?"#fafafa":"#0a0a0a"},children:P})},`date-${i}`),e.jsx(Ke,{index:i,forceAfter:se,isLast:i<b.length-1,message:t,fromMe:f,marginTop:R,theme:o},i)]})})]}),e.jsx("form",{className:"p-2 pt-0 conversation-input position-relative",onSubmit:te,children:e.jsxs("label",{className:`row g-0 align-items-end p-1 ${o=="dark"?"bg-light":"bg-white"}`,htmlFor:"message-input",style:{borderRadius:"24px"},children:[e.jsxs("div",{className:"col-auto mt-0",children:[e.jsxs("div",{className:"dropup",ref:g,children:[e.jsx("button",{type:"button",className:"btn btn-light btn-sm dropdown-toggle","data-bs-toggle":"dropdown","aria-expanded":G,onClick:()=>E(!G),disabled:n||S,title:"Adjuntar archivo",style:{borderRadius:"50%",width:"38px",height:"38px",padding:0},children:e.jsx("i",{className:`mdi ${G?"mdi-close":"mdi-plus"}`})}),e.jsxs("div",{ref:j,className:"dropdown-menu mb-1",children:[e.jsxs("button",{className:"dropdown-item",href:"#",onClick:t=>{var i,f;t.preventDefault(),(i=r.current)==null||i.setAttribute("accept","*"),(f=r.current)==null||f.click()},children:[e.jsx("i",{className:"mdi mdi-file-document me-2",style:{color:"#7F66FF"}}),"Documentos"]}),e.jsxs("button",{className:"dropdown-item",href:"#",onClick:t=>{var i,f;t.preventDefault(),(i=r.current)==null||i.setAttribute("accept","image/*,video/*"),(f=r.current)==null||f.click()},children:[e.jsx("i",{className:"mdi mdi-image me-2",style:{color:"#007BFC"}}),"Fotos y videos"]}),e.jsxs("button",{className:"dropdown-item",href:"#",onClick:t=>{t.preventDefault(),ee(!0)},children:[e.jsx("i",{className:"mdi mdi-camera me-2",style:{color:"#FF2E74"}}),"Cámara"]}),e.jsxs("button",{className:"dropdown-item",href:"#",onClick:t=>{var i,f;t.preventDefault(),(i=r.current)==null||i.setAttribute("accept","audio/*"),(f=r.current)==null||f.click()},children:[e.jsx("i",{className:"mdi mdi-headphones me-2",style:{color:"#FB6533"}}),"Audio"]})]})]}),e.jsx("input",{ref:r,type:"file",className:"d-none",onChange:Me})]}),e.jsx("div",{className:"col mt-0",children:S?e.jsxs("div",{className:"d-flex align-items-center justify-content-center bg-light rounded-pill",style:{minHeight:"38px"},children:[e.jsx("span",{className:"text-danger me-2",children:"●"})," Grabando..."]}):L?e.jsx("div",{className:"d-flex align-items-center bg-light rounded-pill px-2",style:{minHeight:"38px"},children:e.jsx("audio",{ref:N,src:H,className:"me-2",controls:!0,controlsList:"nodownload",style:{height:"30px"}})}):e.jsxs("div",{className:"dropup",children:[e.jsx("div",{className:`dropdown-menu mb-1 ${re?"show":""}`,"data-popper-placement":"top-start",style:{position:"absolute",inset:"auto auto 0px 0px",margin:"0px",transform:"translateY(-44px)",maxHeight:"200px",overflowY:"auto"},children:c.filter(t=>`/${t.name}`.toLowerCase().startsWith(z.toLowerCase())).sort((t,i)=>t.name.localeCompare(i.name)).map((t,i)=>{const f=$(`<div>${t.description}</div>`);return f.find(".mention").each((R,_)=>{const D=$(_),U=D.attr("data-id");D.removeClass("mention"),D.text(p==null?void 0:p[U])}),e.jsxs("div",{className:"dropdown-item",type:"button",style:{width:"300px"},onClick:async()=>{if(le(!1),Y(""),x(!0),t.attachments.length>0){const R=t.attachments[0],_=`${T.APP_URL}/cloud/${R.file}`;await V.send(s,`/attachment:${_}
${f.html()}`),x(!1);return}await V.send(s,f.html()),x(!1)},children:[e.jsxs("span",{className:"d-block text-truncate",children:["/",t.name]}),e.jsx("small",{className:"d-block text-muted text-truncate",children:f.text()})]},i)})}),e.jsx("textarea",{ref:m,id:"message-input",className:"form-control w-100",placeholder:"Ingrese su mensaje aquí",rows:1,style:{minHeight:"38px",maxHeight:"188px",fieldSizing:"content",resize:"none",border:"none",backgroundColor:"transparent"},disabled:n||!!L||!!ie||!!pe,value:z,onChange:t=>{const i=t.target.value;String(i).trim().startsWith("/")&&c.some(({name:f})=>`/${f}`.toLowerCase().startsWith(i.toLowerCase()))?le(!0):le(!1),Y(i)},onKeyDown:t=>{t.key==="Enter"&&!t.shiftKey&&(t.preventDefault(),be()&&te(t))}})]})}),e.jsx("div",{className:"col-auto mt-0",children:(ie||pe)&&!Z?e.jsxs(e.Fragment,{children:[e.jsx("button",{type:"button",className:"btn btn-danger btn-sm me-1",onClick:()=>{he(null),ke(null),Se(null),Ce("")},style:{borderRadius:"50%",width:"38px",height:"38px",padding:0},title:"Descartar adjunto",children:e.jsx("i",{className:"mdi mdi-delete"})}),e.jsx("button",{type:"submit",className:"btn btn-success btn-sm",disabled:n,style:{borderRadius:"50%",width:"38px",height:"38px",padding:0},title:"Enviar adjunto",children:e.jsx("i",{className:"mdi mdi-send"})})]}):L&&!S?e.jsxs(e.Fragment,{children:[e.jsx("button",{type:"button",className:"btn btn-danger btn-sm me-1",onClick:fe,style:{borderRadius:"50%",width:"38px",height:"38px",padding:0},title:"Descartar audio",children:e.jsx("i",{className:"mdi mdi-delete"})}),e.jsx("button",{type:"submit",className:"btn btn-success btn-sm",disabled:n,style:{borderRadius:"50%",width:"38px",height:"38px",padding:0},title:"Enviar audio",children:e.jsx("i",{className:"mdi mdi-send"})})]}):S?e.jsxs(e.Fragment,{children:[e.jsx("button",{type:"button",className:"btn btn-warning btn-sm me-1",onClick:De,style:{borderRadius:"50%",width:"38px",height:"38px",padding:0},title:"Pausar grabación",children:e.jsx("i",{className:"mdi mdi-pause"})}),e.jsx("button",{type:"button",className:"btn btn-danger btn-sm",onClick:fe,style:{borderRadius:"50%",width:"38px",height:"38px",padding:0},title:"Descartar grabación",children:e.jsx("i",{className:"mdi mdi-delete"})})]}):e.jsx(e.Fragment,{children:z.trim()?e.jsx("button",{type:"submit",className:"btn btn-primary btn-sm",disabled:n,style:{borderRadius:"50%",width:"38px",height:"38px",padding:0},children:n?e.jsx("i",{className:"mdi mdi-spin mdi-loading"}):e.jsx("i",{className:"mdi mdi-send"})}):e.jsx("button",{type:"button",className:"btn btn-outline-primary btn-sm",onClick:Re,disabled:n,style:{borderRadius:"50%",width:"38px",height:"38px",padding:0},title:"Grabar audio",children:e.jsx("i",{className:"mdi mdi-microphone"})})})})]})})]})]}),e.jsx(Je,{isOpen:Z,setIsOpen:ee,onTakePhoto:t=>{O("image"),B(t)}})]})]}))},Ze=new We,et=s=>{var m,r,N,l;const[d,o]=a.useState([]),[h,u]=a.useState(!1),c=async()=>{u(!0);const g=await Ze.byClient(s==null?void 0:s.id);o(g??[]),u(!1)};return a.useEffect(()=>{s&&c()},[s]),e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"contact-details d-flex flex-column gap-2 flex-md-row flex-xl-row align-items-center  rounded-4 shadow-sm mb-2 overflow-hidden",children:[e.jsx("img",{src:`/api/whatsapp/profile/${s.contact_phone}`,className:"rounded-circle avatar-lg bg-light border-0 mb-3 mb-md-0 mb-xl-0 flex-shrink-0",alt:s.name,style:{objectFit:"cover"},onError:g=>{g.target.src=`//${T.APP_DOMAIN}/assets/img/user-404.svg`}}),e.jsxs("div",{className:"text-center text-md-start text-xl-start w-100",children:[e.jsx("div",{className:"fw-bold fs-5 text-dark text-truncat",children:s.contact_name}),e.jsx("div",{className:"text-muted text-truncate",children:s.name}),e.jsx("div",{className:"text-muted small text-truncate",children:s.contact_email}),e.jsx("div",{className:"text-muted small text-truncate",children:s.contact_phone})]})]}),e.jsxs("div",{className:"d-flex flex-wrap gap-2 justify-content-around mb-2",children:[e.jsxs("div",{className:"text-center",children:[e.jsx("b",{className:"d-block",children:"Estado de gestión"}),e.jsx("button",{className:"btn",style:{backgroundColor:((m=s.status)==null?void 0:m.color)||"#6c757d",color:"#fff",cursor:"default"},children:((r=s.status)==null?void 0:r.name)||"Sin estado"})]}),e.jsxs("div",{className:"text-center",children:[e.jsx("b",{className:"d-block",children:"Estado del lead"}),e.jsx("button",{className:"btn",style:{backgroundColor:((N=s.manage_status)==null?void 0:N.color)||"#6c757d",color:"#fff",cursor:"default"},children:((l=s.manage_status)==null?void 0:l.name)||"Sin estado"})]})]}),s.assigned_to&&e.jsxs("div",{className:"p-2 bg-light rounded mb-2",children:[e.jsx("h5",{className:"mt-0 mb-2",children:"Atendido por:"}),e.jsxs("div",{className:"d-flex align-items-start",bis_skin_checked:"1",children:[e.jsx("img",{className:"d-flex me-2 rounded-circle",src:`//${T.APP_DOMAIN}/api/profile/thumbnail/${s.assigned.relative_id}`,onError:g=>{g.target.src=`//${T.APP_DOMAIN}/assets/img/user-404.svg`},alt:s.assigned.fullname,height:"32"}),e.jsxs("div",{className:"w-100 overflow-hidden",bis_skin_checked:"1",children:[e.jsx("h5",{className:"m-0 font-14 text-truncate",children:s.assigned.fullname}),e.jsx("span",{className:"font-12 mb-0 text-truncate d-block",children:s.assigned.email})]})]})]}),e.jsx("hr",{className:"mt-0 mb-2"}),e.jsxs("div",{className:"d-flex justify-content-between align-items-center mb-2",children:[e.jsx("h5",{className:"my-0",children:"Actividad"}),e.jsx(ae,{content:"Ver más",children:e.jsx("a",{href:`/leads/${s.id}`,className:"text-decoration-none",children:e.jsx("i",{className:"mdi mdi-arrow-top-right"})})})]}),h?e.jsxs("div",{className:"placeholder-glow",children:[e.jsx("div",{className:"placeholder mb-2 w-100 rounded",style:{height:70}}),e.jsx("div",{className:"placeholder mb-2 w-100 rounded",style:{height:140}})]}):d.sort((g,j)=>j.created_at>g.created_at?1:-1).map((g,j)=>e.jsx(ze,{...g,showOptions:!1,extended:!1},`note-${j}`))]})};function me(s){var d;return typeof s=="string"?s:Array.isArray(s)?s.map(me).join(""):(d=s==null?void 0:s.props)!=null&&d.children?me(s.props.children):""}const _e=new we;_e.paginateSufix=null;const tt=({users:s=[],defaultMessages:d=[],activeLeadId:o,...h})=>{const u=Local.get("adminto_settings")??{},[c,m]=a.useState(u.theme??"light"),[r,N]=a.useState([]),[l,g]=a.useState(o),[j,M]=He(ce.business_id,[ce.service_user.id]),[p,v]=a.useState(!1),[A,k]=a.useState(0),[b,I]=a.useState(""),[W,Q]=a.useState(null),[C,B]=a.useState(null),{socket:q}=ye(),ne=a.useRef(),J=a.useRef(),O=async(n=!1)=>{if(p)return;v(!0);const x={fields:["clients.id","clients.contact_name","clients.contact_phone","clients.last_message","clients.last_message_microtime","clients.assigned_to","clients.status_id","clients.manage_status_id"],withCount:["unSeenMessages"],with:["assigned","status","manageStatus"],sort:[{selector:"last_message_microtime",desc:!0}],skip:0,take:40,requireTotalCount:!0},S=[["clients.last_message_microtime","isnotnull"]];if(j.length&&S.push(de(j.map(w=>["clients.assigned_to","=",w]),"or")),b){const w=[["clients.contact_name","=",b],["clients.contact_name","contains",b],["clients.contact_phone","contains",b]];S.push(de(w,"or"))}if(n&&r.length>0){const w=Math.min(...r.map(H=>H.last_message_microtime));S.push(["clients.last_message_microtime","<",w])}x.filter=de(S,"and");const{data:y,totalCount:L}=await _e.paginate(x);N(n?w=>[...w,...y??[]]:y??[]),k(((y==null?void 0:y.length)??0)+(L??0)),v(!1)},K=n=>{const x=n.target.value;I(x),W&&clearTimeout(W),Q(setTimeout(()=>{O(!1)},500))};return a.useEffect(()=>{O(!1)},[j]),a.useEffect(()=>{if(q)return q.on("client.updated",n=>{N(x=>{const S=x.findIndex(y=>y.id===n.id);if(S!==-1){const y=[...x];return y[S]={...y[S],...n},y}return!j.length||j.includes(n.assigned_to)?[...x,n]:x})}),()=>{q.off("client.updated")}},[q,j]),a.useEffect(()=>{const n=J.current;if(!n)return;const x=()=>{n.scrollTop+n.clientHeight>=n.scrollHeight-10&&r.length<A&&O(!0)};return n.addEventListener("scroll",x),()=>n.removeEventListener("scroll",x)},[r,p,j,A,b]),a.useEffect(()=>{l?history.pushState({},"",`/chat/${l}`):history.pushState({},"","/chat")},[l]),e.jsx(Ie,{...h,title:"Chat",showTitle:!1,setThemeParent:m,children:e.jsxs("div",{className:"row",children:[e.jsx("div",{className:"col-xl-3 col-lg-4",children:e.jsx("div",{className:"card chat-list-card mb-xl-0",children:e.jsxs("div",{className:"card-body p-0",children:[e.jsx("div",{className:"p-2",children:e.jsxs("div",{className:"d-flex w-100 gap-0 align-items-center scroll-hidden",style:{overflowX:"auto"},children:[s.map(n=>e.jsx(ae,{content:`${n.name} ${n.lastname}`,children:e.jsx("div",{onClick:()=>{const x=[...j],S=n.service_user.id,y=x.indexOf(S);y>-1?x.splice(y,1):x.push(S),M(x)},className:`rounded-pill ${j.includes(n.service_user.id)?"bg-purple":""}`,style:{cursor:"pointer",padding:"2px",marginRight:"2px"},children:e.jsx("img",{className:"avatar-xs rounded-circle",src:`//${T.APP_DOMAIN}/api/profile/thumbnail/${n.relative_id}`,onError:x=>{x.target.src=`//${T.APP_DOMAIN}/assets/img/user-404.svg`},alt:n.name,style:{objectFit:"cover",objectPosition:"center"}})})},n.id)),j.length>0&&e.jsx(ae,{content:"Limpiar filtros",children:e.jsx("button",{className:"btn btn-xs btn-soft-danger ms-1 rounded-pill",onClick:()=>M([]),children:e.jsx("i",{className:"mdi mdi-trash-can-outline"})})})]})}),e.jsx("div",{className:"p-2 border-top",children:e.jsxs("div",{className:"search-box chat-search-box",children:[e.jsx("input",{type:"text",className:"form-control rounded-pill",placeholder:"Buscar lead por nombre o número...",value:b,onChange:K}),e.jsx("i",{className:"mdi mdi-magnify search-icon"})]})}),e.jsxs("div",{ref:J,className:"scroll-hidden",style:{overflowY:"auto",height:"calc(100vh - 300px)"},children:[e.jsx("ul",{className:"list-unstyled chat-list mb-0",children:r.sort((n,x)=>new Date(x.last_message_microtime)-new Date(n.last_message_microtime)).map(n=>{var H,X,z,Y,G;const x=new Date((n.last_message_microtime??0)/1e3),S=new Date;S.setHours(0,0,0,0);const y=new Date(S);y.setDate(y.getDate()-1);let L;if(x>=S)L=x.toLocaleString("es-ES",{hour:"2-digit",minute:"2-digit"});else if(x>=y)L="Ayer";else{const E=["Domingo","Lunes","Martes","Miércoles","Jueves","Viernes","Sábado"];if(Math.floor((new Date-x)/(1e3*60*60*24))<=6)L=E[x.getDay()];else{const Z=String(x.getDate()).padStart(2,"0"),ee=String(x.getMonth()+1).padStart(2,"0"),re=x.getFullYear();L=`${Z}/${ee}/${re}`}}let w=n.last_message;if(w.startsWith("/audio:"))w=e.jsxs(e.Fragment,{children:[e.jsx("i",{className:"mdi mdi-microphone"})," Audio"]});else if(w.startsWith("/image:")){const E=String(w.split(`
`).slice(1).join(`
`)||"").trim();w=e.jsxs(e.Fragment,{children:[e.jsx("i",{className:"mdi mdi-image"})," ",E||"Foto"]})}else if(w.startsWith("/document:")){const E=String(w.split(`
`).slice(1).join(`
`)||"").trim();w=e.jsxs(e.Fragment,{children:[e.jsx("i",{className:"mdi mdi-file-document"})," ",E||"Documento"]})}return e.jsx("li",{className:`${n.unread?"unread":""} ${l==n.id?"bg-light":""}`,children:e.jsx("a",{onClick:E=>{g(n.id),E.stopPropagation()},style:{cursor:"pointer"},children:e.jsxs("div",{className:"d-flex",children:[e.jsxs("div",{className:`position-relative flex-shrink-0 chat-user-img ${n.online?"active":""} align-self-center me-2`,children:[e.jsx("img",{src:`/api/whatsapp/profile/${n.contact_phone}`,className:"rounded-circle avatar-sm bg-light",alt:n.name,style:{padding:0,border:"none"},onError:E=>{E.target.src=`//${T.APP_DOMAIN}/assets/img/user-404.svg`}}),n.assigned_to&&((H=n.assigned)==null?void 0:H.relative_id)&&(j.length===0||j.length>1||j[0]!==ce.service_user.id)&&e.jsx(ae,{content:`${n.assigned.name} ${n.assigned.lastname}`,children:e.jsx("img",{className:"position-absolute rounded-pill",src:`//${T.APP_DOMAIN}/api/profile/thumbnail/${n.assigned.relative_id}`,onError:E=>{E.target.src=`//${T.APP_DOMAIN}/assets/img/user-404.svg`},alt:n.assigned.fullname,style:{right:"-4px",bottom:"-4px",objectFit:"cover",objectPosition:"center",padding:0,border:`2px solid ${c=="light"?"#ffffff":"#313844"}`,width:"18px",aspectRatio:1}})},n.assigned.id)]}),e.jsxs("div",{className:"flex-grow-1 overflow-hidden",children:[e.jsx("h5",{className:`text-truncate font-14 mt-0 mb-0 ${n.un_seen_messages_count>0?"fw-bold":""}`,children:n.contact_name}),e.jsx("p",{className:`text-truncate mb-0 ${n.un_seen_messages_count>0?"fw-bold":""}`,title:me(w)??void 0,style:{color:n.un_seen_messages_count>0?c=="light"?"#343a40":"#f7f7f7":void 0},children:w??e.jsx("i",{className:"text-muted",children:"Sin mensaje"})}),e.jsxs("div",{className:"d-flex gap-1",children:[e.jsx("span",{className:"badge",style:{backgroundColor:((X=n.status)==null?void 0:X.color)??"#6c757d"},children:((z=n.status)==null?void 0:z.name)??"Sin estado"}),e.jsx("span",{className:"badge",style:{backgroundColor:((Y=n.manage_status)==null?void 0:Y.color)??"#6c757d"},children:((G=n.manage_status)==null?void 0:G.name)??"Sin estado"})]})]}),e.jsxs("div",{className:"d-flex flex-column align-items-end",children:[e.jsx("div",{className:`font-11 ${n.un_seen_messages_count>0?"text-success":""}`,children:L}),n.un_seen_messages_count>0&&e.jsx("span",{className:"badge bg-success rounded-pill mt-1",children:n.un_seen_messages_count})]})]})})},n.id)})}),e.jsxs("div",{className:"text-center py-2",children:[p&&e.jsx("div",{className:"spinner-border spinner-border-sm text-primary",role:"status",children:e.jsx("span",{className:"visually-hidden",children:"Loading contacts..."})}),!p&&r.length>=A&&r.length>0&&e.jsx("span",{className:"text-muted",children:"No hay más contactos"})]})]})]})})}),e.jsx("div",{className:`col-xl-${C?6:9} col-lg-${C?8:12}`,children:e.jsx("div",{className:"conversation-list-card card",children:l?e.jsx(e.Fragment,{children:e.jsx(Qe,{leadId:l,setLeadId:g,containerRef:ne,theme:c,contactDetails:C,setContactDetails:B,defaultMessages:d})}):e.jsx("div",{className:"card-body d-flex align-items-center justify-content-center",style:{height:"calc(100vh - 184px)"},children:e.jsxs("div",{className:"text-center",children:[e.jsx("img",{src:"/assets/img/icon.svg",alt:`Logo ${T.APP_NAME}`,className:"mb-2",style:{width:60,height:60,objectFit:"contain"}}),e.jsxs("h4",{className:"text-muted",children:["Módulo de chat de ",T.APP_NAME]}),e.jsx("p",{className:"text-muted",children:"Selecciona un contacto para empezar a interactuar"})]})})})}),C&&e.jsx("div",{className:"col-xl-3 col-lg-12",children:e.jsx("div",{className:"card contact-details-card mb-xl-0",children:e.jsx("div",{className:"card-body scroll-hidden",style:{height:"calc(100vh - 186px)",overflowY:"auto"},children:e.jsx(et,{...C})})})})]})})};Ae((s,d)=>{Pe(s).render(e.jsx(tt,{...d}))});
