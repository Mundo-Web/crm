var q=Object.defineProperty;var I=(a,n,s)=>n in a?q(a,n,{enumerable:!0,configurable:!0,writable:!0,value:s}):a[n]=s;var S=(a,n,s)=>I(a,typeof n!="symbol"?n+"":n,s);import{C as V,c as U,R as r,r as o,m as H}from"./CreateReactScript-BzwrR0sZ.js";import{B as O,A as z,S as p}from"./Adminto-BiO-cymU.js";import{P as J,a as K,A as Q}from"./AssignUsersModal-DsZgHCVZ.js";import{N as W}from"./Number2Currency-e57Tgsuk.js";import{a as A,S as C}from"./SetSelectValue-Cjw0rti6.js";import{A as X,D as Z,P as j}from"./DateRange-BAof4H8g.js";import{M as ee}from"./Modal-ChNOGOpW.js";import{T as te,D as re}from"./DxPanelButton-B0o8aYX1.js";import{D as i}from"./DxButton-CsjWvhyj.js";import{I as c}from"./InputFormGroup-UB2lFvd0.js";import{T as ne}from"./TextareaFormGroup-Dl-3XIPv.js";import{D as d}from"./DxBox-CPKh0yyu.js";import{S as oe}from"./SelectFormGroup-Bbfg_VUz.js";import{S as se}from"./SubdomainsRest-B5Z76R3d.js";import"./Dropdown-sydwj0Do.js";import"./DropdownItem-Bmz8ZgWp.js";import"./TippyButton-49AdcpMg.js";import"./server.browser-CLYKlTOS.js";class ae extends O{constructor(){super(...arguments);S(this,"path","projects/done")}}const le=new se,ie=new ae,ce=({statuses:a,can:n})=>{const s=o.useRef(),f=o.useRef(),g=o.useRef(),y=o.useRef(),b=o.useRef(),v=o.useRef(),x=o.useRef(),h=o.useRef(),E=o.useRef(),R=o.useRef(),w=o.useRef(),D=o.useRef(),[P,_]=o.useState(!1),[M,F]=o.useState({}),[k,T]=o.useState({}),B=e=>{var t,l,m,u,N;e!=null&&e.id?_(!0):_(!1),y.current.value=(e==null?void 0:e.id)||null,$(g.current).val(((t=e==null?void 0:e.status)==null?void 0:t.id)??null).trigger("change"),C(b.current,(l=e==null?void 0:e.client)==null?void 0:l.id,(m=e==null?void 0:e.client)==null?void 0:m.name),C(v.current,(u=e==null?void 0:e.type)==null?void 0:u.id,(N=e==null?void 0:e.type)==null?void 0:N.name),x.current.value=(e==null?void 0:e.name)||null,h.current.value=(e==null?void 0:e.description)||null,E.current.value=e==null?void 0:e.cost,R.current.value=e!=null&&e.sign_at?moment(e.sign_at).format("YYYY-MM-DD"):null,w.current.value=e!=null&&e.starts_at?moment(e.starts_at).format("YYYY-MM-DD"):null,D.current.value=e!=null&&e.ends_at?moment(e.ends_at).format("YYYY-MM-DD"):null,$(f.current).modal("show")},G=async e=>{e.preventDefault();const t={status_id:g.current.value,id:y.current.value||void 0,client_id:b.current.value,type_id:v.current.value,name:x.current.value,description:h.current.value,cost:E.current.value??void 0,sign_at:R.current.value??void 0,starts_at:w.current.value,ends_at:D.current.value};await j.save(t)&&($(s.current).dxDataGrid("instance").refresh(),$(f.current).modal("hide"))},Y=async e=>{const{isConfirmed:t}=await p.fire({title:"¿Estás seguro de archivar este proyecto?",text:"Aún podrás verlo en la ventana de archivados",icon:"warning",showCancelButton:!0,confirmButtonText:"Continuar",cancelButtonText:"Cancelar"});!t||!await j.delete(e)||$(s.current).dxDataGrid("instance").refresh()},L=async e=>{const{isConfirmed:t}=await p.fire({title:"¿Estás seguro de agregar páginas?",text:"Esta acción creará un correlativo de páginas para el proyecto.",icon:"warning",showCancelButton:!0,confirmButtonText:"Sí, agregar",cancelButtonText:"Cancelar"});if(!t)return;const l=await le.save({project_id:e.id,name:e.client.tradename});if(!l){p.fire("Error","No se pudo crear la página.","error");return}p.fire("Éxito","Página creada exitosamente.","success"),$(s.current).dxDataGrid("instance").refresh(),location.href=`/pages/${l.correlative}`};return r.createElement(r.Fragment,null,r.createElement(te,{gridRef:s,title:"Proyectos Terminados",rest:ie,exportable:!0,toolBar:e=>{e.unshift(re({className:"btn btn-xs btn-soft-dark",text:"Actualizar",title:"Refrescar tabla",icon:"fas fa-undo-alt",onClick:()=>$(s.current).dxDataGrid("instance").refresh()}))},filterValue:void 0,columns:[{dataField:"client.tradename",caption:"Nombre comercial",filterValue:H.GET.client||void 0,fixed:!0,fixedPosition:"left"},{dataField:"type.name",caption:"Tipo",visible:!1},{dataField:"name",caption:"Proyecto"},{dataField:"users",caption:"Asignados",dataType:"string",cellTemplate:(e,{data:t})=>{const l=(t.users||"").split("|").filter(Boolean);e.append(d([X(l)]))},visible:!1,allowExporting:!1},n("projects","root","all","addpayment")&&{dataField:"cost",caption:"Costo total",dataType:"number",cellTemplate:(e,{data:t})=>{e.text(`S/. ${W(t.cost)}`)}},n("projects","root","all","addpayment")&&{dataField:"remaining_amount",caption:"Debe",dataType:"number",cellTemplate:(e,{data:t})=>{const l=(t.total_payments/t.cost*100).toFixed(2),m=Number(t.total_payments).toLocaleString("en-US",{maximumFractionDigits:2,minimumFractionDigits:2}),u=Number(t.cost-t.total_payments).toLocaleString("en-US",{maximumFractionDigits:2,minimumFractionDigits:2});e.append(d([r.createElement(r.Fragment,null,r.createElement("p",{className:"mb-0 d-flex justify-content-between"},r.createElement("b",{className:"text-success"},r.createElement("i",{className:"fa fa-arrow-circle-up"})," S/. ",m),r.createElement("b",{className:"float-end text-danger"},r.createElement("i",{className:"fa fa-arrow-circle-down"})," S/. ",u)),r.createElement("div",{className:"progress progress-bar-alt-primary progress-sm mt-0 mb-0",style:{width:"200px"}},r.createElement("div",{className:"progress-bar bg-primary progress-animated wow animated animated animated",role:"progressbar","aria-valuenow":t.total_payments,"aria-valuemin":"0","aria-valuemax":t.cost,style:{width:`${l}%`,visibility:"visible",animationName:"animationProgress"}})))],!1))},allowExporting:!1},{dataField:"starts_at",caption:"Fecha inicio proyecto",dataType:"date",format:"yyyy-MM-dd",cellTemplate:(e,{data:t})=>{e.text(moment(t.starts_at).format("LL"))}},{dataField:"ends_at",caption:"Fecha fin proyecto",dataType:"date",format:"yyyy-MM-dd",cellTemplate:(e,{data:t})=>{e.append(d([{width:"200px",height:"30px",children:Z(t.starts_at,t.ends_at)}]))},sortOrder:"asc"},{dataField:"last_payment_date",caption:"Fecha ultimo pago",dataType:"datetime",format:"yyyy-MM-dd HH:mm:ss",cellTemplate:(e,{data:t})=>{if(!t.last_payment_date)return e.html('<i class="text-muted">- No hay pagos -</i>');e.text(moment(t.last_payment_date).format("LLL"))}},n("projects","root","all","changestatus")?{dataField:"status.name",caption:"Estado del proyecto",dataType:"string",cellTemplate:(e,{data:t})=>{e.attr("style","overflow: visible"),e.append(d([{height:"28px",children:r.createElement(J,{can:n,statuses:a,data:t,onChange:()=>{$(s.current).dxDataGrid("instance").refresh()}})}]))}}:null,{caption:"Acciones",cellTemplate:(e,{data:t})=>{n("projects","root","all","update")&&e.append(i({className:"btn btn-xs btn-soft-primary",title:"Editar",icon:"fa fa-pen",onClick:()=>B(t)})),n("projects","root","all","assignUsers")&&e.append(i({className:"btn btn-xs btn-soft-info",title:"Asignar usuarios",icon:"fa fa-user-plus",onClick:()=>T(t)})),n("projects","root","all","addpayment")&&e.append(i({className:"btn btn-xs btn-soft-success",title:"Ver/Agregar pagos",icon:"fas fa-money-check-alt",onClick:()=>F(t)})),n("pages","root","all","create")&&(t.subdomain?e.append(i({className:"btn btn-xs btn-dark-success",title:"Ver páginas",icon:"fas fa-window-restore",onClick:()=>location.href=`/pages/${t.subdomain.correlative}`})):e.append(i({className:"btn btn-xs btn-dark-success",title:"Agregar páginas",icon:"fas fa-window-restore",onClick:()=>L(t)}))),n("projects","root","all","delete")&&e.append(i({className:"btn btn-xs btn-soft-dark",title:"Archivar",icon:"mdi mdi-archive",onClick:()=>Y(t.id)}))},allowFiltering:!1,allowExporting:!1}]}),r.createElement(ee,{modalRef:f,title:P?"Editar proyecto":"Agregar proyecto",onSubmit:G},r.createElement("div",{className:"row",id:"project-crud-container"},r.createElement("div",{className:"col-12"},r.createElement("div",{className:"row justify-content-center"},r.createElement(oe,{eRef:g,label:"Estado del proyecto",dropdownParent:"#project-crud-container",col:"col-md-6 col-sm-12",required:!0},a.map((e,t)=>r.createElement("option",{key:`status-${t}`,value:e.id},e.name))))),r.createElement("input",{ref:y,type:"hidden"}),r.createElement(A,{eRef:b,label:"Cliente",col:"col-12",dropdownParent:"#project-crud-container",searchAPI:"/api/clients/paginate",searchBy:"tradename",required:!0}),r.createElement(A,{eRef:v,label:"Tipo del proyecto",col:"col-md-4",dropdownParent:"#project-crud-container",searchAPI:"/api/types/paginate",searchBy:"name",filter:["table_id","=","cd8bd48f-c73c-4a62-9935-024139f3be5f"],required:!0}),r.createElement(c,{eRef:x,label:"Nombre del proyecto",col:"col-md-8",required:!0}),r.createElement(ne,{eRef:h,label:"Descripcion del proyecto",col:"col-12"}),r.createElement(c,{eRef:E,label:"Costo",col:"col-md-6",type:"number",step:.01,required:!0}),r.createElement(c,{eRef:R,label:"Fecha firma",col:"col-md-6",type:"date"}),r.createElement(c,{eRef:w,label:"Fecha inicio",col:"col-md-6",type:"date",required:!0}),r.createElement(c,{eRef:D,label:"Fecha fin",col:"col-md-6",type:"date",required:!0}))),r.createElement(K,{can:n,dataLoaded:M,setDataLoaded:F,grid2refresh:$(s.current).dxDataGrid("instance")}),r.createElement(Q,{dataLoaded:k,setDataLoaded:T,grid2refresh:$(s.current).dxDataGrid("instance")}))};V((a,n)=>{if(!n.can("projects","root","all","list"))return location.href="/";U(a).render(r.createElement(z,{...n,title:"Proyectos Terminados"},r.createElement(ce,{...n})))});
