var Gs=Object.defineProperty;var Hs=(u,n,c)=>n in u?Gs(u,n,{enumerable:!0,configurable:!0,writable:!0,value:c}):u[n]=c;var me=(u,n,c)=>Hs(u,typeof n!="symbol"?n+"":n,c);import{r,j as e,m as O,G as B,L as le,C as qs,c as zs}from"./CreateReactScript-DSh221L4.js";import{i as q,S as ce,B as Ws,W as Ys,A as Vs}from"./Adminto-CxkkDmWv.js";import{Q as Xs,a as Ks}from"./QuillFormGroup-qUwy-Cwj.js";import{H as Ge,C as Qs,a as Js,P as Zs,b as hs,T as Ls}from"./ProductsByClientsRest-CKl_dIfx.js";import{L as Ns}from"./LeadsRest-D6W3Dn0K.js";import{T as et}from"./TasksRest-BNnU4CMm.js";import{U as vs}from"./UsersRest-CuirQA9r.js";import{M as pe}from"./Modal-D-tXYeXz.js";import{I as re}from"./InputFormGroup-DsuG1yrP.js";import{T as ws}from"./TextareaFormGroup-CVonM_0b.js";import{S as fe}from"./SelectFormGroup-D827EBoU.js";import{T as ne}from"./TippyButton-BY7aP8sy.js";import{a as st,S as tt}from"./SetSelectValue-HiwDtLZy.js";import{D as ys}from"./Dropdown-7dNvA4Pv.js";import{D as Se}from"./DropdownItem-BOKSg5Pi.js";import{N as _e}from"./Number2Currency-e57Tgsuk.js";import{r as fs}from"./server.browser-DoheiHq8.js";import{R as nt}from"./RepositoryDropzone-ClzfO_tq.js";import{T as at,D as ps}from"./DxPanelButton-aij2gTJV.js";import{R as ee}from"./ReactAppend-CCPXxX5R.js";import{S as it}from"./StatusesRest-aDNm-4OS.js";const xs=u=>String(u).toLowerCase().split(" ").map(n=>n.trim()).filter(Boolean).join("-"),rt=async(u,n)=>{const c=u.getBoundingClientRect(),m=c.left+window.scrollX,k=c.top+window.scrollY,R=m+c.width/2,C=k+c.height/2,_=n.getBoundingClientRect(),F=_.left+window.scrollX,w=_.top+window.scrollY,H=F+_.width/2,U=w+_.height/2,D=`
    @keyframes xAxis {
      0% {
        left: ${R}px;
        top: ${C}px;
      }
      100% {
        left: ${H}px;
        top: ${U}px;
      }
    }
    @keyframes yAxis {
      0% {
        color: #343a40;
      }
      100% {
        color: #343a40;
      }
    }
  `;$("#send-to-div-style").attr("href","data:text/css;charset=UTF-8,"+encodeURIComponent(D))},ct=u=>{const n=$("#icon-2-send");n.addClass("sending-to-div"),setTimeout(()=>{n.removeClass("sending-to-div"),$(u).addClass("shake"),setTimeout(function(){$(u).removeClass("shake")},1e3)},1e3)},lt=({onChange:u=()=>{},onDelete:n=()=>{},...c})=>{const[m,k]=r.useState(!1),[R,C]=r.useState(c.pivot_price),_=r.useRef(null);r.useEffect(()=>{const w=H=>{_.current&&!_.current.contains(H.target)&&(k(!1),R!==c.price&&(console.log("cambio a:",R),u({...c,price:R})))};return m?document.addEventListener("mousedown",w):document.removeEventListener("mousedown",w),()=>{document.removeEventListener("mousedown",w)}},[m,R,c,u]);const F=w=>{w.key==="Enter"&&(w.preventDefault(),k(!1),R!==c.price&&(console.log("cambio a:",R),u({...c,price:R})))};return e.jsx(e.Fragment,{children:e.jsx("div",{className:"card mb-0",style:{border:`1px solid ${c.color}44`,backgroundColor:`${c.color}11`},children:e.jsxs("div",{className:"card-body p-2",children:[e.jsx("div",{className:"float-end",children:e.jsx(q,{content:"Quitar producto",children:e.jsx("i",{className:"fa fa-times",onClick:()=>n(c),style:{cursor:"pointer"}})})}),e.jsx("h5",{className:"header-title mt-0 mb-1",style:{fontSize:"14.4px",color:c.color},children:c.name}),m?e.jsx("input",{ref:_,className:"form-control form-control-sm",type:"number",value:R,onChange:w=>C(parseFloat(w.target.value)||0),onKeyDown:F}):e.jsxs("small",{onClick:()=>k(!0),style:{cursor:"text"},children:["S/. ",_e(R)]})]})})})},ot="/build/assets/google-CZOMqMi4.svg";class Cs{constructor(){me(this,"check",async()=>{const{status:n,result:c}=await O.Fetch("/api/gmail/check");return n?c==null?void 0:c.data:O.Notify.add({icon:"/assets/img/logo-login.svg",title:"Error",body:(c==null?void 0:c.message)||"Ocurrió un error inesperado",type:"danger"})});me(this,"list",async n=>{const{status:c,result:m}=await O.Fetch("/api/gmail",{method:"POST",body:O.JSON.stringify({email:n})});return c?m==null?void 0:m.data:O.Notify.add({icon:"/assets/img/logo-login.svg",title:"Error",body:(m==null?void 0:m.message)||"Ocurrió un error inesperado",type:"danger"})});me(this,"getDetails",async n=>{const{status:c,result:m}=await O.Fetch(`/api/gmail/details/${n}`);return c?m==null?void 0:m.data:O.Notify.add({icon:"/assets/img/logo-login.svg",title:"Error",body:(m==null?void 0:m.message)||"Ocurrió un error inesperado",type:"danger"})});me(this,"send",async n=>{const{status:c,result:m}=await O.Fetch("/api/gmail/send",{method:"POST",headers:{"X-Xsrf-Token":decodeURIComponent(O.Cookies.get("XSRF-TOKEN"))},body:O.JSON.stringify(n)});return c?(m==null?void 0:m.data)??!0:O.Notify.add({icon:"/assets/img/logo-login.svg",title:"Error",body:(m==null?void 0:m.message)||"Ocurrió un error inesperado",type:"danger"})})}}const dt=new Cs,mt=({data:u,inReplyTo:n,modalRef:c,onSend:m=()=>{},defaultMessages:k,signs:R=[]})=>{const C=r.useRef(),_=r.useRef(),F=r.useRef(),w=r.useRef(),H=r.useRef(),[U,D]=r.useState(!1),[E,I]=r.useState(!1),[S,j]=r.useState(!1),[f,T]=r.useState([]),z=N=>{T(d=>d.filter(v=>v.id!==N))},J=()=>{F.current.value="",w.current.value="",w.editor.root.innerHTML="",$(C.current).val(null).trigger("change"),$(_.current).val(null).trigger("change"),I(!1),j(!1),T([])},K=async N=>{const d=$(w.editor.root);if(!N){d.find("#mailing-sign").remove();return}const v=e.jsx("img",{id:"mailing-sign",src:`${B.APP_PROTOCOL}://${B.APP_DOMAIN}/repository/signs/${N.sign}`,alt:N.name,style:{maxWidth:"480px"}});if(d.find('[id="mailing-sign-container"]').length===0){const x=fs(e.jsxs(e.Fragment,{children:[e.jsx("p",{}),e.jsx("p",{}),e.jsx("p",{}),e.jsx("p",{children:"--"}),e.jsx("p",{id:"mailing-sign-container",children:v})]}));d.append(x)}else d.find('[id="mailing-sign-container"]').html(fs(v))},Z=async N=>{N.preventDefault(),D(!0);const d=w.current.value,x=$(`<div>${d}</div>`).text().toLowerCase().match(/\b(adjunt\w*)\b/g);if(x&&x.length>0&&f.length===0&&!(await ce.fire({title:"¿Enviar sin adjuntos?",html:`En tu mensaje has escrito "${x[0]}", pero no lleva ningun archivo adjunto ¿quieres enviarlo igualmente?`,icon:"warning",showCancelButton:!0,confirmButtonText:"Sí, enviar",cancelButtonText:"Cancelar"})).isConfirmed){D(!1);return}const g={to:u==null?void 0:u.id,subject:F.current.value,body:d,cc:[],bcc:[],attachments:[]};n&&(g.inReplyTo=n.id);const A=E?$(C.current).val()||[]:[],M=S?$(_.current).val()||[]:[];A.length>0&&(g.cc=A),M.length>0&&(g.bcc=M),g.attachments=f;const P=await dt.send(g);D(!1),P&&(O.Notify.add({icon:"/assets/img/logo-login.svg",title:"Correcto",body:"El correo ha sido enviado correctamente"}),J(),$(c.current).modal("hide"),m(P))},L=N=>{if(!N){w.current.value="",w.editor.root.innerHTML="",T([]);return}const d=$(`<div>${N.description}</div>`);d.find(".mention").each((v,x)=>{const g=$(x),A=g.attr("data-id");g.removeClass("mention"),g.text(u[A])}),F.current.value=N.name,w.current.value=N.description,w.editor.root.innerHTML=d.html(),T(N.attachments)};return e.jsxs(e.Fragment,{children:[e.jsx(pe,{modalRef:c,size:"lg",zIndex:1050,onSubmit:Z,hideHeader:!0,hideFooter:!0,onClose:J,children:e.jsxs("div",{id:"mailing-modal",children:[e.jsx("button",{type:"button",className:"btn-close float-end","data-bs-dismiss":"modal","aria-label":"Close"}),e.jsx("h4",{className:"header-title mb-0",children:"Mensaje nuevo"}),e.jsx("hr",{className:"my-2"}),n&&e.jsxs("div",{className:"mb-2",children:[e.jsx("i",{className:"fas fa-reply me-1"})," ",n==null?void 0:n.sender]}),e.jsxs("div",{className:"mb-2",children:[e.jsx("b",{children:"Para:"})," ",u==null?void 0:u.contact_name,e.jsxs("small",{className:"text-muted d-block",children:["<",u==null?void 0:u.contact_email,">"]})]}),e.jsxs("div",{className:"mb-2 d-flex align-items-center",children:[e.jsxs("div",{className:"form-check me-3",children:[e.jsx("input",{type:"checkbox",className:"form-check-input",id:"showCC",checked:E,onChange:()=>I(!E)}),e.jsx("label",{className:"form-check-label",htmlFor:"showCC",children:"CC"})]}),e.jsxs("div",{className:"form-check",children:[e.jsx("input",{type:"checkbox",className:"form-check-input",id:"showBCC",checked:S,onChange:()=>j(!S)}),e.jsx("label",{className:"form-check-label",htmlFor:"showBCC",children:"CCO"})]})]}),E&&e.jsx(fe,{eRef:C,label:"CC",tags:!0,dropdownParent:"#mailing-modal",multiple:!0}),S&&e.jsx(fe,{eRef:_,label:"CCO",tags:!0,dropdownParent:"#mailing-modal",multiple:!0}),e.jsx(ws,{eRef:F,label:"Asunto",rows:1,required:!0}),e.jsx(Xs,{eRef:w,label:"Mensaje",required:!0}),f.length>0&&e.jsxs("div",{className:"border rounded p-2 mb-3",children:[e.jsxs("div",{className:"d-flex align-items-center mb-2",children:[e.jsx("i",{className:"mdi mdi-paperclip me-1"}),e.jsxs("small",{className:"text-muted",children:["Archivos adjuntos (",f.length,")"]})]}),e.jsx("div",{className:"d-flex flex-wrap gap-2",children:f.map((N,d)=>e.jsxs("div",{className:"border rounded p-1 d-flex align-items-center gap-2",style:{fontSize:"0.8rem"},children:[e.jsx("i",{className:"mdi mdi-file"}),e.jsx("span",{children:N.name}),e.jsx("button",{type:"button",className:"btn btn-xs btn-soft-danger py-0 px-1",onClick:()=>z(N.id),children:e.jsx("i",{className:"mdi mdi-close"})})]},d))})]}),e.jsx("hr",{className:"my-2"}),e.jsxs("div",{className:"d-flex justify-content-between",children:[e.jsxs("div",{className:"d-flex gap-2",children:[e.jsxs("button",{className:"btn btn-sm btn-primary",type:"submit",disabled:U,children:["Enviar",U?e.jsx("i",{className:"fa fa-spin fa-spinner ms-1"}):e.jsx("i",{className:"fas fa-location-arrow ms-1"})]}),e.jsxs("div",{className:"d-flex gap-1",children:[e.jsx(q,{content:"Adjuntar archivos",children:e.jsx("button",{className:"btn btn-sm btn-white mb-0",type:"button",onClick:()=>$(H.current).modal("show"),children:e.jsx("i",{className:"mdi mdi-paperclip"})})}),e.jsxs("div",{class:"dropdown",children:[e.jsx(q,{content:"Usar plantilla",children:e.jsx("button",{class:"btn btn-sm  btn-white dropdown-toggle",type:"button",id:"dropdown-templates-button","data-bs-toggle":"dropdown","aria-haspopup":"true","aria-expanded":"false",children:e.jsx("i",{class:"mdi mdi-message-bulleted"})})}),e.jsxs("div",{class:"dropdown-menu","aria-labelledby":"dropdown-templates-button",children:[e.jsxs("span",{class:"dropdown-item",style:{cursor:"pointer"},onClick:()=>L(),children:[e.jsx("i",{className:"mdi mdi-broom me-1"}),"Limpiar contenido"]}),k.filter(N=>N.type=="email").map((N,d)=>e.jsx("span",{class:"dropdown-item",style:{cursor:"pointer"},onClick:()=>L(N),children:N.name},d)),e.jsx("div",{className:"dropdown-divider"}),e.jsxs("a",{class:"dropdown-item",href:`${B.APP_PROTOCOL}://${B.APP_DOMAIN}/signs`,target:"_blank",children:["Gestionar plantillas",e.jsx("i",{className:"mdi mdi-arrow-top-right ms-1"})]})]})]}),e.jsxs("div",{class:"dropdown",children:[e.jsx(q,{content:"Insertar firma",children:e.jsx("button",{class:"btn btn-sm  btn-white dropdown-toggle",type:"button",id:"dropdown-signs-button","data-bs-toggle":"dropdown","aria-haspopup":"true","aria-expanded":"false",children:e.jsx("i",{class:"mdi mdi-pen"})})}),e.jsxs("div",{class:"dropdown-menu","aria-labelledby":"dropdown-signs-button",children:[e.jsx("span",{class:"dropdown-item",style:{cursor:"pointer"},onClick:()=>K(),children:"Sin firma"}),R.map((N,d)=>e.jsxs("span",{class:"dropdown-item d-flex gap-1 align-items-center",style:{cursor:"pointer"},onClick:()=>K(N),children:[e.jsx("img",{src:`${B.APP_PROTOCOL}://${B.APP_DOMAIN}/repository/signs/${N.sign}`,alt:N.name,style:{width:"20px",aspectRatio:1,objectFit:"cover",objectPosition:"center"}}),N.name||e.jsx("i",{className:"text-muted",children:"Sin nombre"})]},d)),e.jsx("div",{className:"dropdown-divider"}),e.jsxs("a",{class:"dropdown-item",href:`${B.APP_PROTOCOL}://${B.APP_DOMAIN}/signs`,target:"_blank",children:["Gestionar firmas",e.jsx("i",{className:"mdi mdi-arrow-top-right ms-1"})]})]})]})]})]}),e.jsx("button",{className:"btn btn-sm btn-danger",type:"button",onClick:J,children:e.jsx("i",{className:"mdi mdi-delete"})})]})]})}),e.jsx(pe,{modalRef:H,title:"Repositorio",size:"full-width",hideFooter:!0,zIndex:1070,children:e.jsx(nt,{height:"calc(100vh - 300px)",multiple:!0,selectedFiles:f,setSelectedFiles:T,selectable:!0})})]})},ut=u=>{if(u<1024)return`${u} B`;const n=["KB","MB","GB"];let c=-1,m=u;for(;m>=1024&&c<n.length-1;)m/=1024,c++;return`${m.toFixed(1)} ${n[c]}`},gs=new it;function bs({defaultValue:u,items:n=[],base:c={},canCreate:m=!1,canUpdate:k=!1,canDelete:R=!1,onItemClick:C=()=>{},onDropdownClose:_=()=>{}}){const F=r.useRef(),w=r.useRef(),H=r.useRef(),U=r.useRef(),[D,E]=r.useState(n),[I,S]=r.useState(!1),[j,f]=r.useState(!1),T=D.find(d=>d.id==u.id),z=r.useCallback((d,v,x)=>{const g=d.scrollTop,A=v-g,M=performance.now(),P=l=>{const b=l-M,y=Math.min(b/x,1),G=y<.5?4*y*y*y:1-Math.pow(-2*y+2,3)/2;d.scrollTop=g+A*G,y<1&&requestAnimationFrame(P)};requestAnimationFrame(P),O.Local.onchange("statuses",l=>{console.log(l)})},[]);r.useEffect(()=>{if(I&&U.current){const d=U.current.scrollHeight-U.current.clientHeight;z(U.current,d,300),S(!1)}O.Local.set("statuses",D)},[D,I,z]),r.useEffect(()=>{const d=$(F.current),v=()=>{const x=structuredClone(D).filter(g=>g.id).map(g=>(g.editing=!1,g));E(x),_(j,x)};return d.on("hidden.bs.dropdown",v),()=>{d.off("hidden.bs.dropdown",v)}},[j,D]);const J=d=>{d.stopPropagation(),E(v=>[...v.map(x=>(x.editing=!1,x)),{editing:!0}]),S(!0)},K=(d,v)=>{d.stopPropagation(),E(x=>x.map(g=>{if(g.id)return g.editing=g.id===v.id,g}).filter(Boolean))},Z=async(d,v)=>{d.stopPropagation();const{isConfirmed:x}=await ce.fire({title:"Estas seguro de eliminar este estado?",text:"No podras revertir esta accion!",icon:"warning",showCancelButton:!0,confirmButtonText:"Continuar",cancelButtonText:"Cancelar"});if(!x)return;const g=await gs.delete(v.id);if(console.log(g),!g)return;const A=structuredClone(D).map(M=>{if(M.id&&M.id!=v.id)return M.editing=M.id===v.id,M}).filter(Boolean);E(A),f(!0),_(!0,A)},L=async(d,v)=>{d.preventDefault();const x=await gs.save({...structuredClone(c),id:v.id??void 0,name:w.current.value,color:H.current.value});x&&(D.find(g=>g.id==x.id)?E(g=>{const A=g.findIndex(M=>M.id==x.id);return g[A]=x,structuredClone(g).filter(M=>M.id)}):E(g=>[...g.filter(A=>A.id),x]),f(v.name!=x.name||v.color!=x.color))},N=d=>{E(v=>v.filter(x=>x.id||!x.editing).map(x=>({...x,editing:!1})))};return e.jsxs(ys,{ddRef:F,className:"btn btn-white text-truncate",title:T.name,tippy:"Actualizar estado",style:{border:"none",borderRadius:"0",width:"179px",height:"47px",color:"#fff",fontWeight:"bolder",backgroundColor:T.color},children:[e.jsx("div",{ref:U,style:{maxHeight:"173px",overflowY:"auto"},children:D.sort((d,v)=>d.order-v.order).map((d,v)=>{const{name:x,color:g,editing:A}=d,M=`item-${crypto.randomUUID()}`;return e.jsx(Se,{onClick:P=>{A?P.stopPropagation():(E(l=>[...l.map(b=>{if(b.id)return b.editing=!1,b}).filter(Boolean)]),C(d))},className:A?"p-0":"p-2 show-button-child",children:A?e.jsxs("form",{className:"input-group",onSubmit:P=>L(P,d),children:[e.jsx("label",{htmlFor:M,className:"input-group-text p-0 d-flex align-items-center",style:{cursor:"pointer"},children:e.jsx("input",{ref:H,id:M,className:"mx-1",type:"color",defaultValue:g,style:{padding:0,height:"25px",width:"25px",border:"none",borderRadius:"4px",cursor:"pointer"}})}),e.jsx("input",{ref:w,className:"form-control",type:"text",defaultValue:x}),e.jsx(q,{content:"Guardar",children:e.jsxs("button",{className:"btn input-group-text btn-xs btn-success waves-effect waves-light",type:"submit",children:[e.jsx("i",{className:"fa fa-check","aria-hidden":"true"}),e.jsx("span",{className:"sr-only",children:"Guardar"})]})}),e.jsx(q,{content:"Cancelar",children:e.jsxs("button",{className:"btn input-group-text btn-xs btn-danger waves-effect waves-light",type:"button",onClick:()=>N(),children:[e.jsx("i",{className:"fa fa-times","aria-hidden":"true"}),e.jsx("span",{className:"sr-only",children:"Cancelar"})]})})]}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"position-absolute d-flex gap-1",style:{top:"50%",right:"8px",transform:"translateY(-50%)"},children:[k&&e.jsx(q,{content:"Editar",children:e.jsxs("span",{style:{cursor:"pointer"},className:"btn btn-xs btn-soft-primary ",onClick:P=>K(P,d),type:"button",children:[e.jsx("i",{className:"fa fa-pen","aria-hidden":"true"}),e.jsx("span",{className:"sr-only",children:"Editar"})]})}),R&&e.jsx(q,{content:"Eliminar",children:e.jsxs("span",{style:{cursor:"pointer"},className:"btn btn-xs btn-soft-danger",onClick:P=>Z(P,d),type:"button",children:[e.jsx("i",{className:"fa fa-trash","aria-hidden":"true"}),e.jsx("span",{className:"sr-only",children:"Eliminar"})]})})]}),e.jsx("i",{className:"fa fa-circle me-2",style:{color:g},"aria-hidden":"true"}),e.jsx("span",{children:x})]})},v)})}),m&&e.jsxs(Se,{onClick:J,children:[e.jsx("i",{className:"fa fa-plus me-2","aria-hidden":"true"}),e.jsx("span",{children:"Agregar estado"})]})]})}const js=({gridRef:u,rest:n,can:c,defaultLeadStatus:m,statuses:k,manageStatuses:R,onClientStatusClicked:C,onManageStatusChange:_,onLeadClicked:F,onMessagesClicked:w,onAttendClient:H,onOpenModal:U,onMakeLeadClient:D,onArchiveClicked:E,onDeleteClicked:I,title:S})=>e.jsx(at,{gridRef:u,title:S,rest:n,reloadWith:[k,R],toolBar:j=>{j.unshift(ps({className:"btn btn-xs btn-soft-dark text-nowrap",text:"Actualizar",title:"Refrescar tabla",icon:"fas fa-undo-alt",onClick:()=>$(u.current).dxDataGrid("instance").refresh()})),c("leads","all","create")&&j.unshift(ps({className:"btn btn-xs btn-soft-primary text-nowrap",text:"Nuevo",title:"Agregar registro",icon:"fa fa-plus",onClick:()=>U()}))},exportable:!0,height:"calc(65vh - 90px)",pageSize:25,allowedPageSizes:[10,25,50,100],columns:[{dataField:"contact_name",caption:"Lead",width:250,cellTemplate:(j,{data:f})=>{j.attr("style",`height: 48px; border-left: 4px solid ${f.status.color}`),ee(j,e.jsxs("div",{className:"d-flex align-items-center gap-1",children:[e.jsx(ne,{className:"btn btn-xs btn-white",title:"Ver mensajes",onClick:()=>w(f),children:e.jsx("i",{className:"mdi mdi-whatsapp text-success"})}),e.jsxs("div",{onClick:()=>F(f),style:{cursor:"pointer"},children:[f.status_id==m?e.jsx("b",{className:"d-block",children:f.contact_name}):e.jsx("span",{className:"d-block",children:f.contact_name}),f.products_count>0&&e.jsxs("small",{className:"text-muted",children:[f.products_count," ",f.products_count>1?"productos":"producto"]})]})]}))},fixed:!0,fixedPosition:"left"},{dataField:"assigned.fullname",caption:"Usuario",width:58,cellTemplate:(j,{data:f})=>{j.attr("style","height: 48px"),ee(j,e.jsx("div",{className:"d-flex align-items-center gap-1",children:f.assigned_to?e.jsx(e.Fragment,{children:e.jsx(q,{content:`Atendido por ${f.assigned.name} ${f.assigned.lastname}`,children:e.jsx("img",{className:"avatar-sm rounded-circle",src:`//${B.APP_DOMAIN}/api/profile/thumbnail/${f.assigned.relative_id}`,alt:f.assigned.name})})}):""}))},fixed:!0,fixedPosition:"left"},{dataField:"contact_email",caption:"Correo"},{dataField:"contact_phone",caption:"Telefono"},{dataField:"status.name",caption:"Estado de gestión",dataType:"string",width:180,cellTemplate:(j,{data:f})=>{j.addClass("p-0"),j.attr("style","overflow: visible"),ee(j,e.jsx(bs,{items:k,defaultValue:f.status,base:{table_id:"e05a43e5-b3a6-46ce-8d1f-381a73498f33"},onItemClick:T=>C(f.id,T.id),canCreate:c("statuses","all","create"),canUpdate:c("statuses","all","update"),canDelete:c("statuses","all","delete"),onDropdownClose:(T,z)=>{T&&setStatuses(z)}}))}},{dataField:"manage_status.name",caption:"Estado del lead",dataType:"string",width:180,cellTemplate:(j,{data:f})=>{j.addClass("p-0"),j.attr("style","overflow: visible"),ee(j,e.jsx(bs,{items:R,defaultValue:f.manage_status,base:{table_id:"9c27e649-574a-47eb-82af-851c5d425434"},onItemClick:T=>_(f,T),canCreate:c("statuses","all","create"),canUpdate:c("statuses","all","update"),canDelete:c("statuses","all","delete"),onDropdownClose:(T,z)=>{T&&setManageStatuses(z)}}))}},{dataField:"origin",caption:"Origen",dataType:"string"},{dataField:"triggered_by",caption:"Disparado por",dataType:"string"},{dataField:"created_at",caption:"Fecha creacion",dataType:"date",cellTemplate:(j,{data:f})=>{j.text(moment(f.created_at.replace("Z","+05:00")).format("lll"))},sortOrder:"desc"},{caption:"Acciones",width:240,cellTemplate:(j,{data:f})=>{j.attr("style","display: flex; gap: 4px; height: 47px; overflow: visible"),ee(j,e.jsx(ne,{className:"btn btn-xs btn-soft-warning",title:"Editar lead",onClick:()=>U(f),children:e.jsx("i",{className:"fa fa-pen"})})),ee(j,e.jsx(ne,{className:"btn btn-xs btn-soft-primary",title:"Ver detalles",onClick:()=>F(f),children:e.jsx("i",{className:"fa fa-eye"})})),f.assigned_to?f.assigned_to==le.service_user.id&&ee(j,e.jsx(ne,{className:"btn btn-xs btn-soft-danger",title:"Dejar de atender",onClick:()=>H(f.id,!1),children:e.jsx("i",{className:"fas fa-hands-wash"})})):ee(j,e.jsx(ne,{className:"btn btn-xs btn-soft-dark",title:"Atender lead",onClick:()=>H(f.id,!0),children:e.jsx("i",{className:"fas fa-hands-helping"})})),ee(j,e.jsx(ne,{className:"btn btn-xs btn-soft-success",title:"Convertir en cliente",onClick:async()=>D(f),children:e.jsx("i",{className:"fa fa-user-plus"})})),ee(j,e.jsx(ne,{className:"btn btn-xs btn-soft-dark",title:"Archivar lead",onClick:T=>E(f,T),children:e.jsx("i",{className:"mdi mdi-archive"})})),ee(j,e.jsx(ne,{className:"btn btn-xs btn-soft-danger",title:"Eliminar lead",onClick:()=>I(f),children:e.jsx("i",{className:"fa fa-trash"})}))},allowFiltering:!1,allowExporting:!1}]});class ht extends Ns{constructor(){super(...arguments);me(this,"path","leads/new")}}class ft extends Ws{constructor(){super(...arguments);me(this,"path","messages")}}const pt=u=>{const n=u.split(`
`);let c="",m=!1,k="";const R=C=>(C=C.replace(/\*(.*?)\*/g,"<strong>$1</strong>"),C=C.replace(/_(.*?)_/g,"<em>$1</em>"),C=C.replace(/~(.*?)~/g,"<s>$1</s>"),C=C.replace(/```(.*?)```/g,"<code>$1</code>"),C);for(let C of n){if(C=C.trim(),!C){m&&(c+=`</${k}>
`,m=!1);continue}const _=C.match(/^-\s+(.+)$/);if(_){(!m||k!=="ul")&&(m&&(c+=`</${k}>
`),c+=`<ul>
`,m=!0,k="ul"),c+=`<li>${R(_[1])}</li>
`;continue}const F=C.match(/^\d+\.\s+(.+)$/);if(F){(!m||k!=="ol")&&(m&&(c+=`</${k}>
`),c+=`<ol>
`,m=!0,k="ol"),c+=`<li>${R(F[1])}</li>
`;continue}const w=C.match(/^>\s+(.+)$/);if(w){m&&(c+=`</${k}>
`,m=!1),c+=`<blockquote>${R(w[1])}</blockquote>
`;continue}m&&(c+=`</${k}>
`,m=!1),c+=`<p>${R(C)}</p>
`}return m&&(c+=`</${k}>
`),c.trim()},xt=new ft,ke=new Ys,gt=new vs,bt=({offCanvasRef:u,dataLoaded:n,setDataLoaded:c,defaultMessages:m,signs:k,onOpenModal:R=()=>{},onLeadClicked:C=()=>{}})=>{u||(u=r.useRef());const _=r.useRef(),F=r.useRef(),w=r.useRef(),H=r.useRef(),U=r.useRef(),[D,E]=r.useState([]),[I,S]=r.useState(!1),[j,f]=r.useState(!1),[T,z]=r.useState(500),[J,K]=r.useState(!1),[Z,L]=r.useState(le.service_user.whatsapp_sign);r.useEffect(()=>{n!=null&&n.contact_phone&&d().then(l=>{E(l),N()})},[n]),r.useEffect(()=>{if(!(n!=null&&n.id))return;const l=setInterval(async()=>{j||await N()},T);return()=>clearInterval(l)},[n,j,T]);const N=async()=>{const l=await v();f(!0);const{data:b}=await xt.paginate({isLoadingAll:!0,filter:[["wa_id","contains",n==null?void 0:n.contact_phone],"and",["microtime",">",l.microtime]],sort:[{selector:"microtime",desc:!1}]});if(f(!1),!b||!n.id)return;b.length>0?z(500):z(2500);const y=await d();y.push(...b),E(y.sort((G,ae)=>ae.microtime-G.microtime))},d=async()=>{const b=await(await caches.open("messages")).match(`${le.business_uuid}/${n.id}`);return b?await b.json()??[]:[]},v=async()=>(await d()).sort((b,y)=>y.microtime-b.microtime)[0]??{microtime:0},x=async l=>{l.preventDefault();const b=_.current.value,y=n.id;S(!0);const G=await ke.send(y,b);S(!1),G&&(_.current.value="")};r.useEffect(()=>{if(n!=null&&n.id&&(caches.open("messages").then(l=>{l.put(`${le.business_uuid}/${n.id}`,new Response(JSON.stringify(D)))}),U.current)){const l=U.current,b=$(l).parent()[0],y=b.scrollHeight-b.scrollTop===b.clientHeight,G=b.scrollTop===0;(y||G)&&(b.scrollTop=l.scrollHeight)}},[D]),r.useEffect(()=>{u.current.addEventListener("hidden.bs.offcanvas",()=>{c(null),E([])}),document.addEventListener("click",l=>{var b,y;!((b=F.current)!=null&&b.contains(l.target))&&(w.current!=l.target||!((y=w.current)!=null&&y.contains(l.target)))&&K(!1)})},[null]);const g=async l=>{const b=l.target.value;await gt.setDefaultSign({type:"whatsapp",sign:b})&&L(b)},A=()=>{$(H.current).modal("show")},M=async()=>{const l=k.find(y=>y.id==Z),b=`${B.APP_PROTOCOL}://${B.APP_DOMAIN}/repository/signs/${l.sign}`;S(!0),await ke.send(n==null?void 0:n.id,`/signature:${b}`),S(!1)},P=m.filter(({type:l})=>l==="whatsapp");return e.jsxs(e.Fragment,{children:[e.jsxs("form",{ref:u,className:"offcanvas offcanvas-end",tabIndex:"-1","aria-labelledby":"offcanvasRightLabel",style:{visibility:"hidden",width:"95%",maxWidth:"600px",zIndex:1041},"aria-hidden":"true",onSubmit:x,children:[e.jsxs("div",{className:"offcanvas-header border-bottom gap-2",children:[e.jsxs("div",{className:"d-flex gap-2 align-items-center w-100",onClick:()=>C(n),style:{cursor:"pointer"},children:[e.jsx("img",{className:"avatar-sm rounded-circle border",src:`${B.WA_URL}/api/profile/${le.business_uuid}/${n==null?void 0:n.contact_phone}`,onError:l=>{l.target.onerror=null,l.target.src=`//${B.APP_DOMAIN}/api/profile/thumbnail/undefined`},alt:n==null?void 0:n.contact_name}),e.jsxs("div",{children:[e.jsx("h5",{className:"my-0",children:n==null?void 0:n.contact_name}),e.jsxs("small",{className:"text-muted",children:["+",n==null?void 0:n.contact_phone]})]})]}),e.jsxs("div",{className:"d-flex gap-1 align-items-center",children:[e.jsxs("div",{className:"dropdown",children:[e.jsx("i",{className:"mdi  mdi-18px mdi-dots-vertical dropdown-toggle",type:"button",id:"offcanvas-options","data-bs-toggle":"dropdown","aria-haspopup":"true","aria-expanded":"false"}),e.jsxs("div",{className:"dropdown-menu","aria-labelledby":"offcanvas-options",children:[e.jsxs("span",{className:"dropdown-item",style:{cursor:"pointer"},onClick:()=>R(n),children:[e.jsx("i",{className:"mdi mdi-eye me-1",style:{width:"20px"}}),"Editar datos del lead"]}),e.jsxs("span",{className:"dropdown-item",style:{cursor:"pointer"},onClick:A,children:[e.jsx("i",{className:"fa fa-signature me-1",style:{width:"20px"}}),"Ver firmas disponibles"]}),e.jsxs("span",{className:"dropdown-item",style:{cursor:"pointer"},"data-bs-dismiss":"offcanvas",children:[e.jsx("i",{className:"mdi mdi-close me-1",style:{width:"20px"}}),"Cerrar chat"]})]})]}),e.jsx("i",{className:"mdi  mdi-18px mdi-close","data-bs-dismiss":"offcanvas",style:{cursor:"pointer"}})]})]}),e.jsx("div",{className:"offcanvas-body",children:e.jsx("ul",{ref:U,className:"conversation-list slimscroll w-100 align-items-bottom","data-simplebar":!0,children:D.sort((l,b)=>l.microtime-b.microtime).map((l,b)=>{const y=l.message.replace(/\{\{.*?\}\}/gs,""),G=l.role!=="Human";let ae="";return y.startsWith("/attachment:")&&(ae=y.split(`
`)[0]),e.jsx("li",{className:l.role=="Human"?"":"odd",children:e.jsxs("div",{className:"message-list",children:[e.jsx("div",{className:"chat-avatar",children:e.jsx("img",{className:"border",style:{aspectRatio:1},src:G?`//${B.APP_DOMAIN}/api/profile/thumbnail/${le.relative_id}`:`${B.WA_URL}/api/profile/${le.business_uuid}/${l.wa_id}`,onError:W=>{W.target.onerror=null,W.target.src=`//${B.APP_DOMAIN}/api/profile/thumbnail/undefined`},alt:n==null?void 0:n.contact_name})}),e.jsxs("div",{className:"conversation-text",children:[e.jsx("div",{className:"ctext-wrap",children:y.startsWith("/signature:")?e.jsx("img",{src:y.replace("/signature:",""),alt:`${le.service_user.fullname} signature`,style:{minWidth:"300px",maxWidth:"100%",minHeight:"200px",maxHeight:"300px",borderRadius:"4px",objectFit:"cover"},onError:W=>{W.target.onerror=null,W.target.src="//placehold.co/500x200?text=404"}}):e.jsxs(e.Fragment,{children:[ae&&e.jsxs(e.Fragment,{children:[e.jsx("img",{src:ae.replace("/attachment:",""),className:"mb-1",alt:"attachment",style:{minWidth:"300px",width:"100%",maxWidth:"100%",minHeight:"200px",maxHeight:"300px",borderRadius:"4px",objectFit:"cover"},onError:W=>{$(W.target).remove()}}),e.jsx("div",{className:"d-flex justify-content-end",children:e.jsxs("a",{className:"btn btn-xs btn-white mb-1 text-nowrap d-flex text-end",href:ae.replace("/attachment:",""),target:"_blank",download:!0,children:[e.jsx("i",{className:"mdi mdi-download me-1"}),e.jsx("span",{children:"Descargar adjunto"})]})})]}),e.jsx(Ge,{className:"text-start",html:pt(y.replace(ae,""))})]})}),e.jsx("span",{className:"time",children:moment(l.created_at).format("YYYY-MM-DD HH:mm:ss")})]})]})},b)})})}),e.jsxs("div",{className:"offcanvas-footer",children:[e.jsx("div",{ref:F,className:"p-2",onClick:l=>l.stopPropagation(),hidden:!J,style:{transition:"all .125s"},children:e.jsx("div",{className:"d-flex gap-2",children:P.map((l,b)=>e.jsx("span",{className:"badge bg-light text-dark",style:{cursor:"pointer"},onClick:async()=>{if(K(!1),S(!0),l.attachments.length>0){const y=l.attachments[0],G=`${B.APP_URL}/cloud/${y.file}`;await ke.send(n==null?void 0:n.id,`/attachment:${G}
${l.description}`),S(!1);return}await ke.send(n==null?void 0:n.id,l.description),S(!1)},title:l.description,children:l.name},b))})}),e.jsxs("div",{className:"d-flex gap-2 p-2 align-items-end",children:[e.jsx("textarea",{ref:_,className:"form-control w-100",placeholder:"Ingrese su mensaje aqui",rows:1,style:{minHeight:27,fieldSizing:"content"},disabled:I,required:!0}),e.jsxs("div",{className:"d-flex gap-1",children:[e.jsxs("div",{className:"dropdown",children:[e.jsx("button",{className:"btn btn-white dropdown-toggle px-1",type:"button",id:"message-options","data-bs-toggle":"dropdown","aria-haspopup":"true","aria-expanded":"false",children:e.jsx("i",{className:"mdi mdi-plus"})}),e.jsxs("div",{className:"dropdown-menu","aria-labelledby":"message-options",children:[Z?e.jsxs("span",{className:"dropdown-item",style:{cursor:"pointer"},onClick:M,children:[e.jsx("i",{className:"fa fa-signature me-1",style:{width:"20px"}}),"Enviar firma"]}):e.jsx(q,{content:"Selecciona una firma por defecto",children:e.jsxs("span",{className:"dropdown-item",style:{cursor:"pointer"},onClick:A,children:[e.jsx("i",{className:"fa fa-signature me-1",style:{width:"20px"}}),"Enviar firma"]})}),(P==null?void 0:P.length)>0&&e.jsxs("span",{ref:w,className:"dropdown-item",style:{cursor:"pointer"},onClick:()=>K(!0),children:[e.jsx("i",{className:"mdi mdi-message-bulleted me-1",style:{width:"20px"}}),"Mensajes predeterminados"]})]})]}),e.jsx("button",{className:"btn btn-dark waves-effect waves-light",type:"submit",disabled:I,children:I?e.jsx("i",{className:"mdi mdi-spinner mdi-loading"}):e.jsx("i",{className:"mdi mdi-arrow-top-right"})})]})]})]})]}),e.jsxs(pe,{modalRef:H,title:"Tus firmas",hideFooter:!0,children:[e.jsx("b",{className:"d-block",children:"¿Desea seleccionar una de sus firmas disponibles como predeterminado?"}),e.jsx("div",{className:"row mt-2",children:k.map((l,b)=>e.jsx("div",{className:"col-md-6",children:e.jsx(q,{content:"Marcar como predeterminado",children:e.jsxs("label",{className:"card border",style:{cursor:"pointer"},children:[e.jsxs("div",{className:"card-header d-flex gap-1 align-items-center py-1 px-2",children:[e.jsx("input",{type:"radio",name:"sign",className:"form-check-input my-0",id:`sign-${l.id}`,checked:l.id==Z,onChange:g,value:l.id}),e.jsx("b",{className:"d-block my-0 w-100 text-truncate",children:l.name||"Sin nombre"})]}),e.jsx("div",{className:"card-body p-0",children:e.jsx("img",{src:`${B.APP_PROTOCOL}://${B.APP_DOMAIN}/repository/signs/${l.sign}`,alt:l.name,className:"img-fluid w-100",style:{objectFit:"cover",aspectRatio:5/2}})})]})})},b))})]})]})},se=new Ns,jt=new ht,Nt=new Qs,Be=new Js,vt=new et,wt=new vs,Re=new Zs,Ue=new Cs,yt=({statuses:u,defaultClientStatus:n,defaultLeadStatus:c,manageStatuses:m,noteTypes:k,products:R=[],processes:C=[],defaultMessages:_=[],session:F,can:w,lead:H,signs:U})=>{var ss,ts,ns,as,is,rs,cs,ls,os,ds,ms;const D=r.useRef(),E=r.useRef(),I=r.useRef(),S=r.useRef(),j=r.useRef(),f=r.useRef(),T=r.useRef(),z=r.useRef(),J=r.useRef(),K=r.useRef(),Z=r.useRef(),L=r.useRef(),N=r.useRef(),d=r.useRef(),v=r.useRef(),x=r.useRef(),g=r.useRef(),A=r.useRef(),M=r.useRef(),P=r.useRef(),l=r.useRef(),b=r.useRef(),y=r.useRef(),[G,ae]=r.useState(F),[W,Ct]=r.useState(u),[Ne,$t]=r.useState(m),[He,qe]=r.useState([]),[t,ie]=r.useState(null),[ze,De]=r.useState(null),[te,ue]=r.useState([]),[Q,$s]=r.useState(O.Local.get("default-view")??"kanban"),[Pe,ve]=r.useState([]),[Te,ks]=r.useState(!1),[Rs,We]=r.useState(crypto.randomUUID()),[_s,Ss]=r.useState(null),[Ae,Ye]=r.useState([]),[Ve,Xe]=r.useState(!1),[Ds,Ke]=r.useState(null),[p,Ps]=r.useState(null),we={},xe={};k.forEach(s=>{we[s.id]=r.useRef(),xe[s.id]=r.useRef()}),r.useEffect(()=>{if($(D.current).on("hidden.bs.modal",()=>{ie(null),history.pushState(null,null,"/leads")}),!H)return;se.get(H).then(h=>{h&&(ie(h),ue([]),ve([]),$(D.current).modal("show"),O.GET.annotation&&$(`[data-name="${O.GET.annotation}"]`).click())});const s=d.current,a=new bootstrap.Dropdown(s);s.addEventListener("focus",function(){a.show()}),s.addEventListener("blur",function(){setTimeout(()=>{a.hide()},200)})},[null]),r.useEffect(()=>{Ue.check().then(s=>{if(s.authorized)return ks(!0);Ss(s.auth_url)})},[Rs]),r.useEffect(()=>{Te&&(t!=null&&t.contact_email)&&(Xe(!0),Ye([]),Ue.list(t.contact_email).then(s=>{Ye(s??[]),Xe(!1)}))},[Te,t]),r.useEffect(()=>{const s=W.map(a=>`#status-${xs(a.name)}`).join(", ");$(s).sortable({connectWith:".taskList",placeholder:"task-placeholder",forcePlaceholderSize:!0,receive:async function({target:a},{item:h}){const o=a,i=h.get(0);!$(o).sortable("toArray").includes(i.id)||await se.leadStatus({status:o.getAttribute("data-id"),lead:i.id})},update:function(a,h){h.item.parent()[0]}}).disableSelection(),k.forEach(a=>{new Ks(`#editor-${a.id}`,{theme:"bubble",modules:{toolbar:[[{font:[]},{size:[]}],["bold","italic","underline","strike"],[{color:[]},{background:[]}],[{script:"super"},{script:"sub"}],[{header:[!1,1,2,3,4,5,6]},"blockquote","code-block"],[{list:"ordered"},{list:"bullet"},{indent:"-1"},{indent:"+1"}],["direction",{align:[]}],["link","image","video"],["clean"]],mention:{allowedChars:/^[A-Za-z\sÅÄÖåäö]*$/,mentionDenotationChars:["@","#"],source:async function(h,o,...i){const{data:Y}=await wt.paginate({filter:["fullname","contains",h]});o(Y.map(({relative_id:X,fullname:V})=>({id:X,value:V})))}}}}),$(`#editor-${a.id}`).find(".ql-editor").empty()}),qe([]),Q=="kanban"&&oe()},[Q]),r.useEffect(()=>{var s,a;Qe(),Ts(),$(v.current).val((s=t==null?void 0:t.status)==null?void 0:s.id).trigger("change"),$(x.current).val((a=t==null?void 0:t.manage_status)==null?void 0:a.id).trigger("change")},[t]);const oe=async()=>{const s=await se.all();qe(s)},Qe=async()=>{const s=await Be.byClient(t==null?void 0:t.id);ue(s??[])},Ts=async()=>{const s=await Re.byClient(t==null?void 0:t.id);ve(s)},ge=async s=>{ie(s),history.pushState(null,null,`/leads/${s.id}`),ue([]),$(D.current).modal("show")},As=async s=>{const a=s.target.value,h=we[a].current,o=$(h).find(".ql-editor"),i=o.text().trim(),Y=o.html();if(!i.trim())return ce.fire({title:"Ooops!",text:"Ingresa un valor valido",timer:2e3});let X="",V=!1;switch(a){case"ed37659f-f9dc-49c1-9d0e-6a2effe9bd54":X=`${G.service_user.fullname} → ${t.contact_name}`;break;case"e20c7891-1ef8-4388-8150-4c1028cc4525":if(V=!0,X="Nueva tarea",!L.current.value||!N.current.value)return ce.fire({title:"Oops",text:"Ingresa la fecha de finalizacion de la tarea",timer:2e3});break;default:X=`Nota de ${G.service_user.fullname}`;break}const je=[...new Set([...$(o).find(".mention")].map(he=>he.getAttribute("data-id")))],de=await Be.save({id:xe[a].current.value||void 0,note_type_id:a,process:d.current.value,status_id:$(v.current).is(":visible")?v.current.value:void 0,manage_status_id:$(x.current).is(":visible")?x.current.value:void 0,name:X,description:V?void 0:Y,raw:V?void 0:i,client_id:t.id,tasks:V?[{name:z.current.value,type:J.current.value,priority:K.current.value,description:i?Y:void 0,ends_at:`${L.current.value} ${N.current.value}`,assigned_to:Z.current.value,mentions:je}]:[],mentions:V?[]:je});if(!de)return;o.empty(),xe[a].current.value=null,z.current.value="",d.current.value="",$(J.current).val("Por hacer").trigger("change"),$(K.current).val("Media").trigger("change"),$(Z.current).val("").trigger("change"),L.current.value="",N.current.value="";const $e=structuredClone(te),us=$e.findIndex(he=>he.id==de.id);us==-1?$e.push(de):$e[us]=de,ue($e),se.get(t.id).then(he=>{he&&ie(he)}),Q=="kanban"?oe():($(I.current).dxDataGrid("instance").refresh(),$(S.current).dxDataGrid("instance").refresh())},Es=async s=>{const{isConfirmed:a}=await ce.fire({title:"Estas seguro?",text:"No podras revertir esta accion!",icon:"warning",showCancelButton:!0,confirmButtonText:"Continuar",cancelButtonText:"Cancelar"});if(!a)return;await Be.delete(s);const h=structuredClone(te).filter(({id:o})=>o!=s);ue(h)},Ms=async s=>{var h,o;const a=we[s.type.id].current;if(D.current.scrollTo({top:0,behavior:"smooth"}),a.classList.add("highlight"),setTimeout(()=>{a.classList.remove("highlight")},2e3),xe[s.type.id].current.value=s.id||null,$(a).find(".ql-editor").html(s.description),s.type.id=="e20c7891-1ef8-4388-8150-4c1028cc4525"){const i=s.tasks[0]??{};z.current.value=i==null?void 0:i.name,$(J.current).val(i==null?void 0:i.type).trigger("change"),$(K.current).val(i==null?void 0:i.priority).trigger("change"),tt(Z.current,(h=i==null?void 0:i.assigned)==null?void 0:h.id,(o=i==null?void 0:i.assigned)==null?void 0:o.fullname),$(a).find(".ql-editor").html(i==null?void 0:i.description),L.current.value=moment(i==null?void 0:i.ends_at).format("YYYY-MM-DD"),N.current.value=moment(i==null?void 0:i.ends_at).format("HH:mm")}},Je=s=>{O.Local.set("default-view",s),$s(s)},ye=async(s,a)=>{if(await se.leadStatus({lead:s,status:a}),t){const h=structuredClone(t);h.status=W.find(o=>o.id==a),ie(h),history.pushState(null,null,`/leads/${h.id}`)}Q=="kanban"?oe():($(I.current).dxDataGrid("instance").refresh(),$(S.current).dxDataGrid("instance").refresh())},Ce=async(s,a)=>{await se.attend(s,a),Q=="kanban"?oe():($(I.current).dxDataGrid("instance").refresh(),$(S.current).dxDataGrid("instance").refresh())},Ze=async(s,a)=>{var o;const h=await vt.status({id:s,status:a});h&&((o=h==null?void 0:h.data)!=null&&o.refresh&&(Q=="kanban"?oe():($(I.current).dxDataGrid("instance").refresh(),$(S.current).dxDataGrid("instance").refresh())),Qe())},Ee=async(s,a)=>{await se.manageStatus({lead:s.id,status:a.id});const h=structuredClone(s);h.manage_status=a,ie(h),history.pushState(null,null,`/leads/${h.id}`),Q=="kanban"?oe():($(I.current).dxDataGrid("instance").refresh(),$(S.current).dxDataGrid("instance").refresh())},Me=async(s,a=null)=>{const h=a?a.target:$(`[id="${s.id}"]`).get(0),o=document.getElementById("archived-item");rt(h,o);const{isConfirmed:i}=await ce.fire({title:"Este lead sera archivado",text:"Podras verlo en el menu de archivados",icon:"warning",showCancelButton:!0,confirmButtonText:"Continuar",cancelButtonText:"Cancelar"});!i||!await Nt.delete(s.id)||(Q=="kanban"?$(`[id="${s.id}"]`).remove():($(I.current).dxDataGrid("instance").refresh(),$(S.current).dxDataGrid("instance").refresh()),ct(o))},Fe=async s=>{const{isConfirmed:a}=await ce.fire({title:"Estas seguro de eliminar este lead?",text:"No podras revertir esta accion!",icon:"warning",showCancelButton:!0,confirmButtonText:"Continuar",cancelButtonText:"Cancelar"});a&&(await se.delete(s.id),Q=="kanban"?$(`[id="${s.id}"]`).remove():($(I.current).dxDataGrid("instance").refresh(),$(S.current).dxDataGrid("instance").refresh()))},Fs=async s=>{s.preventDefault();const a={id:g.current.value,contact_name:A.current.value||"Lead anonimo",contact_email:M.current.value,contact_phone:P.current.value.keep("0-9"),name:l.current.value||"Lead anonimo",web_url:b.current.value,message:y.current.value||"Sin mensaje",client_width:window.screen.width,client_height:window.screen.height,client_system:navigator.platform??"Linux"};if(!a.id&&!await Le(!0))return;const h=await se.save(a);h&&(t&&ie(h),ze&&De(h),$(E.current).modal("hide"),Q=="kanban"?oe():($(I.current).dxDataGrid("instance").refresh(),$(S.current).dxDataGrid("instance").refresh()))},be=(s={})=>{g.current.value=(s==null?void 0:s.id)??"",A.current.value=(s==null?void 0:s.contact_name)??"",M.current.value=(s==null?void 0:s.contact_email)??"",P.current.value=(s==null?void 0:s.contact_phone)??"",l.current.value=(s==null?void 0:s.name)??"",b.current.value=(s==null?void 0:s.web_url)??"",y.current.value=(s==null?void 0:s.message)??"",$(E.current).modal("show")},Le=async(s=!1)=>{const a=P.current.value.keep("0-9");P.current.disabled=!0;const h=await se.paginate({filter:["contact_phone","=",a],requireTotalCount:!0,take:1,sort:[{selector:"created_at",desc:!0}]});if(P.current.disabled=!1,(h==null?void 0:h.totalCount)>0){const o=h.data[0],{isConfirmed:i}=await ce.fire({title:"Lead registrado!",text:o.creator?`${o.creator.fullname} ha registrado este lead anteriormente con el nombre de ${o.contact_name}`:`Este numero de telefono ha sido registrado anteriormente con el nombre de ${o.contact_name}`,icon:"warning",confirmButtonText:s?"Continuar de todos modos":"Ok",cancelButtonText:"Cancelar",showCancelButton:s});return i}return!0},Ie=async s=>{const{isConfirmed:a}=await ce.fire({title:"Estas seguro?",text:`${s.contact_name} pasara a ser un cliente!`,icon:"warning",showCancelButton:!0,confirmButtonText:"Continuar",cancelButtonText:"Cancelar"});a&&ye(s.id,n)},Is=async s=>{const a=await Re.save({client_id:t.id,product_id:s.id,price:s.price});a&&ve(h=>[...h,{...s,pivot_id:a.pivot_id,pivot_price:a.price}])},Os=async s=>{await Re.delete(s.pivot_id)&&ve(h=>h.filter(o=>o.id!=s.id))},Bs=async s=>{await Re.save({id:s.pivot_id,price:s.price})},Us=[];te==null||te.forEach(s=>Us.push(...s.tasks));const Oe=[];te==null||te.forEach(s=>Oe.push(...s.tasks.filter(a=>a.status!="Realizado")));const es=s=>{De(s),$(T.current).offcanvas("show")};return e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"d-flex mb-2 gap-1",children:[e.jsx("input",{id:"view-as-table",type:"radio",name:"view-as",defaultChecked:Q=="table",onClick:()=>Je("table")}),e.jsx("label",{htmlFor:"view-as-table",children:"Tabla"}),e.jsx("input",{id:"view-as-kanban",type:"radio",name:"view-as",defaultChecked:Q=="kanban",onClick:()=>Je("kanban")}),e.jsx("label",{htmlFor:"view-as-kanban",children:"Pipelines"})]}),Q=="table"?e.jsxs(e.Fragment,{children:[e.jsx(js,{gridRef:S,rest:se,can:w,defaultLeadStatus:c,manageStatuses:Ne,statuses:W,onClientStatusClicked:ye,onManageStatusChange:Ee,onLeadClicked:ge,onMessagesClicked:es,onAttendClient:Ce,onOpenModal:be,onMakeLeadClient:Ie,onArchiveClicked:Me,onDeleteClicked:Fe,title:e.jsx("h4",{className:"header-title my-0",children:"Leads - En Gestion"})}),e.jsx(js,{gridRef:I,rest:jt,can:w,defaultLeadStatus:c,manageStatuses:Ne,statuses:W,onClientStatusClicked:ye,onManageStatusChange:Ee,onLeadClicked:ge,onMessagesClicked:es,onAttendClient:Ce,onOpenModal:be,onMakeLeadClient:Ie,onArchiveClicked:Me,onDeleteClicked:Fe,title:e.jsx("h4",{className:"header-title my-0",children:"Leads - Recien llegados"})})]}):e.jsx("div",{className:"d-flex gap-1 mb-3",style:{overflowX:"auto",minHeight:"calc(100vh - 135px)"},children:W.sort((s,a)=>s.order-a.order).map((s,a)=>{const h=xs(s.name),o=He.filter(i=>i.status_id==s.id).length;return e.jsx("div",{style:{minWidth:"270px",maxWidth:"270px"},children:e.jsxs("div",{className:"card mb-0",children:[e.jsx("div",{className:"card-header",children:e.jsx("h4",{className:"header-title my-0",style:{color:s.color},children:s.name})}),e.jsxs("div",{className:"card-body taskboard-box p-2",style:{minHeight:"200px",maxHeight:"calc(100vh - 190px)",overflow:"auto"},children:[o>50&&e.jsxs("small",{class:"d-block alert alert-warning py-1 px-2",role:"alert",children:[e.jsx("i",{class:"mdi mdi-alert-outline me-2"}),e.jsxs("span",{children:["Tienes ",o," leads en este estado, recuerda que tambien puedes archivar leads."]})]}),e.jsx("ul",{className:"sortable-list list-unstyled taskList",id:`status-${h}`,"data-id":s.id,children:He.filter(i=>i.status_id==s.id).sort((i,Y)=>i.created_at>Y.created_at?-1:1).sort((i,Y)=>i.assigned_to==G.service_user.id?-1:1).map((i,Y)=>{var X,V,je,de;return e.jsx("li",{id:`${i.id}`,style:{cursor:"move"},className:`p-2 ${i.assigned_to==G.service_user.id?"border border-primary":""}`,children:e.jsx("div",{className:"kanban-box",children:e.jsxs("div",{className:"kanban-detail ms-0",children:[e.jsxs("div",{className:"dropdown float-end",children:[e.jsx("a",{href:"#",className:"dropdown-toggle arrow-none card-drop","data-bs-toggle":"dropdown","aria-expanded":"false",children:e.jsx("i",{className:"mdi mdi-dots-vertical"})}),e.jsxs("div",{className:"dropdown-menu dropdown-menu-end",children:[e.jsxs("a",{className:"dropdown-item",style:{cursor:"pointer"},onClick:()=>ge(i),children:[e.jsx("i",{className:"fa fa-eye me-1"}),"Ver detalles"]}),e.jsxs("a",{className:"dropdown-item",style:{cursor:"pointer"},onClick:()=>be(i),children:[e.jsx("i",{className:"fa fa-pen me-1"}),"Editar lead"]}),e.jsxs("a",{className:"dropdown-item",style:{cursor:"pointer"},onClick:()=>Ie(i),children:[e.jsx("i",{className:"fa fa-user-plus me-1"}),"Convertir en cliente"]}),e.jsxs("a",{className:"dropdown-item",style:{cursor:"pointer"},onClick:()=>Me(i),children:[e.jsx("i",{className:"mdi mdi-archive me-1"}),"Archivar lead"]}),e.jsxs("a",{className:"dropdown-item",style:{cursor:"pointer"},onClick:()=>Fe(i),children:[e.jsx("i",{className:"fa fa-trash me-1"}),"Eliminar lead"]})]})]}),e.jsx("h5",{className:"mt-0 text-truncate",children:e.jsx(q,{content:"Ver detalles",children:e.jsx("a",{href:"#",onClick:()=>ge(i),className:"text-dark",children:i.contact_name})})}),e.jsxs("ul",{className:"list-inline d-flex align-items-center gap-1 mb-0",children:[e.jsx("li",{className:"list-inline-item",children:i.assigned_to?i.assigned_to==G.service_user.id?e.jsx(ne,{className:"btn btn-xs btn-soft-danger",title:"Dejar de atender",onClick:()=>Ce(i.id,!1),children:e.jsx("i",{className:"fas fa-hands-wash"})}):e.jsx(q,{content:`Atendido por ${(X=i==null?void 0:i.assigned)==null?void 0:X.fullname}`,children:e.jsx("a",{href:"","data-bs-toggle":"tooltip","data-bs-placement":"top",title:"Username",children:e.jsx("img",{src:`//${B.APP_DOMAIN}/api/profile/${(V=i==null?void 0:i.assigned)==null?void 0:V.relative_id}`,alt:"img",className:"avatar-xs rounded-circle"})})}):e.jsx(ne,{className:"btn btn-xs btn-soft-dark rounded-pill",title:"Atender lead",onClick:()=>Ce(i.id,!0),children:e.jsx("i",{className:"fas fa-hands-helping"})})}),e.jsxs("li",{className:"list-inline-item",children:[e.jsx("span",{className:"badge d-block",style:{backgroundColor:((je=i==null?void 0:i.manage_status)==null?void 0:je.color)||"#6c757d",width:"max-content"},children:((de=i==null?void 0:i.manage_status)==null?void 0:de.name)??"Sin estado"}),e.jsx("small",{className:"text-muted",children:moment(i.created_at).format("LLL")})]})]})]})})},`lead-${Y}`)})})]})]})},`status-${a}`)})}),e.jsx(pe,{modalRef:D,title:"Detalles del lead",btnSubmitText:"Guardar",size:"full-width",bodyClass:"p-3 bg-light",isStatic:!0,onSubmit:s=>s.preventDefault(),zIndex:1042,children:e.jsxs("div",{className:"row",children:[e.jsxs("div",{className:"col-lg-3 col-md-4 col-sm-6 col-xs-12",children:[e.jsx("div",{className:"d-flex mb-3",children:e.jsxs("div",{className:"flex-grow-1",children:[e.jsxs("h4",{className:"media-heading mt-0",children:[e.jsx(q,{content:"Modificar datos",children:e.jsx("i",{className:"mdi mdi-lead-pencil me-1",style:{cursor:"pointer"},onClick:()=>be(t)})}),t==null?void 0:t.contact_name]}),e.jsx("span",{className:"badge bg-primary me-1",children:(t==null?void 0:t.contact_position)||"Trabajador"})," ",e.jsxs("small",{className:"text-muted",children:["desde ",e.jsx("b",{children:t==null?void 0:t.origin})]})]})}),e.jsx("hr",{}),e.jsx("h4",{children:"Estados"}),e.jsxs("div",{className:"d-flex flex-wrap gap-2 justify-content-between mb-2",children:[e.jsxs("div",{children:[e.jsx("b",{className:"d-block",children:"Estado de gestión"}),e.jsxs("div",{className:"btn-group mb-0",style:{width:"100%"},children:[e.jsxs("button",{className:"btn btn-light btn-sm dropdown-toggle",type:"button","data-bs-toggle":"dropdown","aria-haspopup":"true","aria-expanded":"false",style:{color:"#ffffff",backgroundColor:((ss=t==null?void 0:t.status)==null?void 0:ss.color)||"#6c757d"},children:[((ts=t==null?void 0:t.status)==null?void 0:ts.name)||"Sin estado"," ",e.jsx("i",{className:"mdi mdi-chevron-down"})]}),e.jsx("div",{className:"dropdown-menu",children:W.map((s,a)=>e.jsx("span",{className:"dropdown-item",style:{cursor:"pointer"},onClick:()=>ye(t.id,s.id),children:s.name},`status-${a}`))})]})]}),e.jsxs("div",{children:[e.jsx("b",{className:"d-block",children:"Estado del lead"}),e.jsxs("div",{className:"btn-group mb-0",style:{width:"100%"},children:[e.jsxs("button",{className:"btn btn-light btn-sm dropdown-toggle",type:"button","data-bs-toggle":"dropdown","aria-haspopup":"true","aria-expanded":"false",style:{color:"#ffffff",backgroundColor:((ns=t==null?void 0:t.manage_status)==null?void 0:ns.color)||"#6c757d"},children:[((as=t==null?void 0:t.manage_status)==null?void 0:as.name)||"Sin estado"," ",e.jsx("i",{className:"mdi mdi-chevron-down"})]}),e.jsx("div",{className:"dropdown-menu",children:Ne.map((s,a)=>e.jsx("span",{className:"dropdown-item",style:{cursor:"pointer"},onClick:()=>Ee(t,s),children:s.name},`status-${a}`))})]})]})]}),(t==null?void 0:t.assigned_to)&&e.jsxs(e.Fragment,{children:[e.jsx("b",{className:"d-block mb-1",children:"Atendido por:"}),e.jsxs("div",{className:"d-flex align-items-start",children:[e.jsx("img",{className:"d-flex me-2 rounded-circle",src:`//${B.APP_DOMAIN}/api/profile/thumbnail/${(is=t==null?void 0:t.assigned)==null?void 0:is.relative_id}`,alt:(rs=t==null?void 0:t.assigned)==null?void 0:rs.name,height:"32"}),e.jsxs("div",{className:"w-100",children:[e.jsx("h5",{className:"m-0 font-14",children:(cs=t==null?void 0:t.assigned)==null?void 0:cs.name}),e.jsx("span",{className:"font-12 mb-0",children:(ls=t==null?void 0:t.assigned)==null?void 0:ls.email})]})]})]}),e.jsx("hr",{}),e.jsx("h4",{children:"Datos del contacto"}),e.jsx("h5",{className:"font-600 mb-0",children:"Correo electronico"}),e.jsxs("p",{className:"mb-2 text-truncate",children:[" ",t==null?void 0:t.contact_email," "]}),e.jsx("h5",{className:"font-600 mb-0",children:"Tefono / Celular"}),e.jsxs("p",{className:"mb-2",children:[" ",t==null?void 0:t.contact_phone," "]}),e.jsx("h5",{className:"font-600 mb-0",children:"Mensaje"}),e.jsxs("p",{className:"mb-2",children:[" ",t==null?void 0:t.message," "]}),e.jsx("h5",{className:"font-600 mb-0",children:"Fecha de registro"}),e.jsxs("p",{className:"mb-2",children:[moment(t==null?void 0:t.created_at).format("LL"),e.jsx("br",{}),e.jsx("small",{className:"text-muted",children:moment(t==null?void 0:t.created_at).format("LTS")})]}),e.jsx("hr",{}),e.jsx("h4",{children:"Datos de la empresa"}),e.jsx("h5",{className:"font-600 mb-0",children:"Nombre comercial"}),e.jsxs("p",{className:"mb-2",children:[" ",(t==null?void 0:t.tradename)??e.jsx("i",{className:"text-muted",children:"No especifica"})," "]}),e.jsx("h5",{className:"font-600 mb-0",children:"RUC"}),e.jsxs("p",{className:"mb-2",children:[" ",(t==null?void 0:t.ruc)??e.jsx("i",{className:"text-muted",children:"No especifica"})," "]}),e.jsx("h5",{className:"font-600 mb-0",children:"N° trabajadores"}),e.jsxs("p",{className:"mb-2",children:[" ",(t==null?void 0:t.workers)??e.jsx("i",{className:"text-muted",children:"No especifica"})," "]})]}),e.jsx("div",{className:"col-lg-6 col-md-4 col-sm-6 col-xs-12",children:e.jsxs("div",{className:"card card-body",children:[e.jsxs("ul",{className:"nav nav-tabs",style:{flexWrap:"nowrap",overflowX:"auto"},children:[e.jsx("li",{className:"nav-item",children:e.jsxs("a",{href:"#note-type-activity","data-bs-toggle":"tab","aria-expanded":"false",className:"nav-link active text-center",children:[e.jsx("i",{className:"mdi mdi-clock"})," Actividad"]})},"note-type-activity"),k.sort((s,a)=>s.order-a.order).map((s,a)=>{if(!(!(t!=null&&t.contact_email)&&s.name=="Correos"))return e.jsx("li",{className:"nav-item",children:e.jsxs("a",{href:`#note-type-${s.id}`,"data-name":s.name,"data-bs-toggle":"tab","aria-expanded":"false",className:"nav-link text-center",children:[e.jsx("i",{className:s.icon})," ",s.name]})},`note-type-${a}`)})]}),e.jsxs("div",{className:"tab-content",children:[e.jsx("div",{className:"tab-pane active",id:"note-type-activity",children:te.sort((s,a)=>a.created_at>s.created_at?1:-1).map((s,a)=>e.jsx(hs,{...s,onTaskChange:Ze,showOptions:!1,session:G},`note-${a}`))},"tab-note-type-activity"),k.sort((s,a)=>s.order-a.order).map((s,a)=>{const h=s.id=="37b1e8e2-04c4-4246-a8c9-838baa7f8187"&&!Te;return e.jsxs("div",{className:"tab-pane",id:`note-type-${s.id}`,children:[!h&&e.jsxs("h4",{className:"header-title mb-2 d-flex justify-content-between align-items-center",children:[e.jsxs("span",{children:["Lista de ",s.name]}),s.id=="37b1e8e2-04c4-4246-a8c9-838baa7f8187"&&e.jsxs("div",{className:"d-flex gap-1",children:[e.jsx(q,{content:"Refrescar correos",children:e.jsx("button",{className:"btn btn-xs btn-white",type:"button",disabled:Ve,onClick:()=>ie(o=>({...o,refresh:crypto.randomUUID()})),children:Ve?e.jsx("i",{className:"fa fa-spinner fa-spin"}):e.jsx("i",{className:"fas fa-redo"})})}),e.jsxs("button",{className:"btn btn-xs btn-success",type:"button",onClick:()=>{Ke(null),$(j.current).modal("show")},children:[e.jsx("i",{className:"mdi mdi-pen me-1"}),"Redactar"]})]})]}),e.jsx("input",{ref:xe[s.id],type:"hidden"}),e.jsxs("div",{className:"row",children:[h&&e.jsxs("div",{className:"col-12 text-center",children:[e.jsx("h1",{children:"¡Ups!"}),e.jsxs("p",{children:["Necesitamos tu permiso para acceder a tu correo electrónico. ",e.jsx("br",{}),e.jsx("small",{className:"text-muted",children:"No te preocupes, tus datos están seguros con nosotros."})]}),e.jsxs("div",{className:"d-flex flex-column justify-content-center align-items-center gap-1",children:[e.jsx("button",{className:"btn btn-sm btn-primary",type:"button",onClick:()=>We(crypto.randomUUID()),children:"Ya he iniciado sesión"}),e.jsxs("button",{className:"btn btn-sm btn-white d-inline-flex align-items-center gap-1",type:"button",onClick:o=>{const i=window.open(_s,"_blank"),Y=O.Local.get("tokenUUID"),X=setInterval(()=>{const V=O.Local.get("tokenUUID");Y!=V&&(clearInterval(X),i.close(),We())},[500])},children:[e.jsx("img",{src:ot,alt:"",style:{width:"14px",height:"14px",objectFit:"contain",objectPosition:"center"}}),e.jsx("span",{children:"Permitir acceso"})]})]})]}),s.id=="e20c7891-1ef8-4388-8150-4c1028cc4525"&&e.jsxs(e.Fragment,{children:[e.jsx(re,{eRef:z,label:"Titulo de la tarea",col:"col-12",required:!0}),e.jsxs(fe,{eRef:J,label:"Tipo de tarea",col:"col-lg-4 col-md-12",required:!0,dropdownParent:`#note-type-${s.id}`,minimumResultsForSearch:1/0,children:[e.jsx("option",{value:"Llamada",children:"Llamada"}),e.jsx("option",{value:"Correo",children:"Correo"}),e.jsx("option",{value:"Por hacer",selected:!0,children:"Por hacer"})]}),e.jsxs(fe,{eRef:K,label:"Prioridad",col:"col-lg-3 col-md-12",required:!0,dropdownParent:`#note-type-${s.id}`,minimumResultsForSearch:1/0,children:[e.jsx("option",{value:"Baja",children:"Baja"}),e.jsx("option",{value:"Media",selected:!0,children:"Media"}),e.jsx("option",{value:"Alta",children:"Alta"}),e.jsx("option",{value:"Urgente",children:"Urgente"})]}),e.jsx(st,{eRef:Z,label:"Asignado a",col:"col-lg-5 col-md-12",dropdownParent:`#note-type-${s.id}`,searchAPI:"/api/users/paginate",searchBy:"fullname"}),e.jsx(re,{eRef:L,label:"Fecha finalización",type:"date",col:"col-lg-6 col-md-12",required:!0}),e.jsx(re,{eRef:N,label:"Hora finalización",type:"time",col:"col-lg-6 col-md-12",required:!0})]}),s.id=="8e895346-3d87-4a87-897a-4192b917c211"&&e.jsx(e.Fragment,{children:e.jsx(re,{eRef:d,label:"Proceso",col:"col-12",parentClassName:"dropdown",className:"dropdown-toggle","data-bs-toggle":"dropdown",children:e.jsx("ul",{className:"dropdown-menu",style:{width:"100%"},children:C.map((o,i)=>e.jsxs("li",{className:"dropdown-item",onClick:()=>d.current.value=o.name,style:{cursor:"pointer"},children:[e.jsx("b",{className:"d-block",children:o.name}),o.description&&e.jsx("small",{className:"d-block text-truncate",children:o.description})]},i))})})}),e.jsxs("div",{className:"col-12 mb-2",hidden:s.id=="37b1e8e2-04c4-4246-a8c9-838baa7f8187",children:[e.jsx("label",{className:"mb-1",htmlFor:"",children:"Contenido"}),e.jsx("div",{ref:we[s.id],id:`editor-${s.id}`,style:{height:"162px",transition:"transform 0.3s ease, box-shadow 0.3s ease"}})]}),s.id=="8e895346-3d87-4a87-897a-4192b917c211"&&e.jsxs(e.Fragment,{children:[e.jsx(fe,{eRef:v,label:"Estado de gestión",col:"col-sm-12 col-md-12 col-lg-6",dropdownParent:`#note-type-${s.id}`,minimumResultsForSearch:-1,children:W.map((o,i)=>e.jsx("option",{value:o.id,children:o.name},i))}),e.jsx(fe,{eRef:x,label:"Estado del lead",col:"col-lg-6 col-md-12",dropdownParent:`#note-type-${s.id}`,minimumResultsForSearch:-1,children:Ne.map((o,i)=>e.jsx("option",{value:o.id,children:o.name},i))})]}),s.id!="37b1e8e2-04c4-4246-a8c9-838baa7f8187"&&e.jsx("div",{className:"col-12",children:e.jsx("button",{className:"btn btn-sm btn-success",type:"button",value:s.id,onClick:As,children:"Guardar"})})]}),s.id!="37b1e8e2-04c4-4246-a8c9-838baa7f8187"&&e.jsx("hr",{}),s.id=="37b1e8e2-04c4-4246-a8c9-838baa7f8187"?Ae==null?void 0:Ae.map((o,i)=>{const Y=O.String(o.sender).replace(/\<(.*?)\>/g,'<span className="me-1">·</span><small style="font-weight: lighter">&lt;$1&gt;</small>'),X=new Date(o.date);return e.jsxs("div",{className:"card mb-2 border",children:[e.jsxs("div",{className:"card-header p-2",style:{cursor:"pointer"},onClick:async()=>{const V=await Ue.getDetails(o.id);V&&(Ps(V),$(f.current).modal("show"))},children:[e.jsxs("b",{className:"d-block",children:[o.type=="sent"?e.jsx("i",{className:"mdi mdi-send me-1"}):e.jsx("i",{className:"mdi mdi-inbox me-1"}),e.jsx(Ge,{className:"d-inline",html:Y})]}),e.jsx("small",{className:"text-muted",children:moment(X).format("LLL")})]}),e.jsx("div",{className:"card-body p-2",children:e.jsxs("small",{children:[e.jsx("b",{children:o.subject})," - ",o.snippet||"."]})})]},i)}):te.filter(o=>o.note_type_id==s.id).sort((o,i)=>i.created_at>o.created_at?1:-1).map((o,i)=>e.jsx(hs,{...o,session:G,onDeleteNote:Es,onUpdateNote:Ms},`note-${i}`))]},`tab-note-type-${a}`)})]})]})}),e.jsxs("div",{className:"col-lg-3 col-md-4 col-sm-6 col-xs-12",children:[e.jsxs("div",{className:"card",children:[e.jsx("div",{className:"card-header bg-danger",children:e.jsx("h5",{className:"header-title my-0 text-white",children:"Tareas"})}),e.jsx("div",{className:"card-body",children:Oe.length>0?Oe.sort((s,a)=>s.ends_at>a.ends_at?1:-1).map((s,a)=>e.jsx(Ls,{...s,onChange:Ze},`task-${a}`)):e.jsx("i",{className:"text-muted",children:"- No hay tareas pendientes -"})})]}),e.jsxs("div",{className:"card",children:[e.jsxs("div",{className:"card-header bg-primary",children:[e.jsxs("div",{className:"float-end text-white",children:["S/. ",_e(Pe.reduce((s,a)=>s+Number(a.price),0))]}),e.jsx("h5",{className:"header-title my-0 text-white",children:"Productos"})]}),e.jsxs("div",{className:"card-body",children:[e.jsx(ys,{className:"d-block mx-auto btn btn-sm btn-white rounded-pill",title:"Agregar",icon:{icon:"fa fa-plus"},tippy:"Agregar producto al cliente",children:R.map((s,a)=>Pe.find(h=>h.id==s.id)?e.jsxs(Se,{className:"py-1",style:{cursor:"not-allowed",opacity:.5},tippy:"Ya ha sido agregado",children:[e.jsx("b",{className:"d-block text-truncate",children:s.name}),e.jsxs("small",{children:["S/. ",_e(s.price)]})]},a):e.jsxs(Se,{className:"py-1",onClick:()=>Is(s),children:[e.jsx("b",{className:"d-block text-truncate",children:s.name}),e.jsxs("small",{children:["S/. ",_e(s.price)]})]},a))}),e.jsx("div",{className:"mt-2 d-flex flex-column gap-2",children:Pe.map((s,a)=>e.jsx(lt,{...s,onDelete:Os,onChange:Bs},a))})]})]})]})]})}),e.jsx(pe,{modalRef:E,title:"Nuevo lead",btnSubmitText:"Guardar",onSubmit:Fs,zIndex:1060,children:e.jsxs("div",{className:"row mb-0",children:[e.jsx("input",{ref:g,type:"hidden"}),e.jsx(re,{eRef:A,label:"Nombre completo"}),e.jsx(re,{eRef:M,label:"Correo electronico",type:"email",col:"col-md-6"}),e.jsx(re,{eRef:P,label:"Telefono",type:"tel",col:"col-md-6",required:!0,onBlur:()=>Le()}),e.jsx(re,{eRef:l,label:"Empresa / Marca",col:"col-md-6"}),e.jsx(re,{eRef:b,label:"Link de WEB",col:"col-md-6"}),e.jsx(ws,{eRef:y,label:"Mensaje",placeholder:"Ingresa tu mensaje",rows:4})]})}),e.jsxs(pe,{modalRef:f,title:p==null?void 0:p.subject,size:"lg",zIndex:1055,hideHeader:!0,hideFooter:!0,children:[e.jsx("button",{type:"button",className:"btn-close float-end","data-bs-dismiss":"modal","aria-label":"Close"}),e.jsx("table",{style:{width:"max-content",maxWidth:"100%"},children:e.jsxs("tbody",{children:[e.jsxs("tr",{children:[e.jsx("th",{className:"py-0 px-1",style:{textAlign:"end"},children:"De:"}),e.jsx("td",{className:"py-0 px-1",children:p==null?void 0:p.sender})]}),e.jsxs("tr",{children:[e.jsx("th",{className:"py-0 px-1",style:{textAlign:"end"},children:"Para:"}),e.jsx("td",{className:"py-0 px-1",children:p==null?void 0:p.to})]}),(p==null?void 0:p.cc)&&e.jsxs("tr",{children:[e.jsx("th",{className:"py-0 px-1",style:{textAlign:"end"},children:"Cc:"}),e.jsx("td",{className:"py-0 px-1",children:p==null?void 0:p.cc})]}),(p==null?void 0:p.bcc)&&e.jsxs("tr",{children:[e.jsx("th",{className:"py-0 px-1",style:{textAlign:"end"},children:"Bcc:"}),e.jsx("td",{className:"py-0 px-1",children:p==null?void 0:p.bcc})]}),e.jsxs("tr",{children:[e.jsx("th",{className:"py-0 px-1",style:{textAlign:"end"},children:"Fecha:"}),e.jsx("td",{className:"py-0 px-1",children:moment(new Date(p==null?void 0:p.date)).format("LLL")})]}),e.jsxs("tr",{children:[e.jsx("th",{className:"py-0 px-1",style:{textAlign:"end"},children:"Asunto:"}),e.jsx("td",{className:"py-0 px-1",children:p==null?void 0:p.subject})]})]})}),e.jsx("hr",{className:"my-2"}),e.jsx(Ge,{html:p==null?void 0:p.bodyHtml,style:{minHeight:"360px"}}),e.jsx("hr",{className:"mt-2 mb-0"}),((os=p==null?void 0:p.attachments)==null?void 0:os.length)>0&&e.jsx("div",{className:"mt-2 d-flex flex-wrap gap-2",children:(ds=p==null?void 0:p.attachments)==null?void 0:ds.map(s=>e.jsxs("div",{className:"d-flex gap-1 border p-1",style:{width:"180px"},children:[e.jsx("i",{className:"mdi mdi-file"}),e.jsxs("div",{children:[e.jsx(q,{content:s.filename,children:e.jsx("span",{className:"d-block text-truncate",style:{width:"145px"},children:s.filename})}),e.jsxs("div",{className:"d-flex gap-1 align-items-center justify-content-between",children:[e.jsx("small",{className:"d-block",children:ut(s.size)}),e.jsxs("div",{className:"d-flex gap-1",children:[e.jsx(q,{content:"Abrir",children:e.jsx("a",{href:`/api/gmail/attachment/${p==null?void 0:p.id}/${s.attachmentId}/${s.filename}`,target:"_blank",className:"btn btn-xs btn-white",type:"button",children:e.jsx("i",{className:"fa fa-eye"})})}),e.jsx(q,{content:"Descargar",children:e.jsx("a",{href:`/api/gmail/attachment/${p==null?void 0:p.id}/${s.attachmentId}/${s.filename}`,target:"_blank",download:!0,className:"btn btn-xs btn-white",type:"button",children:e.jsx("i",{className:"fa fa-download"})})})]})]})]})]}))}),((ms=p==null?void 0:p.sender)==null?void 0:ms.includes(t==null?void 0:t.contact_email))&&e.jsx("div",{className:"mt-2",children:e.jsxs("button",{className:"btn btn-xs btn-white rounded-pill",type:"button",onClick:()=>{Ke(p),$(j.current).modal("show")},children:[e.jsx("i",{className:"fas fa-reply me-1"}),"Responder"]})})]}),e.jsx(mt,{modalRef:j,data:t,session:G,setSession:ae,inReplyTo:Ds,onSend:s=>{ie(a=>({...a,refresh:crypto.randomUUID()})),ue(a=>[...a,s])},defaultMessages:_,signs:U}),e.jsx(bt,{offCanvasRef:T,dataLoaded:ze,setDataLoaded:De,defaultMessages:_,onOpenModal:be,onLeadClicked:ge,signs:U})]})};qs((u,n)=>{zs(u).render(e.jsx(Vs,{...n,title:"Leads",children:e.jsx(yt,{...n})}))});
