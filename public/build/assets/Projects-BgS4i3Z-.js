import{r as n,R as t,C as Y,c as G,m as k}from"./CreateReactScript-vbGM1frk.js";import{A as q,S as I}from"./Adminto-C4gHCc0i.js";import{D as g,a as L,A as U,P as V}from"./AssignUsersModal-BFEQI42Y.js";import{P as D,A as O,N as z,D as H}from"./Assigneds-Dr-QTxsg.js";import{a as A,S as T}from"./SetSelectValue-BojEVN_p.js";import{M as J}from"./Modal-eo6CSBkF.js";import{T as K}from"./Table-M5GT6Uvl.js";import{I as p}from"./InputFormGroup-HYuIwuxN.js";import{T as Q}from"./TextareaFormGroup-BpOjoQVu.js";import"./Dropdown-BisDtF4t.js";import"./DropdownItem-SxBzees4.js";const b=({className:l,title:s,icon:o,onClick:a,...i})=>$("<div>").dxButton({hint:s,template:(m,u)=>{u.addClass(`${o} d-block`)},elementAttr:{class:`${l} position-relative me-1 px-1 py-0 tippy-here`,...i},onClick:a}),W=({col:l,label:s,eRef:o,required:a=!1,children:i,dropdownParent:m})=>(o||(o=n.useRef()),n.useEffect(()=>{$(o.current).select2({dropdownParent:m})},[m]),t.createElement("div",{className:`form-group ${l} mb-2`},t.createElement("label",{htmlFor:""},s," ",a&&t.createElement("b",{className:"text-danger"},"*")),t.createElement("select",{ref:o,required:a,className:"form-control",style:{width:"100%"}},i))),X=({statuses:l,can:s})=>{const o=n.useRef(),a=n.useRef(),i=n.useRef(),m=n.useRef(),u=n.useRef(),y=n.useRef(),E=n.useRef(),v=n.useRef(),h=n.useRef(),x=n.useRef(),R=n.useRef(),w=n.useRef(),[C,F]=n.useState(!1),[j,N]=n.useState({}),[P,S]=n.useState({}),_=e=>{var r,c,f,d;e!=null&&e.id?F(!0):F(!1),$(i.current).val(null).trigger("change"),m.current.value=(e==null?void 0:e.id)||null,T(u.current,(r=e==null?void 0:e.client)==null?void 0:r.id,(c=e==null?void 0:e.client)==null?void 0:c.name),T(y.current,(f=e==null?void 0:e.type)==null?void 0:f.id,(d=e==null?void 0:e.type)==null?void 0:d.name),E.current.value=(e==null?void 0:e.name)||null,v.current.value=(e==null?void 0:e.description)||null,h.current.value=e==null?void 0:e.cost,x.current.value=e!=null&&e.sign_at?moment(e.sign_at).format("YYYY-MM-DD"):null,R.current.value=e!=null&&e.starts_at?moment(e.starts_at).format("YYYY-MM-DD"):null,w.current.value=e!=null&&e.ends_at?moment(e.ends_at).format("YYYY-MM-DD"):null,$(a.current).modal("show")},B=async e=>{e.preventDefault();const r={status_id:i.current.value,id:m.current.value||void 0,client_id:u.current.value,type_id:y.current.value,name:E.current.value,description:v.current.value,cost:h.current.value??void 0,sign_at:x.current.value??void 0,starts_at:R.current.value,ends_at:w.current.value};await D.save(r)&&($(o.current).dxDataGrid("instance").refresh(),$(a.current).modal("hide"))},M=async e=>{const{isConfirmed:r}=await I.fire({title:"Estas seguro?",text:"Esta acciÃ³n no se puede deshacer",icon:"warning",showCancelButton:!0,confirmButtonText:"Continuar",cancelButtonText:"Cancelar"});!r||!await D.delete(e)||$(o.current).dxDataGrid("instance").refresh()};return t.createElement(t.Fragment,null,t.createElement(K,{gridRef:o,title:"Proyectos",rest:D,toolBar:e=>{e.unshift({widget:"dxButton",location:"after",options:{icon:"refresh",hint:"Refrescar tabla",onClick:()=>$(o.current).dxDataGrid("instance").refresh()}}),s("projects","root","all","create")&&e.unshift({widget:"dxButton",location:"after",options:{icon:"plus",hint:"Nuevo registro",onClick:()=>_()}})},filterValue:void 0,columns:[{dataField:"client.tradename",caption:"Nombre comercial",filterValue:k.GET.client||void 0,fixed:!0,fixedPosition:"left"},{dataField:"type.name",caption:"Tipo"},{dataField:"name",caption:"Proyecto",visible:!1},{dataField:"users",caption:"Asignados",dataType:"string",cellTemplate:(e,{data:r})=>{const c=(r.users||"").split("|").filter(Boolean);e.append(g([O(c)]))}},{dataField:"cost",caption:"Costo",dataType:"number",cellTemplate:(e,{data:r})=>{e.text(`S/. ${z(r.cost)}`)}},{dataField:"remaining_amount",caption:"Pagos",dataType:"number",cellTemplate:(e,{data:r})=>{const c=(r.total_payments/r.cost*100).toFixed(2),f=Number(r.total_payments).toLocaleString("en-US",{maximumFractionDigits:2,minimumFractionDigits:2}),d=Number(r.cost-r.total_payments).toLocaleString("en-US",{maximumFractionDigits:2,minimumFractionDigits:2});e.append(g([t.createElement(t.Fragment,null,t.createElement("p",{className:"mb-0 d-flex justify-content-between"},t.createElement("b",{className:"text-success"},t.createElement("i",{className:"fa fa-arrow-circle-up"})," S/. ",f),t.createElement("b",{className:"float-end text-danger"},t.createElement("i",{className:"fa fa-arrow-circle-down"})," S/. ",d)),t.createElement("div",{className:"progress progress-bar-alt-primary progress-sm mt-0 mb-0",style:{width:"200px"}},t.createElement("div",{className:"progress-bar bg-primary progress-animated wow animated animated",role:"progressbar","aria-valuenow":r.total_payments,"aria-valuemin":"0","aria-valuemax":r.cost,style:{width:`${c}%`,visibility:"visible",animationName:"animationProgress"}})))],!1))}},{dataField:"starts_at",caption:"Fecha de desarrollo",dataType:"date",cellTemplate:(e,{data:r})=>{e.append(g([{width:"200px",height:"30px",children:H(r.starts_at,r.ends_at)}]))},sortOrder:"asc"},s("projects","root","all","changestatus")?{dataField:"status.name",caption:"Estado del proyecto",dataType:"string",cellTemplate:(e,{data:r})=>{e.attr("style","overflow: visible"),e.append(g([{height:"28px",children:t.createElement(V,{can:s,statuses:l,data:r,onChange:()=>{$(o.current).dxDataGrid("instance").refresh()}})}]))}}:null,{caption:"Acciones",cellTemplate:(e,{data:r})=>{s("projects","root","all","update")&&e.append(b({className:"btn btn-xs btn-soft-primary",title:"Editar",icon:"fa fa-pen",onClick:()=>_(r)})),s("projects","root","all","assignUsers")&&e.append(b({className:"btn btn-xs btn-soft-info",title:"Asignar usuarios",icon:"fa fa-user-plus",onClick:()=>S(r)})),s("projects","root","all","addpayment")&&e.append(b({className:"btn btn-xs btn-soft-success",title:"Ver/Agregar pagos",icon:"fas fa-money-check-alt",onClick:()=>N(r)})),s("projects","root","all","delete")&&e.append(b({className:"btn btn-xs btn-soft-danger",title:"Eliminar",icon:"fa fa-trash-alt",onClick:()=>M(r.id)}))},allowFiltering:!1,allowExporting:!1}]}),t.createElement(J,{modalRef:a,title:C?"Editar proyecto":"Agregar proyecto",onSubmit:B},t.createElement("div",{className:"row",id:"project-crud-container"},t.createElement("div",{className:"col-12"},t.createElement("div",{className:"row justify-content-center"},t.createElement(W,{eRef:i,label:"Estado del proyecto",dropdownParent:"#project-crud-container",col:"col-md-6 col-sm-12",required:!0},l.map((e,r)=>t.createElement("option",{key:`status-${r}`,value:e.id},e.name))))),t.createElement("input",{ref:m,type:"hidden"}),t.createElement(A,{eRef:u,label:"Cliente",col:"col-12",dropdownParent:"#project-crud-container",searchAPI:"/api/clients/paginate",searchBy:"name",required:!0}),t.createElement(A,{eRef:y,label:"Tipo del proyecto",col:"col-md-4",dropdownParent:"#project-crud-container",searchAPI:"/api/types/paginate",searchBy:"name",filter:["table_id","=","cd8bd48f-c73c-4a62-9935-024139f3be5f"],required:!0}),t.createElement(p,{eRef:E,label:"Nombre del proyecto",col:"col-md-8",required:!0}),t.createElement(Q,{eRef:v,label:"Descripcion del proyecto",col:"col-12"}),t.createElement(p,{eRef:h,label:"Costo",col:"col-md-6",type:"number",step:.01,required:!0}),t.createElement(p,{eRef:x,label:"Fecha firma",col:"col-md-6",type:"date"}),t.createElement(p,{eRef:R,label:"Fecha inicio",col:"col-md-6",type:"date",required:!0}),t.createElement(p,{eRef:w,label:"Fecha fin",col:"col-md-6",type:"date",required:!0}))),t.createElement(L,{can:s,dataLoaded:j,setDataLoaded:N,grid2refresh:$(o.current).dxDataGrid("instance")}),t.createElement(U,{dataLoaded:P,setDataLoaded:S,grid2refresh:$(o.current).dxDataGrid("instance")}))};Y((l,s)=>{if(!s.can("projects","root","all","list"))return location.href="/";G(l).render(t.createElement(q,{...s,title:"Proyectos"},t.createElement(X,{...s})))});
