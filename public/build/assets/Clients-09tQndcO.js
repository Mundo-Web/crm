import{S as J,A as se,i as q}from"./Adminto-BBPgMFMA.js";import{r as n,R as e,C as ce,c as oe,G as ie}from"./CreateReactScript-Cr76lECz.js";import{M as U,T as z}from"./TextareaFormGroup-DpQiZCGF.js";import{C as T,a as me,L as ue}from"./LeadsRest-CT_bIbgG.js";import{I as v}from"./InputFormGroup-DfllSyoc.js";import{S as I,a as de}from"./SetSelectValue-CfjBp_ib.js";import{D as G}from"./DropdownItem-Dd6zonp_.js";import{D as fe}from"./DropdownEnd-CXnHC35Z.js";import{P as pe,A as Ee}from"./AssignUsersModal-CsyGr6Qz.js";import{P as be}from"./ProjectStatusDropdown-CBoESW0t.js";import{R as b}from"./ReactAppend-BUdEshxq.js";import{P as ge,A as ve,N as he,D as Ne}from"./Assigneds-Ka2L8EGu.js";import{T as we,D as H}from"./DxPanelButton-BirM2UWv.js";import{T as g}from"./TippyButton-BkidhdIh.js";import{D as ye}from"./DxBox-CyhaKWwR.js";import{D as W}from"./Dropdown-CaUzbQ6I.js";import"./server.browser-Dt1gYAOJ.js";const Re=({can:h,client:r,setClient:P,grid2refresh:S,page:c})=>{const x=n.useRef(),o=n.useRef(),f=n.useRef(),m=n.useRef(),p=n.useRef(),E=n.useRef(),[C,N]=n.useState([]),[D,y]=n.useState(!1);n.useEffect(()=>{r.id&&_(),$(x.current).on("hidden.bs.modal",()=>{P({}),N([]),y(!1),f.current.value=null,I(m.current,null,null),p.current.value=null,E.current.value=null})},[r]);const _=async()=>{const l=await T.byClient(r==null?void 0:r.id);N(l),$(x.current).modal("show")},A=async l=>{l.preventDefault();const u={id:f.current.value||void 0,type_id:m.current.value,client_id:r.id,name:p.current.value,description:E.current.value};await T.save(u)&&($(o.current).modal("hide"),f.current.value=null,I(m.current,null,null),p.current.value=null,E.current.value=null,await R(),$(S.current).dxDataGrid("instance").refresh())},R=async()=>{const l=await T.byClient(r.id);N(l)},L=async l=>{f.current.value=l.id,I(m.current,l.type.id,l.type.name),p.current.value=l.name,E.current.value=l.description,$(o.current).modal("show"),y(!0)},k=async l=>{const{isConfirmed:u}=await J.fire({title:"Estas seguro de eliminar esta nota?",text:"No podras revertir esto!",icon:"warning",showCancelButton:!0,confirmButtonText:"Continuar",cancelButtonText:"Cancelar"});!u||!await T.delete(l)||(await R(),$(S.current).dxDataGrid("instance").refresh())};return e.createElement(e.Fragment,null,e.createElement(U,{modalRef:x,title:`Notas de ${(r==null?void 0:r.tradename)||(r==null?void 0:r.name)||(r==null?void 0:r.contact_name)}`,size:"full-width",isStatic:!0,hideFooter:!0},e.createElement("div",{style:{height:"calc(100vh - 180px)",overflowY:"auto"}},e.createElement("div",{className:"text-center"},e.createElement("button",{className:"btn btn-primary",type:"button",onClick:()=>$(o.current).modal("show")},"Agregar nota")),e.createElement("hr",{className:"my-2"}),e.createElement("div",{className:"d-flex flex-wrap flex-row justify-content-center gap-2"},C.sort((l,u)=>new Date(u.created_at)-new Date(l.created_at)).map((l,u)=>{const w=moment(l.created_at),j=moment().diff(w,"hours")>12?w.format("lll"):w.fromNow();return e.createElement("div",{key:`note-${u}`,className:"card text-white bg-purple mb-0",style:{width:"100%",maxWidth:"300px",height:"max-content"}},e.createElement("div",{className:"card-body p-2"},e.createElement("div",{className:"d-flex align-items-center border-bottom border-white pb-1 mb-1"},e.createElement("div",{className:"avatar-sm me-2 mb-1"},e.createElement("img",{src:`/api/profile/thumbnail/${l.user.relative_id}?v=${new Date(l.user.updated_at).getTime()}`,className:"img-fluid rounded-circle",alt:"user"})),e.createElement("div",{className:"flex-grow-1 overflow-hidden"},e.createElement("h5",{className:"text-white m-0"},l.user.name," ",l.user.lastname),e.createElement("p",{className:"text-white-50 m-0 font-13 text-truncate"},j)),h(c,"root","all","editnotes","deletenotes")&&e.createElement(fe,null,h(c,"root","all","editnotes")&&e.createElement(G,{onClick:()=>L(l)},"Editar"),h(c,"root","all","deletenotes")&&e.createElement(G,{onClick:()=>k(l.id)},"Eliminar"))),e.createElement("blockquote",{className:"card-bodyquote mb-0"},l.name&&e.createElement("b",null,l.name),e.createElement("p",{className:"mb-1"},l.description))))})))),e.createElement(U,{modalRef:o,title:D?"Editar nota":"Agregar nota",size:"sm",onSubmit:A},e.createElement("div",{id:"note-crud-container"},e.createElement("input",{ref:f,type:"hidden"}),e.createElement(de,{eRef:m,label:"Tipo de nota",col:"col-12",dropdownParent:"#note-crud-container",searchAPI:"/api/types/paginate",searchBy:"name",filter:["table_id","=","c81ad4fb-a895-4f4c-b4b3-5989a7a66a85"],required:!0}),e.createElement(v,{eRef:p,label:"Titulo de la nota"}),e.createElement(z,{eRef:E,label:"Descripcion de la nota",required:!0}))))},F=new me,Y=new ue,xe=({projectStatuses:h,clientStatuses:r,manageStatuses:P,session:S,can:c,defaultClientStatus:x})=>{const o=n.useRef(),f=n.useRef(),m=n.useRef(),p=n.useRef(),E=n.useRef(),C=n.useRef(),N=n.useRef(),D=n.useRef(),y=n.useRef(),_=n.useRef(),A=n.useRef(),R=n.useRef(),[L,k]=n.useState(!1),[l,u]=n.useState({}),[w,B]=n.useState({}),[O,j]=n.useState({}),[K,Q]=n.useState({});n.useState([]);const X=t=>{t!=null&&t.id?k(!0):k(!1),$('[href="#client-data"]').addClass("active"),$('[href="#contact-data"]').removeClass("active"),$("#client-data").addClass("active"),$("#contact-data").removeClass("active"),m.current.value=(t==null?void 0:t.id)||null,p.current.value=(t==null?void 0:t.ruc)||null,E.current.value=(t==null?void 0:t.name)||null,C.current.value=(t==null?void 0:t.tradename)||null,N.current.value=(t==null?void 0:t.web_url)||null,D.current.value=(t==null?void 0:t.message)||"Cliente creado desde Atalaya",y.current.value=(t==null?void 0:t.contact_name)||null,_.current.value=(t==null?void 0:t.contact_phone)||null,A.current.value=(t==null?void 0:t.contact_email)||null,R.current.value=(t==null?void 0:t.contact_address)||null,$(f.current).modal("show")},Z=async t=>{t.preventDefault();const a={id:m.current.value||void 0,ruc:p.current.value,name:E.current.value,tradename:C.current.value,web_url:N.current.value,message:D.current.value??"Cliente creado desde Atalaya",contact_name:y.current.value??"",contact_phone:_.current.value??"",contact_email:A.current.value??"",contact_address:R.current.value??"",status_id:m.current.value?void 0:x};await F.save(a)&&($(o.current).dxDataGrid("instance").refresh(),$(f.current).modal("hide"))},ee=async t=>{const{isConfirmed:a}=await J.fire({title:"Estas seguro de eliminar este lead?",text:"No podras revertir esta accion!",icon:"warning",showCancelButton:!0,confirmButtonText:"Continuar",cancelButtonText:"Cancelar"});!a||!await F.delete(t)||$(o.current).dxDataGrid("instance").refresh()},V=async(t,a)=>{await F.assign(t,a)&&$(o.current).dxDataGrid("instance").refresh()},te=async(t,a)=>{await Y.leadStatus({lead:t,status:a}),$(o.current).dxDataGrid("instance").refresh()},ae=async(t,a)=>{await Y.manageStatus({lead:t.id,status:a.id}),$(o.current).dxDataGrid("instance").refresh()};return e.createElement(e.Fragment,null,e.createElement(we,{gridRef:o,title:"Clientes",rest:F,toolBar:t=>{t.unshift(H({className:"btn btn-xs btn-soft-dark",text:"Actualizar",title:"Refrescar tabla",icon:"fas fa-undo-alt",onClick:()=>$(o.current).dxDataGrid("instance").refresh()})),c("clients","all","create")&&t.unshift(H({className:"btn btn-xs btn-soft-primary",text:"Nuevo",title:"Agregar registro",icon:"fa fa-plus",onClick:()=>onOpenModal()}))},columns:[c("projects","root","all","list")?{dataField:"id",caption:"ID",dataType:"number",cellTemplate:(t,{data:a,value:i,...d})=>{b(t,e.createElement(g,{className:"btn btn-xs btn-white",title:`Ver ${a.projects_count} proyectos`,onClick:()=>{d.component.collapseAll(-1),d.component.expandRow(d.row.data)}},e.createElement("i",{className:"fas fa-shapes"})," ",a.projects_count))},sortOrder:"desc"}:null,{dataField:"ruc",caption:"RUC",cellTemplate:(t,{data:a})=>{t.html(a.ruc||'<i class="text-muted">- Sin RUC -</i>')}},{dataField:"tradename",caption:"Nombre comercial",width:250,cellTemplate:(t,{data:a})=>{b(t,e.createElement("div",{className:"d-flex align-items-center"},a.assigned_to&&e.createElement(q,{content:`Atendido por ${a.assigned.name} ${a.assigned.lastname}`},e.createElement("img",{className:"avatar-xs rounded-circle me-1",src:`//${ie.APP_DOMAIN}/api/profile/thumbnail/${a.assigned.relative_id}`,alt:a.assigned.name})),e.createElement("div",null,a.tradename||e.createElement("i",{className:"text-muted"},"- Sin nombre -"))))}},{dataField:"name",caption:"Razon social",visible:!1},{dataField:"contact_name",caption:"Nombre de contacto"},{dataField:"contact_phone",caption:"Telefono"},{dataField:"contact_email",caption:"Correo"},c("clients","root","all","changestatus")?{dataField:"status.name",caption:"Estado del cliente",dataType:"string",cellTemplate:(t,{data:a})=>{t.attr("style","overflow: visible"),b(t,e.createElement(W,{className:"btn btn-xs btn-white rounded-pill",title:a.status.name,icon:{icon:"fa fa-circle",color:a.status.color},tippy:"Actualizar estado"},r.map(({id:i,name:d,color:s})=>e.createElement(G,{key:i,onClick:()=>te(a.id,i)},e.createElement("i",{className:"fa fa-circle",style:{color:s}})," ",d))))}}:null,c("clients","root","all","changestatus")?{dataField:"manage_status.name",caption:"Estado de gestion",dataType:"string",cellTemplate:(t,{data:a})=>{var i,d;t.attr("style","overflow: visible"),b(t,e.createElement(W,{className:"btn btn-xs btn-white rounded-pill",title:(i=a==null?void 0:a.manage_status)==null?void 0:i.name,icon:{icon:"fa fa-circle",color:(d=a==null?void 0:a.manage_status)==null?void 0:d.color},tippy:"Actualizar estado"},P.map((s,M)=>e.createElement(G,{key:`status-${M}`,onClick:()=>ae(a,s)},e.createElement("i",{className:"fa fa-circle",style:{color:s.color}})," ",s.name))))}}:null,c("clients","root","all","list","update","changestatus","delete")?{caption:"Acciones",width:235,cellTemplate:(t,{data:a})=>{t.attr("style","display: flex; gap: 4px; overflow: visible"),c("clients","root","all","update")&&b(t,e.createElement(g,{className:"btn btn-xs btn-soft-primary",title:"Editar",onClick:()=>X(a)},e.createElement("i",{className:"fa fa-pen"}))),a.assigned_to?a.assigned_to==S.id&&b(t,e.createElement(g,{className:"btn btn-xs btn-soft-danger",title:"Dejar de atender",onClick:()=>V(a.id,!1)},e.createElement("i",{className:"fas fa-hands-wash"}))):b(t,e.createElement(g,{className:"btn btn-xs btn-soft-dark",title:"Atender lead",onClick:()=>V(a.id,!0)},e.createElement("i",{className:"fas fa-hands-helping"}))),c("clients","root","all","delete")&&b(t,e.createElement(g,{className:"btn btn-xs btn-soft-danger",title:"Eliminar",onClick:()=>ee(a.id)},e.createElement("i",{className:"fa fa-trash-alt"})))},allowFiltering:!1,allowExporting:!1}:null],masterDetail:{enabled:!1,template:async(t,{data:a,component:i})=>{t.css("padding","10px"),t.css("overflow","visible"),t.css("background-color","#323a46");let{data:d}=await ge.paginate({filter:["client_id","=",a.id],isLoadingAll:!0});t.append(ye([e.createElement(e.Fragment,null,e.createElement(g,{title:"Cerrar tabla",className:"btn btn-xs btn-soft-danger waves-effect mb-1",onClick:()=>i.collapseAll(-1)},e.createElement("i",{className:"fa fa-times"})),e.createElement("table",{className:"table table-dark table-sm table-bordered mb-0",style:{width:"100%"}},e.createElement("thead",null,e.createElement("tr",null,e.createElement("th",{scope:"col"},"Tipo"),e.createElement("th",{scope:"col"},"Asignados"),e.createElement("th",{scope:"col"},"Costo"),e.createElement("th",{scope:"col"},"Pagos"),e.createElement("th",{scope:"col"},"Fecha de desarrollo"),e.createElement("th",{scope:"col"},"Estado del proyecto"),e.createElement("th",{scope:"col"},"Acciones"))),e.createElement("tbody",null,d.map(s=>{const M=(s.total_payments/s.cost*100).toFixed(2),le=Number(s.total_payments).toLocaleString("en-US",{maximumFractionDigits:2,minimumFractionDigits:2}),ne=Number(s.cost-s.total_payments).toLocaleString("en-US",{maximumFractionDigits:2,minimumFractionDigits:2}),re=(s.users||"").split("|").filter(Boolean);return e.createElement("tr",{key:`project-${s.id}`},e.createElement("td",{valign:"middle"},s.type.name),e.createElement("td",{valign:"middle"},ve(re)),e.createElement("td",{valign:"middle"},`S/. ${he(s.cost)}`),e.createElement("td",{valign:"middle"},e.createElement("p",{className:"mb-0 d-flex justify-content-between"},e.createElement("b",{className:"text-success"},e.createElement("i",{className:"fa fa-arrow-circle-up"})," S/. ",le),e.createElement("b",{className:"float-end text-danger"},e.createElement("i",{className:"fa fa-arrow-circle-down"})," S/. ",ne)),e.createElement("div",{className:"progress progress-bar-alt-primary progress-sm mt-0 mb-0",style:{width:"200px"}},e.createElement("div",{className:"progress-bar bg-primary progress-animated wow animated",role:"progressbar","aria-valuenow":s.total_payments,"aria-valuemin":"0","aria-valuemax":s.cost,style:{width:`${M}%`,visibility:"visible",animationName:"animationProgress"}}))),e.createElement("td",{valign:"middle"},Ne(s.starts_at,s.ends_at)),e.createElement("td",{valign:"middle"},e.createElement(be,{can:c,statuses:h,data:s,onChange:()=>{$(o.current).dxDataGrid("instance").refresh()}})),e.createElement("td",null,c("projects","root","all","assignUsers")&&e.createElement(g,{className:"btn btn-xs btn-soft-info me-1",title:"Asignar usuarios",icon:"fa fa-user-plus",onClick:()=>B(s)},e.createElement("i",{className:"fa fa-user-plus"})),c("projects","root","all","addpayment")&&e.createElement(g,{className:"btn btn-xs btn-soft-success",title:"Ver/Agregar pagos",icon:"fas fa-money-check-alt",onClick:()=>u(s)},e.createElement("i",{className:"fas fa-money-check-alt"}))))}))))]))}}}),e.createElement(U,{modalRef:f,title:L?"Editar cliente":"Agregar cliente",onSubmit:Z,size:"md"},e.createElement("input",{ref:m,type:"hidden"}),e.createElement("ul",{className:"nav nav-pills navtab-bg nav-justified"},e.createElement("li",{className:"nav-item"},e.createElement(q,{content:"Datos del negocio"},e.createElement("a",{href:"#client-data","data-bs-toggle":"tab","aria-expanded":"false",className:"nav-link active"},"Negocio"))),e.createElement("li",{className:"nav-item"},e.createElement(q,{content:"Datos de contacto"},e.createElement("a",{href:"#contact-data","data-bs-toggle":"tab","aria-expanded":"true",className:"nav-link"},"Contacto")))),e.createElement("div",{className:"tab-content"},e.createElement("div",{className:"tab-pane active",id:"client-data"},e.createElement("div",{className:"row"},e.createElement(v,{eRef:p,label:"RUC",col:"col-4",required:!0}),e.createElement(v,{eRef:C,label:"Nombre comercial",col:"col-8",required:!0}),e.createElement(v,{eRef:E,label:"Razon social",col:"col-md-6",required:!0}),e.createElement(v,{eRef:N,label:"URL Web",col:"col-md-6"}),e.createElement(z,{eRef:D,label:"Mensaje",col:"col-12",required:!0}))),e.createElement("div",{className:"tab-pane show",id:"contact-data"},e.createElement("div",{className:"row"},e.createElement(v,{eRef:y,label:"Nombre de contacto",col:"col-6"}),e.createElement(v,{eRef:_,label:"Celular de contacto",type:"tel",col:"col-6"}),e.createElement(v,{eRef:A,label:"Email de contacto",col:"col-12",type:"email"}),e.createElement(z,{eRef:R,label:"Direccion de contacto",col:"col-12"}))))),e.createElement(pe,{can:c,dataLoaded:l,setDataLoaded:u,grid2refresh:O}),e.createElement(Re,{can:c,client:K,setClient:Q,grid2refresh:o,page:"clients"}),e.createElement(Ee,{dataLoaded:w,setDataLoaded:B,grid2refresh:$(o.current).dxDataGrid("instance")}))};ce((h,r)=>{if(!r.can("clients","root","all","list"))return location.href="/";oe(h).render(e.createElement(se,{...r,title:"Clientes"},e.createElement(xe,{...r})))});
