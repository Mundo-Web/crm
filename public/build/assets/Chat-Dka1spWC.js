import{j as e,G as P,r as n,C as Ee,c as De,L as ae}from"./CreateReactScript-DEiMbi6B.js";import{W as Ae,M as Le,u as ge,i as ee,a as Te,A as Fe}from"./Adminto-lUnuPBnJ.js";import{L as pe}from"./LeadsRest-z3cA1exe.js";import{H as fe,C as Pe,a as He}from"./ClientNotesRest-XbJtIw03.js";import{w as be,A as ne}from"./ArrayJoin-6-TTvUmN.js";import"./Logout-DAQhHADr.js";import"./sweetalert2.esm.all-B5d0Dmk7.js";const Ie=({contact:a,contactDetails:r,setContactDetails:b,loading:f,theme:u})=>e.jsx("div",{className:`card-header ${u=="light"?"bg-white":"bg-light"}`,style:{cursor:"pointer"},onClick:()=>(a==null?void 0:a.id)&&b(r?null:a),children:e.jsxs("div",{className:"d-flex align-items-center",children:[!f&&a&&e.jsx("img",{src:`/api/whatsapp/profile/${a.contact_phone}`,className:"rounded-circle avatar-sm bg-light me-2",alt:a.contact_name,style:{padding:0,border:"none"},onError:m=>{m.target.src=`//${P.APP_DOMAIN}/assets/img/user-404.svg`}}),f&&e.jsx("div",{className:"placeholder-glow",children:e.jsx("div",{className:"rounded-circle avatar-sm me-2 placeholder",style:{width:36,height:36}})}),e.jsxs("div",{className:`flex-grow-1 ${f?"placeholder-glow":""}`,children:[e.jsx("h5",{className:`mt-0 mb-1 text-truncate ${f?"placeholder col-3":""}`,children:a==null?void 0:a.contact_name}),e.jsxs("p",{className:`d-block font-13 text-muted mb-0 ${f?"placeholder col-2":""}`,children:[e.jsx("i",{className:"mdi mdi-phone me-1 font-11"}),a==null?void 0:a.contact_phone]})]}),!f&&a&&e.jsx("div",{className:"ms-2",children:e.jsx("i",{className:`mdi mdi-24px mdi-chevron-double-${r?"right":"left"} text-muted`})})]})}),We=({fromMe:a,content:r,attachment:b,theme:f,time:u,campaign:m})=>e.jsxs("div",{className:`ctext-wrap ${a?`message-out-${f}`:`message-in-${f}`}`,style:{boxShadow:"rgba(11, 20, 26, 0.13) 0px 1px 0.5px 0px",padding:"6px 8px"},children:[m&&e.jsxs("div",{className:"rounded p-2 mb-2",style:{backgroundColor:"rgba(240, 240, 240, 0.125)",cursor:m.link?"pointer":"default",maxWidth:"240px"},onClick:()=>{m.link&&window.open(m.link,"_blank")},children:[e.jsxs("div",{className:"d-flex gap-1",style:{maxWidth:"100%"},children:[e.jsx("div",{className:"fw-bold",children:m.code}),e.jsx("div",{className:"small text-truncate",children:m.title})]}),e.jsx("small",{className:"d-block text-truncate",style:{maxWidth:300},children:m.link})]}),b&&e.jsxs(e.Fragment,{children:[e.jsx("img",{src:b.replace("/attachment:",""),className:"mb-1",alt:"attachment",style:{minWidth:"300px",width:"100%",maxWidth:"100%",minHeight:"200px",maxHeight:"300px",borderRadius:"4px",objectFit:"cover"},onError:h=>{const c=h.target;c&&c.parentNode&&(c.style.display="none")}}),e.jsx("div",{className:"d-flex justify-content-end",children:e.jsxs("a",{className:"btn btn-xs btn-light mb-1 text-nowrap d-flex text-end",href:b.replace("/attachment:",""),target:"_blank",rel:"noreferrer",download:!0,children:[e.jsx("i",{className:"mdi mdi-download me-1"}),e.jsx("span",{children:"Descargar adjunto"})]})}),!r.trim()&&e.jsx("span",{className:"time mt-0 float-end",style:{fontSize:"10px",marginLeft:"6px",marginTop:"8px !important"},children:u})]}),r.trim()&&e.jsx(fe,{className:"text-start font-14",html:be(r+`<span class="time mt-0 float-end" style="font-size: 10px; margin-left: 6px; margin-top: 8px !important">${u}</span>`)})]}),Oe=({fromMe:a,theme:r,url:b,time:f})=>{const[u,m]=n.useState(!1),[h,c]=n.useState(0),[j,w]=n.useState(0),l=n.useRef(null),S=()=>{const g=l.current;g&&(u?g.pause():g.play(),m(!u))};n.useEffect(()=>{const g=l.current;if(!g)return;const T=()=>c(Math.floor(g.duration)),d=()=>w(Math.floor(g.currentTime)),k=()=>{m(!1),w(0)};return g.addEventListener("loadedmetadata",T),g.addEventListener("timeupdate",d),g.addEventListener("ended",k),()=>{g.removeEventListener("loadedmetadata",T),g.removeEventListener("timeupdate",d),g.removeEventListener("ended",k)}},[]);const x=h?j/h*100:0,H=g=>{const T=Math.floor(g/60),d=g%60;return`${T}:${d<10?"0":""}${d}`};return e.jsxs("div",{className:`ctext-wrap d-flex align-items-start ${a?`message-out-${r}`:`message-in-${r}`}`,style:{minWidth:"240px",maxWidth:"320px",padding:"6px 8px",boxShadow:"rgba(11, 20, 26, 0.13) 0px 1px 0.5px 0px"},children:[e.jsxs("div",{className:"flex-grow-1",children:[e.jsxs("div",{className:"d-flex align-items-center mb-1",children:[e.jsx("button",{onClick:S,className:"btn btn-sm d-flex align-items-center justify-content-center rounded-circle me-2 p-0",style:{width:"32px",height:"32px",border:"none",color:r=="dark"?"#fff":"#6f8171",flexShrink:0},children:e.jsx("i",{className:`mdi mdi-${u?"pause":"play"}`,style:{fontSize:"24px"}})}),e.jsx("div",{className:"flex-grow-1",style:{height:"4px",backgroundColor:r=="dark"?"#ffffff55":"#6f817155",borderRadius:"2px",position:"relative"},children:e.jsx("div",{style:{height:"100%",width:`${x}%`,backgroundColor:r=="dark"?"#fff":"#6f8171",borderRadius:"2px",transition:"width 100ms ease"}})})]}),e.jsxs("div",{className:"d-flex justify-content-between align-items-center px-1",style:{fontSize:"10px"},children:[e.jsx("span",{children:H(h)}),e.jsx("span",{className:"time mt-0 float-end",style:{fontSize:"10px",marginLeft:"6px",marginTop:"8px !important"},children:f})]})]}),e.jsx("audio",{ref:l,src:b,preload:"metadata"})]})},ze=({fromMe:a,theme:r,url:b,time:f,caption:u})=>{const[m,h]=n.useState(!1),[c,j]=n.useState(1),[w,l]=n.useState({x:0,y:0}),S=n.useRef(null),x=()=>h(!0),H=()=>{h(!1),j(1),l({x:0,y:0})},g=d=>{d.preventDefault();const k=d.deltaY>0?-.1:.1;j(C=>Math.max(.5,Math.min(3,C+k)))},T=d=>{if(c>1){const k=S.current.getBoundingClientRect(),C=(d.clientX-k.left)/k.width*100,Y=(d.clientY-k.top)/k.height*100;l({x:C,y:Y})}};return e.jsxs(e.Fragment,{children:[e.jsx("div",{className:`ctext-wrap d-flex align-items-start ${a?`message-out-${r}`:`message-in-${r}`}`,style:{minWidth:"240px",maxWidth:"320px",padding:"3px",boxShadow:"rgba(11, 20, 26, 0.13) 0px 1px 0.5px 0px"},children:e.jsxs("div",{className:"flex-grow-1 position-relative",children:[e.jsx("img",{src:b,alt:"imagen",style:{width:"100%",borderRadius:"6px"},onError:d=>{d.target.src=`//${Global.APP_DOMAIN}/assets/img/image-404.svg`}}),!u&&e.jsxs(e.Fragment,{children:[e.jsx("div",{onClick:x,className:"position-absolute",style:{top:0,bottom:0,right:0,left:0,background:"linear-gradient(to top, rgba(0, 0, 0, .5) 0%, transparent 12%)",cursor:"zoom-in"}}),e.jsx("span",{className:"position-absolute time",style:{fontSize:"10px",right:"6px",bottom:"2px",textShadow:"0 0 5px rgba(0,0,0,1)",color:r!="dark"?"#fafafa":void 0},children:f})]}),(u==null?void 0:u.trim())&&e.jsx("div",{style:{padding:"3px 5px",marginTop:"6px"},children:e.jsx(fe,{className:"text-start font-14",html:be(u+`<span class="time mt-0 float-end" style="font-size: 10px; margin-left: 6px; margin-top: 8px !important">${f}</span>`)})})]})}),m&&e.jsx("div",{onClick:H,style:{position:"fixed",inset:0,backgroundColor:"rgba(0,0,0,0.8)",zIndex:1002,display:"flex",alignItems:"center",justifyContent:"center",cursor:"zoom-out"},children:e.jsx("img",{ref:S,src:b,alt:"imagen ampliada",onClick:d=>d.stopPropagation(),onWheel:g,onMouseMove:T,style:{maxWidth:"90vw",maxHeight:"90vh",transform:`scale(${c}) translate(${w.x}%, ${w.y}%)`,transformOrigin:"center center",transition:"transform 0.2s ease",cursor:"grab"},draggable:!1})})]})},Ue=({index:a,forceAfter:r,message:b,isLast:f=!1,fromMe:u,marginTop:m,theme:h})=>{var l;let c=((l=b.message)==null?void 0:l.replace(/\{\{.*?\}\}/gs,""))||"",j="";if(c.startsWith("/attachment:")&&(j=c.split(`
`)[0],c=c.replace(j,"")),b.role=="Form")return e.jsx("li",{children:e.jsx("div",{className:"chat-day-title mt-3 mb-0",children:e.jsx("small",{className:"title badge badge-soft-dark rounded-pill",children:c})})},a);let w=null;return c.startsWith("/audio:")?w=e.jsx(Oe,{fromMe:u,theme:h,url:c.replace("/audio:","/storage/images/whatsapp/"),time:moment(b.created_at).subtract(5,"hours").format("HH:mm")}):c.startsWith("/image:")?w=e.jsx(ze,{fromMe:u,theme:h,url:c.replace("/image:","/storage/images/whatsapp/").split(`
`)[0],caption:c.split(`
`).slice(1).join(`
`)||"",time:moment(b.created_at).subtract(5,"hours").format("HH:mm")}):w=e.jsx(We,{fromMe:u,theme:h,content:c,attachment:j,time:moment(b.created_at).subtract(5,"hours").format("HH:mm"),campaign:b.campaign}),e.jsx("li",{className:`${u?"odd":""} ${m||r?"":"hide-after"}`,style:{marginBottom:f?"0px":"24px",marginTop:m?"12px":"2px"},children:e.jsx("div",{className:"message-list",children:e.jsx("div",{className:"conversation-text",children:w})})})},xe=new Ae,he=new Le,Be=new pe,Ye=({leadId:a,theme:r,contactDetails:b,setContactDetails:f})=>{const u=n.useRef(),m=n.useRef(),h=n.useRef(),c=n.useRef(),j=n.useRef(),w=n.useRef(),l=n.useRef(),S=n.useRef(),[x,H]=n.useState(null),[g,T]=n.useState(!0),[d,k]=n.useState([]),[C,Y]=n.useState(!0),{socket:I}=ge(),[W,z]=n.useState(!1),[q,G]=n.useState(!1),[D,V]=n.useState(null),[t,o]=n.useState(null),[v,N]=n.useState(""),[F,_]=n.useState(!1),[R,X]=n.useState(null),[O,U]=n.useState(null),[B,M]=n.useState(!1),[se,re]=n.useState(3),[J,te]=n.useState([]),Q=n.useRef(!1);n.useEffect(()=>()=>{t&&URL.revokeObjectURL(t)},[t]),n.useEffect(()=>()=>{R&&R.getTracks().forEach(s=>s.stop())},[R]),n.useEffect(()=>{if(!C)return;const s=setInterval(()=>{const i=3+Math.floor(Math.random()*5);re(i),te(Array.from({length:i},()=>Math.random()>.5))},1500);return()=>clearInterval(s)},[C]);const le=(s=!0)=>{const i=S.current;i&&i.scrollTo({top:i.scrollHeight,behavior:s?"smooth":"auto"})},Ne=()=>{const s=S.current;return s?s.scrollTop+s.clientHeight>=s.scrollHeight-60:!0};n.useEffect(()=>{!C&&d.length&&le(!1)},[C,d.length]),n.useEffect(()=>{if(!(!I||!x))return I.on("message.created",s=>{if(s.wa_id!=(x==null?void 0:x.contact_phone))return;const{id:i,microtime:p}=s;k(y=>y.find(L=>L.id===i)?y.map(L=>L.id===i?{...L,...s}:L):[...y,s].sort((L,E)=>L.microtime-E.microtime));const $=d.reduce((y,A)=>Math.max(y,A.microtime),0);p>$&&$e(p),Ne()&&!Q.current&&setTimeout(()=>le(!0),100)}),()=>{I.off("message.created")}},[I,x,d]),n.useEffect(()=>{if(C)return;const s=S.current;if(!s)return;const i=()=>{s.scrollTop===0&&(Q.current=!0,ue())};return s.addEventListener("scroll",i),()=>s.removeEventListener("scroll",i)},[S,C]),n.useEffect(()=>{const s=i=>{l.current&&!l.current.contains(i.target)&&_(!1)};return document.addEventListener("mousedown",s),()=>document.removeEventListener("mousedown",s)},[]),n.useEffect(()=>{B&&R&&j.current&&(j.current.srcObject=R)},[B,R]);const ve=async()=>{try{const s=await navigator.mediaDevices.getUserMedia({audio:!0}),i=new MediaRecorder(s),p=[];i.ondataavailable=$=>p.push($.data),i.onstop=()=>{const $=new Blob(p,{type:"audio/mp3"});V($),o(URL.createObjectURL($)),s.getTracks().forEach(y=>y.stop())},i.start(),c.current=i,G(!0)}catch(s){console.error("Error accessing microphone:",s)}},ye=()=>{c.current&&c.current.state!=="inactive"&&c.current.stop(),G(!1)},oe=()=>{c.current&&c.current.state!=="inactive"&&c.current.stop(),G(!1),V(null),t&&URL.revokeObjectURL(t),o(null)},ce=async s=>{if(s.preventDefault(),!x)return;const i=v.trim();!i&&!D&&!O||(z(!0),D?(console.warn("Audio upload not implemented yet"),console.log(D),await xe.sendAudio(x.id,D)):O?console.warn("Camera image upload not implemented yet"):await xe.send(x.id,i),N(""),V(null),t&&URL.revokeObjectURL(t),o(null),U(null),M(!1),z(!1))},we=s=>{s.target.files[0]&&(console.warn("File upload not implemented yet"),s.target.value="")},_e=async()=>{try{const s=await navigator.mediaDevices.getUserMedia({video:!0});X(s),M(!0),_(!1)}catch(s){console.error("Error accessing camera:",s)}},de=()=>{R&&(R.getTracks().forEach(s=>s.stop()),X(null)),M(!1),U(null)},Se=()=>{const s=w.current,i=j.current;if(!s||!i)return;s.width=i.videoWidth,s.height=i.videoHeight,s.getContext("2d").drawImage(i,0,0),s.toBlob($=>{U($),de()},"image/jpeg",.95)},ke=()=>v.trim()||D||O;let me=!1;const Ce=async()=>{T(!0);const s=await Be.get(a);if(T(!1),!s){H(null),f(null);return}H(s)},ue=async()=>{var y;if(!x||!a)return;const s=S.current,i=s?s.scrollHeight:0,p=d.filter(A=>A.wa_id==x.contact_phone).sort((A,K)=>A.microtime-K.microtime)[0]??{microtime:(Date.now()+5*60*60*1e3)*1e3};Y(!0);const $=await he.paginate({summary:{contact_phone:x.contact_phone},filter:[["microtime","<",p.microtime],"and",["wa_id","contains",x.contact_phone]],sort:[{selector:"microtime",desc:!0}],skip:0,take:40});if(Y(!1),((y=$.data)==null?void 0:y.length)>0){if(k(A=>{const K=new Set(A.map(E=>E.id));return[...($.data??[]).filter(E=>!K.has(E.id)),...A].sort((E,Z)=>E.microtime-Z.microtime)}),s){const A=s.scrollHeight;s.scrollTop=A-i}Q.current=!1}},$e=async s=>{x&&await he.paginate({summary:{contact_phone:x.contact_phone},filter:[["microtime","<=",s],"and",["wa_id","contains",x.contact_phone]],sort:[{selector:"microtime",desc:!0}],skip:0,take:40})};n.useEffect(()=>{H(null),f(null),k([]),a&&Ce()},[a]),n.useEffect(()=>{k([]),!(!a&&!x)&&ue()},[x,a]);const Re=()=>e.jsx(e.Fragment,{children:Array.from({length:se}).map((s,i)=>{const p=1+Math.floor(Math.random()*3);return e.jsx("li",{className:J[i]?"odd":"",style:{marginBottom:i<se-1?"0px":"24px",marginTop:i>0&&J[i]===J[i-1]?"3px":"12px"},children:e.jsx("div",{className:"message-list",children:e.jsx("div",{className:"conversation-text",children:e.jsx("div",{className:`ctext-wrap ${J[i]?`message-out-${r}`:`message-in-${r}`}`,style:{boxShadow:"rgba(11, 20, 26, 0.13) 0px 1px 0.5px 0px",padding:"6px 8px",width:`${300+300*(p-1)/6}px`},children:e.jsxs("div",{className:"placeholder-glow",children:[Array.from({length:p}).map(($,y)=>e.jsx("span",{className:`placeholder ${y===p-1?"col-6 ms-0":"col-12"} `},y)),e.jsx("span",{className:"placeholder time float-end col-1",style:{fontSize:"10px",marginLeft:"6px",marginTop:"8px !important"}})]})})})})},i)})}),Me=()=>e.jsxs("div",{className:"d-flex flex-column align-items-center justify-content-center text-center px-4",style:{height:"calc(100vh - 260px)"},children:[e.jsx("div",{className:"mb-3",children:e.jsx("i",{className:"mdi mdi-account-off-outline text-muted",style:{fontSize:"4rem"}})}),e.jsx("h5",{className:"text-muted mb-2",children:"Este contacto no existe en la empresa seleccionada"}),e.jsx("p",{className:"text-muted mb-3",children:"Por favor, elige otro contacto desde la lista o intenta refrescar la página si crees que debería estar aquí."}),e.jsxs("button",{className:"btn btn-outline-primary",onClick:()=>window.location.reload(),children:[e.jsx("i",{className:"mdi mdi-refresh me-1"}),"Refrescar página"]})]});return e.jsxs(e.Fragment,{children:[e.jsx(Ie,{contact:x,contactDetails:b,setContactDetails:f,loading:g,theme:r}),e.jsxs("div",{className:"card-body p-0 position-relative border",style:{backgroundColor:r=="light"?"rgb(245, 241, 235)":"rgb(22, 23, 23)"},children:[e.jsx("div",{className:"position-absolute",style:{top:0,right:0,bottom:0,left:0,backgroundImage:"url(/assets/img/doodles.png)",backgroundRepeat:"repeat",zIndex:0,opacity:r=="light"?1:.0625}}),e.jsx("section",{className:"d-flex flex-column position-relative",style:{height:"calc(100vh - 260px)",zIndex:1},children:!x&&!g?Me():e.jsxs(e.Fragment,{children:[e.jsxs("ul",{ref:S,className:"conversation-list flex-grow-1 px-3 pt-3 scroll-hidden",style:{overflowY:"auto",scrollBehavior:"smooth",position:"relative"},children:[C&&d.length===0&&Re(),d.map((s,i)=>{const p=s.role!=="Human",$=me!==p;me=p;const y=new Date(s.microtime/1e3-5*60*60*1e3),K=new Date-y,L=Math.floor(K/(1e3*60*60*24));let E=null;L===0?E="Hoy":L===1?E="Ayer":L<=6?E=["Domingo","Lunes","Martes","Miércoles","Jueves","Viernes","Sábado"][y.getDay()]:E=`${y.getDate()}/${y.getMonth()+1}/${y.getFullYear()}`;const Z=i===0||new Date(d[i-1].microtime/1e3).toDateString()!==y.toDateString();return e.jsxs(e.Fragment,{children:[Z&&e.jsx("li",{className:"text-center p-0 mx-auto",style:{position:"sticky",top:0,zIndex:10,width:"max-content",marginTop:"12px",marginBottom:"12px"},children:e.jsx("span",{className:"badge",style:{width:"68px",backgroundColor:r=="dark"?"rgb(36, 38, 38)":"rgb(255, 255, 255)",color:r=="dark"?"#fafafa":"#0a0a0a"},children:E})},`date-${i}`),e.jsx(Ue,{index:i,forceAfter:Z,isLast:i<d.length-1,message:s,fromMe:p,marginTop:$,theme:r},i)]})})]}),e.jsx("form",{className:"p-2 pt-0 conversation-input",onSubmit:ce,children:e.jsxs("label",{className:`row g-0 align-items-end p-1 ${r=="dark"?"bg-light":"bg-white"}`,htmlFor:"message-input",style:{borderRadius:"24px"},children:[e.jsxs("div",{className:"col-auto mt-0",children:[e.jsxs("div",{className:"dropup",ref:l,children:[e.jsx("button",{type:"button",className:"btn btn-light btn-sm dropdown-toggle","data-bs-toggle":"dropdown","aria-expanded":F,onClick:()=>_(!F),disabled:W||q,title:"Adjuntar archivo",style:{borderRadius:"50%",width:"38px",height:"38px",padding:0},children:e.jsx("i",{className:`mdi ${F?"mdi-close":"mdi-plus"}`})}),e.jsxs("div",{className:"dropdown-menu mb-1",children:[e.jsxs("button",{className:"dropdown-item",href:"#",onClick:s=>{var i,p;s.preventDefault(),(i=m.current)==null||i.setAttribute("accept",".pdf,.doc,.docx"),(p=m.current)==null||p.click()},children:[e.jsx("i",{className:"mdi mdi-file-document me-2",style:{color:"#7F66FF"}}),"Documentos"]}),e.jsxs("button",{className:"dropdown-item",href:"#",onClick:s=>{var i,p;s.preventDefault(),(i=m.current)==null||i.setAttribute("accept","image/*,video/*"),(p=m.current)==null||p.click()},children:[e.jsx("i",{className:"mdi mdi-image me-2",style:{color:"#007BFC"}}),"Fotos y videos"]}),e.jsxs("button",{className:"dropdown-item",href:"#",onClick:s=>{s.preventDefault(),_e()},children:[e.jsx("i",{className:"mdi mdi-camera me-2",style:{color:"#FF2E74"}}),"Cámara"]}),e.jsxs("button",{className:"dropdown-item",href:"#",onClick:s=>{var i,p;s.preventDefault(),(i=m.current)==null||i.setAttribute("accept","audio/*"),(p=m.current)==null||p.click()},children:[e.jsx("i",{className:"mdi mdi-headphones me-2",style:{color:"#FB6533"}}),"Audio"]})]})]}),e.jsx("input",{ref:m,type:"file",className:"d-none",onChange:we})]}),e.jsx("div",{className:"col mt-0",children:q?e.jsxs("div",{className:"d-flex align-items-center justify-content-center bg-light rounded-pill",style:{minHeight:"38px"},children:[e.jsx("span",{className:"text-danger me-2",children:"●"})," Grabando..."]}):D?e.jsx("div",{className:"d-flex align-items-center bg-light rounded-pill px-2",style:{minHeight:"38px"},children:e.jsx("audio",{ref:h,src:t,className:"me-2",controls:!0,controlsList:"nodownload",style:{height:"30px"}})}):O?e.jsx("div",{className:"d-flex align-items-center bg-light rounded-pill px-2",style:{minHeight:"38px"},children:e.jsx("span",{className:"me-2",children:"📷 Foto capturada"})}):e.jsx("textarea",{ref:u,id:"message-input",className:"form-control w-100",placeholder:"Ingrese su mensaje aquí",rows:1,style:{minHeight:"38px",maxHeight:"188px",fieldSizing:"content",resize:"none",border:"none",backgroundColor:"transparent"},disabled:W||!!D||!!O,value:v,onChange:s=>N(s.target.value),onKeyDown:s=>{s.key==="Enter"&&!s.shiftKey&&(s.preventDefault(),ke()&&ce(s))}})}),e.jsx("div",{className:"col-auto mt-0",children:O&&!B?e.jsxs(e.Fragment,{children:[e.jsx("button",{type:"button",className:"btn btn-danger btn-sm me-1",onClick:()=>U(null),style:{borderRadius:"50%",width:"38px",height:"38px",padding:0},title:"Descartar foto",children:e.jsx("i",{className:"mdi mdi-delete"})}),e.jsx("button",{type:"submit",className:"btn btn-success btn-sm",disabled:W,style:{borderRadius:"50%",width:"38px",height:"38px",padding:0},title:"Enviar foto",children:e.jsx("i",{className:"mdi mdi-send"})})]}):D&&!q?e.jsxs(e.Fragment,{children:[e.jsx("button",{type:"button",className:"btn btn-danger btn-sm me-1",onClick:oe,style:{borderRadius:"50%",width:"38px",height:"38px",padding:0},title:"Descartar audio",children:e.jsx("i",{className:"mdi mdi-delete"})}),e.jsx("button",{type:"submit",className:"btn btn-success btn-sm",disabled:W,style:{borderRadius:"50%",width:"38px",height:"38px",padding:0},title:"Enviar audio",children:e.jsx("i",{className:"mdi mdi-send"})})]}):q?e.jsxs(e.Fragment,{children:[e.jsx("button",{type:"button",className:"btn btn-warning btn-sm me-1",onClick:ye,style:{borderRadius:"50%",width:"38px",height:"38px",padding:0},title:"Pausar grabación",children:e.jsx("i",{className:"mdi mdi-pause"})}),e.jsx("button",{type:"button",className:"btn btn-danger btn-sm",onClick:oe,style:{borderRadius:"50%",width:"38px",height:"38px",padding:0},title:"Descartar grabación",children:e.jsx("i",{className:"mdi mdi-delete"})})]}):e.jsx(e.Fragment,{children:v.trim()?e.jsx("button",{type:"submit",className:"btn btn-primary btn-sm",disabled:W,style:{borderRadius:"50%",width:"38px",height:"38px",padding:0},children:W?e.jsx("i",{className:"mdi mdi-spin mdi-loading"}):e.jsx("i",{className:"mdi mdi-send"})}):e.jsx("button",{type:"button",className:"btn btn-outline-primary btn-sm",onClick:ve,disabled:W,style:{borderRadius:"50%",width:"38px",height:"38px",padding:0},title:"Grabar audio",children:e.jsx("i",{className:"mdi mdi-microphone"})})})})]})})]})}),B&&e.jsx("div",{className:"position-fixed top-0 start-0 w-100 h-100 d-flex align-items-center justify-content-center",style:{backgroundColor:"rgba(0,0,0,0.8)",zIndex:9999},children:e.jsxs("div",{className:"card",style:{width:"90%",maxWidth:"500px"},children:[e.jsxs("div",{className:"card-header d-flex justify-content-between align-items-center",children:[e.jsx("h5",{className:"mb-0",children:"Cámara"}),e.jsx("button",{type:"button",className:"btn btn-sm btn-outline-secondary",onClick:de,children:e.jsx("i",{className:"mdi mdi-close"})})]}),e.jsxs("div",{className:"card-body p-0",children:[e.jsx("video",{ref:j,autoPlay:!0,playsInline:!0,muted:!0,className:"w-100",style:{maxHeight:"400px"}}),e.jsx("canvas",{ref:w,className:"d-none"})]}),e.jsx("div",{className:"card-footer d-flex justify-content-center",children:e.jsxs("button",{type:"button",className:"btn btn-primary btn-lg rounded-pill",onClick:Se,children:[e.jsx("i",{className:"mdi mdi-camera me-2"}),"Tomar foto"]})})]})})]})]})},qe=new Pe,Ge=a=>{var h,c,j,w;const[r,b]=n.useState([]),[f,u]=n.useState(!1),m=async()=>{u(!0);const l=await qe.byClient(a==null?void 0:a.id);b(l??[]),u(!1)};return n.useEffect(()=>{a&&m()},[a]),e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"contact-details d-flex flex-column gap-2 flex-md-row flex-xl-row align-items-center  rounded-4 shadow-sm mb-2 overflow-hidden",children:[e.jsx("img",{src:`/api/whatsapp/profile/${a.contact_phone}`,className:"rounded-circle avatar-lg bg-light border-0 mb-3 mb-md-0 mb-xl-0 flex-shrink-0",alt:a.name,style:{objectFit:"cover"},onError:l=>{l.target.src=`//${P.APP_DOMAIN}/assets/img/user-404.svg`}}),e.jsxs("div",{className:"text-center text-md-start text-xl-start w-100",children:[e.jsx("div",{className:"fw-bold fs-5 text-dark text-truncat",children:a.contact_name}),e.jsx("div",{className:"text-muted text-truncate",children:a.name}),e.jsx("div",{className:"text-muted small text-truncate",children:a.contact_email}),e.jsx("div",{className:"text-muted small text-truncate",children:a.contact_phone})]})]}),e.jsxs("div",{className:"d-flex flex-wrap gap-2 justify-content-around mb-2",children:[e.jsxs("div",{className:"text-center",children:[e.jsx("b",{className:"d-block",children:"Estado de gestión"}),e.jsx("button",{className:"btn",style:{backgroundColor:((h=a.status)==null?void 0:h.color)||"#6c757d",color:"#fff",cursor:"default"},children:((c=a.status)==null?void 0:c.name)||"Sin estado"})]}),e.jsxs("div",{className:"text-center",children:[e.jsx("b",{className:"d-block",children:"Estado del lead"}),e.jsx("button",{className:"btn",style:{backgroundColor:((j=a.manage_status)==null?void 0:j.color)||"#6c757d",color:"#fff",cursor:"default"},children:((w=a.manage_status)==null?void 0:w.name)||"Sin estado"})]})]}),a.assigned_to&&e.jsxs("div",{className:"p-2 bg-light rounded mb-2",children:[e.jsx("h5",{className:"mt-0 mb-2",children:"Atendido por:"}),e.jsxs("div",{className:"d-flex align-items-start",bis_skin_checked:"1",children:[e.jsx("img",{className:"d-flex me-2 rounded-circle",src:`//${P.APP_DOMAIN}/api/profile/thumbnail/${a.assigned.relative_id}`,onError:l=>{l.target.src=`//${P.APP_DOMAIN}/assets/img/user-404.svg`},alt:a.assigned.fullname,height:"32"}),e.jsxs("div",{className:"w-100 overflow-hidden",bis_skin_checked:"1",children:[e.jsx("h5",{className:"m-0 font-14 text-truncate",children:a.assigned.fullname}),e.jsx("span",{className:"font-12 mb-0 text-truncate d-block",children:a.assigned.email})]})]})]}),e.jsx("hr",{className:"mt-0 mb-2"}),e.jsxs("div",{className:"d-flex justify-content-between align-items-center mb-2",children:[e.jsx("h5",{className:"my-0",children:"Actividad"}),e.jsx(ee,{content:"Ver más",children:e.jsx("a",{href:`/leads/${a.id}`,className:"text-decoration-none",children:e.jsx("i",{className:"mdi mdi-arrow-top-right"})})})]}),f?e.jsxs("div",{className:"placeholder-glow",children:[e.jsx("div",{className:"placeholder mb-2 w-100 rounded",style:{height:70}}),e.jsx("div",{className:"placeholder mb-2 w-100 rounded",style:{height:140}})]}):r.sort((l,S)=>S.created_at>l.created_at?1:-1).map((l,S)=>e.jsx(He,{...l,showOptions:!1,extended:!1},`note-${S}`))]})};function ie(a){var r;return typeof a=="string"?a:Array.isArray(a)?a.map(ie).join(""):(r=a==null?void 0:a.props)!=null&&r.children?ie(a.props.children):""}const je=new pe;je.paginateSufix=null;const Je=({users:a,activeLeadId:r,...b})=>{const f=Local.get("adminto_settings")??{},[u,m]=n.useState(f.theme??"light"),[h,c]=n.useState([]),[j,w]=n.useState(r),[l,S]=Te(ae.business_id,[ae.service_user.id]),[x,H]=n.useState(!1),[g,T]=n.useState(0),[d,k]=n.useState(""),[C,Y]=n.useState(null),[I,W]=n.useState(null),{socket:z}=ge(),q=n.useRef(),G=n.useRef(),D=async(t=!1)=>{if(x)return;H(!0);const o={fields:["clients.id","clients.contact_name","clients.contact_phone","clients.last_message","clients.last_message_microtime","clients.assigned_to","clients.status_id","clients.manage_status_id"],withCount:["unSeenMessages"],with:["assigned","status","manageStatus"],sort:[{selector:"last_message_microtime",desc:!0}],skip:0,take:40,requireTotalCount:!0},v=[["clients.last_message_microtime","isnotnull"]];if(l.length&&v.push(ne(l.map(_=>["clients.assigned_to","=",_]),"or")),d){const _=[["clients.contact_name","=",d],["clients.contact_name","contains",d],["clients.contact_phone","contains",d]];v.push(ne(_,"or"))}if(t&&h.length>0){const _=Math.min(...h.map(R=>R.last_message_microtime));v.push(["clients.last_message_microtime","<",_])}o.filter=ne(v,"and");const{data:N,totalCount:F}=await je.paginate(o);c(t?_=>[..._,...N??[]]:N??[]),T(((N==null?void 0:N.length)??0)+(F??0)),H(!1)},V=t=>{const o=t.target.value;k(o),C&&clearTimeout(C),Y(setTimeout(()=>{D(!1)},500))};return n.useEffect(()=>{D(!1)},[l]),n.useEffect(()=>{const t=o=>{o.key==="Escape"&&(w(null),W(null))};return window.addEventListener("keydown",t),()=>window.removeEventListener("keydown",t)},[]),n.useEffect(()=>{if(z)return z.on("client.updated",t=>{c(o=>{const v=o.findIndex(N=>N.id===t.id);if(v!==-1){const N=[...o];return N[v]={...N[v],...t},N}return!l.length||l.includes(t.assigned_to)?[...o,t]:o})}),()=>{z.off("client.updated")}},[z,l]),n.useEffect(()=>{const t=G.current;if(!t)return;const o=()=>{t.scrollTop+t.clientHeight>=t.scrollHeight-10&&h.length<g&&D(!0)};return t.addEventListener("scroll",o),()=>t.removeEventListener("scroll",o)},[h,x,l,g,d]),n.useEffect(()=>{j?history.pushState({},"",`/chat/${j}`):history.pushState({},"","/chat")},[j]),e.jsx(Fe,{...b,title:"Chat",showTitle:!1,setThemeParent:m,children:e.jsxs("div",{className:"row",children:[e.jsx("div",{className:"col-xl-3 col-lg-4",children:e.jsx("div",{className:"card chat-list-card mb-xl-0",children:e.jsxs("div",{className:"card-body p-0",children:[e.jsx("div",{className:"p-2",children:e.jsxs("div",{className:"d-flex w-100 gap-0 align-items-center scroll-hidden",style:{overflowX:"auto"},children:[a.map(t=>e.jsx(ee,{content:`${t.name} ${t.lastname}`,children:e.jsx("div",{onClick:()=>{const o=[...l],v=t.service_user.id,N=o.indexOf(v);N>-1?o.splice(N,1):o.push(v),S(o)},className:`rounded-pill ${l.includes(t.service_user.id)?"bg-purple":""}`,style:{cursor:"pointer",padding:"2px",marginRight:"2px"},children:e.jsx("img",{className:"avatar-xs rounded-circle",src:`//${P.APP_DOMAIN}/api/profile/thumbnail/${t.relative_id}`,onError:o=>{o.target.src=`//${P.APP_DOMAIN}/assets/img/user-404.svg`},alt:t.name,style:{objectFit:"cover",objectPosition:"center"}})})},t.id)),l.length>0&&e.jsx(ee,{content:"Limpiar filtros",children:e.jsx("button",{className:"btn btn-xs btn-soft-danger ms-1 rounded-pill",onClick:()=>S([]),children:e.jsx("i",{className:"mdi mdi-trash-can-outline"})})})]})}),e.jsx("div",{className:"p-2 border-top",children:e.jsxs("div",{className:"search-box chat-search-box",children:[e.jsx("input",{type:"text",className:"form-control rounded-pill",placeholder:"Buscar lead por nombre o número...",value:d,onChange:V}),e.jsx("i",{className:"mdi mdi-magnify search-icon"})]})}),e.jsxs("div",{ref:G,className:"scroll-hidden",style:{overflowY:"auto",height:"calc(100vh - 300px)"},children:[e.jsx("ul",{className:"list-unstyled chat-list mb-0",children:h.sort((t,o)=>new Date(o.last_message_microtime)-new Date(t.last_message_microtime)).map(t=>{var R,X,O,U,B;const o=new Date((t.last_message_microtime??0)/1e3),v=new Date;v.setHours(0,0,0,0);const N=new Date(v);N.setDate(N.getDate()-1);let F;if(o>=v)F=o.toLocaleString("es-ES",{hour:"2-digit",minute:"2-digit"});else if(o>=N)F="Ayer";else{const M=["Domingo","Lunes","Martes","Miércoles","Jueves","Viernes","Sábado"];if(Math.floor((new Date-o)/(1e3*60*60*24))<=6)F=M[o.getDay()];else{const J=String(o.getDate()).padStart(2,"0"),te=String(o.getMonth()+1).padStart(2,"0"),Q=o.getFullYear();F=`${J}/${te}/${Q}`}}let _=t.last_message;if(_.startsWith("/audio:"))_=e.jsxs(e.Fragment,{children:[e.jsx("i",{className:"mdi mdi-microphone"})," Audio"]});else if(_.startsWith("/image:")){const M=String(_.split(`
`).slice(1).join(`
`)||"").trim();_=e.jsxs(e.Fragment,{children:[e.jsx("i",{className:"mdi mdi-image"})," ",M||"Foto"]})}return e.jsx("li",{className:`${t.unread?"unread":""} ${j==t.id?"bg-light":""}`,children:e.jsx("a",{onClick:M=>{w(t.id),M.stopPropagation()},style:{cursor:"pointer"},children:e.jsxs("div",{className:"d-flex",children:[e.jsxs("div",{className:`position-relative flex-shrink-0 chat-user-img ${t.online?"active":""} align-self-center me-2`,children:[e.jsx("img",{src:`/api/whatsapp/profile/${t.contact_phone}`,className:"rounded-circle avatar-sm bg-light",alt:t.name,style:{padding:0,border:"none"},onError:M=>{M.target.src=`//${P.APP_DOMAIN}/assets/img/user-404.svg`}}),t.assigned_to&&((R=t.assigned)==null?void 0:R.relative_id)&&(l.length===0||l.length>1||l[0]!==ae.service_user.id)&&e.jsx(ee,{content:`${t.assigned.name} ${t.assigned.lastname}`,children:e.jsx("img",{className:"position-absolute rounded-pill",src:`//${P.APP_DOMAIN}/api/profile/thumbnail/${t.assigned.relative_id}`,onError:M=>{M.target.src=`//${P.APP_DOMAIN}/assets/img/user-404.svg`},alt:t.assigned.fullname,style:{right:"-4px",bottom:"-4px",objectFit:"cover",objectPosition:"center",padding:0,border:`2px solid ${u=="light"?"#ffffff":"#313844"}`,width:"18px",aspectRatio:1}})},t.assigned.id)]}),e.jsxs("div",{className:"flex-grow-1 overflow-hidden",children:[e.jsx("h5",{className:`text-truncate font-14 mt-0 mb-0 ${t.un_seen_messages_count>0?"fw-bold":""}`,children:t.contact_name}),e.jsx("p",{className:`text-truncate mb-0 ${t.un_seen_messages_count>0?"fw-bold":""}`,title:ie(_)??void 0,style:{color:t.un_seen_messages_count>0?u=="light"?"#343a40":"#f7f7f7":void 0},children:_??e.jsx("i",{className:"text-muted",children:"Sin mensaje"})}),e.jsxs("div",{className:"d-flex gap-1",children:[e.jsx("span",{className:"badge",style:{backgroundColor:((X=t.status)==null?void 0:X.color)??"#6c757d"},children:((O=t.status)==null?void 0:O.name)??"Sin estado"}),e.jsx("span",{className:"badge",style:{backgroundColor:((U=t.manage_status)==null?void 0:U.color)??"#6c757d"},children:((B=t.manage_status)==null?void 0:B.name)??"Sin estado"})]})]}),e.jsxs("div",{className:"d-flex flex-column align-items-end",children:[e.jsx("div",{className:`font-11 ${t.un_seen_messages_count>0?"text-success":""}`,children:F}),t.un_seen_messages_count>0&&e.jsx("span",{className:"badge bg-success rounded-pill mt-1",children:t.un_seen_messages_count})]})]})})},t.id)})}),e.jsxs("div",{className:"text-center py-2",children:[x&&e.jsx("div",{className:"spinner-border spinner-border-sm text-primary",role:"status",children:e.jsx("span",{className:"visually-hidden",children:"Loading contacts..."})}),!x&&h.length>=g&&h.length>0&&e.jsx("span",{className:"text-muted",children:"No hay más contactos"})]})]})]})})}),e.jsx("div",{className:`col-xl-${I?6:9} col-lg-${I?8:12}`,children:e.jsx("div",{className:"conversation-list-card card",children:j?e.jsx(e.Fragment,{children:e.jsx(Ye,{leadId:j,containerRef:q,theme:u,contactDetails:I,setContactDetails:W})}):e.jsx("div",{className:"card-body d-flex align-items-center justify-content-center",style:{height:"calc(100vh - 184px)"},children:e.jsxs("div",{className:"text-center",children:[e.jsx("img",{src:"/assets/img/icon.svg",alt:`Logo ${P.APP_NAME}`,className:"mb-2",style:{width:60,height:60,objectFit:"contain"}}),e.jsxs("h4",{className:"text-muted",children:["Módulo de chat de ",P.APP_NAME]}),e.jsx("p",{className:"text-muted",children:"Selecciona un contacto para empezar a interactuar"})]})})})}),I&&e.jsx("div",{className:"col-xl-3 col-lg-12",children:e.jsx("div",{className:"card contact-details-card mb-xl-0",children:e.jsx("div",{className:"card-body scroll-hidden",style:{height:"calc(100vh - 186px)",overflowY:"auto"},children:e.jsx(Ge,{...I})})})})]})})};Ee((a,r)=>{De(a).render(e.jsx(Je,{...r}))});
