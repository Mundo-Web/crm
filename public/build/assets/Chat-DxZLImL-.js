import{j as e,G as T,r as a,C as Me,c as De,L as re}from"./CreateReactScript-DcwmeAVN.js";import{W as Ee,M as Ae,u as be,i as se,a as Le,A as Te}from"./Adminto-8qxubLRL.js";import{L as je}from"./LeadsRest-Bywyklws.js";import{H as ce,C as Fe,a as Pe}from"./ClientNotesRest-BK7aNUza.js";import{w as de,A as le}from"./ArrayJoin-6-TTvUmN.js";import"./Logout-CMhpjQt5.js";import"./sweetalert2.esm.all-BB4SRWjP.js";const Ie=({contact:t,contactDetails:m,setContactDetails:l,loading:h,theme:d})=>e.jsx("div",{className:`card-header ${d=="light"?"bg-white":"bg-light"}`,style:{cursor:"pointer"},onClick:()=>(t==null?void 0:t.id)&&l(m?null:t),children:e.jsxs("div",{className:"d-flex align-items-center",children:[!h&&t&&e.jsx("img",{src:`/api/whatsapp/profile/${t.contact_phone}`,className:"rounded-circle avatar-sm bg-light me-2",alt:t.contact_name,style:{padding:0,border:"none"},onError:u=>{u.target.src=`//${T.APP_DOMAIN}/assets/img/user-404.svg`}}),h&&e.jsx("div",{className:"placeholder-glow",children:e.jsx("div",{className:"rounded-circle avatar-sm me-2 placeholder",style:{width:36,height:36}})}),e.jsxs("div",{className:`flex-grow-1 ${h?"placeholder-glow":""}`,children:[e.jsx("h5",{className:`mt-0 mb-1 text-truncate ${h?"placeholder col-3":""}`,children:t==null?void 0:t.contact_name}),e.jsxs("p",{className:`d-block font-13 text-muted mb-0 ${h?"placeholder col-2":""}`,children:[e.jsx("i",{className:"mdi mdi-phone me-1 font-11"}),t==null?void 0:t.contact_phone]})]}),!h&&t&&e.jsx("div",{className:"ms-2",children:e.jsx("i",{className:`mdi mdi-24px mdi-chevron-double-${m?"right":"left"} text-muted`})})]})}),He=({fromMe:t,content:m,attachment:l,theme:h,time:d,campaign:u})=>e.jsxs("div",{className:`ctext-wrap ${t?`message-out-${h}`:`message-in-${h}`}`,style:{boxShadow:"rgba(11, 20, 26, 0.13) 0px 1px 0.5px 0px",padding:"6px 8px"},children:[u&&e.jsxs("div",{className:"rounded p-2 mb-2",style:{backgroundColor:"rgba(240, 240, 240, 0.125)",cursor:u.link?"pointer":"default",maxWidth:"240px"},onClick:()=>{u.link&&window.open(u.link,"_blank")},children:[e.jsxs("div",{className:"d-flex gap-1",style:{maxWidth:"100%"},children:[e.jsx("div",{className:"fw-bold",children:u.code}),e.jsx("div",{className:"small text-truncate",children:u.title})]}),e.jsx("small",{className:"d-block text-truncate",style:{maxWidth:300},children:u.link})]}),l&&e.jsxs(e.Fragment,{children:[e.jsx("img",{src:l.replace("/attachment:",""),className:"mb-1",alt:"attachment",style:{minWidth:"300px",width:"100%",maxWidth:"100%",minHeight:"200px",maxHeight:"300px",borderRadius:"4px",objectFit:"cover"},onError:i=>{const o=i.target;o&&o.parentNode&&(o.style.display="none")}}),e.jsx("div",{className:"d-flex justify-content-end",children:e.jsxs("a",{className:"btn btn-xs btn-light mb-1 text-nowrap d-flex text-end",href:l.replace("/attachment:",""),target:"_blank",rel:"noreferrer",download:!0,children:[e.jsx("i",{className:"mdi mdi-download me-1"}),e.jsx("span",{children:"Descargar adjunto"})]})}),!m.trim()&&e.jsx("span",{className:"time mt-0 float-end",style:{fontSize:"10px",marginLeft:"6px",marginTop:"8px !important"},children:d})]}),m.trim()&&e.jsx(ce,{className:"text-start font-14",html:de(m+`<span class="time mt-0 float-end" style="font-size: 10px; margin-left: 6px; margin-top: 8px !important">${d}</span>`)})]}),We=({fromMe:t,theme:m,url:l,time:h})=>{const[d,u]=a.useState(!1),[i,o]=a.useState(0),[p,x]=a.useState(0),c=a.useRef(null),_=()=>{const j=c.current;j&&(d?j.pause():j.play(),u(!d))};a.useEffect(()=>{const j=c.current;if(!j)return;const F=()=>o(Math.floor(j.duration)),b=()=>x(Math.floor(j.currentTime)),C=()=>{u(!1),x(0)};return j.addEventListener("loadedmetadata",F),j.addEventListener("timeupdate",b),j.addEventListener("ended",C),()=>{j.removeEventListener("loadedmetadata",F),j.removeEventListener("timeupdate",b),j.removeEventListener("ended",C)}},[]);const f=i?p/i*100:0,I=j=>{const F=Math.floor(j/60),b=j%60;return`${F}:${b<10?"0":""}${b}`};return e.jsxs("div",{className:`ctext-wrap d-flex align-items-start ${t?`message-out-${m}`:`message-in-${m}`}`,style:{minWidth:"240px",maxWidth:"320px",padding:"6px 8px",boxShadow:"rgba(11, 20, 26, 0.13) 0px 1px 0.5px 0px"},children:[e.jsxs("div",{className:"flex-grow-1",children:[e.jsxs("div",{className:"d-flex align-items-center mb-1",children:[e.jsx("button",{onClick:_,className:"btn btn-sm d-flex align-items-center justify-content-center rounded-circle me-2 p-0",style:{width:"32px",height:"32px",border:"none",color:m=="dark"?"#fff":"#6f8171",flexShrink:0},children:e.jsx("i",{className:`mdi mdi-${d?"pause":"play"}`,style:{fontSize:"24px"}})}),e.jsx("div",{className:"flex-grow-1",style:{height:"4px",backgroundColor:m=="dark"?"#ffffff55":"#6f817155",borderRadius:"2px",position:"relative"},children:e.jsx("div",{style:{height:"100%",width:`${f}%`,backgroundColor:m=="dark"?"#fff":"#6f8171",borderRadius:"2px",transition:"width 100ms ease"}})})]}),e.jsxs("div",{className:"d-flex justify-content-between align-items-center px-1",style:{fontSize:"10px"},children:[e.jsx("span",{children:I(i)}),e.jsx("span",{className:"time mt-0 float-end",style:{fontSize:"10px",marginLeft:"6px",marginTop:"8px !important"},children:h})]})]}),e.jsx("audio",{ref:c,src:l,preload:"metadata"})]})},ze=({fromMe:t,theme:m,url:l,time:h,mask:d,caption:u})=>{const i=d||(l==null?void 0:l.split("/").pop()),o=()=>{const p=document.createElement("a");p.href=l,p.download=i,p.click()};return e.jsx(e.Fragment,{children:e.jsx("div",{className:`ctext-wrap d-flex align-items-start ${t?`message-out-${m}`:`message-in-${m}`}`,style:{minWidth:"240px",maxWidth:"320px",padding:"8px",boxShadow:"rgba(11, 20, 26, 0.13) 0px 1px 0.5px 0px"},children:e.jsxs("div",{className:"flex-grow-1 position-relative",children:[e.jsxs("div",{className:"d-flex align-items-center justify-content-end rounded gap-2",style:{backgroundColor:"rgba(0, 0, 0, .125)",padding:"3px 6px",cursor:"pointer",minWidth:0},onClick:o,children:[e.jsx("div",{children:e.jsx("i",{className:"mdi mdi-file-document mdi-24px"})}),e.jsx("div",{className:"flex-grow-1 text-truncate text-start",children:e.jsx("div",{className:"font-14 text-truncate",style:{overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap",maxWidth:"220px"},children:i})}),e.jsx("div",{children:e.jsx("i",{className:"mdi mdi-download mdi-24px"})})]}),e.jsx(ce,{className:`text-start font-14 ${u&&"mt-1"}`,html:de(u+`<span class="time mt-0 float-end" style="font-size: 10px; margin-left: 6px; margin-top: 8px !important">${h}</span>`)})]})})})},Oe=({fromMe:t,theme:m,url:l,time:h,caption:d})=>{const[u,i]=a.useState(!1),[o,p]=a.useState(1),[x,c]=a.useState({x:0,y:0}),_=a.useRef(null),f=()=>i(!0),I=()=>{i(!1),p(1),c({x:0,y:0})},j=b=>{b.preventDefault();const C=b.deltaY>0?-.1:.1;p(E=>Math.max(.5,Math.min(3,E+C)))},F=b=>{if(o>1){const C=_.current.getBoundingClientRect(),E=(b.clientX-C.left)/C.width*100,O=(b.clientY-C.top)/C.height*100;c({x:E,y:O})}};return e.jsxs(e.Fragment,{children:[e.jsx("div",{className:`ctext-wrap d-flex align-items-start ${t?`message-out-${m}`:`message-in-${m}`}`,style:{minWidth:"240px",maxWidth:"320px",padding:"3px",boxShadow:"rgba(11, 20, 26, 0.13) 0px 1px 0.5px 0px"},children:e.jsxs("div",{className:"flex-grow-1 position-relative",children:[e.jsx("img",{src:l,alt:"imagen",style:{width:"100%",borderRadius:"6px"},onError:b=>{b.target.src=`//${T.APP_DOMAIN}/assets/img/image-404.svg`}}),!d&&e.jsxs(e.Fragment,{children:[e.jsx("div",{onClick:f,className:"position-absolute",style:{top:0,bottom:0,right:0,left:0,background:"linear-gradient(to top, rgba(0, 0, 0, .5) 0%, transparent 12%)",cursor:"zoom-in",borderRadius:"6px"}}),e.jsx("span",{className:"position-absolute time",style:{fontSize:"10px",right:"6px",bottom:"2px",textShadow:"0 0 5px rgba(0,0,0,1)",color:m!="dark"?"#fafafa":void 0},children:h})]}),(d==null?void 0:d.trim())&&e.jsx("div",{style:{padding:"3px 5px",marginTop:"6px"},children:e.jsx(ce,{className:"text-start font-14",html:de(d+`<span class="time mt-0 float-end" style="font-size: 10px; margin-left: 6px; margin-top: 8px !important">${h}</span>`)})})]})}),u&&e.jsx("div",{onClick:I,style:{position:"fixed",inset:0,backgroundColor:"rgba(0,0,0,0.8)",zIndex:1002,display:"flex",alignItems:"center",justifyContent:"center",cursor:"zoom-out"},children:e.jsx("img",{ref:_,src:l,alt:"imagen ampliada",onClick:b=>b.stopPropagation(),onWheel:j,onMouseMove:F,style:{maxWidth:"90vw",maxHeight:"90vh",transform:`scale(${o}) translate(${x.x}%, ${x.y}%)`,transformOrigin:"center center",transition:"transform 0.2s ease",cursor:"grab"},draggable:!1})})]})},Ue=({index:t,forceAfter:m,message:l,isLast:h=!1,fromMe:d,marginTop:u,theme:i})=>{var c;let o=((c=l.message)==null?void 0:c.replace(/\{\{.*?\}\}/gs,""))||"",p="";if(o.startsWith("/attachment:")&&(p=o.split(`
`)[0],o=o.replace(p,"")),l.role=="Form")return e.jsx("li",{children:e.jsx("div",{className:"chat-day-title mt-3 mb-0",children:e.jsx("small",{className:"title badge badge-soft-dark rounded-pill",children:o})})},t);let x=null;return o.startsWith("/audio:")?x=e.jsx(We,{fromMe:d,theme:i,url:o.replace("/audio:","/storage/images/whatsapp/"),time:moment(l.created_at).subtract(5,"hours").format("HH:mm")}):o.startsWith("/image:")?x=e.jsx(Oe,{fromMe:d,theme:i,url:o.replace("/image:","/storage/images/whatsapp/").split(`
`)[0],caption:o.split(`
`).slice(1).join(`
`)||"",time:moment(l.created_at).subtract(5,"hours").format("HH:mm")}):o.startsWith("/document:")?x=e.jsx(ze,{fromMe:d,theme:i,url:o.replace("/document:","/storage/images/whatsapp/").split(`
`)[0],mask:l.mask,caption:o.split(`
`).slice(1).join(`
`)||"",time:moment(l.created_at).subtract(5,"hours").format("HH:mm")}):x=e.jsx(He,{fromMe:d,theme:i,content:o,attachment:p,time:moment(l.created_at).subtract(5,"hours").format("HH:mm"),campaign:l.campaign}),e.jsx("li",{className:`${d?"odd":""} ${u||m?"":"hide-after"}`,style:{marginBottom:h?"0px":"24px",marginTop:u?"12px":"2px"},children:e.jsx("div",{className:"message-list",children:e.jsx("div",{className:"conversation-text",children:x})})})},Be=()=>e.jsxs("div",{className:"d-flex flex-column align-items-center justify-content-center text-center px-4",style:{height:"calc(100vh - 186px)"},children:[e.jsx("div",{className:"mb-3",children:e.jsx("i",{className:"mdi mdi-account-off-outline text-muted",style:{fontSize:"4rem"}})}),e.jsx("h5",{className:"text-muted mb-2",children:"Este contacto no existe en la empresa seleccionada"}),e.jsx("p",{className:"text-muted mb-3",children:"Por favor, elige otro contacto desde la lista o intenta refrescar la página si crees que debería estar aquí."}),e.jsxs("button",{className:"btn btn-outline-primary",onClick:()=>window.location.reload(),children:[e.jsx("i",{className:"mdi mdi-refresh me-1"}),"Refrescar página"]})]}),Ye=({theme:t})=>{const[m,l]=a.useState(3),[h,d]=a.useState([]);return a.useEffect(()=>{const u=setInterval(()=>{const i=3+Math.floor(Math.random()*5);l(i),d(Array.from({length:i},()=>Math.random()>.5))},1500);return()=>clearInterval(u)},[null]),e.jsx(e.Fragment,{children:Array.from({length:m}).map((u,i)=>{const o=1+Math.floor(Math.random()*3);return e.jsx("li",{className:h[i]?"odd":"",style:{marginBottom:i<m-1?"0px":"24px",marginTop:i>0&&h[i]===h[i-1]?"3px":"12px"},children:e.jsx("div",{className:"message-list",children:e.jsx("div",{className:"conversation-text",children:e.jsx("div",{className:`ctext-wrap ${h[i]?`message-out-${t}`:`message-in-${t}`}`,style:{boxShadow:"rgba(11, 20, 26, 0.13) 0px 1px 0.5px 0px",padding:"6px 8px",width:`${300+300*(o-1)/6}px`},children:e.jsxs("div",{className:"placeholder-glow",children:[Array.from({length:o}).map((p,x)=>e.jsx("span",{className:`placeholder ${x===o-1?"col-6 ms-0":"col-12"} `},x)),e.jsx("span",{className:"placeholder time float-end col-1",style:{fontSize:"10px",marginLeft:"6px",marginTop:"8px !important"}})]})})})})},i)})})},qe=({isOpen:t,setIsOpen:m,onTakePhoto:l})=>{const h=a.useRef(),d=a.useRef(),[u,i]=a.useState(null),o=()=>{const x=d.current,c=h.current;if(!x||!c)return;x.width=c.videoWidth,x.height=c.videoHeight,x.getContext("2d").drawImage(c,0,0),x.toBlob(f=>{l(f),m(!1)},"image/jpeg",.95)};a.useEffect(()=>{t&&u&&h.current&&(h.current.srcObject=u)},[t,u]);const p=async()=>{try{const x=await navigator.mediaDevices.getUserMedia({video:!0});i(x)}catch(x){console.error("Error accessing camera:",x)}};return a.useEffect(()=>{t?p():u&&(u.getTracks().forEach(x=>x.stop()),i(null))},[t]),t?e.jsx("div",{className:"position-fixed top-0 start-0 w-100 h-100 d-flex align-items-center justify-content-center",style:{backgroundColor:"rgba(0,0,0,0.8)",zIndex:9999},children:e.jsxs("div",{className:"card",style:{width:"90%",maxWidth:"500px"},children:[e.jsxs("div",{className:"card-header d-flex justify-content-between",bis_skin_checked:"1",children:[e.jsx("h4",{className:"header-title my-0",children:"Cámara"}),e.jsx("button",{type:"button",class:"btn-close",onClick:()=>m(!1)})]}),e.jsxs("div",{className:"card-body p-0 position-relative",children:[e.jsx("video",{ref:h,autoPlay:!0,playsInline:!0,muted:!0,className:"w-100",style:{maxHeight:"400px"}}),e.jsx("canvas",{ref:d,className:"d-none"}),e.jsx("span",{className:"position-absolute bg-white",onClick:o,style:{width:"40px",height:"40px",bottom:"24px",borderRadius:"50%",left:"50%",transform:"translateX(-50%)",cursor:"pointer"}})]})]})}):e.jsx(e.Fragment,{})},te=new Ee,fe=new Ae,Ke=new je,Ge=({leadId:t,setLeadId:m,theme:l,contactDetails:h,setContactDetails:d})=>{const u=a.useRef(),i=a.useRef(),o=a.useRef(),p=a.useRef(),x=a.useRef(),c=a.useRef(),_=a.useRef(),[f,I]=a.useState(null),[j,F]=a.useState(!0),[b,C]=a.useState([]),[E,O]=a.useState(!0),[k,z]=a.useState(null),[U,ae]=a.useState(null),[G,H]=a.useState(null),{socket:B}=be(),[n,g]=a.useState(!1),[w,v]=a.useState(!1),[R,y]=a.useState(null),[P,J]=a.useState(null),[W,Y]=a.useState(""),[q,$]=a.useState(!1),[ne,me]=a.useState(null),[V,X]=a.useState(!1),[Q,Ne]=a.useState(null),[Qe,ye]=a.useState(null),[Ze,we]=a.useState(""),ie=a.useRef(!1);a.useEffect(()=>()=>{P&&URL.revokeObjectURL(P)},[P]);const ue=(s=!0)=>{const r=_.current;r&&r.scrollTo({top:r.scrollHeight,behavior:s?"smooth":"auto"})},_e=()=>{const s=_.current;return s?s.scrollTop+s.clientHeight>=s.scrollHeight-60:!0};a.useEffect(()=>{!E&&b.length&&ue(!1)},[E,b.length]),a.useEffect(()=>{if(!(!B||!f))return B.on("message.created",s=>{if(s.wa_id!=(f==null?void 0:f.contact_phone))return;const{id:r,microtime:N}=s;C(S=>S.find(L=>L.id===r)?S.map(L=>L.id===r?{...L,...s}:L):[...S,s].sort((L,D)=>L.microtime-D.microtime));const M=b.reduce((S,A)=>Math.max(S,A.microtime),0);N>M&&$e(N),_e()&&!ie.current&&setTimeout(()=>ue(!0),100)}),()=>{B.off("message.created")}},[B,f,b]),a.useEffect(()=>{if(E)return;const s=_.current;if(!s)return;const r=()=>{s.scrollTop===0&&(ie.current=!0,ge())};return s.addEventListener("scroll",r),()=>s.removeEventListener("scroll",r)},[_,E]),a.useEffect(()=>{const s=r=>{x.current&&!x.current.contains(r.target)&&$(!1)};return document.addEventListener("mousedown",s),()=>document.removeEventListener("mousedown",s)},[]);const ke=async()=>{try{const s=await navigator.mediaDevices.getUserMedia({audio:!0}),r=new MediaRecorder(s),N=[];r.ondataavailable=M=>N.push(M.data),r.onstop=()=>{const M=new Blob(N,{type:"audio/mp3"});y(M),J(URL.createObjectURL(M)),H("audio"),s.getTracks().forEach(S=>S.stop())},r.start(),p.current=r,v(!0)}catch(s){console.error("Error accessing microphone:",s)}},Se=()=>{p.current&&p.current.state!=="inactive"&&p.current.stop(),v(!1)},xe=()=>{p.current&&p.current.state!=="inactive"&&p.current.stop(),v(!1),y(null),P&&URL.revokeObjectURL(P),J(null)},Z=async s=>{if(s.preventDefault(),!f)return;const r=W.trim();if(!(!r&&!R&&!k)){if(g(!0),k){switch(G){case"audio":await te.sendAudio(f.id,R);break;case"image":await te.sendImage(f.id,k,r);break;default:await te.sendDocument(f.id,k,r);break}z(null),H(null)}else await te.send(f.id,r);Y(""),g(!1)}},Ce=s=>{const r=s.target.files[0];if(!r)return;const N=r,M=r.type.startsWith("image/")?"image":r.type.startsWith("video/")?"video":"document";z(N),H(M),s.target.value=""},he=()=>W.trim()||R||k;let pe=!1;const Re=async()=>{F(!0);const s=await Ke.get(t);if(F(!1),!s){I(null),d(null);return}I(s)},ge=async()=>{var S;if(!f||!t)return;const s=_.current,r=s?s.scrollHeight:0,N=b.filter(A=>A.wa_id==f.contact_phone).sort((A,K)=>A.microtime-K.microtime)[0]??{microtime:(Date.now()+5*60*60*1e3)*1e3};O(!0);const M=await fe.paginate({summary:{contact_phone:f.contact_phone},filter:[["microtime","<",N.microtime],"and",["wa_id","contains",f.contact_phone]],sort:[{selector:"microtime",desc:!0}],skip:0,take:40});if(O(!1),((S=M.data)==null?void 0:S.length)>0){if(C(A=>{const K=new Set(A.map(D=>D.id));return[...(M.data??[]).filter(D=>!K.has(D.id)),...A].sort((D,ee)=>D.microtime-ee.microtime)}),s){const A=s.scrollHeight;s.scrollTop=A-r}ie.current=!1}},$e=async s=>{f&&await fe.paginate({summary:{contact_phone:f.contact_phone},filter:[["microtime","<=",s],"and",["wa_id","contains",f.contact_phone]],sort:[{selector:"microtime",desc:!0}],skip:0,take:40})};return a.useEffect(()=>{I(null),d(null),C([]),t&&Re()},[t]),a.useEffect(()=>{C([]),!(!t&&!f)&&ge()},[f,t]),a.useEffect(()=>{const s=r=>{r.key==="Escape"&&(k?z(null):(m(null),d(null)))};return window.addEventListener("keydown",s),()=>window.removeEventListener("keydown",s)},[k]),a.useEffect(()=>{if(!k)return;const s=URL.createObjectURL(k);return ae(s),()=>{URL.revokeObjectURL(s)}},[k]),!f&&!j?e.jsx(Be,{}):e.jsxs(e.Fragment,{children:[e.jsx(Ie,{contact:f,contactDetails:h,setContactDetails:d,loading:j,theme:l}),e.jsxs("div",{className:"card-body p-0 position-relative border",style:{backgroundColor:l=="light"?"rgb(245, 241, 235)":"rgb(22, 23, 23)"},children:[k?e.jsxs("section",{className:"position-relative p-4",style:{height:"calc(100vh - 260px)",zIndex:1},children:[e.jsx("i",{className:"mdi mdi-close mdi-24px position-absolute cursor-pointer",onClick:()=>z(null)}),e.jsxs("div",{className:"d-flex flex-column h-100 gap-2",children:[e.jsx("div",{className:"flex-grow-1 d-flex align-items-center justify-content-center overflow-hidden",children:G==="image"?e.jsx("img",{src:U,alt:"Adjunto",style:{maxWidth:"100%",maxHeight:"100%",objectFit:"contain"}}):e.jsxs("div",{className:"text-center",children:[e.jsx("i",{className:"mdi mdi-file-document",style:{fontSize:"48px"}}),e.jsx("div",{className:"mt-2",children:k.name||"Documento"})]})}),e.jsx("form",{className:"pt-0 conversation-input",onSubmit:Z,children:e.jsxs("label",{className:`row mx-auto g-0 align-items-end p-1 ${l==="dark"?"bg-light":"bg-white"}`,htmlFor:"message-input",style:{borderRadius:"24px",maxWidth:"600px"},children:[e.jsx("div",{className:"col mt-0",children:e.jsx("textarea",{ref:u,id:"message-input",className:"form-control w-100",placeholder:"Ingrese su mensaje aquí",rows:1,style:{minHeight:"38px",maxHeight:"122px",fieldSizing:"content",resize:"none",border:"none",backgroundColor:"transparent"},disabled:n||!!R,value:W,onChange:s=>Y(s.target.value),onKeyDown:s=>{s.key==="Enter"&&!s.shiftKey&&(s.preventDefault(),he()&&Z(s))}})}),e.jsx("div",{className:"col-auto mt-0",children:e.jsx("button",{type:"submit",className:"btn btn-primary btn-sm",disabled:n,style:{borderRadius:"50%",width:"38px",height:"38px",padding:0},children:n?e.jsx("i",{className:"mdi mdi-spin mdi-loading"}):e.jsx("i",{className:"mdi mdi-send"})})})]})})]})]}):e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"position-absolute",style:{top:0,right:0,bottom:0,left:0,backgroundImage:"url(/assets/img/doodles.png)",backgroundRepeat:"repeat",zIndex:0,opacity:l=="light"?1:.0625}}),e.jsxs("section",{className:"d-flex flex-column position-relative",style:{height:"calc(100vh - 260px)",zIndex:1},children:[e.jsxs("ul",{ref:_,className:"conversation-list flex-grow-1 px-3 pt-3 scroll-hidden",style:{overflowY:"auto",scrollBehavior:"smooth",position:"relative"},children:[E&&b.length===0&&e.jsx(Ye,{theme:l}),b.map((s,r)=>{const N=s.role!=="Human",M=pe!==N;pe=N;const S=new Date(s.microtime/1e3-5*60*60*1e3),K=new Date-S,L=Math.floor(K/(1e3*60*60*24));let D=null;L===0?D="Hoy":L===1?D="Ayer":L<=6?D=["Domingo","Lunes","Martes","Miércoles","Jueves","Viernes","Sábado"][S.getDay()]:D=`${S.getDate()}/${S.getMonth()+1}/${S.getFullYear()}`;const ee=r===0||new Date(b[r-1].microtime/1e3).toDateString()!==S.toDateString();return e.jsxs(e.Fragment,{children:[ee&&e.jsx("li",{className:"text-center p-0 mx-auto",style:{position:"sticky",top:0,zIndex:10,width:"max-content",marginTop:"12px",marginBottom:"12px"},children:e.jsx("span",{className:"badge",style:{width:"68px",backgroundColor:l=="dark"?"rgb(36, 38, 38)":"rgb(255, 255, 255)",color:l=="dark"?"#fafafa":"#0a0a0a"},children:D})},`date-${r}`),e.jsx(Ue,{index:r,forceAfter:ee,isLast:r<b.length-1,message:s,fromMe:N,marginTop:M,theme:l},r)]})})]}),e.jsx("form",{className:"p-2 pt-0 conversation-input",onSubmit:Z,children:e.jsxs("label",{className:`row g-0 align-items-end p-1 ${l=="dark"?"bg-light":"bg-white"}`,htmlFor:"message-input",style:{borderRadius:"24px"},children:[e.jsxs("div",{className:"col-auto mt-0",children:[e.jsxs("div",{className:"dropup",ref:x,children:[e.jsx("button",{type:"button",className:"btn btn-light btn-sm dropdown-toggle","data-bs-toggle":"dropdown","aria-expanded":q,onClick:()=>$(!q),disabled:n||w,title:"Adjuntar archivo",style:{borderRadius:"50%",width:"38px",height:"38px",padding:0},children:e.jsx("i",{className:`mdi ${q?"mdi-close":"mdi-plus"}`})}),e.jsxs("div",{ref:c,className:"dropdown-menu mb-1",children:[e.jsxs("button",{className:"dropdown-item",href:"#",onClick:s=>{var r,N;s.preventDefault(),(r=i.current)==null||r.setAttribute("accept","*"),(N=i.current)==null||N.click()},children:[e.jsx("i",{className:"mdi mdi-file-document me-2",style:{color:"#7F66FF"}}),"Documentos"]}),e.jsxs("button",{className:"dropdown-item",href:"#",onClick:s=>{var r,N;s.preventDefault(),(r=i.current)==null||r.setAttribute("accept","image/*,video/*"),(N=i.current)==null||N.click()},children:[e.jsx("i",{className:"mdi mdi-image me-2",style:{color:"#007BFC"}}),"Fotos y videos"]}),e.jsxs("button",{className:"dropdown-item",href:"#",onClick:s=>{s.preventDefault(),X(!0)},children:[e.jsx("i",{className:"mdi mdi-camera me-2",style:{color:"#FF2E74"}}),"Cámara"]}),e.jsxs("button",{className:"dropdown-item",href:"#",onClick:s=>{var r,N;s.preventDefault(),(r=i.current)==null||r.setAttribute("accept","audio/*"),(N=i.current)==null||N.click()},children:[e.jsx("i",{className:"mdi mdi-headphones me-2",style:{color:"#FB6533"}}),"Audio"]})]})]}),e.jsx("input",{ref:i,type:"file",className:"d-none",onChange:Ce})]}),e.jsx("div",{className:"col mt-0",children:w?e.jsxs("div",{className:"d-flex align-items-center justify-content-center bg-light rounded-pill",style:{minHeight:"38px"},children:[e.jsx("span",{className:"text-danger me-2",children:"●"})," Grabando..."]}):R?e.jsx("div",{className:"d-flex align-items-center bg-light rounded-pill px-2",style:{minHeight:"38px"},children:e.jsx("audio",{ref:o,src:P,className:"me-2",controls:!0,controlsList:"nodownload",style:{height:"30px"}})}):e.jsx("textarea",{ref:u,id:"message-input",className:"form-control w-100",placeholder:"Ingrese su mensaje aquí",rows:1,style:{minHeight:"38px",maxHeight:"188px",fieldSizing:"content",resize:"none",border:"none",backgroundColor:"transparent"},disabled:n||!!R||!!ne||!!Q,value:W,onChange:s=>Y(s.target.value),onKeyDown:s=>{s.key==="Enter"&&!s.shiftKey&&(s.preventDefault(),he()&&Z(s))}})}),e.jsx("div",{className:"col-auto mt-0",children:(ne||Q)&&!V?e.jsxs(e.Fragment,{children:[e.jsx("button",{type:"button",className:"btn btn-danger btn-sm me-1",onClick:()=>{me(null),Ne(null),ye(null),we("")},style:{borderRadius:"50%",width:"38px",height:"38px",padding:0},title:"Descartar adjunto",children:e.jsx("i",{className:"mdi mdi-delete"})}),e.jsx("button",{type:"submit",className:"btn btn-success btn-sm",disabled:n,style:{borderRadius:"50%",width:"38px",height:"38px",padding:0},title:"Enviar adjunto",children:e.jsx("i",{className:"mdi mdi-send"})})]}):R&&!w?e.jsxs(e.Fragment,{children:[e.jsx("button",{type:"button",className:"btn btn-danger btn-sm me-1",onClick:xe,style:{borderRadius:"50%",width:"38px",height:"38px",padding:0},title:"Descartar audio",children:e.jsx("i",{className:"mdi mdi-delete"})}),e.jsx("button",{type:"submit",className:"btn btn-success btn-sm",disabled:n,style:{borderRadius:"50%",width:"38px",height:"38px",padding:0},title:"Enviar audio",children:e.jsx("i",{className:"mdi mdi-send"})})]}):w?e.jsxs(e.Fragment,{children:[e.jsx("button",{type:"button",className:"btn btn-warning btn-sm me-1",onClick:Se,style:{borderRadius:"50%",width:"38px",height:"38px",padding:0},title:"Pausar grabación",children:e.jsx("i",{className:"mdi mdi-pause"})}),e.jsx("button",{type:"button",className:"btn btn-danger btn-sm",onClick:xe,style:{borderRadius:"50%",width:"38px",height:"38px",padding:0},title:"Descartar grabación",children:e.jsx("i",{className:"mdi mdi-delete"})})]}):e.jsx(e.Fragment,{children:W.trim()?e.jsx("button",{type:"submit",className:"btn btn-primary btn-sm",disabled:n,style:{borderRadius:"50%",width:"38px",height:"38px",padding:0},children:n?e.jsx("i",{className:"mdi mdi-spin mdi-loading"}):e.jsx("i",{className:"mdi mdi-send"})}):e.jsx("button",{type:"button",className:"btn btn-outline-primary btn-sm",onClick:ke,disabled:n,style:{borderRadius:"50%",width:"38px",height:"38px",padding:0},title:"Grabar audio",children:e.jsx("i",{className:"mdi mdi-microphone"})})})})]})})]})]}),e.jsx(qe,{isOpen:V,setIsOpen:X,onTakePhoto:s=>{H("image"),z(s)}})]})]})},Je=new Fe,Ve=t=>{var i,o,p,x;const[m,l]=a.useState([]),[h,d]=a.useState(!1),u=async()=>{d(!0);const c=await Je.byClient(t==null?void 0:t.id);l(c??[]),d(!1)};return a.useEffect(()=>{t&&u()},[t]),e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"contact-details d-flex flex-column gap-2 flex-md-row flex-xl-row align-items-center  rounded-4 shadow-sm mb-2 overflow-hidden",children:[e.jsx("img",{src:`/api/whatsapp/profile/${t.contact_phone}`,className:"rounded-circle avatar-lg bg-light border-0 mb-3 mb-md-0 mb-xl-0 flex-shrink-0",alt:t.name,style:{objectFit:"cover"},onError:c=>{c.target.src=`//${T.APP_DOMAIN}/assets/img/user-404.svg`}}),e.jsxs("div",{className:"text-center text-md-start text-xl-start w-100",children:[e.jsx("div",{className:"fw-bold fs-5 text-dark text-truncat",children:t.contact_name}),e.jsx("div",{className:"text-muted text-truncate",children:t.name}),e.jsx("div",{className:"text-muted small text-truncate",children:t.contact_email}),e.jsx("div",{className:"text-muted small text-truncate",children:t.contact_phone})]})]}),e.jsxs("div",{className:"d-flex flex-wrap gap-2 justify-content-around mb-2",children:[e.jsxs("div",{className:"text-center",children:[e.jsx("b",{className:"d-block",children:"Estado de gestión"}),e.jsx("button",{className:"btn",style:{backgroundColor:((i=t.status)==null?void 0:i.color)||"#6c757d",color:"#fff",cursor:"default"},children:((o=t.status)==null?void 0:o.name)||"Sin estado"})]}),e.jsxs("div",{className:"text-center",children:[e.jsx("b",{className:"d-block",children:"Estado del lead"}),e.jsx("button",{className:"btn",style:{backgroundColor:((p=t.manage_status)==null?void 0:p.color)||"#6c757d",color:"#fff",cursor:"default"},children:((x=t.manage_status)==null?void 0:x.name)||"Sin estado"})]})]}),t.assigned_to&&e.jsxs("div",{className:"p-2 bg-light rounded mb-2",children:[e.jsx("h5",{className:"mt-0 mb-2",children:"Atendido por:"}),e.jsxs("div",{className:"d-flex align-items-start",bis_skin_checked:"1",children:[e.jsx("img",{className:"d-flex me-2 rounded-circle",src:`//${T.APP_DOMAIN}/api/profile/thumbnail/${t.assigned.relative_id}`,onError:c=>{c.target.src=`//${T.APP_DOMAIN}/assets/img/user-404.svg`},alt:t.assigned.fullname,height:"32"}),e.jsxs("div",{className:"w-100 overflow-hidden",bis_skin_checked:"1",children:[e.jsx("h5",{className:"m-0 font-14 text-truncate",children:t.assigned.fullname}),e.jsx("span",{className:"font-12 mb-0 text-truncate d-block",children:t.assigned.email})]})]})]}),e.jsx("hr",{className:"mt-0 mb-2"}),e.jsxs("div",{className:"d-flex justify-content-between align-items-center mb-2",children:[e.jsx("h5",{className:"my-0",children:"Actividad"}),e.jsx(se,{content:"Ver más",children:e.jsx("a",{href:`/leads/${t.id}`,className:"text-decoration-none",children:e.jsx("i",{className:"mdi mdi-arrow-top-right"})})})]}),h?e.jsxs("div",{className:"placeholder-glow",children:[e.jsx("div",{className:"placeholder mb-2 w-100 rounded",style:{height:70}}),e.jsx("div",{className:"placeholder mb-2 w-100 rounded",style:{height:140}})]}):m.sort((c,_)=>_.created_at>c.created_at?1:-1).map((c,_)=>e.jsx(Pe,{...c,showOptions:!1,extended:!1},`note-${_}`))]})};function oe(t){var m;return typeof t=="string"?t:Array.isArray(t)?t.map(oe).join(""):(m=t==null?void 0:t.props)!=null&&m.children?oe(t.props.children):""}const ve=new je;ve.paginateSufix=null;const Xe=({users:t,activeLeadId:m,...l})=>{const h=Local.get("adminto_settings")??{},[d,u]=a.useState(h.theme??"light"),[i,o]=a.useState([]),[p,x]=a.useState(m),[c,_]=Le(re.business_id,[re.service_user.id]),[f,I]=a.useState(!1),[j,F]=a.useState(0),[b,C]=a.useState(""),[E,O]=a.useState(null),[k,z]=a.useState(null),{socket:U}=be(),ae=a.useRef(),G=a.useRef(),H=async(n=!1)=>{if(f)return;I(!0);const g={fields:["clients.id","clients.contact_name","clients.contact_phone","clients.last_message","clients.last_message_microtime","clients.assigned_to","clients.status_id","clients.manage_status_id"],withCount:["unSeenMessages"],with:["assigned","status","manageStatus"],sort:[{selector:"last_message_microtime",desc:!0}],skip:0,take:40,requireTotalCount:!0},w=[["clients.last_message_microtime","isnotnull"]];if(c.length&&w.push(le(c.map(y=>["clients.assigned_to","=",y]),"or")),b){const y=[["clients.contact_name","=",b],["clients.contact_name","contains",b],["clients.contact_phone","contains",b]];w.push(le(y,"or"))}if(n&&i.length>0){const y=Math.min(...i.map(P=>P.last_message_microtime));w.push(["clients.last_message_microtime","<",y])}g.filter=le(w,"and");const{data:v,totalCount:R}=await ve.paginate(g);o(n?y=>[...y,...v??[]]:v??[]),F(((v==null?void 0:v.length)??0)+(R??0)),I(!1)},B=n=>{const g=n.target.value;C(g),E&&clearTimeout(E),O(setTimeout(()=>{H(!1)},500))};return a.useEffect(()=>{H(!1)},[c]),a.useEffect(()=>{if(U)return U.on("client.updated",n=>{o(g=>{const w=g.findIndex(v=>v.id===n.id);if(w!==-1){const v=[...g];return v[w]={...v[w],...n},v}return!c.length||c.includes(n.assigned_to)?[...g,n]:g})}),()=>{U.off("client.updated")}},[U,c]),a.useEffect(()=>{const n=G.current;if(!n)return;const g=()=>{n.scrollTop+n.clientHeight>=n.scrollHeight-10&&i.length<j&&H(!0)};return n.addEventListener("scroll",g),()=>n.removeEventListener("scroll",g)},[i,f,c,j,b]),a.useEffect(()=>{p?history.pushState({},"",`/chat/${p}`):history.pushState({},"","/chat")},[p]),e.jsx(Te,{...l,title:"Chat",showTitle:!1,setThemeParent:u,children:e.jsxs("div",{className:"row",children:[e.jsx("div",{className:"col-xl-3 col-lg-4",children:e.jsx("div",{className:"card chat-list-card mb-xl-0",children:e.jsxs("div",{className:"card-body p-0",children:[e.jsx("div",{className:"p-2",children:e.jsxs("div",{className:"d-flex w-100 gap-0 align-items-center scroll-hidden",style:{overflowX:"auto"},children:[t.map(n=>e.jsx(se,{content:`${n.name} ${n.lastname}`,children:e.jsx("div",{onClick:()=>{const g=[...c],w=n.service_user.id,v=g.indexOf(w);v>-1?g.splice(v,1):g.push(w),_(g)},className:`rounded-pill ${c.includes(n.service_user.id)?"bg-purple":""}`,style:{cursor:"pointer",padding:"2px",marginRight:"2px"},children:e.jsx("img",{className:"avatar-xs rounded-circle",src:`//${T.APP_DOMAIN}/api/profile/thumbnail/${n.relative_id}`,onError:g=>{g.target.src=`//${T.APP_DOMAIN}/assets/img/user-404.svg`},alt:n.name,style:{objectFit:"cover",objectPosition:"center"}})})},n.id)),c.length>0&&e.jsx(se,{content:"Limpiar filtros",children:e.jsx("button",{className:"btn btn-xs btn-soft-danger ms-1 rounded-pill",onClick:()=>_([]),children:e.jsx("i",{className:"mdi mdi-trash-can-outline"})})})]})}),e.jsx("div",{className:"p-2 border-top",children:e.jsxs("div",{className:"search-box chat-search-box",children:[e.jsx("input",{type:"text",className:"form-control rounded-pill",placeholder:"Buscar lead por nombre o número...",value:b,onChange:B}),e.jsx("i",{className:"mdi mdi-magnify search-icon"})]})}),e.jsxs("div",{ref:G,className:"scroll-hidden",style:{overflowY:"auto",height:"calc(100vh - 300px)"},children:[e.jsx("ul",{className:"list-unstyled chat-list mb-0",children:i.sort((n,g)=>new Date(g.last_message_microtime)-new Date(n.last_message_microtime)).map(n=>{var P,J,W,Y,q;const g=new Date((n.last_message_microtime??0)/1e3),w=new Date;w.setHours(0,0,0,0);const v=new Date(w);v.setDate(v.getDate()-1);let R;if(g>=w)R=g.toLocaleString("es-ES",{hour:"2-digit",minute:"2-digit"});else if(g>=v)R="Ayer";else{const $=["Domingo","Lunes","Martes","Miércoles","Jueves","Viernes","Sábado"];if(Math.floor((new Date-g)/(1e3*60*60*24))<=6)R=$[g.getDay()];else{const V=String(g.getDate()).padStart(2,"0"),X=String(g.getMonth()+1).padStart(2,"0"),Q=g.getFullYear();R=`${V}/${X}/${Q}`}}let y=n.last_message;if(y.startsWith("/audio:"))y=e.jsxs(e.Fragment,{children:[e.jsx("i",{className:"mdi mdi-microphone"})," Audio"]});else if(y.startsWith("/image:")){const $=String(y.split(`
`).slice(1).join(`
`)||"").trim();y=e.jsxs(e.Fragment,{children:[e.jsx("i",{className:"mdi mdi-image"})," ",$||"Foto"]})}else if(y.startsWith("/document:")){const $=String(y.split(`
`).slice(1).join(`
`)||"").trim();y=e.jsxs(e.Fragment,{children:[e.jsx("i",{className:"mdi mdi-file-document"})," ",$||"Documento"]})}return e.jsx("li",{className:`${n.unread?"unread":""} ${p==n.id?"bg-light":""}`,children:e.jsx("a",{onClick:$=>{x(n.id),$.stopPropagation()},style:{cursor:"pointer"},children:e.jsxs("div",{className:"d-flex",children:[e.jsxs("div",{className:`position-relative flex-shrink-0 chat-user-img ${n.online?"active":""} align-self-center me-2`,children:[e.jsx("img",{src:`/api/whatsapp/profile/${n.contact_phone}`,className:"rounded-circle avatar-sm bg-light",alt:n.name,style:{padding:0,border:"none"},onError:$=>{$.target.src=`//${T.APP_DOMAIN}/assets/img/user-404.svg`}}),n.assigned_to&&((P=n.assigned)==null?void 0:P.relative_id)&&(c.length===0||c.length>1||c[0]!==re.service_user.id)&&e.jsx(se,{content:`${n.assigned.name} ${n.assigned.lastname}`,children:e.jsx("img",{className:"position-absolute rounded-pill",src:`//${T.APP_DOMAIN}/api/profile/thumbnail/${n.assigned.relative_id}`,onError:$=>{$.target.src=`//${T.APP_DOMAIN}/assets/img/user-404.svg`},alt:n.assigned.fullname,style:{right:"-4px",bottom:"-4px",objectFit:"cover",objectPosition:"center",padding:0,border:`2px solid ${d=="light"?"#ffffff":"#313844"}`,width:"18px",aspectRatio:1}})},n.assigned.id)]}),e.jsxs("div",{className:"flex-grow-1 overflow-hidden",children:[e.jsx("h5",{className:`text-truncate font-14 mt-0 mb-0 ${n.un_seen_messages_count>0?"fw-bold":""}`,children:n.contact_name}),e.jsx("p",{className:`text-truncate mb-0 ${n.un_seen_messages_count>0?"fw-bold":""}`,title:oe(y)??void 0,style:{color:n.un_seen_messages_count>0?d=="light"?"#343a40":"#f7f7f7":void 0},children:y??e.jsx("i",{className:"text-muted",children:"Sin mensaje"})}),e.jsxs("div",{className:"d-flex gap-1",children:[e.jsx("span",{className:"badge",style:{backgroundColor:((J=n.status)==null?void 0:J.color)??"#6c757d"},children:((W=n.status)==null?void 0:W.name)??"Sin estado"}),e.jsx("span",{className:"badge",style:{backgroundColor:((Y=n.manage_status)==null?void 0:Y.color)??"#6c757d"},children:((q=n.manage_status)==null?void 0:q.name)??"Sin estado"})]})]}),e.jsxs("div",{className:"d-flex flex-column align-items-end",children:[e.jsx("div",{className:`font-11 ${n.un_seen_messages_count>0?"text-success":""}`,children:R}),n.un_seen_messages_count>0&&e.jsx("span",{className:"badge bg-success rounded-pill mt-1",children:n.un_seen_messages_count})]})]})})},n.id)})}),e.jsxs("div",{className:"text-center py-2",children:[f&&e.jsx("div",{className:"spinner-border spinner-border-sm text-primary",role:"status",children:e.jsx("span",{className:"visually-hidden",children:"Loading contacts..."})}),!f&&i.length>=j&&i.length>0&&e.jsx("span",{className:"text-muted",children:"No hay más contactos"})]})]})]})})}),e.jsx("div",{className:`col-xl-${k?6:9} col-lg-${k?8:12}`,children:e.jsx("div",{className:"conversation-list-card card",children:p?e.jsx(e.Fragment,{children:e.jsx(Ge,{leadId:p,setLeadId:x,containerRef:ae,theme:d,contactDetails:k,setContactDetails:z})}):e.jsx("div",{className:"card-body d-flex align-items-center justify-content-center",style:{height:"calc(100vh - 184px)"},children:e.jsxs("div",{className:"text-center",children:[e.jsx("img",{src:"/assets/img/icon.svg",alt:`Logo ${T.APP_NAME}`,className:"mb-2",style:{width:60,height:60,objectFit:"contain"}}),e.jsxs("h4",{className:"text-muted",children:["Módulo de chat de ",T.APP_NAME]}),e.jsx("p",{className:"text-muted",children:"Selecciona un contacto para empezar a interactuar"})]})})})}),k&&e.jsx("div",{className:"col-xl-3 col-lg-12",children:e.jsx("div",{className:"card contact-details-card mb-xl-0",children:e.jsx("div",{className:"card-body scroll-hidden",style:{height:"calc(100vh - 186px)",overflowY:"auto"},children:e.jsx(Ve,{...k})})})})]})})};Me((t,m)=>{De(t).render(e.jsx(Xe,{...m}))});
