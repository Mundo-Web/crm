import{S as J,A as re,i as M}from"./Adminto-BlzcUb4S.js";import{r as n,R as e,C as se,c as ce}from"./CreateReactScript-Cr76lECz.js";import{M as U,T as z}from"./TextareaFormGroup-DpQiZCGF.js";import{C as F,a as oe,L as ie}from"./LeadsRest-DlxOf-26.js";import{I as v}from"./InputFormGroup-DfllSyoc.js";import{S as I,a as me}from"./SetSelectValue-CfjBp_ib.js";import{D as B}from"./DropdownItem-Dd6zonp_.js";import{D as ue}from"./DropdownEnd-CXnHC35Z.js";import{P as de,A as fe}from"./AssignUsersModal-D1FeFNQZ.js";import{P as pe}from"./ProjectStatusDropdown-CenSfql4.js";import{R as b}from"./ReactAppend-BUdEshxq.js";import{P as Ee,A as be,N as ge,D as ve}from"./Assigneds-DyTBt26D.js";import{T as he}from"./Table-DyL-cwJJ.js";import{T as g}from"./TippyButton-v15Bj3sT.js";import{D as we}from"./DxBox-CyhaKWwR.js";import{D as W}from"./Dropdown-HnL06DgH.js";import"./server.browser-Dt1gYAOJ.js";const Ne=({can:h,client:r,setClient:G,grid2refresh:A,page:c})=>{const x=n.useRef(),o=n.useRef(),f=n.useRef(),m=n.useRef(),p=n.useRef(),E=n.useRef(),[C,w]=n.useState([]),[D,y]=n.useState(!1);n.useEffect(()=>{r.id&&_(),$(x.current).on("hidden.bs.modal",()=>{G({}),w([]),y(!1),f.current.value=null,I(m.current,null,null),p.current.value=null,E.current.value=null})},[r]);const _=async()=>{const l=await F.byClient(r==null?void 0:r.id);w(l),$(x.current).modal("show")},S=async l=>{l.preventDefault();const u={id:f.current.value||void 0,type_id:m.current.value,client_id:r.id,name:p.current.value,description:E.current.value};await F.save(u)&&($(o.current).modal("hide"),f.current.value=null,I(m.current,null,null),p.current.value=null,E.current.value=null,await R(),$(A.current).dxDataGrid("instance").refresh())},R=async()=>{const l=await F.byClient(r.id);w(l)},L=async l=>{f.current.value=l.id,I(m.current,l.type.id,l.type.name),p.current.value=l.name,E.current.value=l.description,$(o.current).modal("show"),y(!0)},k=async l=>{const{isConfirmed:u}=await J.fire({title:"Estas seguro de eliminar esta nota?",text:"No podras revertir esto!",icon:"warning",showCancelButton:!0,confirmButtonText:"Continuar",cancelButtonText:"Cancelar"});!u||!await F.delete(l)||(await R(),$(A.current).dxDataGrid("instance").refresh())};return e.createElement(e.Fragment,null,e.createElement(U,{modalRef:x,title:`Notas de ${(r==null?void 0:r.tradename)||(r==null?void 0:r.name)||(r==null?void 0:r.contact_name)}`,size:"full-width",isStatic:!0,hideFooter:!0},e.createElement("div",{style:{height:"calc(100vh - 180px)",overflowY:"auto"}},e.createElement("div",{className:"text-center"},e.createElement("button",{className:"btn btn-primary",type:"button",onClick:()=>$(o.current).modal("show")},"Agregar nota")),e.createElement("hr",{className:"my-2"}),e.createElement("div",{className:"d-flex flex-wrap flex-row justify-content-center gap-2"},C.sort((l,u)=>new Date(u.created_at)-new Date(l.created_at)).map((l,u)=>{const N=moment(l.created_at),O=moment().diff(N,"hours")>12?N.format("lll"):N.fromNow();return e.createElement("div",{key:`note-${u}`,className:"card text-white bg-purple mb-0",style:{width:"100%",maxWidth:"300px",height:"max-content"}},e.createElement("div",{className:"card-body p-2"},e.createElement("div",{className:"d-flex align-items-center border-bottom border-white pb-1 mb-1"},e.createElement("div",{className:"avatar-sm me-2 mb-1"},e.createElement("img",{src:`/api/profile/thumbnail/${l.user.relative_id}?v=${new Date(l.user.updated_at).getTime()}`,className:"img-fluid rounded-circle",alt:"user"})),e.createElement("div",{className:"flex-grow-1 overflow-hidden"},e.createElement("h5",{className:"text-white m-0"},l.user.name," ",l.user.lastname),e.createElement("p",{className:"text-white-50 m-0 font-13 text-truncate"},O)),h(c,"root","all","editnotes","deletenotes")&&e.createElement(ue,null,h(c,"root","all","editnotes")&&e.createElement(B,{onClick:()=>L(l)},"Editar"),h(c,"root","all","deletenotes")&&e.createElement(B,{onClick:()=>k(l.id)},"Eliminar"))),e.createElement("blockquote",{className:"card-bodyquote mb-0"},l.name&&e.createElement("b",null,l.name),e.createElement("p",{className:"mb-1"},l.description))))})))),e.createElement(U,{modalRef:o,title:D?"Editar nota":"Agregar nota",size:"sm",onSubmit:S},e.createElement("div",{id:"note-crud-container"},e.createElement("input",{ref:f,type:"hidden"}),e.createElement(me,{eRef:m,label:"Tipo de nota",col:"col-12",dropdownParent:"#note-crud-container",searchAPI:"/api/types/paginate",searchBy:"name",filter:["table_id","=","c81ad4fb-a895-4f4c-b4b3-5989a7a66a85"],required:!0}),e.createElement(v,{eRef:p,label:"Titulo de la nota"}),e.createElement(z,{eRef:E,label:"Descripcion de la nota",required:!0}))))},T=new oe,Y=new ie,ye=({projectStatuses:h,clientStatuses:r,manageStatuses:G,session:A,can:c,defaultClientStatus:x})=>{const o=n.useRef(),f=n.useRef(),m=n.useRef(),p=n.useRef(),E=n.useRef(),C=n.useRef(),w=n.useRef(),D=n.useRef(),y=n.useRef(),_=n.useRef(),S=n.useRef(),R=n.useRef(),[L,k]=n.useState(!1),[l,u]=n.useState({}),[N,P]=n.useState({}),[j,O]=n.useState({}),[K,Q]=n.useState({});n.useState([]);const V=t=>{t!=null&&t.id?k(!0):k(!1),$('[href="#client-data"]').addClass("active"),$('[href="#contact-data"]').removeClass("active"),$("#client-data").addClass("active"),$("#contact-data").removeClass("active"),m.current.value=(t==null?void 0:t.id)||null,p.current.value=(t==null?void 0:t.ruc)||null,E.current.value=(t==null?void 0:t.name)||null,C.current.value=(t==null?void 0:t.tradename)||null,w.current.value=(t==null?void 0:t.web_url)||null,D.current.value=(t==null?void 0:t.message)||"Cliente creado desde Atalaya",y.current.value=(t==null?void 0:t.contact_name)||null,_.current.value=(t==null?void 0:t.contact_phone)||null,S.current.value=(t==null?void 0:t.contact_email)||null,R.current.value=(t==null?void 0:t.contact_address)||null,$(f.current).modal("show")},X=async t=>{t.preventDefault();const a={id:m.current.value||void 0,ruc:p.current.value,name:E.current.value,tradename:C.current.value,web_url:w.current.value,message:D.current.value??"Cliente creado desde Atalaya",contact_name:y.current.value??"",contact_phone:_.current.value??"",contact_email:S.current.value??"",contact_address:R.current.value??"",status_id:m.current.value?void 0:x};await T.save(a)&&($(o.current).dxDataGrid("instance").refresh(),$(f.current).modal("hide"))},Z=async t=>{const{isConfirmed:a}=await J.fire({title:"Estas seguro de eliminar este lead?",text:"No podras revertir esta accion!",icon:"warning",showCancelButton:!0,confirmButtonText:"Continuar",cancelButtonText:"Cancelar"});!a||!await T.delete(t)||$(o.current).dxDataGrid("instance").refresh()},H=async(t,a)=>{await T.assign(t,a)&&$(o.current).dxDataGrid("instance").refresh()},ee=async(t,a)=>{await Y.leadStatus({lead:t,status:a}),$(o.current).dxDataGrid("instance").refresh()},te=async(t,a)=>{await Y.manageStatus({lead:t.id,status:a.id}),$(o.current).dxDataGrid("instance").refresh()};return e.createElement(e.Fragment,null,e.createElement(he,{gridRef:o,title:"Clientes",rest:T,toolBar:t=>{t.unshift({widget:"dxButton",location:"after",options:{icon:"refresh",hint:"Refrescar tabla",onClick:()=>$(o.current).dxDataGrid("instance").refresh()}}),c("clients","root","all","create")&&t.unshift({widget:"dxButton",location:"after",options:{icon:"plus",hint:"Nuevo registro",onClick:()=>V()}})},columns:[c("projects","root","all","list")?{dataField:"id",caption:"ID",dataType:"number",cellTemplate:(t,{data:a,value:i,...d})=>{b(t,e.createElement(g,{className:"btn btn-xs btn-white",title:`Ver ${a.projects_count} proyectos`,onClick:()=>{d.component.collapseAll(-1),d.component.expandRow(d.row.data)}},e.createElement("i",{className:"fas fa-shapes"})," ",a.projects_count))},sortOrder:"desc"}:null,{dataField:"ruc",caption:"RUC"},{dataField:"tradename",caption:"Nombre comercial",width:250,cellTemplate:(t,{data:a})=>{b(t,e.createElement("div",{className:"d-flex align-items-center"},a.assigned_to&&e.createElement(M,{content:`Atendido por ${a.assigned.name} ${a.assigned.lastname}`},e.createElement("img",{className:"avatar-xs rounded-circle me-1",src:`/api/profile/thumbnail/${a.assigned.relative_id}`,alt:a.assigned.name})),e.createElement("div",null,a.tradename)))}},{dataField:"name",caption:"Razon social",visible:!1},{dataField:"contact_name",caption:"Nombre de contacto"},{dataField:"contact_phone",caption:"Telefono"},{dataField:"contact_email",caption:"Correo"},c("leads","root","all","changestatus")?{dataField:"status.name",caption:"Estado del cliente",dataType:"string",cellTemplate:(t,{data:a})=>{t.attr("style","overflow: visible"),b(t,e.createElement(W,{className:"btn btn-xs btn-white rounded-pill",title:a.status.name,icon:{icon:"fa fa-circle",color:a.status.color},tippy:"Actualizar estado"},r.map(({id:i,name:d,color:s})=>e.createElement(B,{key:i,onClick:()=>ee(a.id,i)},e.createElement("i",{className:"fa fa-circle",style:{color:s}})," ",d))))}}:null,c("leads","root","all","changestatus")?{dataField:"manage_status.name",caption:"Estado de gestion",dataType:"string",cellTemplate:(t,{data:a})=>{var i,d;t.attr("style","overflow: visible"),b(t,e.createElement(W,{className:"btn btn-xs btn-white rounded-pill",title:(i=a==null?void 0:a.manage_status)==null?void 0:i.name,icon:{icon:"fa fa-circle",color:(d=a==null?void 0:a.manage_status)==null?void 0:d.color},tippy:"Actualizar estado"},G.map((s,q)=>e.createElement(B,{key:`status-${q}`,onClick:()=>te(a,s)},e.createElement("i",{className:"fa fa-circle",style:{color:s.color}})," ",s.name))))}}:null,c("projects","root","all","list","update","changestatus","delete")?{caption:"Acciones",width:235,cellTemplate:(t,{data:a})=>{t.attr("style","display: flex; gap: 4px; overflow: visible"),c("clients","root","all","update")&&b(t,e.createElement(g,{className:"btn btn-xs btn-soft-primary",title:"Editar",onClick:()=>V(a)},e.createElement("i",{className:"fa fa-pen"}))),a.assigned_to?a.assigned_to==A.id&&b(t,e.createElement(g,{className:"btn btn-xs btn-soft-danger",title:"Dejar de atender",onClick:()=>H(a.id,!1)},e.createElement("i",{className:"fas fa-hands-wash"}))):b(t,e.createElement(g,{className:"btn btn-xs btn-soft-dark",title:"Atender lead",onClick:()=>H(a.id,!0)},e.createElement("i",{className:"fas fa-hands-helping"}))),c("clients","root","all","delete")&&b(t,e.createElement(g,{className:"btn btn-xs btn-soft-danger",title:"Eliminar",onClick:()=>Z(a.id)},e.createElement("i",{className:"fa fa-trash-alt"})))},allowFiltering:!1,allowExporting:!1}:null],masterDetail:{enabled:!1,template:async(t,{data:a,component:i})=>{t.css("padding","10px"),t.css("overflow","visible"),t.css("background-color","#323a46");let{data:d}=await Ee.paginate({filter:["client_id","=",a.id],isLoadingAll:!0});t.append(we([e.createElement(e.Fragment,null,e.createElement(g,{title:"Cerrar tabla",className:"btn btn-xs btn-soft-danger waves-effect mb-1",onClick:()=>i.collapseAll(-1)},e.createElement("i",{className:"fa fa-times"})),e.createElement("table",{className:"table table-dark table-sm table-bordered mb-0",style:{width:"100%"}},e.createElement("thead",null,e.createElement("tr",null,e.createElement("th",{scope:"col"},"Tipo"),e.createElement("th",{scope:"col"},"Asignados"),e.createElement("th",{scope:"col"},"Costo"),e.createElement("th",{scope:"col"},"Pagos"),e.createElement("th",{scope:"col"},"Fecha de desarrollo"),e.createElement("th",{scope:"col"},"Estado del proyecto"),e.createElement("th",{scope:"col"},"Acciones"))),e.createElement("tbody",null,d.map(s=>{const q=(s.total_payments/s.cost*100).toFixed(2),ae=Number(s.total_payments).toLocaleString("en-US",{maximumFractionDigits:2,minimumFractionDigits:2}),le=Number(s.cost-s.total_payments).toLocaleString("en-US",{maximumFractionDigits:2,minimumFractionDigits:2}),ne=(s.users||"").split("|").filter(Boolean);return e.createElement("tr",{key:`project-${s.id}`},e.createElement("td",{valign:"middle"},s.type.name),e.createElement("td",{valign:"middle"},be(ne)),e.createElement("td",{valign:"middle"},`S/. ${ge(s.cost)}`),e.createElement("td",{valign:"middle"},e.createElement("p",{className:"mb-0 d-flex justify-content-between"},e.createElement("b",{className:"text-success"},e.createElement("i",{className:"fa fa-arrow-circle-up"})," S/. ",ae),e.createElement("b",{className:"float-end text-danger"},e.createElement("i",{className:"fa fa-arrow-circle-down"})," S/. ",le)),e.createElement("div",{className:"progress progress-bar-alt-primary progress-sm mt-0 mb-0",style:{width:"200px"}},e.createElement("div",{className:"progress-bar bg-primary progress-animated wow animated",role:"progressbar","aria-valuenow":s.total_payments,"aria-valuemin":"0","aria-valuemax":s.cost,style:{width:`${q}%`,visibility:"visible",animationName:"animationProgress"}}))),e.createElement("td",{valign:"middle"},ve(s.starts_at,s.ends_at)),e.createElement("td",{valign:"middle"},e.createElement(pe,{can:c,statuses:h,data:s,onChange:()=>{$(o.current).dxDataGrid("instance").refresh()}})),e.createElement("td",null,c("projects","root","all","assignUsers")&&e.createElement(g,{className:"btn btn-xs btn-soft-info me-1",title:"Asignar usuarios",icon:"fa fa-user-plus",onClick:()=>P(s)},e.createElement("i",{className:"fa fa-user-plus"})),c("projects","root","all","addpayment")&&e.createElement(g,{className:"btn btn-xs btn-soft-success",title:"Ver/Agregar pagos",icon:"fas fa-money-check-alt",onClick:()=>u(s)},e.createElement("i",{className:"fas fa-money-check-alt"}))))}))))]))}}}),e.createElement(U,{modalRef:f,title:L?"Editar cliente":"Agregar cliente",onSubmit:X,size:"md"},e.createElement("input",{ref:m,type:"hidden"}),e.createElement("ul",{className:"nav nav-pills navtab-bg nav-justified"},e.createElement("li",{className:"nav-item"},e.createElement(M,{content:"Datos del negocio"},e.createElement("a",{href:"#client-data","data-bs-toggle":"tab","aria-expanded":"false",className:"nav-link active"},"Negocio"))),e.createElement("li",{className:"nav-item"},e.createElement(M,{content:"Datos de contacto"},e.createElement("a",{href:"#contact-data","data-bs-toggle":"tab","aria-expanded":"true",className:"nav-link"},"Contacto")))),e.createElement("div",{className:"tab-content"},e.createElement("div",{className:"tab-pane active",id:"client-data"},e.createElement("div",{className:"row"},e.createElement(v,{eRef:p,label:"RUC",col:"col-4",required:!0}),e.createElement(v,{eRef:C,label:"Nombre comercial",col:"col-8",required:!0}),e.createElement(v,{eRef:E,label:"Razon social",col:"col-md-6",required:!0}),e.createElement(v,{eRef:w,label:"URL Web",col:"col-md-6"}),e.createElement(z,{eRef:D,label:"Mensaje",col:"col-12",required:!0}))),e.createElement("div",{className:"tab-pane show",id:"contact-data"},e.createElement("div",{className:"row"},e.createElement(v,{eRef:y,label:"Nombre de contacto",col:"col-6"}),e.createElement(v,{eRef:_,label:"Celular de contacto",type:"tel",col:"col-6"}),e.createElement(v,{eRef:S,label:"Email de contacto",col:"col-12",type:"email"}),e.createElement(z,{eRef:R,label:"Direccion de contacto",col:"col-12"}))))),e.createElement(de,{can:c,dataLoaded:l,setDataLoaded:u,grid2refresh:j}),e.createElement(Ne,{can:c,client:K,setClient:Q,grid2refresh:o,page:"clients"}),e.createElement(fe,{dataLoaded:N,setDataLoaded:P,grid2refresh:$(o.current).dxDataGrid("instance")}))};se((h,r)=>{if(!r.can("clients","root","all","list"))return location.href="/";ce(h).render(e.createElement(re,{...r,title:"Clientes"},e.createElement(ye,{...r})))});
