import{j as e,G as A,r as a,C as Re,c as $e,L as ne}from"./CreateReactScript-DEiMbi6B.js";import{W as Ee,M as De,u as xe,i as Q,a as Le,A as Me}from"./Adminto-lUnuPBnJ.js";import{L as pe}from"./LeadsRest-z3cA1exe.js";import{H as Ae,C as Te,a as Fe}from"./ClientNotesRest-XbJtIw03.js";import{w as Pe,A as ie}from"./ArrayJoin-6-TTvUmN.js";import"./Logout-DAQhHADr.js";import"./sweetalert2.esm.all-B5d0Dmk7.js";const He=({contact:i,contactDetails:r,setContactDetails:L,loading:g,theme:v})=>e.jsx("div",{className:`card-header ${v=="light"?"bg-white":"bg-light"}`,style:{cursor:"pointer"},onClick:()=>(i==null?void 0:i.id)&&L(r?null:i),children:e.jsxs("div",{className:"d-flex align-items-center",children:[!g&&i&&e.jsx("img",{src:`/api/whatsapp/profile/${i.contact_phone}`,className:"rounded-circle avatar-sm bg-light me-2",alt:i.contact_name,style:{padding:0,border:"none"},onError:f=>{f.target.src=`//${A.APP_DOMAIN}/assets/img/user-404.svg`}}),g&&e.jsx("div",{className:"placeholder-glow",children:e.jsx("div",{className:"rounded-circle avatar-sm me-2 placeholder",style:{width:36,height:36}})}),e.jsxs("div",{className:`flex-grow-1 ${g?"placeholder-glow":""}`,children:[e.jsx("h5",{className:`mt-0 mb-1 text-truncate ${g?"placeholder col-3":""}`,children:i==null?void 0:i.contact_name}),e.jsxs("p",{className:`d-block font-13 text-muted mb-0 ${g?"placeholder col-2":""}`,children:[e.jsx("i",{className:"mdi mdi-phone me-1 font-11"}),i==null?void 0:i.contact_phone]})]}),!g&&i&&e.jsx("div",{className:"ms-2",children:e.jsx("i",{className:`mdi mdi-24px mdi-chevron-double-${r?"right":"left"} text-muted`})})]})}),Ie=({fromMe:i,theme:r,url:L,time:g})=>{const[v,f]=a.useState(!1),[c,h]=a.useState(0),[N,k]=a.useState(0),o=a.useRef(null),y=()=>{const u=o.current;u&&(v?u.pause():u.play(),f(!v))};a.useEffect(()=>{const u=o.current;if(!u)return;const H=()=>h(Math.floor(u.duration)),x=()=>k(Math.floor(u.currentTime)),I=()=>{f(!1),k(0)};return u.addEventListener("loadedmetadata",H),u.addEventListener("timeupdate",x),u.addEventListener("ended",I),()=>{u.removeEventListener("loadedmetadata",H),u.removeEventListener("timeupdate",x),u.removeEventListener("ended",I)}},[]);const d=c?N/c*100:0,U=u=>{const H=Math.floor(u/60),x=u%60;return`${H}:${x<10?"0":""}${x}`};return e.jsxs("div",{className:`ctext-wrap d-flex align-items-start ${i?`message-out-${r}`:`message-in-${r}`}`,style:{minWidth:"240px",maxWidth:"320px",padding:"6px 8px"},children:[e.jsxs("div",{className:"flex-grow-1",children:[e.jsxs("div",{className:"d-flex align-items-center mb-1",children:[e.jsx("button",{onClick:y,className:"btn btn-sm d-flex align-items-center justify-content-center rounded-circle me-2 p-0",style:{width:"32px",height:"32px",border:"none",color:r=="dark"?"#fff":"#6f8171",flexShrink:0},children:e.jsx("i",{className:`mdi mdi-${v?"pause":"play"}`,style:{fontSize:"24px"}})}),e.jsx("div",{className:"flex-grow-1",style:{height:"4px",backgroundColor:r=="dark"?"#ffffff55":"#6f817155",borderRadius:"2px",position:"relative"},children:e.jsx("div",{style:{height:"100%",width:`${d}%`,backgroundColor:r=="dark"?"#fff":"#6f8171",borderRadius:"2px",transition:"width 0.2s ease"}})})]}),e.jsxs("div",{className:"d-flex justify-content-between align-items-center px-1",style:{fontSize:"10px"},children:[e.jsx("span",{children:U(c)}),e.jsx("span",{className:"time mt-0 float-end",style:{fontSize:"10px",marginLeft:"6px",marginTop:"8px !important"},children:g})]})]}),e.jsx("audio",{ref:o,src:L,preload:"metadata"})]})},Oe=({key:i,message:r,isLast:L=!1,fromMe:g,marginTop:v,theme:f})=>{var N;let c=((N=r.message)==null?void 0:N.replace(/\{\{.*?\}\}/gs,""))||"",h="";return c.startsWith("/attachment:")&&(h=c.split(`
`)[0],c=c.replace(h,"")),r.role=="Form"?e.jsx("li",{children:e.jsx("div",{className:"chat-day-title mt-3 mb-0",children:e.jsx("small",{className:"title badge badge-soft-dark rounded-pill",children:c})})},i):e.jsx("li",{className:`${g?"odd":""} ${v?"":"hide-after"}`,style:{marginBottom:L?"0px":"24px",marginTop:v?"12px":"3px"},children:e.jsx("div",{className:"message-list",children:e.jsx("div",{className:"conversation-text",children:c.startsWith("/audio:")?e.jsx(Ie,{avatar:`/api/whatsapp/profile/${r.wa_id}`,fromMe:g,theme:f,url:c.replace("/audio:","/storage/images/whatsapp/"),time:moment(r.created_at).subtract(5,"hours").format("HH:mm")}):e.jsxs("div",{className:`ctext-wrap ${g?`message-out-${f}`:`message-in-${f}`}`,style:{boxShadow:"rgba(11, 20, 26, 0.13) 0px 1px 0.5px 0px",padding:"6px 8px"},children:[r.campaign&&e.jsxs("div",{className:"rounded p-2 mb-2",style:{backgroundColor:"rgba(240, 240, 240, 0.125)",cursor:r.campaign.link?"pointer":"default",maxWidth:"240px"},onClick:()=>{r.campaign.link&&window.open(r.campaign.link,"_blank")},children:[e.jsxs("div",{className:"d-flex gap-1",style:{maxWidth:"100%"},children:[e.jsx("div",{className:"fw-bold",children:r.campaign.code}),e.jsx("div",{className:"small text-truncate",children:r.campaign.title})]}),e.jsx("small",{className:"d-block text-truncate",style:{maxWidth:300},children:r.campaign.link})]}),h&&e.jsxs(e.Fragment,{children:[e.jsx("img",{src:h.replace("/attachment:",""),className:"mb-1",alt:"attachment",style:{minWidth:"300px",width:"100%",maxWidth:"100%",minHeight:"200px",maxHeight:"300px",borderRadius:"4px",objectFit:"cover"},onError:k=>{const o=k.target;o&&o.parentNode&&(o.style.display="none")}}),e.jsx("div",{className:"d-flex justify-content-end",children:e.jsxs("a",{className:"btn btn-xs btn-light mb-1 text-nowrap d-flex text-end",href:h.replace("/attachment:",""),target:"_blank",rel:"noreferrer",download:!0,children:[e.jsx("i",{className:"mdi mdi-download me-1"}),e.jsx("span",{children:"Descargar adjunto"})]})}),!c.trim()&&e.jsx("span",{className:"time mt-0 float-end",style:{fontSize:"10px",marginLeft:"6px",marginTop:"8px !important"},children:moment(r.created_at).subtract(5,"hours").format("HH:mm")})]}),c.trim()&&e.jsx(Ae,{className:"text-start font-14",html:Pe(c+`<span class="time mt-0 float-end" style="font-size: 10px; margin-left: 6px; margin-top: 8px !important">${moment(r.created_at).subtract(5,"hours").format("HH:mm")}</span>`)})]})})})},i)},ue=new Ee,he=new De,Ue=new pe,ze=({leadId:i,theme:r,contactDetails:L,setContactDetails:g})=>{const v=a.useRef(),f=a.useRef(),c=a.useRef(),h=a.useRef(),N=a.useRef(),k=a.useRef(),o=a.useRef(),y=a.useRef(),[d,U]=a.useState(null),[u,H]=a.useState(!0),[x,I]=a.useState([]),[T,V]=a.useState(!0),{socket:F}=xe(),[P,z]=a.useState(!1),[W,q]=a.useState(!1),[R,J]=a.useState(null),[t,l]=a.useState(null),[b,p]=a.useState(""),[M,w]=a.useState(!1),[S,K]=a.useState(null),[O,B]=a.useState(null),[$,X]=a.useState(!1),[Z,ee]=a.useState(3),[Y,se]=a.useState([]),te=a.useRef(!1);a.useEffect(()=>()=>{t&&URL.revokeObjectURL(t)},[t]),a.useEffect(()=>()=>{S&&S.getTracks().forEach(s=>s.stop())},[S]),a.useEffect(()=>{if(!T)return;const s=setInterval(()=>{const n=3+Math.floor(Math.random()*5);ee(n),se(Array.from({length:n},()=>Math.random()>.5))},1500);return()=>clearInterval(s)},[T]);const re=(s=!0)=>{const n=y.current;n&&n.scrollTo({top:n.scrollHeight,behavior:s?"smooth":"auto"})},fe=()=>{const s=y.current;return s?s.scrollTop+s.clientHeight>=s.scrollHeight-60:!0};a.useEffect(()=>{!T&&x.length&&re(!1)},[T,x.length]),a.useEffect(()=>{if(!(!F||!d))return F.on("message.created",s=>{if(s.wa_id!=(d==null?void 0:d.contact_phone))return;const{id:n,microtime:m}=s;I(j=>j.find(D=>D.id===n)?j.map(D=>D.id===n?{...D,...s}:D):[...j,s].sort((D,C)=>D.microtime-C.microtime));const _=x.reduce((j,E)=>Math.max(j,E.microtime),0);m>_&&ke(m),fe()&&!te.current&&setTimeout(()=>re(!0),100)}),()=>{F.off("message.created")}},[F,d,x]),a.useEffect(()=>{if(T)return;const s=y.current;if(!s)return;const n=()=>{s.scrollTop===0&&(te.current=!0,me())};return s.addEventListener("scroll",n),()=>s.removeEventListener("scroll",n)},[y,T]),a.useEffect(()=>{const s=n=>{o.current&&!o.current.contains(n.target)&&w(!1)};return document.addEventListener("mousedown",s),()=>document.removeEventListener("mousedown",s)},[]),a.useEffect(()=>{$&&S&&N.current&&(N.current.srcObject=S)},[$,S]);const be=async()=>{try{const s=await navigator.mediaDevices.getUserMedia({audio:!0}),n=new MediaRecorder(s),m=[];n.ondataavailable=_=>m.push(_.data),n.onstop=()=>{const _=new Blob(m,{type:"audio/mp3"});J(_),l(URL.createObjectURL(_)),s.getTracks().forEach(j=>j.stop())},n.start(),h.current=n,q(!0)}catch(s){console.error("Error accessing microphone:",s)}},je=()=>{h.current&&h.current.state!=="inactive"&&h.current.stop(),q(!1)},le=()=>{h.current&&h.current.state!=="inactive"&&h.current.stop(),q(!1),J(null),t&&URL.revokeObjectURL(t),l(null)},oe=async s=>{if(s.preventDefault(),!d)return;const n=b.trim();!n&&!R&&!O||(z(!0),R?(console.warn("Audio upload not implemented yet"),console.log(R),await ue.sendAudio(d.id,R)):O?console.warn("Camera image upload not implemented yet"):await ue.send(d.id,n),p(""),J(null),t&&URL.revokeObjectURL(t),l(null),B(null),X(!1),z(!1))},Ne=s=>{s.target.files[0]&&(console.warn("File upload not implemented yet"),s.target.value="")},ve=async()=>{try{const s=await navigator.mediaDevices.getUserMedia({video:!0});K(s),X(!0),w(!1)}catch(s){console.error("Error accessing camera:",s)}},ce=()=>{S&&(S.getTracks().forEach(s=>s.stop()),K(null)),X(!1),B(null)},ye=()=>{const s=k.current,n=N.current;if(!s||!n)return;s.width=n.videoWidth,s.height=n.videoHeight,s.getContext("2d").drawImage(n,0,0),s.toBlob(_=>{B(_),ce()},"image/jpeg",.95)},we=()=>b.trim()||R||O;let de=!1;const _e=async()=>{H(!0);const s=await Ue.get(i);if(H(!1),!s){U(null),g(null);return}U(s)},me=async()=>{var j;if(!d||!i)return;const s=y.current,n=s?s.scrollHeight:0,m=x.filter(E=>E.wa_id==d.contact_phone).sort((E,G)=>E.microtime-G.microtime)[0]??{microtime:(Date.now()+5*60*60*1e3)*1e3};V(!0);const _=await he.paginate({summary:{contact_phone:d.contact_phone},filter:[["microtime","<",m.microtime],"and",["wa_id","contains",d.contact_phone]],sort:[{selector:"microtime",desc:!0}],skip:0,take:40});if(V(!1),((j=_.data)==null?void 0:j.length)>0){if(I(E=>{const G=new Set(E.map(C=>C.id));return[...(_.data??[]).filter(C=>!G.has(C.id)),...E].sort((C,ae)=>C.microtime-ae.microtime)}),s){const E=s.scrollHeight;s.scrollTop=E-n}te.current=!1}},ke=async s=>{d&&await he.paginate({summary:{contact_phone:d.contact_phone},filter:[["microtime","<=",s],"and",["wa_id","contains",d.contact_phone]],sort:[{selector:"microtime",desc:!0}],skip:0,take:40})};a.useEffect(()=>{U(null),g(null),I([]),i&&_e()},[i]),a.useEffect(()=>{I([]),!(!i&&!d)&&me()},[d,i]);const Se=()=>e.jsx(e.Fragment,{children:Array.from({length:Z}).map((s,n)=>{const m=1+Math.floor(Math.random()*3);return e.jsx("li",{className:Y[n]?"odd":"",style:{marginBottom:n<Z-1?"0px":"24px",marginTop:n>0&&Y[n]===Y[n-1]?"3px":"12px"},children:e.jsx("div",{className:"message-list",children:e.jsx("div",{className:"conversation-text",children:e.jsx("div",{className:`ctext-wrap ${Y[n]?`message-out-${r}`:`message-in-${r}`}`,style:{boxShadow:"rgba(11, 20, 26, 0.13) 0px 1px 0.5px 0px",padding:"6px 8px",width:`${300+300*(m-1)/6}px`},children:e.jsxs("div",{className:"placeholder-glow",children:[Array.from({length:m}).map((_,j)=>e.jsx("span",{className:`placeholder ${j===m-1?"col-6 ms-0":"col-12"} `},j)),e.jsx("span",{className:"placeholder time float-end col-1",style:{fontSize:"10px",marginLeft:"6px",marginTop:"8px !important"}})]})})})})},n)})}),Ce=()=>e.jsxs("div",{className:"d-flex flex-column align-items-center justify-content-center text-center px-4",style:{height:"calc(100vh - 260px)"},children:[e.jsx("div",{className:"mb-3",children:e.jsx("i",{className:"mdi mdi-account-off-outline text-muted",style:{fontSize:"4rem"}})}),e.jsx("h5",{className:"text-muted mb-2",children:"Este contacto no existe en la empresa seleccionada"}),e.jsx("p",{className:"text-muted mb-3",children:"Por favor, elige otro contacto desde la lista o intenta refrescar la página si crees que debería estar aquí."}),e.jsxs("button",{className:"btn btn-outline-primary",onClick:()=>window.location.reload(),children:[e.jsx("i",{className:"mdi mdi-refresh me-1"}),"Refrescar página"]})]});return e.jsxs(e.Fragment,{children:[e.jsx(He,{contact:d,contactDetails:L,setContactDetails:g,loading:u,theme:r}),e.jsxs("div",{className:"card-body p-0 position-relative border",style:{backgroundColor:r=="light"?"rgb(245, 241, 235)":"rgb(22, 23, 23)"},children:[e.jsx("div",{className:"position-absolute",style:{top:0,right:0,bottom:0,left:0,backgroundImage:"url(/assets/img/doodles.png)",backgroundRepeat:"repeat",zIndex:0,opacity:r=="light"?1:.0625}}),e.jsx("section",{className:"d-flex flex-column position-relative",style:{height:"calc(100vh - 260px)",zIndex:1},children:!d&&!u?Ce():e.jsxs(e.Fragment,{children:[e.jsxs("ul",{ref:y,className:"conversation-list flex-grow-1 px-3 pt-3 scroll-hidden",style:{overflowY:"auto",scrollBehavior:"smooth",position:"relative"},children:[T&&x.length===0&&Se(),x.map((s,n)=>{const m=s.role!=="Human",_=de!==m;de=m;const j=new Date(s.microtime/1e3),G=new Date-j,D=Math.floor(G/(1e3*60*60*24));let C=null;D===0?C="Hoy":D===1?C="Ayer":D<=6?C=["Domingo","Lunes","Martes","Miércoles","Jueves","Viernes","Sábado"][j.getDay()]:C=`${j.getDate()}/${j.getMonth()+1}/${j.getFullYear()}`;const ae=n===0||new Date(x[n-1].microtime/1e3).toDateString()!==j.toDateString();return e.jsxs(e.Fragment,{children:[ae&&e.jsx("li",{className:"text-center py-1 px-2 mx-auto",style:{position:"sticky",top:0,zIndex:10,width:"max-content"},children:e.jsx("span",{className:"badge text-muted",style:{width:"68px",backgroundColor:r=="dark"?"rgb(36, 38, 38)":"rgb(217, 253, 211)"},children:C})},`date-${n}`),e.jsx(Oe,{isLast:n<x.length-1,message:s,fromMe:m,marginTop:_,theme:r},n)]})})]}),e.jsx("form",{className:"p-2 pt-0 conversation-input",onSubmit:oe,children:e.jsxs("label",{className:`row g-0 align-items-end p-1 ${r=="dark"?"bg-light":"bg-white"}`,htmlFor:"message-input",style:{borderRadius:"24px"},children:[e.jsxs("div",{className:"col-auto mt-0",children:[e.jsxs("div",{className:"dropup",ref:o,children:[e.jsx("button",{type:"button",className:"btn btn-light btn-sm dropdown-toggle","data-bs-toggle":"dropdown","aria-expanded":M,onClick:()=>w(!M),disabled:P||W,title:"Adjuntar archivo",style:{borderRadius:"50%",width:"38px",height:"38px",padding:0},children:e.jsx("i",{className:`mdi ${M?"mdi-close":"mdi-plus"}`})}),e.jsxs("div",{className:"dropdown-menu mb-1",children:[e.jsxs("button",{className:"dropdown-item",href:"#",onClick:s=>{var n,m;s.preventDefault(),(n=f.current)==null||n.setAttribute("accept",".pdf,.doc,.docx"),(m=f.current)==null||m.click()},children:[e.jsx("i",{className:"mdi mdi-file-document me-2",style:{color:"#7F66FF"}}),"Documentos"]}),e.jsxs("button",{className:"dropdown-item",href:"#",onClick:s=>{var n,m;s.preventDefault(),(n=f.current)==null||n.setAttribute("accept","image/*,video/*"),(m=f.current)==null||m.click()},children:[e.jsx("i",{className:"mdi mdi-image me-2",style:{color:"#007BFC"}}),"Fotos y videos"]}),e.jsxs("button",{className:"dropdown-item",href:"#",onClick:s=>{s.preventDefault(),ve()},children:[e.jsx("i",{className:"mdi mdi-camera me-2",style:{color:"#FF2E74"}}),"Cámara"]}),e.jsxs("button",{className:"dropdown-item",href:"#",onClick:s=>{var n,m;s.preventDefault(),(n=f.current)==null||n.setAttribute("accept","audio/*"),(m=f.current)==null||m.click()},children:[e.jsx("i",{className:"mdi mdi-headphones me-2",style:{color:"#FB6533"}}),"Audio"]})]})]}),e.jsx("input",{ref:f,type:"file",className:"d-none",onChange:Ne})]}),e.jsx("div",{className:"col mt-0",children:W?e.jsxs("div",{className:"d-flex align-items-center justify-content-center bg-light rounded-pill",style:{minHeight:"38px"},children:[e.jsx("span",{className:"text-danger me-2",children:"●"})," Grabando..."]}):R?e.jsx("div",{className:"d-flex align-items-center bg-light rounded-pill px-2",style:{minHeight:"38px"},children:e.jsx("audio",{ref:c,src:t,className:"me-2",controls:!0,controlsList:"nodownload",style:{height:"30px"}})}):O?e.jsx("div",{className:"d-flex align-items-center bg-light rounded-pill px-2",style:{minHeight:"38px"},children:e.jsx("span",{className:"me-2",children:"📷 Foto capturada"})}):e.jsx("textarea",{ref:v,id:"message-input",className:"form-control w-100",placeholder:"Ingrese su mensaje aquí",rows:1,style:{minHeight:"38px",maxHeight:"188px",fieldSizing:"content",resize:"none",border:"none",backgroundColor:"transparent"},disabled:P||!!R||!!O,value:b,onChange:s=>p(s.target.value),onKeyDown:s=>{s.key==="Enter"&&!s.shiftKey&&(s.preventDefault(),we()&&oe(s))}})}),e.jsx("div",{className:"col-auto mt-0",children:O&&!$?e.jsxs(e.Fragment,{children:[e.jsx("button",{type:"button",className:"btn btn-danger btn-sm me-1",onClick:()=>B(null),style:{borderRadius:"50%",width:"38px",height:"38px",padding:0},title:"Descartar foto",children:e.jsx("i",{className:"mdi mdi-delete"})}),e.jsx("button",{type:"submit",className:"btn btn-success btn-sm",disabled:P,style:{borderRadius:"50%",width:"38px",height:"38px",padding:0},title:"Enviar foto",children:e.jsx("i",{className:"mdi mdi-send"})})]}):R&&!W?e.jsxs(e.Fragment,{children:[e.jsx("button",{type:"button",className:"btn btn-danger btn-sm me-1",onClick:le,style:{borderRadius:"50%",width:"38px",height:"38px",padding:0},title:"Descartar audio",children:e.jsx("i",{className:"mdi mdi-delete"})}),e.jsx("button",{type:"submit",className:"btn btn-success btn-sm",disabled:P,style:{borderRadius:"50%",width:"38px",height:"38px",padding:0},title:"Enviar audio",children:e.jsx("i",{className:"mdi mdi-send"})})]}):W?e.jsxs(e.Fragment,{children:[e.jsx("button",{type:"button",className:"btn btn-warning btn-sm me-1",onClick:je,style:{borderRadius:"50%",width:"38px",height:"38px",padding:0},title:"Pausar grabación",children:e.jsx("i",{className:"mdi mdi-pause"})}),e.jsx("button",{type:"button",className:"btn btn-danger btn-sm",onClick:le,style:{borderRadius:"50%",width:"38px",height:"38px",padding:0},title:"Descartar grabación",children:e.jsx("i",{className:"mdi mdi-delete"})})]}):e.jsx(e.Fragment,{children:b.trim()?e.jsx("button",{type:"submit",className:"btn btn-primary btn-sm",disabled:P,style:{borderRadius:"50%",width:"38px",height:"38px",padding:0},children:P?e.jsx("i",{className:"mdi mdi-spin mdi-loading"}):e.jsx("i",{className:"mdi mdi-send"})}):e.jsx("button",{type:"button",className:"btn btn-outline-primary btn-sm",onClick:be,disabled:P,style:{borderRadius:"50%",width:"38px",height:"38px",padding:0},title:"Grabar audio",children:e.jsx("i",{className:"mdi mdi-microphone"})})})})]})})]})}),$&&e.jsx("div",{className:"position-fixed top-0 start-0 w-100 h-100 d-flex align-items-center justify-content-center",style:{backgroundColor:"rgba(0,0,0,0.8)",zIndex:9999},children:e.jsxs("div",{className:"card",style:{width:"90%",maxWidth:"500px"},children:[e.jsxs("div",{className:"card-header d-flex justify-content-between align-items-center",children:[e.jsx("h5",{className:"mb-0",children:"Cámara"}),e.jsx("button",{type:"button",className:"btn btn-sm btn-outline-secondary",onClick:ce,children:e.jsx("i",{className:"mdi mdi-close"})})]}),e.jsxs("div",{className:"card-body p-0",children:[e.jsx("video",{ref:N,autoPlay:!0,playsInline:!0,muted:!0,className:"w-100",style:{maxHeight:"400px"}}),e.jsx("canvas",{ref:k,className:"d-none"})]}),e.jsx("div",{className:"card-footer d-flex justify-content-center",children:e.jsxs("button",{type:"button",className:"btn btn-primary btn-lg rounded-pill",onClick:ye,children:[e.jsx("i",{className:"mdi mdi-camera me-2"}),"Tomar foto"]})})]})})]})]})},Be=new Te,We=i=>{var c,h,N,k;const[r,L]=a.useState([]),[g,v]=a.useState(!1),f=async()=>{v(!0);const o=await Be.byClient(i==null?void 0:i.id);L(o??[]),v(!1)};return a.useEffect(()=>{i&&f()},[i]),e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"contact-details d-flex flex-column gap-2 flex-md-row flex-xl-row align-items-center  rounded-4 shadow-sm mb-2 overflow-hidden",children:[e.jsx("img",{src:`/api/whatsapp/profile/${i.contact_phone}`,className:"rounded-circle avatar-lg bg-light border-0 mb-3 mb-md-0 mb-xl-0 flex-shrink-0",alt:i.name,style:{objectFit:"cover"},onError:o=>{o.target.src=`//${A.APP_DOMAIN}/assets/img/user-404.svg`}}),e.jsxs("div",{className:"text-center text-md-start text-xl-start w-100",children:[e.jsx("div",{className:"fw-bold fs-5 text-dark text-truncat",children:i.contact_name}),e.jsx("div",{className:"text-muted text-truncate",children:i.name}),e.jsx("div",{className:"text-muted small text-truncate",children:i.contact_email}),e.jsx("div",{className:"text-muted small text-truncate",children:i.contact_phone})]})]}),e.jsxs("div",{className:"d-flex flex-wrap gap-2 justify-content-around mb-2",children:[e.jsxs("div",{className:"text-center",children:[e.jsx("b",{className:"d-block",children:"Estado de gestión"}),e.jsx("button",{className:"btn",style:{backgroundColor:((c=i.status)==null?void 0:c.color)||"#6c757d",color:"#fff",cursor:"default"},children:((h=i.status)==null?void 0:h.name)||"Sin estado"})]}),e.jsxs("div",{className:"text-center",children:[e.jsx("b",{className:"d-block",children:"Estado del lead"}),e.jsx("button",{className:"btn",style:{backgroundColor:((N=i.manage_status)==null?void 0:N.color)||"#6c757d",color:"#fff",cursor:"default"},children:((k=i.manage_status)==null?void 0:k.name)||"Sin estado"})]})]}),i.assigned_to&&e.jsxs("div",{className:"p-2 bg-light rounded mb-2",children:[e.jsx("h5",{className:"mt-0 mb-2",children:"Atendido por:"}),e.jsxs("div",{className:"d-flex align-items-start",bis_skin_checked:"1",children:[e.jsx("img",{className:"d-flex me-2 rounded-circle",src:`//${A.APP_DOMAIN}/api/profile/thumbnail/${i.assigned.relative_id}`,onError:o=>{o.target.src=`//${A.APP_DOMAIN}/assets/img/user-404.svg`},alt:i.assigned.fullname,height:"32"}),e.jsxs("div",{className:"w-100 overflow-hidden",bis_skin_checked:"1",children:[e.jsx("h5",{className:"m-0 font-14 text-truncate",children:i.assigned.fullname}),e.jsx("span",{className:"font-12 mb-0 text-truncate d-block",children:i.assigned.email})]})]})]}),e.jsx("hr",{className:"mt-0 mb-2"}),e.jsxs("div",{className:"d-flex justify-content-between align-items-center mb-2",children:[e.jsx("h5",{className:"my-0",children:"Actividad"}),e.jsx(Q,{content:"Ver más",children:e.jsx("a",{href:`/leads/${i.id}`,className:"text-decoration-none",children:e.jsx("i",{className:"mdi mdi-arrow-top-right"})})})]}),g?e.jsxs("div",{className:"placeholder-glow",children:[e.jsx("div",{className:"placeholder mb-2 w-100 rounded",style:{height:70}}),e.jsx("div",{className:"placeholder mb-2 w-100 rounded",style:{height:140}})]}):r.sort((o,y)=>y.created_at>o.created_at?1:-1).map((o,y)=>e.jsx(Fe,{...o,showOptions:!1,extended:!1},`note-${y}`))]})},ge=new pe;ge.paginateSufix=null;const qe=({users:i,activeLeadId:r,...L})=>{const g=Local.get("adminto_settings")??{},[v,f]=a.useState(g.theme??"light"),[c,h]=a.useState([]),[N,k]=a.useState(r),[o,y]=Le(ne.business_id,[ne.service_user.id]),[d,U]=a.useState(!1),[u,H]=a.useState(0),[x,I]=a.useState(""),[T,V]=a.useState(null),[F,P]=a.useState(null),{socket:z}=xe(),W=a.useRef(),q=a.useRef(),R=async(t=!1)=>{if(d)return;U(!0);const l={fields:["clients.id","clients.contact_name","clients.contact_phone","clients.last_message","clients.last_message_microtime","clients.assigned_to","clients.status_id","clients.manage_status_id"],withCount:["unSeenMessages"],with:["assigned","status","manageStatus"],sort:[{selector:"last_message_microtime",desc:!0}],skip:0,take:40,requireTotalCount:!0},b=[["clients.last_message_microtime","isnotnull"]];if(o.length&&b.push(ie(o.map(w=>["clients.assigned_to","=",w]),"or")),x){const w=[["clients.contact_name","=",x],["clients.contact_name","contains",x],["clients.contact_phone","contains",x]];b.push(ie(w,"or"))}if(t&&c.length>0){const w=Math.min(...c.map(S=>S.last_message_microtime));b.push(["clients.last_message_microtime","<",w])}l.filter=ie(b,"and");const{data:p,totalCount:M}=await ge.paginate(l);h(t?w=>[...w,...p??[]]:p??[]),H(((p==null?void 0:p.length)??0)+(M??0)),U(!1)},J=t=>{const l=t.target.value;I(l),T&&clearTimeout(T),V(setTimeout(()=>{R(!1)},500))};return a.useEffect(()=>{R(!1)},[o]),a.useEffect(()=>{const t=l=>{l.key==="Escape"&&(k(null),P(null))};return window.addEventListener("keydown",t),()=>window.removeEventListener("keydown",t)},[]),a.useEffect(()=>{if(z)return z.on("client.updated",t=>{h(l=>{const b=l.findIndex(p=>p.id===t.id);if(b!==-1){const p=[...l];return p[b]={...p[b],...t},p}return!o.length||o.includes(t.assigned_to)?[...l,t]:l})}),()=>{z.off("client.updated")}},[z,o]),a.useEffect(()=>{const t=q.current;if(!t)return;const l=()=>{t.scrollTop+t.clientHeight>=t.scrollHeight-10&&c.length<u&&R(!0)};return t.addEventListener("scroll",l),()=>t.removeEventListener("scroll",l)},[c,d,o,u,x]),a.useEffect(()=>{N?history.pushState({},"",`/chat/${N}`):history.pushState({},"","/chat")},[N]),e.jsx(Me,{...L,title:"Chat",showTitle:!1,setThemeParent:f,children:e.jsxs("div",{className:"row",children:[e.jsx("div",{className:"col-xl-3 col-lg-4",children:e.jsx("div",{className:"card chat-list-card mb-xl-0",children:e.jsxs("div",{className:"card-body p-0",children:[e.jsx("div",{className:"p-2",children:e.jsxs("div",{className:"d-flex w-100 gap-0 align-items-center scroll-hidden",style:{overflowX:"auto"},children:[i.map(t=>e.jsx(Q,{content:`${t.name} ${t.lastname}`,children:e.jsx("div",{onClick:()=>{const l=[...o],b=t.service_user.id,p=l.indexOf(b);p>-1?l.splice(p,1):l.push(b),y(l)},className:`rounded-pill ${o.includes(t.service_user.id)?"bg-purple":""}`,style:{cursor:"pointer",padding:"2px",marginRight:"2px"},children:e.jsx("img",{className:"avatar-xs rounded-circle",src:`//${A.APP_DOMAIN}/api/profile/thumbnail/${t.relative_id}`,onError:l=>{l.target.src=`//${A.APP_DOMAIN}/assets/img/user-404.svg`},alt:t.name,style:{objectFit:"cover",objectPosition:"center"}})})},t.id)),o.length>0&&e.jsx(Q,{content:"Limpiar filtros",children:e.jsx("button",{className:"btn btn-xs btn-soft-danger ms-1 rounded-pill",onClick:()=>y([]),children:e.jsx("i",{className:"mdi mdi-trash-can-outline"})})})]})}),e.jsx("div",{className:"p-2 border-top",children:e.jsxs("div",{className:"search-box chat-search-box",children:[e.jsx("input",{type:"text",className:"form-control rounded-pill",placeholder:"Buscar lead por nombre o número...",value:x,onChange:J}),e.jsx("i",{className:"mdi mdi-magnify search-icon"})]})}),e.jsxs("div",{ref:q,className:"scroll-hidden",style:{overflowY:"auto",height:"calc(100vh - 300px)"},children:[e.jsx("ul",{className:"list-unstyled chat-list mb-0",children:c.sort((t,l)=>new Date(l.last_message_microtime)-new Date(t.last_message_microtime)).map(t=>{var w,S,K,O,B;const l=new Date((t.last_message_microtime??0)/1e3),b=new Date;b.setHours(0,0,0,0);const p=new Date(b);p.setDate(p.getDate()-1);let M;if(l>=b)M=l.toLocaleString("es-ES",{hour:"2-digit",minute:"2-digit"});else if(l>=p)M="Ayer";else{const $=["Domingo","Lunes","Martes","Miércoles","Jueves","Viernes","Sábado"];if(Math.floor((new Date-l)/(1e3*60*60*24))<=6)M=$[l.getDay()];else{const ee=String(l.getDate()).padStart(2,"0"),Y=String(l.getMonth()+1).padStart(2,"0"),se=l.getFullYear();M=`${ee}/${Y}/${se}`}}return e.jsx("li",{className:`${t.unread?"unread":""} ${N==t.id?"bg-light":""}`,children:e.jsx("a",{onClick:$=>{k(t.id),$.stopPropagation()},style:{cursor:"pointer"},children:e.jsxs("div",{className:"d-flex",children:[e.jsxs("div",{className:`position-relative flex-shrink-0 chat-user-img ${t.online?"active":""} align-self-center me-2`,children:[e.jsx("img",{src:`/api/whatsapp/profile/${t.contact_phone}`,className:"rounded-circle avatar-sm bg-light",alt:t.name,style:{padding:0,border:"none"},onError:$=>{$.target.src=`//${A.APP_DOMAIN}/assets/img/user-404.svg`}}),t.assigned_to&&((w=t.assigned)==null?void 0:w.relative_id)&&(o.length===0||o.length>1||o[0]!==ne.service_user.id)&&e.jsx(Q,{content:`${t.assigned.name} ${t.assigned.lastname}`,children:e.jsx("img",{className:"position-absolute rounded-pill",src:`//${A.APP_DOMAIN}/api/profile/thumbnail/${t.assigned.relative_id}`,onError:$=>{$.target.src=`//${A.APP_DOMAIN}/assets/img/user-404.svg`},alt:t.assigned.fullname,style:{right:"-4px",bottom:"-4px",objectFit:"cover",objectPosition:"center",padding:0,border:`2px solid ${v=="light"?"#ffffff":"#313844"}`,width:"18px",aspectRatio:1}})},t.assigned.id)]}),e.jsxs("div",{className:"flex-grow-1 overflow-hidden",children:[e.jsx("h5",{className:`text-truncate font-14 mt-0 mb-0 ${t.un_seen_messages_count>0?"fw-bold":""}`,children:t.contact_name}),e.jsx("p",{className:`text-truncate mb-0 ${t.un_seen_messages_count>0?"fw-bold":""}`,title:t.last_message??void 0,style:{color:t.un_seen_messages_count>0?v=="light"?"#343a40":"#f7f7f7":void 0},children:t.last_message??e.jsx("i",{className:"text-muted",children:"Sin mensaje"})}),e.jsxs("div",{className:"d-flex gap-1",children:[e.jsx("span",{className:"badge",style:{backgroundColor:((S=t.status)==null?void 0:S.color)??"#6c757d"},children:((K=t.status)==null?void 0:K.name)??"Sin estado"}),e.jsx("span",{className:"badge",style:{backgroundColor:((O=t.manage_status)==null?void 0:O.color)??"#6c757d"},children:((B=t.manage_status)==null?void 0:B.name)??"Sin estado"})]})]}),e.jsxs("div",{className:"d-flex flex-column align-items-end",children:[e.jsx("div",{className:`font-11 ${t.un_seen_messages_count>0?"text-success":""}`,children:M}),t.un_seen_messages_count>0&&e.jsx("span",{className:"badge bg-success rounded-pill mt-1",children:t.un_seen_messages_count})]})]})})},t.id)})}),e.jsxs("div",{className:"text-center py-2",children:[d&&e.jsx("div",{className:"spinner-border spinner-border-sm text-primary",role:"status",children:e.jsx("span",{className:"visually-hidden",children:"Loading contacts..."})}),!d&&c.length>=u&&c.length>0&&e.jsx("span",{className:"text-muted",children:"No hay más contactos"})]})]})]})})}),e.jsx("div",{className:`col-xl-${F?6:9} col-lg-${F?8:12}`,children:e.jsx("div",{className:"conversation-list-card card",children:N?e.jsx(e.Fragment,{children:e.jsx(ze,{leadId:N,containerRef:W,theme:v,contactDetails:F,setContactDetails:P})}):e.jsx("div",{className:"card-body d-flex align-items-center justify-content-center",style:{height:"calc(100vh - 184px)"},children:e.jsxs("div",{className:"text-center",children:[e.jsx("img",{src:"/assets/img/icon.svg",alt:`Logo ${A.APP_NAME}`,className:"mb-2",style:{width:60,height:60,objectFit:"contain"}}),e.jsxs("h4",{className:"text-muted",children:["Módulo de chat de ",A.APP_NAME]}),e.jsx("p",{className:"text-muted",children:"Selecciona un contacto para empezar a interactuar"})]})})})}),F&&e.jsx("div",{className:"col-xl-3 col-lg-12",children:e.jsx("div",{className:"card contact-details-card mb-xl-0",children:e.jsx("div",{className:"card-body scroll-hidden",style:{height:"calc(100vh - 186px)",overflowY:"auto"},children:e.jsx(We,{...F})})})})]})})};Re((i,r)=>{$e(i).render(e.jsx(qe,{...r}))});
