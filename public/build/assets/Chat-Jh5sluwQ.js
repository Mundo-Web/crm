import{r as a,j as e,C as se,c as ae,G as T}from"./CreateReactScript-DWfX8fUe.js";import{W as ne,u as ie,A as ce,i as K}from"./Adminto-MJzZ0wrP.js";import{L as re}from"./LeadsRest-C5jY68we.js";import{w as le,M as oe}from"./wa2html-CUcujwW3.js";import{H as de}from"./HtmlContent-BMwpNjLf.js";import"./Logout-2N6K_MpN.js";import"./sweetalert2.esm.all-C4h_z6Pa.js";const me=new ne,ue=({messages:k,containerRef:j,lead:H,loading:R,getMessages:D,theme:L})=>{const C=a.useRef(),m=a.useRef(),U=a.useRef(),u=a.useRef(),N=a.useRef(),v=a.useRef(),y=a.useRef(),[p,F]=a.useState(!1),[w,S]=a.useState(!1),[h,_]=a.useState(null),[r,E]=a.useState(null),[f,P]=a.useState(""),[M,A]=a.useState(!1),[t,i]=a.useState(null),[n,l]=a.useState(null),[o,g]=a.useState(!1);a.useEffect(()=>{C.current&&(C.current.value=f)},[f]),a.useEffect(()=>()=>{r&&URL.revokeObjectURL(r)},[r]),a.useEffect(()=>()=>{t&&t.getTracks().forEach(s=>s.stop())},[t]),a.useEffect(()=>{const s=j.current;if(!s)return;const c=()=>{s.scrollTop===0&&!R&&D&&D()};return s.addEventListener("scroll",c),()=>s.removeEventListener("scroll",c)},[j,R,D]),a.useEffect(()=>{const s=c=>{y.current&&!y.current.contains(c.target)&&A(!1)};return document.addEventListener("mousedown",s),()=>document.removeEventListener("mousedown",s)},[]),a.useEffect(()=>{o&&t&&N.current&&(N.current.srcObject=t)},[o,t]);const B=async()=>{try{const s=await navigator.mediaDevices.getUserMedia({audio:!0}),c=new MediaRecorder(s),d=[];c.ondataavailable=b=>d.push(b.data),c.onstop=()=>{const b=new Blob(d,{type:"audio/webm"});_(b),E(URL.createObjectURL(b)),s.getTracks().forEach(x=>x.stop())},c.start(),u.current=c,S(!0)}catch(s){console.error("Error accessing microphone:",s)}},Q=()=>{u.current&&u.current.state!=="inactive"&&u.current.stop(),S(!1)},O=()=>{u.current&&u.current.state!=="inactive"&&u.current.stop(),S(!1),_(null),r&&URL.revokeObjectURL(r),E(null)},W=async s=>{if(s.preventDefault(),!H)return;const c=f.trim();!c&&!h&&!n||(F(!0),h?console.warn("Audio upload not implemented yet"):n?console.warn("Camera image upload not implemented yet"):await me.send(H.id,c),P(""),_(null),r&&URL.revokeObjectURL(r),E(null),l(null),g(!1),F(!1))},V=s=>{s.target.files[0]&&(console.warn("File upload not implemented yet"),s.target.value="")},X=async()=>{try{const s=await navigator.mediaDevices.getUserMedia({video:!0});i(s),g(!0),A(!1)}catch(s){console.error("Error accessing camera:",s)}},z=()=>{t&&(t.getTracks().forEach(s=>s.stop()),i(null)),g(!1),l(null)},Z=()=>{const s=v.current,c=N.current;if(!s||!c)return;s.width=c.videoWidth,s.height=c.videoHeight,s.getContext("2d").drawImage(c,0,0),s.toBlob(b=>{l(b),z()},"image/jpeg",.95)},ee=()=>f.trim()||h||n;let Y=!1;return e.jsxs("div",{className:"card-body p-0 position-relative border",style:{backgroundColor:"var(--bs-body-bg)"},children:[e.jsx("div",{className:"position-absolute",style:{top:0,right:0,bottom:0,left:0,backgroundImage:"url(/assets/img/doodles.png)",backgroundRepeat:"repeat",zIndex:0,opacity:L=="light"?1:.125}}),e.jsxs("section",{className:"d-flex flex-column position-relative",style:{height:"calc(100vh - 260px)",zIndex:1},children:[e.jsxs("ul",{ref:j,className:"conversation-list slimscroll flex-grow-1 px-3 pt-3",style:{overflowY:"auto",scrollBehavior:"smooth",position:"relative"},children:[R&&e.jsxs("li",{className:"text-center py-1 px-2 rounded-pill mx-auto",style:{position:"sticky",top:0,zIndex:10,width:"max-content",backgroundColor:"var(--bs-light)"},children:[e.jsx("i",{className:"mdi mdi-spin mdi-loading"}),e.jsx("small",{className:"text-muted ms-2",children:"Cargando mensajes..."})]}),k.map((s,c)=>{var G;const d=s.role!=="Human",b=Y===d?"3px":"12px";Y=d;let x=((G=s.message)==null?void 0:G.replace(/\{\{.*?\}\}/gs,""))||"",I="";return x.startsWith("/attachment:")&&(I=x.split(`
`)[0],x=x.replace(I,"")),s.role=="Form"?e.jsx("li",{children:e.jsx("div",{className:"chat-day-title mt-3 mb-0",children:e.jsx("small",{className:"title badge badge-soft-dark rounded-pill",children:x})})},c):e.jsx("li",{className:d?"odd":"",style:{marginBottom:c<k.length-1?"0px":"24px",marginTop:b},children:e.jsx("div",{className:"message-list",children:e.jsx("div",{className:"conversation-text",children:e.jsxs("div",{className:"ctext-wrap",children:[s.campaign&&e.jsxs("div",{className:"rounded p-2 mb-2",style:{backgroundColor:"rgba(240, 240, 240, 0.125)",cursor:s.campaign.link?"pointer":"default",maxWidth:"240px"},onClick:()=>{s.campaign.link&&window.open(s.campaign.link,"_blank")},children:[e.jsxs("div",{className:"d-flex gap-1",style:{maxWidth:"100%"},children:[e.jsx("div",{className:"fw-bold",children:s.campaign.code}),e.jsx("div",{className:"small text-truncate",children:s.campaign.title})]}),e.jsx("small",{className:"d-block text-truncate",style:{maxWidth:300},children:s.campaign.link})]}),I&&e.jsxs(e.Fragment,{children:[e.jsx("img",{src:I.replace("/attachment:",""),className:"mb-1",alt:"attachment",style:{minWidth:"300px",width:"100%",maxWidth:"100%",minHeight:"200px",maxHeight:"300px",borderRadius:"4px",objectFit:"cover"},onError:te=>$(te.target).remove()}),e.jsx("div",{className:"d-flex justify-content-end",children:e.jsxs("a",{className:"btn btn-xs btn-light mb-1 text-nowrap d-flex text-end",href:I.replace("/attachment:",""),target:"_blank",rel:"noreferrer",download:!0,children:[e.jsx("i",{className:"mdi mdi-download me-1"}),e.jsx("span",{children:"Descargar adjunto"})]})}),!x.trim()&&e.jsx("span",{className:"time mt-0 float-end",style:{fontSize:"8px",marginLeft:"6px",marginTop:"6px !important"},children:moment(s.created_at).format("HH:mm")})]}),x.trim()&&e.jsx(de,{className:"text-start",html:le(x+`<span class="time mt-0 float-end" style="font-size: 8px; margin-left: 6px; margin-top: 6px !important">${moment(s.created_at).format("HH:mm")}</span>`)})]})})})},c)})]}),e.jsx("form",{className:"p-2 pt-0 conversation-input",onSubmit:W,children:e.jsxs("label",{className:`row g-0 align-items-end p-1 ${L=="dark"?"bg-light":"bg-white"}`,htmlFor:"message-input",style:{borderRadius:"24px"},children:[e.jsxs("div",{className:"col-auto mt-0",children:[e.jsxs("div",{className:"dropup",ref:y,children:[e.jsx("button",{type:"button",className:"btn btn-light btn-sm dropdown-toggle","data-bs-toggle":"dropdown","aria-expanded":M,onClick:()=>A(!M),disabled:p||w,title:"Adjuntar archivo",style:{borderRadius:"50%",width:"38px",height:"38px",padding:0},children:e.jsx("i",{className:`mdi ${M?"mdi-close":"mdi-plus"}`})}),e.jsxs("div",{className:"dropdown-menu mb-1",children:[e.jsxs("button",{className:"dropdown-item",href:"#",onClick:s=>{var c,d;s.preventDefault(),(c=m.current)==null||c.setAttribute("accept",".pdf,.doc,.docx"),(d=m.current)==null||d.click()},children:[e.jsx("i",{className:"mdi mdi-file-document me-2",style:{color:"#7F66FF"}}),"Documentos"]}),e.jsxs("button",{className:"dropdown-item",href:"#",onClick:s=>{var c,d;s.preventDefault(),(c=m.current)==null||c.setAttribute("accept","image/*,video/*"),(d=m.current)==null||d.click()},children:[e.jsx("i",{className:"mdi mdi-image me-2",style:{color:"#007BFC"}}),"Fotos y videos"]}),e.jsxs("button",{className:"dropdown-item",href:"#",onClick:s=>{s.preventDefault(),X()},children:[e.jsx("i",{className:"mdi mdi-camera me-2",style:{color:"#FF2E74"}}),"CÃ¡mara"]}),e.jsxs("button",{className:"dropdown-item",href:"#",onClick:s=>{var c,d;s.preventDefault(),(c=m.current)==null||c.setAttribute("accept","audio/*"),(d=m.current)==null||d.click()},children:[e.jsx("i",{className:"mdi mdi-headphones me-2",style:{color:"#FB6533"}}),"Audio"]})]})]}),e.jsx("input",{ref:m,type:"file",className:"d-none",onChange:V})]}),e.jsx("div",{className:"col mt-0",children:w?e.jsxs("div",{className:"d-flex align-items-center justify-content-center bg-light rounded-pill",style:{minHeight:"38px"},children:[e.jsx("span",{className:"text-danger me-2",children:"â—"})," Grabando..."]}):h?e.jsx("div",{className:"d-flex align-items-center bg-light rounded-pill px-2",style:{minHeight:"38px"},children:e.jsx("audio",{ref:U,src:r,className:"me-2",controls:!0,controlsList:"nodownload",style:{height:"30px"}})}):n?e.jsx("div",{className:"d-flex align-items-center bg-light rounded-pill px-2",style:{minHeight:"38px"},children:e.jsx("span",{className:"me-2",children:"ðŸ“· Foto capturada"})}):e.jsx("textarea",{ref:C,id:"message-input",className:"form-control w-100",placeholder:"Ingrese su mensaje aquÃ­",rows:1,style:{minHeight:"38px",maxHeight:"188px",fieldSizing:"content",resize:"none",border:"none",backgroundColor:"transparent"},disabled:p||!!h||!!n,value:f,onChange:s=>P(s.target.value),onKeyDown:s=>{s.key==="Enter"&&!s.shiftKey&&(s.preventDefault(),ee()&&W(s))}})}),e.jsx("div",{className:"col-auto mt-0",children:n&&!o?e.jsxs(e.Fragment,{children:[e.jsx("button",{type:"button",className:"btn btn-danger btn-sm me-1",onClick:()=>l(null),style:{borderRadius:"50%",width:"38px",height:"38px",padding:0},title:"Descartar foto",children:e.jsx("i",{className:"mdi mdi-delete"})}),e.jsx("button",{type:"submit",className:"btn btn-success btn-sm",disabled:p,style:{borderRadius:"50%",width:"38px",height:"38px",padding:0},title:"Enviar foto",children:e.jsx("i",{className:"mdi mdi-send"})})]}):h&&!w?e.jsxs(e.Fragment,{children:[e.jsx("button",{type:"button",className:"btn btn-danger btn-sm me-1",onClick:O,style:{borderRadius:"50%",width:"38px",height:"38px",padding:0},title:"Descartar audio",children:e.jsx("i",{className:"mdi mdi-delete"})}),e.jsx("button",{type:"submit",className:"btn btn-success btn-sm",disabled:p,style:{borderRadius:"50%",width:"38px",height:"38px",padding:0},title:"Enviar audio",children:e.jsx("i",{className:"mdi mdi-send"})})]}):w?e.jsxs(e.Fragment,{children:[e.jsx("button",{type:"button",className:"btn btn-warning btn-sm me-1",onClick:Q,style:{borderRadius:"50%",width:"38px",height:"38px",padding:0},title:"Pausar grabaciÃ³n",children:e.jsx("i",{className:"mdi mdi-pause"})}),e.jsx("button",{type:"button",className:"btn btn-danger btn-sm",onClick:O,style:{borderRadius:"50%",width:"38px",height:"38px",padding:0},title:"Descartar grabaciÃ³n",children:e.jsx("i",{className:"mdi mdi-delete"})})]}):e.jsx(e.Fragment,{children:f.trim()?e.jsx("button",{type:"submit",className:"btn btn-primary btn-sm",disabled:p,style:{borderRadius:"50%",width:"38px",height:"38px",padding:0},children:p?e.jsx("i",{className:"mdi mdi-spin mdi-loading"}):e.jsx("i",{className:"mdi mdi-send"})}):e.jsx("button",{type:"button",className:"btn btn-outline-primary btn-sm",onClick:B,disabled:p,style:{borderRadius:"50%",width:"38px",height:"38px",padding:0},title:"Grabar audio",children:e.jsx("i",{className:"mdi mdi-microphone"})})})})]})})]}),o&&e.jsx("div",{className:"position-fixed top-0 start-0 w-100 h-100 d-flex align-items-center justify-content-center",style:{backgroundColor:"rgba(0,0,0,0.8)",zIndex:9999},children:e.jsxs("div",{className:"card",style:{width:"90%",maxWidth:"500px"},children:[e.jsxs("div",{className:"card-header d-flex justify-content-between align-items-center",children:[e.jsx("h5",{className:"mb-0",children:"CÃ¡mara"}),e.jsx("button",{type:"button",className:"btn btn-sm btn-outline-secondary",onClick:z,children:e.jsx("i",{className:"mdi mdi-close"})})]}),e.jsxs("div",{className:"card-body p-0",children:[e.jsx("video",{ref:N,autoPlay:!0,playsInline:!0,muted:!0,className:"w-100",style:{maxHeight:"400px"}}),e.jsx("canvas",{ref:v,className:"d-none"})]}),e.jsx("div",{className:"card-footer d-flex justify-content-center",children:e.jsxs("button",{type:"button",className:"btn btn-primary btn-lg rounded-pill",onClick:Z,children:[e.jsx("i",{className:"mdi mdi-camera me-2"}),"Tomar foto"]})})]})})]})},J=new re;J.paginateSufix=null;const q=new oe,he=new Audio("/assets/sounds/notification.wav"),xe=({users:k,...j})=>{const H=Local.get("adminto_settings")??{},[R,D]=a.useState(H.theme??"light"),[L,C]=a.useState([]),[m,U]=a.useState(null),[u,N]=a.useState([]),[v,y]=a.useState([]),[p,F]=a.useState(!0),[w,S]=a.useState(!1),{socket:h}=ie(),_=a.useRef(),r=L.find(t=>t.id==m),E=v.filter(t=>t.wa_id==(r==null?void 0:r.contact_phone)),f=async()=>{F(!0);const{data:t}=await J.paginate({fields:["clients.id","clients.contact_name","clients.contact_phone","clients.last_message","clients.last_message_microtime"],withCount:["unSeenMessages"],sort:[{selector:"last_message_microtime",desc:!0}],limit:40});C(t??[]),F(!1)},P=async()=>{if(!r||w)return;S(!0);const t=v.filter(n=>n.wa_id==r.contact_phone).sort((n,l)=>l.microtime-n.microtime)[0]??{microtime:(Date.now()+5*60*60*1e3)*1e3},i=await q.paginate({summary:{contact_phone:r.contact_phone},filter:[["microtime","<=",t.microtime],"and",["wa_id","contains",r.contact_phone]],sort:[{selector:"microtime",desc:!0}],skip:0,take:40});y(n=>[...n,...i.data??[]].sort((l,o)=>l.microtime-o.microtime)),S(!1)},M=async()=>{if(!r)return;const t=v.filter(n=>n.wa_id===r.contact_phone).sort((n,l)=>l.microtime-n.microtime)[0];if(!t)return;const i=await q.paginate({summary:{contact_phone:r.contact_phone},filter:[["microtime",">",t.microtime],"and",["wa_id","contains",r.contact_phone]],sort:[{selector:"microtime",desc:!1}],skip:0,take:100});i.data&&i.data.length&&y(n=>[...n,...i.data].sort((l,o)=>l.microtime-o.microtime))},A=async()=>{if(!r)return;E.length>0||await P()};return a.useEffect(()=>{f()},[]),a.useEffect(()=>{const t=i=>{i.key==="Escape"&&U(null)};return window.addEventListener("keydown",t),()=>window.removeEventListener("keydown",t)},[]),a.useEffect(()=>{m&&(A(),M())},[m]),a.useEffect(()=>{if(h)return h.on("message.created",t=>{if(t.role=="Human"&&he.play(),t.wa_id!==(r==null?void 0:r.contact_phone))return;const{id:i}=t;y(n=>n.find(o=>o.id===i)?n.map(o=>o.id===i?{...o,...t}:o):[...n,t].sort((o,g)=>o.microtime-g.microtime))}),h.on("client.updated",t=>{C(i=>{const n=i.findIndex(l=>l.id===t.id);if(n!==-1){const l=[...i];return l[n]={...l[n],...t},l}return[...i,t]})}),()=>{}},[h,r]),a.useEffect(()=>{if(!_.current)return;const t=_.current;t.scrollTop=t.scrollHeight},[v]),console.log(m),e.jsx(ce,{...j,title:"Chat",showTitle:!1,setThemeParent:D,children:e.jsxs("div",{className:"row",children:[e.jsx("div",{className:"col-xl-3 col-lg-4",children:e.jsx("div",{className:"card chat-list-card mb-xl-0",children:e.jsxs("div",{className:"card-body p-0",children:[e.jsxs("div",{className:"p-2",children:[e.jsxs("div",{className:"d-flex w-100 gap-0 align-items-center",children:[k.map(t=>e.jsx(K,{content:`${t.name} ${t.lastname}`,children:e.jsx("div",{onClick:()=>{const i=[...u],n=t.service_user.id,l=i.indexOf(n);l>-1?i.splice(l,1):i.push(n),N(i)},className:`rounded-pill ${u.includes(t.service_user.id)?"bg-purple":""}`,style:{cursor:"pointer",padding:"2px",marginRight:"2px"},children:e.jsx("img",{className:"avatar-xs rounded-circle",src:`//${T.APP_DOMAIN}/api/profile/thumbnail/${t.relative_id}`,alt:t.name,style:{objectFit:"cover",objectPosition:"center"}})})},t.id)),u.length>0&&e.jsx(K,{content:"Limpiar filtros",children:e.jsx("button",{className:"btn btn-xs btn-soft-danger ms-1 rounded-pill",onClick:()=>N([]),children:e.jsx("i",{className:"mdi mdi-trash-can-outline"})})})]}),e.jsx("hr",{className:"my-2"}),e.jsxs("div",{className:"search-box chat-search-box",children:[e.jsx("input",{type:"text",className:"form-control",placeholder:"Buscar lead por nombre o nÃºmero..."}),e.jsx("i",{className:"mdi mdi-magnify search-icon"})]})]}),e.jsx("hr",{className:"my-0"}),e.jsx("div",{style:{overflowY:"auto"},children:p?e.jsxs("div",{className:"text-center py-4",style:{height:"calc(100vh - 300px)"},children:[e.jsx("div",{className:"spinner-border text-primary",role:"status",children:e.jsx("span",{className:"visually-hidden",children:"Loading contacts..."})}),e.jsx("p",{className:"mt-2 mb-0 text-muted",children:"Cargando contactos..."})]}):e.jsx("ul",{className:"list-unstyled chat-list mb-0",style:{height:"calc(100vh - 300px)"},children:L.sort((t,i)=>new Date(i.last_message_microtime)-new Date(t.last_message_microtime)).map(t=>{const i=new Date((t.last_message_microtime??0)/1e3),n=new Date;n.setHours(0,0,0,0);const l=new Date(n);l.setDate(l.getDate()-1);let o;if(i>=n)o=i.toLocaleString("es-ES",{hour:"2-digit",minute:"2-digit"});else if(i>=l)o="Ayer";else{const g=new Date().getFullYear();i.getFullYear()===g?o=i.toLocaleDateString("es-ES",{day:"2-digit",month:"2-digit"}):o=i.toLocaleDateString("es-ES",{month:"2-digit",year:"numeric"})}return e.jsx("li",{className:`${t.unread?"unread":""} ${m==t.id?"bg-light":""}`,children:e.jsx("a",{onClick:g=>{U(t.id),g.stopPropagation()},style:{cursor:"pointer"},children:e.jsxs("div",{className:"d-flex",children:[e.jsx("div",{className:`flex-shrink-0 chat-user-img ${t.online?"active":""} align-self-center me-2`,children:e.jsx("img",{src:`//${T.APP_DOMAIN}/api/profile/thumbnail/${t.avatar}`,className:"rounded-circle avatar-sm",alt:t.name})}),e.jsxs("div",{className:"flex-grow-1 overflow-hidden",children:[e.jsx("h5",{className:`text-truncate font-14 mt-0 mb-1 ${t.un_seen_messages_count>0?"fw-bold":""}`,children:t.contact_name}),e.jsx("p",{className:"text-truncate mb-0",children:t.last_message??e.jsx("i",{className:"text-muted",children:"Sin mensaje"})})]}),e.jsxs("div",{className:"d-flex flex-column align-items-end",children:[e.jsx("div",{className:`font-11 ${t.un_seen_messages_count>0?"text-success":""}`,children:o}),t.un_seen_messages_count>0&&e.jsx("span",{className:"badge bg-success rounded-pill mt-1",children:t.un_seen_messages_count})]})]})})},t.id)})})})]})})}),e.jsx("div",{className:"col-xl-9 col-lg-8",children:e.jsx("div",{className:"conversation-list-card card",children:r?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:`card-header ${R=="light"?"bg-white":"bg-light"}`,children:e.jsx("div",{className:"d-flex",children:e.jsxs("div",{className:"flex-grow-1",children:[e.jsx("h5",{className:"my-0 text-truncate",children:r.contact_name}),e.jsxs("p",{className:"font-13 text-muted mb-0",children:[e.jsx("i",{className:"mdi mdi-phone me-1 font-11"})," ",r.contact_phone]})]})})}),e.jsx(ue,{containerRef:_,messages:E,lead:r,loading:w,theme:R})]}):e.jsx("div",{className:"card-body d-flex align-items-center justify-content-center",style:{height:"calc(100vh - 184px)"},children:e.jsxs("div",{className:"text-center",children:[e.jsx("img",{src:"/assets/img/icon.svg",alt:`Logo ${T.APP_NAME}`,className:"mb-2",style:{width:60,height:60,objectFit:"contain"}}),e.jsxs("h4",{className:"text-muted",children:["MÃ³dulo de chat de ",T.APP_NAME]}),e.jsx("p",{className:"text-muted",children:"Selecciona un contacto para empezar a interactuar"})]})})})})]})})};se((k,j)=>{ae(k).render(e.jsx(xe,{...j}))});
