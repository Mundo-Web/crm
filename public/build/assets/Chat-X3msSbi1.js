import{j as e,G as M,r as n,C as $e,c as Ee,L as ae}from"./CreateReactScript-DEiMbi6B.js";import{W as De,M as Le,u as pe,i as ee,a as Ae,A as Me}from"./Adminto-lUnuPBnJ.js";import{L as ge}from"./LeadsRest-z3cA1exe.js";import{H as Te,C as Fe,a as Pe}from"./ClientNotesRest-XbJtIw03.js";import{w as He,A as ne}from"./ArrayJoin-6-TTvUmN.js";import"./Logout-DAQhHADr.js";import"./sweetalert2.esm.all-B5d0Dmk7.js";const Ie=({contact:a,contactDetails:o,setContactDetails:u,loading:y,theme:w})=>e.jsx("div",{className:`card-header ${w=="light"?"bg-white":"bg-light"}`,style:{cursor:"pointer"},onClick:()=>(a==null?void 0:a.id)&&u(o?null:a),children:e.jsxs("div",{className:"d-flex align-items-center",children:[!y&&a&&e.jsx("img",{src:`/api/whatsapp/profile/${a.contact_phone}`,className:"rounded-circle avatar-sm bg-light me-2",alt:a.contact_name,style:{padding:0,border:"none"},onError:N=>{N.target.src=`//${M.APP_DOMAIN}/assets/img/user-404.svg`}}),y&&e.jsx("div",{className:"placeholder-glow",children:e.jsx("div",{className:"rounded-circle avatar-sm me-2 placeholder",style:{width:36,height:36}})}),e.jsxs("div",{className:`flex-grow-1 ${y?"placeholder-glow":""}`,children:[e.jsx("h5",{className:`mt-0 mb-1 text-truncate ${y?"placeholder col-3":""}`,children:a==null?void 0:a.contact_name}),e.jsxs("p",{className:`d-block font-13 text-muted mb-0 ${y?"placeholder col-2":""}`,children:[e.jsx("i",{className:"mdi mdi-phone me-1 font-11"}),a==null?void 0:a.contact_phone]})]}),!y&&a&&e.jsx("div",{className:"ms-2",children:e.jsx("i",{className:`mdi mdi-24px mdi-chevron-double-${o?"right":"left"} text-muted`})})]})}),Oe=({fromMe:a,theme:o,url:u,time:y})=>{const[w,N]=n.useState(!1),[f,c]=n.useState(0),[x,k]=n.useState(0),l=n.useRef(null),v=()=>{const h=l.current;h&&(w?h.pause():h.play(),N(!w))};n.useEffect(()=>{const h=l.current;if(!h)return;const H=()=>c(Math.floor(h.duration)),p=()=>k(Math.floor(h.currentTime)),I=()=>{N(!1),k(0)};return h.addEventListener("loadedmetadata",H),h.addEventListener("timeupdate",p),h.addEventListener("ended",I),()=>{h.removeEventListener("loadedmetadata",H),h.removeEventListener("timeupdate",p),h.removeEventListener("ended",I)}},[]);const d=f?x/f*100:0,U=h=>{const H=Math.floor(h/60),p=h%60;return`${H}:${p<10?"0":""}${p}`};return e.jsxs("div",{className:`ctext-wrap d-flex align-items-start ${a?`message-out-${o}`:`message-in-${o}`}`,style:{minWidth:"240px",maxWidth:"320px",padding:"6px 8px",boxShadow:"rgba(11, 20, 26, 0.13) 0px 1px 0.5px 0px"},children:[e.jsxs("div",{className:"flex-grow-1",children:[e.jsxs("div",{className:"d-flex align-items-center mb-1",children:[e.jsx("button",{onClick:v,className:"btn btn-sm d-flex align-items-center justify-content-center rounded-circle me-2 p-0",style:{width:"32px",height:"32px",border:"none",color:o=="dark"?"#fff":"#6f8171",flexShrink:0},children:e.jsx("i",{className:`mdi mdi-${w?"pause":"play"}`,style:{fontSize:"24px"}})}),e.jsx("div",{className:"flex-grow-1",style:{height:"4px",backgroundColor:o=="dark"?"#ffffff55":"#6f817155",borderRadius:"2px",position:"relative"},children:e.jsx("div",{style:{height:"100%",width:`${d}%`,backgroundColor:o=="dark"?"#fff":"#6f8171",borderRadius:"2px",transition:"width 100ms ease"}})})]}),e.jsxs("div",{className:"d-flex justify-content-between align-items-center px-1",style:{fontSize:"10px"},children:[e.jsx("span",{children:U(f)}),e.jsx("span",{className:"time mt-0 float-end",style:{fontSize:"10px",marginLeft:"6px",marginTop:"8px !important"},children:y})]})]}),e.jsx("audio",{ref:l,src:u,preload:"metadata"})]})},Ue=({key:a,forceAfter:o,message:u,isLast:y=!1,fromMe:w,marginTop:N,theme:f})=>{var k;let c=((k=u.message)==null?void 0:k.replace(/\{\{.*?\}\}/gs,""))||"",x="";return c.startsWith("/attachment:")&&(x=c.split(`
`)[0],c=c.replace(x,"")),u.role=="Form"?e.jsx("li",{children:e.jsx("div",{className:"chat-day-title mt-3 mb-0",children:e.jsx("small",{className:"title badge badge-soft-dark rounded-pill",children:c})})},a):e.jsx("li",{className:`${w?"odd":""} ${N||o?"":"hide-after"}`,style:{marginBottom:y?"0px":"24px",marginTop:N?"12px":"2px"},children:e.jsx("div",{className:"message-list",children:e.jsx("div",{className:"conversation-text",children:c.startsWith("/audio:")?e.jsx(Oe,{avatar:`/api/whatsapp/profile/${u.wa_id}`,fromMe:w,theme:f,url:c.replace("/audio:","/storage/images/whatsapp/"),time:moment(u.created_at).subtract(5,"hours").format("HH:mm")}):e.jsxs("div",{className:`ctext-wrap ${w?`message-out-${f}`:`message-in-${f}`}`,style:{boxShadow:"rgba(11, 20, 26, 0.13) 0px 1px 0.5px 0px",padding:"6px 8px"},children:[u.campaign&&e.jsxs("div",{className:"rounded p-2 mb-2",style:{backgroundColor:"rgba(240, 240, 240, 0.125)",cursor:u.campaign.link?"pointer":"default",maxWidth:"240px"},onClick:()=>{u.campaign.link&&window.open(u.campaign.link,"_blank")},children:[e.jsxs("div",{className:"d-flex gap-1",style:{maxWidth:"100%"},children:[e.jsx("div",{className:"fw-bold",children:u.campaign.code}),e.jsx("div",{className:"small text-truncate",children:u.campaign.title})]}),e.jsx("small",{className:"d-block text-truncate",style:{maxWidth:300},children:u.campaign.link})]}),x&&e.jsxs(e.Fragment,{children:[e.jsx("img",{src:x.replace("/attachment:",""),className:"mb-1",alt:"attachment",style:{minWidth:"300px",width:"100%",maxWidth:"100%",minHeight:"200px",maxHeight:"300px",borderRadius:"4px",objectFit:"cover"},onError:l=>{const v=l.target;v&&v.parentNode&&(v.style.display="none")}}),e.jsx("div",{className:"d-flex justify-content-end",children:e.jsxs("a",{className:"btn btn-xs btn-light mb-1 text-nowrap d-flex text-end",href:x.replace("/attachment:",""),target:"_blank",rel:"noreferrer",download:!0,children:[e.jsx("i",{className:"mdi mdi-download me-1"}),e.jsx("span",{children:"Descargar adjunto"})]})}),!c.trim()&&e.jsx("span",{className:"time mt-0 float-end",style:{fontSize:"10px",marginLeft:"6px",marginTop:"8px !important"},children:moment(u.created_at).subtract(5,"hours").format("HH:mm")})]}),c.trim()&&e.jsx(Te,{className:"text-start font-14",html:He(c+`<span class="time mt-0 float-end" style="font-size: 10px; margin-left: 6px; margin-top: 8px !important">${moment(u.created_at).subtract(5,"hours").format("HH:mm")}</span>`)})]})})})},a)},he=new De,xe=new Le,Be=new ge,We=({leadId:a,theme:o,contactDetails:u,setContactDetails:y})=>{const w=n.useRef(),N=n.useRef(),f=n.useRef(),c=n.useRef(),x=n.useRef(),k=n.useRef(),l=n.useRef(),v=n.useRef(),[d,U]=n.useState(null),[h,H]=n.useState(!0),[p,I]=n.useState([]),[T,Q]=n.useState(!0),{socket:F}=pe(),[P,B]=n.useState(!1),[q,Y]=n.useState(!1),[$,K]=n.useState(null),[s,r]=n.useState(null),[b,g]=n.useState(""),[L,_]=n.useState(!1),[C,V]=n.useState(null),[O,W]=n.useState(null),[z,A]=n.useState(!1),[te,re]=n.useState(3),[G,se]=n.useState([]),X=n.useRef(!1);n.useEffect(()=>()=>{s&&URL.revokeObjectURL(s)},[s]),n.useEffect(()=>()=>{C&&C.getTracks().forEach(t=>t.stop())},[C]),n.useEffect(()=>{if(!T)return;const t=setInterval(()=>{const i=3+Math.floor(Math.random()*5);re(i),se(Array.from({length:i},()=>Math.random()>.5))},1500);return()=>clearInterval(t)},[T]);const le=(t=!0)=>{const i=v.current;i&&i.scrollTo({top:i.scrollHeight,behavior:t?"smooth":"auto"})},be=()=>{const t=v.current;return t?t.scrollTop+t.clientHeight>=t.scrollHeight-60:!0};n.useEffect(()=>{!T&&p.length&&le(!1)},[T,p.length]),n.useEffect(()=>{if(!(!F||!d))return F.on("message.created",t=>{if(t.wa_id!=(d==null?void 0:d.contact_phone))return;const{id:i,microtime:m}=t;I(j=>j.find(D=>D.id===i)?j.map(D=>D.id===i?{...D,...t}:D):[...j,t].sort((D,R)=>D.microtime-R.microtime));const S=p.reduce((j,E)=>Math.max(j,E.microtime),0);m>S&&Se(m),be()&&!X.current&&setTimeout(()=>le(!0),100)}),()=>{F.off("message.created")}},[F,d,p]),n.useEffect(()=>{if(T)return;const t=v.current;if(!t)return;const i=()=>{t.scrollTop===0&&(X.current=!0,ue())};return t.addEventListener("scroll",i),()=>t.removeEventListener("scroll",i)},[v,T]),n.useEffect(()=>{const t=i=>{l.current&&!l.current.contains(i.target)&&_(!1)};return document.addEventListener("mousedown",t),()=>document.removeEventListener("mousedown",t)},[]),n.useEffect(()=>{z&&C&&x.current&&(x.current.srcObject=C)},[z,C]);const je=async()=>{try{const t=await navigator.mediaDevices.getUserMedia({audio:!0}),i=new MediaRecorder(t),m=[];i.ondataavailable=S=>m.push(S.data),i.onstop=()=>{const S=new Blob(m,{type:"audio/mp3"});K(S),r(URL.createObjectURL(S)),t.getTracks().forEach(j=>j.stop())},i.start(),c.current=i,Y(!0)}catch(t){console.error("Error accessing microphone:",t)}},Ne=()=>{c.current&&c.current.state!=="inactive"&&c.current.stop(),Y(!1)},oe=()=>{c.current&&c.current.state!=="inactive"&&c.current.stop(),Y(!1),K(null),s&&URL.revokeObjectURL(s),r(null)},ce=async t=>{if(t.preventDefault(),!d)return;const i=b.trim();!i&&!$&&!O||(B(!0),$?(console.warn("Audio upload not implemented yet"),console.log($),await he.sendAudio(d.id,$)):O?console.warn("Camera image upload not implemented yet"):await he.send(d.id,i),g(""),K(null),s&&URL.revokeObjectURL(s),r(null),W(null),A(!1),B(!1))},ve=t=>{t.target.files[0]&&(console.warn("File upload not implemented yet"),t.target.value="")},ye=async()=>{try{const t=await navigator.mediaDevices.getUserMedia({video:!0});V(t),A(!0),_(!1)}catch(t){console.error("Error accessing camera:",t)}},de=()=>{C&&(C.getTracks().forEach(t=>t.stop()),V(null)),A(!1),W(null)},we=()=>{const t=k.current,i=x.current;if(!t||!i)return;t.width=i.videoWidth,t.height=i.videoHeight,t.getContext("2d").drawImage(i,0,0),t.toBlob(S=>{W(S),de()},"image/jpeg",.95)},_e=()=>b.trim()||$||O;let me=!1;const ke=async()=>{H(!0);const t=await Be.get(a);if(H(!1),!t){U(null),y(null);return}U(t)},ue=async()=>{var j;if(!d||!a)return;const t=v.current,i=t?t.scrollHeight:0,m=p.filter(E=>E.wa_id==d.contact_phone).sort((E,J)=>E.microtime-J.microtime)[0]??{microtime:(Date.now()+5*60*60*1e3)*1e3};Q(!0);const S=await xe.paginate({summary:{contact_phone:d.contact_phone},filter:[["microtime","<",m.microtime],"and",["wa_id","contains",d.contact_phone]],sort:[{selector:"microtime",desc:!0}],skip:0,take:40});if(Q(!1),((j=S.data)==null?void 0:j.length)>0){if(I(E=>{const J=new Set(E.map(R=>R.id));return[...(S.data??[]).filter(R=>!J.has(R.id)),...E].sort((R,Z)=>R.microtime-Z.microtime)}),t){const E=t.scrollHeight;t.scrollTop=E-i}X.current=!1}},Se=async t=>{d&&await xe.paginate({summary:{contact_phone:d.contact_phone},filter:[["microtime","<=",t],"and",["wa_id","contains",d.contact_phone]],sort:[{selector:"microtime",desc:!0}],skip:0,take:40})};n.useEffect(()=>{U(null),y(null),I([]),a&&ke()},[a]),n.useEffect(()=>{I([]),!(!a&&!d)&&ue()},[d,a]);const Ce=()=>e.jsx(e.Fragment,{children:Array.from({length:te}).map((t,i)=>{const m=1+Math.floor(Math.random()*3);return e.jsx("li",{className:G[i]?"odd":"",style:{marginBottom:i<te-1?"0px":"24px",marginTop:i>0&&G[i]===G[i-1]?"3px":"12px"},children:e.jsx("div",{className:"message-list",children:e.jsx("div",{className:"conversation-text",children:e.jsx("div",{className:`ctext-wrap ${G[i]?`message-out-${o}`:`message-in-${o}`}`,style:{boxShadow:"rgba(11, 20, 26, 0.13) 0px 1px 0.5px 0px",padding:"6px 8px",width:`${300+300*(m-1)/6}px`},children:e.jsxs("div",{className:"placeholder-glow",children:[Array.from({length:m}).map((S,j)=>e.jsx("span",{className:`placeholder ${j===m-1?"col-6 ms-0":"col-12"} `},j)),e.jsx("span",{className:"placeholder time float-end col-1",style:{fontSize:"10px",marginLeft:"6px",marginTop:"8px !important"}})]})})})})},i)})}),Re=()=>e.jsxs("div",{className:"d-flex flex-column align-items-center justify-content-center text-center px-4",style:{height:"calc(100vh - 260px)"},children:[e.jsx("div",{className:"mb-3",children:e.jsx("i",{className:"mdi mdi-account-off-outline text-muted",style:{fontSize:"4rem"}})}),e.jsx("h5",{className:"text-muted mb-2",children:"Este contacto no existe en la empresa seleccionada"}),e.jsx("p",{className:"text-muted mb-3",children:"Por favor, elige otro contacto desde la lista o intenta refrescar la p√°gina si crees que deber√≠a estar aqu√≠."}),e.jsxs("button",{className:"btn btn-outline-primary",onClick:()=>window.location.reload(),children:[e.jsx("i",{className:"mdi mdi-refresh me-1"}),"Refrescar p√°gina"]})]});return e.jsxs(e.Fragment,{children:[e.jsx(Ie,{contact:d,contactDetails:u,setContactDetails:y,loading:h,theme:o}),e.jsxs("div",{className:"card-body p-0 position-relative border",style:{backgroundColor:o=="light"?"rgb(245, 241, 235)":"rgb(22, 23, 23)"},children:[e.jsx("div",{className:"position-absolute",style:{top:0,right:0,bottom:0,left:0,backgroundImage:"url(/assets/img/doodles.png)",backgroundRepeat:"repeat",zIndex:0,opacity:o=="light"?1:.0625}}),e.jsx("section",{className:"d-flex flex-column position-relative",style:{height:"calc(100vh - 260px)",zIndex:1},children:!d&&!h?Re():e.jsxs(e.Fragment,{children:[e.jsxs("ul",{ref:v,className:"conversation-list flex-grow-1 px-3 pt-3 scroll-hidden",style:{overflowY:"auto",scrollBehavior:"smooth",position:"relative"},children:[T&&p.length===0&&Ce(),p.map((t,i)=>{const m=t.role!=="Human",S=me!==m;me=m;const j=new Date(t.microtime/1e3),J=new Date-j,D=Math.floor(J/(1e3*60*60*24));let R=null;D===0?R="Hoy":D===1?R="Ayer":D<=6?R=["Domingo","Lunes","Martes","Mi√©rcoles","Jueves","Viernes","S√°bado"][j.getDay()]:R=`${j.getDate()}/${j.getMonth()+1}/${j.getFullYear()}`;const Z=i===0||new Date(p[i-1].microtime/1e3).toDateString()!==j.toDateString();return e.jsxs(e.Fragment,{children:[Z&&e.jsx("li",{className:"text-center p-0 mx-auto",style:{position:"sticky",top:0,zIndex:10,width:"max-content",marginTop:"12px",marginBottom:"12px"},children:e.jsx("span",{className:"badge",style:{width:"68px",backgroundColor:o=="dark"?"rgb(36, 38, 38)":"rgb(255, 255, 255)",color:o=="dark"?"#fafafa":"#0a0a0a"},children:R})},`date-${i}`),e.jsx(Ue,{forceAfter:Z,isLast:i<p.length-1,message:t,fromMe:m,marginTop:S,theme:o},i)]})})]}),e.jsx("form",{className:"p-2 pt-0 conversation-input",onSubmit:ce,children:e.jsxs("label",{className:`row g-0 align-items-end p-1 ${o=="dark"?"bg-light":"bg-white"}`,htmlFor:"message-input",style:{borderRadius:"24px"},children:[e.jsxs("div",{className:"col-auto mt-0",children:[e.jsxs("div",{className:"dropup",ref:l,children:[e.jsx("button",{type:"button",className:"btn btn-light btn-sm dropdown-toggle","data-bs-toggle":"dropdown","aria-expanded":L,onClick:()=>_(!L),disabled:P||q,title:"Adjuntar archivo",style:{borderRadius:"50%",width:"38px",height:"38px",padding:0},children:e.jsx("i",{className:`mdi ${L?"mdi-close":"mdi-plus"}`})}),e.jsxs("div",{className:"dropdown-menu mb-1",children:[e.jsxs("button",{className:"dropdown-item",href:"#",onClick:t=>{var i,m;t.preventDefault(),(i=N.current)==null||i.setAttribute("accept",".pdf,.doc,.docx"),(m=N.current)==null||m.click()},children:[e.jsx("i",{className:"mdi mdi-file-document me-2",style:{color:"#7F66FF"}}),"Documentos"]}),e.jsxs("button",{className:"dropdown-item",href:"#",onClick:t=>{var i,m;t.preventDefault(),(i=N.current)==null||i.setAttribute("accept","image/*,video/*"),(m=N.current)==null||m.click()},children:[e.jsx("i",{className:"mdi mdi-image me-2",style:{color:"#007BFC"}}),"Fotos y videos"]}),e.jsxs("button",{className:"dropdown-item",href:"#",onClick:t=>{t.preventDefault(),ye()},children:[e.jsx("i",{className:"mdi mdi-camera me-2",style:{color:"#FF2E74"}}),"C√°mara"]}),e.jsxs("button",{className:"dropdown-item",href:"#",onClick:t=>{var i,m;t.preventDefault(),(i=N.current)==null||i.setAttribute("accept","audio/*"),(m=N.current)==null||m.click()},children:[e.jsx("i",{className:"mdi mdi-headphones me-2",style:{color:"#FB6533"}}),"Audio"]})]})]}),e.jsx("input",{ref:N,type:"file",className:"d-none",onChange:ve})]}),e.jsx("div",{className:"col mt-0",children:q?e.jsxs("div",{className:"d-flex align-items-center justify-content-center bg-light rounded-pill",style:{minHeight:"38px"},children:[e.jsx("span",{className:"text-danger me-2",children:"‚óè"})," Grabando..."]}):$?e.jsx("div",{className:"d-flex align-items-center bg-light rounded-pill px-2",style:{minHeight:"38px"},children:e.jsx("audio",{ref:f,src:s,className:"me-2",controls:!0,controlsList:"nodownload",style:{height:"30px"}})}):O?e.jsx("div",{className:"d-flex align-items-center bg-light rounded-pill px-2",style:{minHeight:"38px"},children:e.jsx("span",{className:"me-2",children:"üì∑ Foto capturada"})}):e.jsx("textarea",{ref:w,id:"message-input",className:"form-control w-100",placeholder:"Ingrese su mensaje aqu√≠",rows:1,style:{minHeight:"38px",maxHeight:"188px",fieldSizing:"content",resize:"none",border:"none",backgroundColor:"transparent"},disabled:P||!!$||!!O,value:b,onChange:t=>g(t.target.value),onKeyDown:t=>{t.key==="Enter"&&!t.shiftKey&&(t.preventDefault(),_e()&&ce(t))}})}),e.jsx("div",{className:"col-auto mt-0",children:O&&!z?e.jsxs(e.Fragment,{children:[e.jsx("button",{type:"button",className:"btn btn-danger btn-sm me-1",onClick:()=>W(null),style:{borderRadius:"50%",width:"38px",height:"38px",padding:0},title:"Descartar foto",children:e.jsx("i",{className:"mdi mdi-delete"})}),e.jsx("button",{type:"submit",className:"btn btn-success btn-sm",disabled:P,style:{borderRadius:"50%",width:"38px",height:"38px",padding:0},title:"Enviar foto",children:e.jsx("i",{className:"mdi mdi-send"})})]}):$&&!q?e.jsxs(e.Fragment,{children:[e.jsx("button",{type:"button",className:"btn btn-danger btn-sm me-1",onClick:oe,style:{borderRadius:"50%",width:"38px",height:"38px",padding:0},title:"Descartar audio",children:e.jsx("i",{className:"mdi mdi-delete"})}),e.jsx("button",{type:"submit",className:"btn btn-success btn-sm",disabled:P,style:{borderRadius:"50%",width:"38px",height:"38px",padding:0},title:"Enviar audio",children:e.jsx("i",{className:"mdi mdi-send"})})]}):q?e.jsxs(e.Fragment,{children:[e.jsx("button",{type:"button",className:"btn btn-warning btn-sm me-1",onClick:Ne,style:{borderRadius:"50%",width:"38px",height:"38px",padding:0},title:"Pausar grabaci√≥n",children:e.jsx("i",{className:"mdi mdi-pause"})}),e.jsx("button",{type:"button",className:"btn btn-danger btn-sm",onClick:oe,style:{borderRadius:"50%",width:"38px",height:"38px",padding:0},title:"Descartar grabaci√≥n",children:e.jsx("i",{className:"mdi mdi-delete"})})]}):e.jsx(e.Fragment,{children:b.trim()?e.jsx("button",{type:"submit",className:"btn btn-primary btn-sm",disabled:P,style:{borderRadius:"50%",width:"38px",height:"38px",padding:0},children:P?e.jsx("i",{className:"mdi mdi-spin mdi-loading"}):e.jsx("i",{className:"mdi mdi-send"})}):e.jsx("button",{type:"button",className:"btn btn-outline-primary btn-sm",onClick:je,disabled:P,style:{borderRadius:"50%",width:"38px",height:"38px",padding:0},title:"Grabar audio",children:e.jsx("i",{className:"mdi mdi-microphone"})})})})]})})]})}),z&&e.jsx("div",{className:"position-fixed top-0 start-0 w-100 h-100 d-flex align-items-center justify-content-center",style:{backgroundColor:"rgba(0,0,0,0.8)",zIndex:9999},children:e.jsxs("div",{className:"card",style:{width:"90%",maxWidth:"500px"},children:[e.jsxs("div",{className:"card-header d-flex justify-content-between align-items-center",children:[e.jsx("h5",{className:"mb-0",children:"C√°mara"}),e.jsx("button",{type:"button",className:"btn btn-sm btn-outline-secondary",onClick:de,children:e.jsx("i",{className:"mdi mdi-close"})})]}),e.jsxs("div",{className:"card-body p-0",children:[e.jsx("video",{ref:x,autoPlay:!0,playsInline:!0,muted:!0,className:"w-100",style:{maxHeight:"400px"}}),e.jsx("canvas",{ref:k,className:"d-none"})]}),e.jsx("div",{className:"card-footer d-flex justify-content-center",children:e.jsxs("button",{type:"button",className:"btn btn-primary btn-lg rounded-pill",onClick:we,children:[e.jsx("i",{className:"mdi mdi-camera me-2"}),"Tomar foto"]})})]})})]})]})},ze=new Fe,qe=a=>{var f,c,x,k;const[o,u]=n.useState([]),[y,w]=n.useState(!1),N=async()=>{w(!0);const l=await ze.byClient(a==null?void 0:a.id);u(l??[]),w(!1)};return n.useEffect(()=>{a&&N()},[a]),e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"contact-details d-flex flex-column gap-2 flex-md-row flex-xl-row align-items-center  rounded-4 shadow-sm mb-2 overflow-hidden",children:[e.jsx("img",{src:`/api/whatsapp/profile/${a.contact_phone}`,className:"rounded-circle avatar-lg bg-light border-0 mb-3 mb-md-0 mb-xl-0 flex-shrink-0",alt:a.name,style:{objectFit:"cover"},onError:l=>{l.target.src=`//${M.APP_DOMAIN}/assets/img/user-404.svg`}}),e.jsxs("div",{className:"text-center text-md-start text-xl-start w-100",children:[e.jsx("div",{className:"fw-bold fs-5 text-dark text-truncat",children:a.contact_name}),e.jsx("div",{className:"text-muted text-truncate",children:a.name}),e.jsx("div",{className:"text-muted small text-truncate",children:a.contact_email}),e.jsx("div",{className:"text-muted small text-truncate",children:a.contact_phone})]})]}),e.jsxs("div",{className:"d-flex flex-wrap gap-2 justify-content-around mb-2",children:[e.jsxs("div",{className:"text-center",children:[e.jsx("b",{className:"d-block",children:"Estado de gesti√≥n"}),e.jsx("button",{className:"btn",style:{backgroundColor:((f=a.status)==null?void 0:f.color)||"#6c757d",color:"#fff",cursor:"default"},children:((c=a.status)==null?void 0:c.name)||"Sin estado"})]}),e.jsxs("div",{className:"text-center",children:[e.jsx("b",{className:"d-block",children:"Estado del lead"}),e.jsx("button",{className:"btn",style:{backgroundColor:((x=a.manage_status)==null?void 0:x.color)||"#6c757d",color:"#fff",cursor:"default"},children:((k=a.manage_status)==null?void 0:k.name)||"Sin estado"})]})]}),a.assigned_to&&e.jsxs("div",{className:"p-2 bg-light rounded mb-2",children:[e.jsx("h5",{className:"mt-0 mb-2",children:"Atendido por:"}),e.jsxs("div",{className:"d-flex align-items-start",bis_skin_checked:"1",children:[e.jsx("img",{className:"d-flex me-2 rounded-circle",src:`//${M.APP_DOMAIN}/api/profile/thumbnail/${a.assigned.relative_id}`,onError:l=>{l.target.src=`//${M.APP_DOMAIN}/assets/img/user-404.svg`},alt:a.assigned.fullname,height:"32"}),e.jsxs("div",{className:"w-100 overflow-hidden",bis_skin_checked:"1",children:[e.jsx("h5",{className:"m-0 font-14 text-truncate",children:a.assigned.fullname}),e.jsx("span",{className:"font-12 mb-0 text-truncate d-block",children:a.assigned.email})]})]})]}),e.jsx("hr",{className:"mt-0 mb-2"}),e.jsxs("div",{className:"d-flex justify-content-between align-items-center mb-2",children:[e.jsx("h5",{className:"my-0",children:"Actividad"}),e.jsx(ee,{content:"Ver m√°s",children:e.jsx("a",{href:`/leads/${a.id}`,className:"text-decoration-none",children:e.jsx("i",{className:"mdi mdi-arrow-top-right"})})})]}),y?e.jsxs("div",{className:"placeholder-glow",children:[e.jsx("div",{className:"placeholder mb-2 w-100 rounded",style:{height:70}}),e.jsx("div",{className:"placeholder mb-2 w-100 rounded",style:{height:140}})]}):o.sort((l,v)=>v.created_at>l.created_at?1:-1).map((l,v)=>e.jsx(Pe,{...l,showOptions:!1,extended:!1},`note-${v}`))]})};function ie(a){var o;return typeof a=="string"?a:Array.isArray(a)?a.map(ie).join(""):(o=a==null?void 0:a.props)!=null&&o.children?ie(a.props.children):""}const fe=new ge;fe.paginateSufix=null;const Ye=({users:a,activeLeadId:o,...u})=>{const y=Local.get("adminto_settings")??{},[w,N]=n.useState(y.theme??"light"),[f,c]=n.useState([]),[x,k]=n.useState(o),[l,v]=Ae(ae.business_id,[ae.service_user.id]),[d,U]=n.useState(!1),[h,H]=n.useState(0),[p,I]=n.useState(""),[T,Q]=n.useState(null),[F,P]=n.useState(null),{socket:B}=pe(),q=n.useRef(),Y=n.useRef(),$=async(s=!1)=>{if(d)return;U(!0);const r={fields:["clients.id","clients.contact_name","clients.contact_phone","clients.last_message","clients.last_message_microtime","clients.assigned_to","clients.status_id","clients.manage_status_id"],withCount:["unSeenMessages"],with:["assigned","status","manageStatus"],sort:[{selector:"last_message_microtime",desc:!0}],skip:0,take:40,requireTotalCount:!0},b=[["clients.last_message_microtime","isnotnull"]];if(l.length&&b.push(ne(l.map(_=>["clients.assigned_to","=",_]),"or")),p){const _=[["clients.contact_name","=",p],["clients.contact_name","contains",p],["clients.contact_phone","contains",p]];b.push(ne(_,"or"))}if(s&&f.length>0){const _=Math.min(...f.map(C=>C.last_message_microtime));b.push(["clients.last_message_microtime","<",_])}r.filter=ne(b,"and");const{data:g,totalCount:L}=await fe.paginate(r);c(s?_=>[..._,...g??[]]:g??[]),H(((g==null?void 0:g.length)??0)+(L??0)),U(!1)},K=s=>{const r=s.target.value;I(r),T&&clearTimeout(T),Q(setTimeout(()=>{$(!1)},500))};return n.useEffect(()=>{$(!1)},[l]),n.useEffect(()=>{const s=r=>{r.key==="Escape"&&(k(null),P(null))};return window.addEventListener("keydown",s),()=>window.removeEventListener("keydown",s)},[]),n.useEffect(()=>{if(B)return B.on("client.updated",s=>{c(r=>{const b=r.findIndex(g=>g.id===s.id);if(b!==-1){const g=[...r];return g[b]={...g[b],...s},g}return!l.length||l.includes(s.assigned_to)?[...r,s]:r})}),()=>{B.off("client.updated")}},[B,l]),n.useEffect(()=>{const s=Y.current;if(!s)return;const r=()=>{s.scrollTop+s.clientHeight>=s.scrollHeight-10&&f.length<h&&$(!0)};return s.addEventListener("scroll",r),()=>s.removeEventListener("scroll",r)},[f,d,l,h,p]),n.useEffect(()=>{x?history.pushState({},"",`/chat/${x}`):history.pushState({},"","/chat")},[x]),e.jsx(Me,{...u,title:"Chat",showTitle:!1,setThemeParent:N,children:e.jsxs("div",{className:"row",children:[e.jsx("div",{className:"col-xl-3 col-lg-4",children:e.jsx("div",{className:"card chat-list-card mb-xl-0",children:e.jsxs("div",{className:"card-body p-0",children:[e.jsx("div",{className:"p-2",children:e.jsxs("div",{className:"d-flex w-100 gap-0 align-items-center scroll-hidden",style:{overflowX:"auto"},children:[a.map(s=>e.jsx(ee,{content:`${s.name} ${s.lastname}`,children:e.jsx("div",{onClick:()=>{const r=[...l],b=s.service_user.id,g=r.indexOf(b);g>-1?r.splice(g,1):r.push(b),v(r)},className:`rounded-pill ${l.includes(s.service_user.id)?"bg-purple":""}`,style:{cursor:"pointer",padding:"2px",marginRight:"2px"},children:e.jsx("img",{className:"avatar-xs rounded-circle",src:`//${M.APP_DOMAIN}/api/profile/thumbnail/${s.relative_id}`,onError:r=>{r.target.src=`//${M.APP_DOMAIN}/assets/img/user-404.svg`},alt:s.name,style:{objectFit:"cover",objectPosition:"center"}})})},s.id)),l.length>0&&e.jsx(ee,{content:"Limpiar filtros",children:e.jsx("button",{className:"btn btn-xs btn-soft-danger ms-1 rounded-pill",onClick:()=>v([]),children:e.jsx("i",{className:"mdi mdi-trash-can-outline"})})})]})}),e.jsx("div",{className:"p-2 border-top",children:e.jsxs("div",{className:"search-box chat-search-box",children:[e.jsx("input",{type:"text",className:"form-control rounded-pill",placeholder:"Buscar lead por nombre o n√∫mero...",value:p,onChange:K}),e.jsx("i",{className:"mdi mdi-magnify search-icon"})]})}),e.jsxs("div",{ref:Y,className:"scroll-hidden",style:{overflowY:"auto",height:"calc(100vh - 300px)"},children:[e.jsx("ul",{className:"list-unstyled chat-list mb-0",children:f.sort((s,r)=>new Date(r.last_message_microtime)-new Date(s.last_message_microtime)).map(s=>{var C,V,O,W,z;const r=new Date((s.last_message_microtime??0)/1e3),b=new Date;b.setHours(0,0,0,0);const g=new Date(b);g.setDate(g.getDate()-1);let L;if(r>=b)L=r.toLocaleString("es-ES",{hour:"2-digit",minute:"2-digit"});else if(r>=g)L="Ayer";else{const A=["Domingo","Lunes","Martes","Mi√©rcoles","Jueves","Viernes","S√°bado"];if(Math.floor((new Date-r)/(1e3*60*60*24))<=6)L=A[r.getDay()];else{const G=String(r.getDate()).padStart(2,"0"),se=String(r.getMonth()+1).padStart(2,"0"),X=r.getFullYear();L=`${G}/${se}/${X}`}}let _=s.last_message;return _.startsWith("/audio:")&&(_=e.jsxs(e.Fragment,{children:[e.jsx("i",{className:"mdi mdi-microphone"})," Audio"]})),e.jsx("li",{className:`${s.unread?"unread":""} ${x==s.id?"bg-light":""}`,children:e.jsx("a",{onClick:A=>{k(s.id),A.stopPropagation()},style:{cursor:"pointer"},children:e.jsxs("div",{className:"d-flex",children:[e.jsxs("div",{className:`position-relative flex-shrink-0 chat-user-img ${s.online?"active":""} align-self-center me-2`,children:[e.jsx("img",{src:`/api/whatsapp/profile/${s.contact_phone}`,className:"rounded-circle avatar-sm bg-light",alt:s.name,style:{padding:0,border:"none"},onError:A=>{A.target.src=`//${M.APP_DOMAIN}/assets/img/user-404.svg`}}),s.assigned_to&&((C=s.assigned)==null?void 0:C.relative_id)&&(l.length===0||l.length>1||l[0]!==ae.service_user.id)&&e.jsx(ee,{content:`${s.assigned.name} ${s.assigned.lastname}`,children:e.jsx("img",{className:"position-absolute rounded-pill",src:`//${M.APP_DOMAIN}/api/profile/thumbnail/${s.assigned.relative_id}`,onError:A=>{A.target.src=`//${M.APP_DOMAIN}/assets/img/user-404.svg`},alt:s.assigned.fullname,style:{right:"-4px",bottom:"-4px",objectFit:"cover",objectPosition:"center",padding:0,border:`2px solid ${w=="light"?"#ffffff":"#313844"}`,width:"18px",aspectRatio:1}})},s.assigned.id)]}),e.jsxs("div",{className:"flex-grow-1 overflow-hidden",children:[e.jsx("h5",{className:`text-truncate font-14 mt-0 mb-0 ${s.un_seen_messages_count>0?"fw-bold":""}`,children:s.contact_name}),e.jsx("p",{className:`text-truncate mb-0 ${s.un_seen_messages_count>0?"fw-bold":""}`,title:ie(_)??void 0,style:{color:s.un_seen_messages_count>0?w=="light"?"#343a40":"#f7f7f7":void 0},children:_??e.jsx("i",{className:"text-muted",children:"Sin mensaje"})}),e.jsxs("div",{className:"d-flex gap-1",children:[e.jsx("span",{className:"badge",style:{backgroundColor:((V=s.status)==null?void 0:V.color)??"#6c757d"},children:((O=s.status)==null?void 0:O.name)??"Sin estado"}),e.jsx("span",{className:"badge",style:{backgroundColor:((W=s.manage_status)==null?void 0:W.color)??"#6c757d"},children:((z=s.manage_status)==null?void 0:z.name)??"Sin estado"})]})]}),e.jsxs("div",{className:"d-flex flex-column align-items-end",children:[e.jsx("div",{className:`font-11 ${s.un_seen_messages_count>0?"text-success":""}`,children:L}),s.un_seen_messages_count>0&&e.jsx("span",{className:"badge bg-success rounded-pill mt-1",children:s.un_seen_messages_count})]})]})})},s.id)})}),e.jsxs("div",{className:"text-center py-2",children:[d&&e.jsx("div",{className:"spinner-border spinner-border-sm text-primary",role:"status",children:e.jsx("span",{className:"visually-hidden",children:"Loading contacts..."})}),!d&&f.length>=h&&f.length>0&&e.jsx("span",{className:"text-muted",children:"No hay m√°s contactos"})]})]})]})})}),e.jsx("div",{className:`col-xl-${F?6:9} col-lg-${F?8:12}`,children:e.jsx("div",{className:"conversation-list-card card",children:x?e.jsx(e.Fragment,{children:e.jsx(We,{leadId:x,containerRef:q,theme:w,contactDetails:F,setContactDetails:P})}):e.jsx("div",{className:"card-body d-flex align-items-center justify-content-center",style:{height:"calc(100vh - 184px)"},children:e.jsxs("div",{className:"text-center",children:[e.jsx("img",{src:"/assets/img/icon.svg",alt:`Logo ${M.APP_NAME}`,className:"mb-2",style:{width:60,height:60,objectFit:"contain"}}),e.jsxs("h4",{className:"text-muted",children:["M√≥dulo de chat de ",M.APP_NAME]}),e.jsx("p",{className:"text-muted",children:"Selecciona un contacto para empezar a interactuar"})]})})})}),F&&e.jsx("div",{className:"col-xl-3 col-lg-12",children:e.jsx("div",{className:"card contact-details-card mb-xl-0",children:e.jsx("div",{className:"card-body scroll-hidden",style:{height:"calc(100vh - 186px)",overflowY:"auto"},children:e.jsx(qe,{...F})})})})]})})};$e((a,o)=>{Ee(a).render(e.jsx(Ye,{...o}))});
