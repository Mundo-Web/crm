import{r as n,j as e,G as T,C as Ce,c as Re,L as ae}from"./CreateReactScript-DcwmeAVN.js";import{W as $e,M as Ee,u as ue,i as Q,a as Le,A as Me}from"./Adminto-C2tpzC-o.js";import{L as he}from"./LeadsRest-BtHf6UdV.js";import{H as De,C as Ae,a as Fe}from"./ClientNotesRest-DMWw5gc7.js";import{w as Te,A as ne}from"./ArrayJoin-6-TTvUmN.js";import"./Logout-CMhpjQt5.js";import"./sweetalert2.esm.all-BB4SRWjP.js";const He=new $e,me=new Ee,Pe=new he,Ie=({leadId:r,theme:p,contactDetails:O,setContactDetails:H})=>{const A=n.useRef(),w=n.useRef(),y=n.useRef(),g=n.useRef(),f=n.useRef(),F=n.useRef(),c=n.useRef(),N=n.useRef(),[i,B]=n.useState(null),[_,J]=n.useState(!0),[x,W]=n.useState([]),[C,V]=n.useState(!0),{socket:R}=ue(),[$,P]=n.useState(!1),[z,q]=n.useState(!1),[E,Y]=n.useState(null),[s,l]=n.useState(null),[u,m]=n.useState(""),[k,b]=n.useState(!1),[v,K]=n.useState(null),[D,I]=n.useState(null),[L,X]=n.useState(!1),[Z,ee]=n.useState(3),[G,te]=n.useState([]),se=n.useRef(!1);n.useEffect(()=>()=>{s&&URL.revokeObjectURL(s)},[s]),n.useEffect(()=>()=>{v&&v.getTracks().forEach(t=>t.stop())},[v]),n.useEffect(()=>{if(!C)return;const t=setInterval(()=>{const a=3+Math.floor(Math.random()*5);ee(a),te(Array.from({length:a},()=>Math.random()>.5))},1500);return()=>clearInterval(t)},[C]);const ie=(t=!0)=>{const a=N.current;a&&a.scrollTo({top:a.scrollHeight,behavior:t?"smooth":"auto"})},pe=()=>{const t=N.current;return t?t.scrollTop+t.clientHeight>=t.scrollHeight-60:!0};n.useEffect(()=>{!C&&x.length&&ie(!1)},[C,x.length]),n.useEffect(()=>{if(!(!R||!i))return R.on("message.created",t=>{if(t.wa_id!=(i==null?void 0:i.contact_phone))return;const{id:a,microtime:o}=t;W(d=>d.find(M=>M.id===a)?d.map(M=>M.id===a?{...M,...t}:M):[...d,t].sort((M,S)=>M.microtime-S.microtime));const j=x.reduce((d,h)=>Math.max(d,h.microtime),0);o>j&&we(o),pe()&&!se.current&&setTimeout(()=>ie(!0),100)}),()=>{R.off("message.created")}},[R,i,x]),n.useEffect(()=>{if(C)return;const t=N.current;if(!t)return;const a=()=>{t.scrollTop===0&&(se.current=!0,de())};return t.addEventListener("scroll",a),()=>t.removeEventListener("scroll",a)},[N,C]),n.useEffect(()=>{const t=a=>{c.current&&!c.current.contains(a.target)&&b(!1)};return document.addEventListener("mousedown",t),()=>document.removeEventListener("mousedown",t)},[]),n.useEffect(()=>{L&&v&&f.current&&(f.current.srcObject=v)},[L,v]);const ge=async()=>{try{const t=await navigator.mediaDevices.getUserMedia({audio:!0}),a=new MediaRecorder(t),o=[];a.ondataavailable=j=>o.push(j.data),a.onstop=()=>{const j=new Blob(o,{type:"audio/webm"});Y(j),l(URL.createObjectURL(j)),t.getTracks().forEach(d=>d.stop())},a.start(),g.current=a,q(!0)}catch(t){console.error("Error accessing microphone:",t)}},fe=()=>{g.current&&g.current.state!=="inactive"&&g.current.stop(),q(!1)},le=()=>{g.current&&g.current.state!=="inactive"&&g.current.stop(),q(!1),Y(null),s&&URL.revokeObjectURL(s),l(null)},re=async t=>{if(t.preventDefault(),!i)return;const a=u.trim();!a&&!E&&!D||(P(!0),E?console.warn("Audio upload not implemented yet"):D?console.warn("Camera image upload not implemented yet"):await He.send(i.id,a),m(""),Y(null),s&&URL.revokeObjectURL(s),l(null),I(null),X(!1),P(!1))},be=t=>{t.target.files[0]&&(console.warn("File upload not implemented yet"),t.target.value="")},je=async()=>{try{const t=await navigator.mediaDevices.getUserMedia({video:!0});K(t),X(!0),b(!1)}catch(t){console.error("Error accessing camera:",t)}},ce=()=>{v&&(v.getTracks().forEach(t=>t.stop()),K(null)),X(!1),I(null)},Ne=()=>{const t=F.current,a=f.current;if(!t||!a)return;t.width=a.videoWidth,t.height=a.videoHeight,t.getContext("2d").drawImage(a,0,0),t.toBlob(j=>{I(j),ce()},"image/jpeg",.95)},ve=()=>u.trim()||E||D;let oe=!1;const ye=async()=>{J(!0);const t=await Pe.get(r);if(J(!1),!t){B(null),H(null);return}B(t)},de=async()=>{var d;if(!i||!r)return;const t=N.current,a=t?t.scrollHeight:0,o=x.filter(h=>h.wa_id==i.contact_phone).sort((h,U)=>h.microtime-U.microtime)[0]??{microtime:(Date.now()+5*60*60*1e3)*1e3};V(!0);const j=await me.paginate({summary:{contact_phone:i.contact_phone},filter:[["microtime","<",o.microtime],"and",["wa_id","contains",i.contact_phone]],sort:[{selector:"microtime",desc:!0}],skip:0,take:40});if(V(!1),((d=j.data)==null?void 0:d.length)>0){if(W(h=>{const U=new Set(h.map(S=>S.id));return[...(j.data??[]).filter(S=>!U.has(S.id)),...h].sort((S,Se)=>S.microtime-Se.microtime)}),t){const h=t.scrollHeight;t.scrollTop=h-a}se.current=!1}},we=async t=>{i&&await me.paginate({summary:{contact_phone:i.contact_phone},filter:[["microtime","<=",t],"and",["wa_id","contains",i.contact_phone]],sort:[{selector:"microtime",desc:!0}],skip:0,take:40})};n.useEffect(()=>{B(null),H(null),W([]),r&&ye()},[r]),n.useEffect(()=>{W([]),!(!r&&!i)&&de()},[i,r]);const _e=()=>e.jsx(e.Fragment,{children:Array.from({length:Z}).map((t,a)=>{const o=1+Math.floor(Math.random()*3);return e.jsx("li",{className:G[a]?"odd":"",style:{marginBottom:a<Z-1?"0px":"24px",marginTop:a>0&&G[a]===G[a-1]?"3px":"12px"},children:e.jsx("div",{className:"message-list",children:e.jsx("div",{className:"conversation-text",children:e.jsx("div",{className:`ctext-wrap ${G[a]?`message-out-${p}`:`message-in-${p}`}`,style:{boxShadow:"rgba(11, 20, 26, 0.13) 0px 1px 0.5px 0px",padding:"6px 8px",width:"300px"},children:e.jsxs("div",{className:"placeholder-glow",children:[Array.from({length:o}).map((j,d)=>e.jsx("span",{className:`placeholder ${d===o-1?"col-6 ms-0":"col-12"} `},d)),e.jsx("span",{className:"placeholder time float-end col-1",style:{fontSize:"10px",marginLeft:"6px",marginTop:"8px !important"}})]})})})})},a)})}),ke=()=>e.jsxs("div",{className:"d-flex flex-column align-items-center justify-content-center text-center px-4",style:{height:"calc(100vh - 260px)"},children:[e.jsx("div",{className:"mb-3",children:e.jsx("i",{className:"mdi mdi-account-off-outline text-muted",style:{fontSize:"4rem"}})}),e.jsx("h5",{className:"text-muted mb-2",children:"Este contacto no existe en la empresa seleccionada"}),e.jsx("p",{className:"text-muted mb-3",children:"Por favor, elige otro contacto desde la lista o intenta refrescar la página si crees que debería estar aquí."}),e.jsxs("button",{className:"btn btn-outline-primary",onClick:()=>window.location.reload(),children:[e.jsx("i",{className:"mdi mdi-refresh me-1"}),"Refrescar página"]})]});return e.jsxs(e.Fragment,{children:[e.jsx("div",{className:`card-header ${p=="light"?"bg-white":"bg-light"}`,style:{cursor:"pointer"},onClick:()=>(i==null?void 0:i.id)&&H(O?null:i),children:e.jsxs("div",{className:"d-flex align-items-center",children:[!_&&i&&e.jsx("img",{src:`/api/whatsapp/profile/${i.contact_phone}`,className:"rounded-circle avatar-sm bg-light me-2",alt:i.contact_name,style:{padding:0,border:"none"},onError:t=>{var a;t.target.src=`//${(a=T)==null?void 0:a.APP_DOMAIN}/api/profile/thumbnail/null`}}),_&&e.jsx("div",{className:"placeholder-glow",children:e.jsx("div",{className:"rounded-circle avatar-sm me-2 placeholder",style:{width:36,height:36}})}),e.jsxs("div",{className:`flex-grow-1 ${_?"placeholder-glow":""}`,children:[e.jsx("h5",{className:`mt-0 mb-1 text-truncate ${_?"placeholder col-3":""}`,children:i==null?void 0:i.contact_name}),e.jsxs("p",{className:`d-block font-13 text-muted mb-0 ${_?"placeholder col-2":""}`,children:[e.jsx("i",{className:"mdi mdi-phone me-1 font-11"}),i==null?void 0:i.contact_phone]})]}),!_&&i&&e.jsx("div",{className:"ms-2",children:e.jsx("i",{className:`mdi mdi-24px mdi-chevron-double-${O?"left":"right"} text-muted`})})]})}),e.jsxs("div",{className:"card-body p-0 position-relative border",style:{backgroundColor:p=="light"?"rgb(245, 241, 235)":"rgb(22, 23, 23)"},children:[e.jsx("div",{className:"position-absolute",style:{top:0,right:0,bottom:0,left:0,backgroundImage:"url(/assets/img/doodles.png)",backgroundRepeat:"repeat",zIndex:0,opacity:p=="light"?1:.0625}}),e.jsx("section",{className:"d-flex flex-column position-relative",style:{height:"calc(100vh - 260px)",zIndex:1},children:!i&&!_?ke():e.jsxs(e.Fragment,{children:[e.jsxs("ul",{ref:N,className:"conversation-list flex-grow-1 px-3 pt-3 scroll-hidden",style:{overflowY:"auto",scrollBehavior:"smooth",position:"relative"},children:[C&&x.length===0&&_e(),x.map((t,a)=>{var U;const o=t.role!=="Human",j=oe===o?"3px":"12px";oe=o;let d=((U=t.message)==null?void 0:U.replace(/\{\{.*?\}\}/gs,""))||"",h="";return d.startsWith("/attachment:")&&(h=d.split(`
`)[0],d=d.replace(h,"")),t.role=="Form"?e.jsx("li",{children:e.jsx("div",{className:"chat-day-title mt-3 mb-0",children:e.jsx("small",{className:"title badge badge-soft-dark rounded-pill",children:d})})},a):e.jsx("li",{className:o?"odd":"",style:{marginBottom:a<x.length-1?"0px":"24px",marginTop:j},children:e.jsx("div",{className:"message-list",children:e.jsx("div",{className:"conversation-text",children:e.jsxs("div",{className:`ctext-wrap ${o?`message-out-${p}`:`message-in-${p}`}`,style:{boxShadow:"rgba(11, 20, 26, 0.13) 0px 1px 0.5px 0px",padding:"6px 8px"},children:[t.campaign&&e.jsxs("div",{className:"rounded p-2 mb-2",style:{backgroundColor:"rgba(240, 240, 240, 0.125)",cursor:t.campaign.link?"pointer":"default",maxWidth:"240px"},onClick:()=>{t.campaign.link&&window.open(t.campaign.link,"_blank")},children:[e.jsxs("div",{className:"d-flex gap-1",style:{maxWidth:"100%"},children:[e.jsx("div",{className:"fw-bold",children:t.campaign.code}),e.jsx("div",{className:"small text-truncate",children:t.campaign.title})]}),e.jsx("small",{className:"d-block text-truncate",style:{maxWidth:300},children:t.campaign.link})]}),h&&e.jsxs(e.Fragment,{children:[e.jsx("img",{src:h.replace("/attachment:",""),className:"mb-1",alt:"attachment",style:{minWidth:"300px",width:"100%",maxWidth:"100%",minHeight:"200px",maxHeight:"300px",borderRadius:"4px",objectFit:"cover"},onError:M=>{const S=M.target;S&&S.parentNode&&(S.style.display="none")}}),e.jsx("div",{className:"d-flex justify-content-end",children:e.jsxs("a",{className:"btn btn-xs btn-light mb-1 text-nowrap d-flex text-end",href:h.replace("/attachment:",""),target:"_blank",rel:"noreferrer",download:!0,children:[e.jsx("i",{className:"mdi mdi-download me-1"}),e.jsx("span",{children:"Descargar adjunto"})]})}),!d.trim()&&e.jsx("span",{className:"time mt-0 float-end",style:{fontSize:"10px",marginLeft:"6px",marginTop:"8px !important"},children:moment(t.created_at).subtract(5,"hours").format("HH:mm")})]}),d.trim()&&e.jsx(De,{className:"text-start font-14",html:Te(d+`<span class="time mt-0 float-end" style="font-size: 10px; margin-left: 6px; margin-top: 8px !important">${moment(t.created_at).subtract(5,"hours").format("HH:mm")}</span>`)})]})})})},a)})]}),e.jsx("form",{className:"p-2 pt-0 conversation-input",onSubmit:re,children:e.jsxs("label",{className:`row g-0 align-items-end p-1 ${p=="dark"?"bg-light":"bg-white"}`,htmlFor:"message-input",style:{borderRadius:"24px"},children:[e.jsxs("div",{className:"col-auto mt-0",children:[e.jsxs("div",{className:"dropup",ref:c,children:[e.jsx("button",{type:"button",className:"btn btn-light btn-sm dropdown-toggle","data-bs-toggle":"dropdown","aria-expanded":k,onClick:()=>b(!k),disabled:$||z,title:"Adjuntar archivo",style:{borderRadius:"50%",width:"38px",height:"38px",padding:0},children:e.jsx("i",{className:`mdi ${k?"mdi-close":"mdi-plus"}`})}),e.jsxs("div",{className:"dropdown-menu mb-1",children:[e.jsxs("button",{className:"dropdown-item",href:"#",onClick:t=>{var a,o;t.preventDefault(),(a=w.current)==null||a.setAttribute("accept",".pdf,.doc,.docx"),(o=w.current)==null||o.click()},children:[e.jsx("i",{className:"mdi mdi-file-document me-2",style:{color:"#7F66FF"}}),"Documentos"]}),e.jsxs("button",{className:"dropdown-item",href:"#",onClick:t=>{var a,o;t.preventDefault(),(a=w.current)==null||a.setAttribute("accept","image/*,video/*"),(o=w.current)==null||o.click()},children:[e.jsx("i",{className:"mdi mdi-image me-2",style:{color:"#007BFC"}}),"Fotos y videos"]}),e.jsxs("button",{className:"dropdown-item",href:"#",onClick:t=>{t.preventDefault(),je()},children:[e.jsx("i",{className:"mdi mdi-camera me-2",style:{color:"#FF2E74"}}),"Cámara"]}),e.jsxs("button",{className:"dropdown-item",href:"#",onClick:t=>{var a,o;t.preventDefault(),(a=w.current)==null||a.setAttribute("accept","audio/*"),(o=w.current)==null||o.click()},children:[e.jsx("i",{className:"mdi mdi-headphones me-2",style:{color:"#FB6533"}}),"Audio"]})]})]}),e.jsx("input",{ref:w,type:"file",className:"d-none",onChange:be})]}),e.jsx("div",{className:"col mt-0",children:z?e.jsxs("div",{className:"d-flex align-items-center justify-content-center bg-light rounded-pill",style:{minHeight:"38px"},children:[e.jsx("span",{className:"text-danger me-2",children:"●"})," Grabando..."]}):E?e.jsx("div",{className:"d-flex align-items-center bg-light rounded-pill px-2",style:{minHeight:"38px"},children:e.jsx("audio",{ref:y,src:s,className:"me-2",controls:!0,controlsList:"nodownload",style:{height:"30px"}})}):D?e.jsx("div",{className:"d-flex align-items-center bg-light rounded-pill px-2",style:{minHeight:"38px"},children:e.jsx("span",{className:"me-2",children:"📷 Foto capturada"})}):e.jsx("textarea",{ref:A,id:"message-input",className:"form-control w-100",placeholder:"Ingrese su mensaje aquí",rows:1,style:{minHeight:"38px",maxHeight:"188px",fieldSizing:"content",resize:"none",border:"none",backgroundColor:"transparent"},disabled:$||!!E||!!D,value:u,onChange:t=>m(t.target.value),onKeyDown:t=>{t.key==="Enter"&&!t.shiftKey&&(t.preventDefault(),ve()&&re(t))}})}),e.jsx("div",{className:"col-auto mt-0",children:D&&!L?e.jsxs(e.Fragment,{children:[e.jsx("button",{type:"button",className:"btn btn-danger btn-sm me-1",onClick:()=>I(null),style:{borderRadius:"50%",width:"38px",height:"38px",padding:0},title:"Descartar foto",children:e.jsx("i",{className:"mdi mdi-delete"})}),e.jsx("button",{type:"submit",className:"btn btn-success btn-sm",disabled:$,style:{borderRadius:"50%",width:"38px",height:"38px",padding:0},title:"Enviar foto",children:e.jsx("i",{className:"mdi mdi-send"})})]}):E&&!z?e.jsxs(e.Fragment,{children:[e.jsx("button",{type:"button",className:"btn btn-danger btn-sm me-1",onClick:le,style:{borderRadius:"50%",width:"38px",height:"38px",padding:0},title:"Descartar audio",children:e.jsx("i",{className:"mdi mdi-delete"})}),e.jsx("button",{type:"submit",className:"btn btn-success btn-sm",disabled:$,style:{borderRadius:"50%",width:"38px",height:"38px",padding:0},title:"Enviar audio",children:e.jsx("i",{className:"mdi mdi-send"})})]}):z?e.jsxs(e.Fragment,{children:[e.jsx("button",{type:"button",className:"btn btn-warning btn-sm me-1",onClick:fe,style:{borderRadius:"50%",width:"38px",height:"38px",padding:0},title:"Pausar grabación",children:e.jsx("i",{className:"mdi mdi-pause"})}),e.jsx("button",{type:"button",className:"btn btn-danger btn-sm",onClick:le,style:{borderRadius:"50%",width:"38px",height:"38px",padding:0},title:"Descartar grabación",children:e.jsx("i",{className:"mdi mdi-delete"})})]}):e.jsx(e.Fragment,{children:u.trim()?e.jsx("button",{type:"submit",className:"btn btn-primary btn-sm",disabled:$,style:{borderRadius:"50%",width:"38px",height:"38px",padding:0},children:$?e.jsx("i",{className:"mdi mdi-spin mdi-loading"}):e.jsx("i",{className:"mdi mdi-send"})}):e.jsx("button",{type:"button",className:"btn btn-outline-primary btn-sm",onClick:ge,disabled:$,style:{borderRadius:"50%",width:"38px",height:"38px",padding:0},title:"Grabar audio",children:e.jsx("i",{className:"mdi mdi-microphone"})})})})]})})]})}),L&&e.jsx("div",{className:"position-fixed top-0 start-0 w-100 h-100 d-flex align-items-center justify-content-center",style:{backgroundColor:"rgba(0,0,0,0.8)",zIndex:9999},children:e.jsxs("div",{className:"card",style:{width:"90%",maxWidth:"500px"},children:[e.jsxs("div",{className:"card-header d-flex justify-content-between align-items-center",children:[e.jsx("h5",{className:"mb-0",children:"Cámara"}),e.jsx("button",{type:"button",className:"btn btn-sm btn-outline-secondary",onClick:ce,children:e.jsx("i",{className:"mdi mdi-close"})})]}),e.jsxs("div",{className:"card-body p-0",children:[e.jsx("video",{ref:f,autoPlay:!0,playsInline:!0,muted:!0,className:"w-100",style:{maxHeight:"400px"}}),e.jsx("canvas",{ref:F,className:"d-none"})]}),e.jsx("div",{className:"card-footer d-flex justify-content-center",children:e.jsxs("button",{type:"button",className:"btn btn-primary btn-lg rounded-pill",onClick:Ne,children:[e.jsx("i",{className:"mdi mdi-camera me-2"}),"Tomar foto"]})})]})})]})]})},Ue=new Ae,Oe=r=>{var y,g,f,F;const[p,O]=n.useState([]),[H,A]=n.useState(!1),w=async()=>{A(!0);const c=await Ue.byClient(r==null?void 0:r.id);O(c??[]),A(!1)};return n.useEffect(()=>{r&&w()},[r]),e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"contact-details d-flex flex-column gap-2 flex-md-row flex-xl-row align-items-center  rounded-4 shadow-sm mb-2 overflow-hidden",children:[e.jsx("img",{src:`/api/whatsapp/profile/${r.contact_phone}`,className:"rounded-circle avatar-lg bg-light border-0 mb-3 mb-md-0 mb-xl-0 flex-shrink-0",alt:r.name,style:{objectFit:"cover"},onError:c=>{c.target.src=`//${T.APP_DOMAIN}/api/profile/thumbnail/null`}}),e.jsxs("div",{className:"text-center text-md-start text-xl-start w-100",children:[e.jsx("div",{className:"fw-bold fs-5 text-dark text-truncat",children:r.contact_name}),e.jsx("div",{className:"text-muted text-truncate",children:r.name}),e.jsx("div",{className:"text-muted small text-truncate",children:r.contact_email}),e.jsx("div",{className:"text-muted small text-truncate",children:r.contact_phone})]})]}),e.jsxs("div",{className:"d-flex flex-wrap gap-2 justify-content-around mb-2",children:[e.jsxs("div",{className:"text-center",children:[e.jsx("b",{className:"d-block",children:"Estado de gestión"}),e.jsx("button",{className:"btn",style:{backgroundColor:((y=r.status)==null?void 0:y.color)||"#6c757d",color:"#fff",cursor:"default"},children:((g=r.status)==null?void 0:g.name)||"Sin estado"})]}),e.jsxs("div",{className:"text-center",children:[e.jsx("b",{className:"d-block",children:"Estado del lead"}),e.jsx("button",{className:"btn",style:{backgroundColor:((f=r.manage_status)==null?void 0:f.color)||"#6c757d",color:"#fff",cursor:"default"},children:((F=r.manage_status)==null?void 0:F.name)||"Sin estado"})]})]}),r.assigned_to&&e.jsxs("div",{className:"p-2 bg-light rounded mb-2",children:[e.jsx("h5",{className:"mt-0 mb-2",children:"Atendido por:"}),e.jsxs("div",{className:"d-flex align-items-start",bis_skin_checked:"1",children:[e.jsx("img",{className:"d-flex me-2 rounded-circle",src:`//${T.APP_DOMAIN}/api/profile/thumbnail/${r.assigned.relative_id}`,alt:"Manuel",height:"32"}),e.jsxs("div",{className:"w-100 overflow-hidden",bis_skin_checked:"1",children:[e.jsx("h5",{className:"m-0 font-14 text-truncate",children:r.assigned.fullname}),e.jsx("span",{className:"font-12 mb-0 text-truncate d-block",children:r.assigned.email})]})]})]}),e.jsx("hr",{className:"mt-0 mb-2"}),e.jsxs("div",{className:"d-flex justify-content-between align-items-center mb-2",children:[e.jsx("h5",{className:"my-0",children:"Actividad"}),e.jsx(Q,{content:"Ver más",children:e.jsx("a",{href:`/leads/${r.id}`,className:"text-decoration-none",children:e.jsx("i",{className:"mdi mdi-arrow-top-right"})})})]}),H?e.jsxs("div",{className:"placeholder-glow",children:[e.jsx("div",{className:"placeholder mb-2 w-100 rounded",style:{height:70}}),e.jsx("div",{className:"placeholder mb-2 w-100 rounded",style:{height:140}})]}):p.sort((c,N)=>N.created_at>c.created_at?1:-1).map((c,N)=>e.jsx(Fe,{...c,showOptions:!1,extended:!1},`note-${N}`))]})},xe=new he;xe.paginateSufix=null;const Be=({users:r,activeLeadId:p,...O})=>{const H=Local.get("adminto_settings")??{},[A,w]=n.useState(H.theme??"light"),[y,g]=n.useState([]),[f,F]=n.useState(p),[c,N]=Le(ae.business_id,[ae.service_user.id]),[i,B]=n.useState(!1),[_,J]=n.useState(0),[x,W]=n.useState(""),[C,V]=n.useState(null),[R,$]=n.useState(null),{socket:P}=ue(),z=n.useRef(),q=n.useRef(),E=async(s=!1)=>{if(i)return;B(!0);const l={fields:["clients.id","clients.contact_name","clients.contact_phone","clients.last_message","clients.last_message_microtime","clients.assigned_to","clients.status_id","clients.manage_status_id"],withCount:["unSeenMessages"],with:["assigned","status","manageStatus"],sort:[{selector:"last_message_microtime",desc:!0}],skip:0,take:40,requireTotalCount:!0},u=[["clients.last_message_microtime","isnotnull"]];if(c.length&&u.push(ne(c.map(b=>["clients.assigned_to","=",b]),"or")),x){const b=[["clients.contact_name","=",x],["clients.contact_name","contains",x],["clients.contact_phone","contains",x]];u.push(ne(b,"or"))}if(s&&y.length>0){const b=Math.min(...y.map(v=>v.last_message_microtime));u.push(["clients.last_message_microtime","<",b])}l.filter=ne(u,"and");const{data:m,totalCount:k}=await xe.paginate(l);g(s?b=>[...b,...m??[]]:m??[]),J(((m==null?void 0:m.length)??0)+(k??0)),B(!1)},Y=s=>{const l=s.target.value;W(l),C&&clearTimeout(C),V(setTimeout(()=>{E(!1)},500))};return n.useEffect(()=>{E(!1)},[c]),n.useEffect(()=>{const s=l=>{l.key==="Escape"&&(F(null),$(null))};return window.addEventListener("keydown",s),()=>window.removeEventListener("keydown",s)},[]),n.useEffect(()=>{if(P)return P.on("client.updated",s=>{g(l=>{const u=l.findIndex(m=>m.id===s.id);if(u!==-1){const m=[...l];return m[u]={...m[u],...s},m}return!c.length||c.includes(s.assigned_to)?[...l,s]:l})}),()=>{P.off("client.updated")}},[P,c]),n.useEffect(()=>{const s=q.current;if(!s)return;const l=()=>{s.scrollTop+s.clientHeight>=s.scrollHeight-10&&y.length<_&&E(!0)};return s.addEventListener("scroll",l),()=>s.removeEventListener("scroll",l)},[y,i,c,_,x]),n.useEffect(()=>{f?history.pushState({},"",`/chat/${f}`):history.pushState({},"","/chat")},[f]),e.jsx(Me,{...O,title:"Chat",showTitle:!1,setThemeParent:w,children:e.jsxs("div",{className:"row",children:[e.jsx("div",{className:"col-xl-3 col-lg-4",children:e.jsx("div",{className:"card chat-list-card mb-xl-0",children:e.jsxs("div",{className:"card-body p-0",children:[e.jsx("div",{className:"p-2",children:e.jsxs("div",{className:"d-flex w-100 gap-0 align-items-center scroll-hidden",style:{overflowX:"auto"},children:[r.map(s=>e.jsx(Q,{content:`${s.name} ${s.lastname}`,children:e.jsx("div",{onClick:()=>{const l=[...c],u=s.service_user.id,m=l.indexOf(u);m>-1?l.splice(m,1):l.push(u),N(l)},className:`rounded-pill ${c.includes(s.service_user.id)?"bg-purple":""}`,style:{cursor:"pointer",padding:"2px",marginRight:"2px"},children:e.jsx("img",{className:"avatar-xs rounded-circle",src:`//${T.APP_DOMAIN}/api/profile/thumbnail/${s.relative_id}`,alt:s.name,style:{objectFit:"cover",objectPosition:"center"}})})},s.id)),c.length>0&&e.jsx(Q,{content:"Limpiar filtros",children:e.jsx("button",{className:"btn btn-xs btn-soft-danger ms-1 rounded-pill",onClick:()=>N([]),children:e.jsx("i",{className:"mdi mdi-trash-can-outline"})})})]})}),e.jsx("div",{className:"p-2 border-top",children:e.jsxs("div",{className:"search-box chat-search-box",children:[e.jsx("input",{type:"text",className:"form-control rounded-pill",placeholder:"Buscar lead por nombre o número...",value:x,onChange:Y}),e.jsx("i",{className:"mdi mdi-magnify search-icon"})]})}),e.jsxs("div",{ref:q,className:"scroll-hidden",style:{overflowY:"auto",height:"calc(100vh - 300px)"},children:[e.jsx("ul",{className:"list-unstyled chat-list mb-0",children:y.sort((s,l)=>new Date(l.last_message_microtime)-new Date(s.last_message_microtime)).map(s=>{var b,v,K,D,I;const l=new Date((s.last_message_microtime??0)/1e3),u=new Date;u.setHours(0,0,0,0);const m=new Date(u);m.setDate(m.getDate()-1);let k;if(l>=u)k=l.toLocaleString("es-ES",{hour:"2-digit",minute:"2-digit"});else if(l>=m)k="Ayer";else{const L=["Domingo","Lunes","Martes","Miércoles","Jueves","Viernes","Sábado"];if(Math.floor((new Date-l)/(1e3*60*60*24))<=6)k=L[l.getDay()];else{const ee=String(l.getDate()).padStart(2,"0"),G=String(l.getMonth()+1).padStart(2,"0"),te=l.getFullYear();k=`${ee}/${G}/${te}`}}return e.jsx("li",{className:`${s.unread?"unread":""} ${f==s.id?"bg-light":""}`,children:e.jsx("a",{onClick:L=>{F(s.id),L.stopPropagation()},style:{cursor:"pointer"},children:e.jsxs("div",{className:"d-flex",children:[e.jsxs("div",{className:`position-relative flex-shrink-0 chat-user-img ${s.online?"active":""} align-self-center me-2`,children:[e.jsx("img",{src:`/api/whatsapp/profile/${s.contact_phone}`,className:"rounded-circle avatar-sm bg-light",alt:s.name,style:{padding:0,border:"none"},onError:L=>{L.target.src=`//${T.APP_DOMAIN}/api/profile/thumbnail/null`}}),s.assigned_to&&((b=s.assigned)==null?void 0:b.relative_id)&&(c.length===0||c.length>1||c[0]!==ae.service_user.id)&&e.jsx(Q,{content:`${s.assigned.name} ${s.assigned.lastname}`,children:e.jsx("img",{className:"position-absolute rounded-pill",src:`//${T.APP_DOMAIN}/api/profile/thumbnail/${s.assigned.relative_id}`,alt:s.assigned.fullname,style:{right:"-4px",bottom:"-4px",objectFit:"cover",objectPosition:"center",padding:0,border:`2px solid ${A=="light"?"#ffffff":"#313844"}`,width:"18px",aspectRatio:1}})},s.assigned.id)]}),e.jsxs("div",{className:"flex-grow-1 overflow-hidden",children:[e.jsx("h5",{className:`text-truncate font-14 mt-0 mb-0 ${s.un_seen_messages_count>0?"fw-bold":""}`,children:s.contact_name}),e.jsx("p",{className:`text-truncate mb-0 ${s.un_seen_messages_count>0?"fw-bold":""}`,title:s.last_message??void 0,style:{color:s.un_seen_messages_count>0?A=="light"?"#343a40":"#f7f7f7":void 0},children:s.last_message??e.jsx("i",{className:"text-muted",children:"Sin mensaje"})}),e.jsxs("div",{className:"d-flex gap-1",children:[e.jsx("span",{className:"badge",style:{backgroundColor:((v=s.status)==null?void 0:v.color)??"#6c757d"},children:((K=s.status)==null?void 0:K.name)??"Sin estado"}),e.jsx("span",{className:"badge",style:{backgroundColor:((D=s.manage_status)==null?void 0:D.color)??"#6c757d"},children:((I=s.manage_status)==null?void 0:I.name)??"Sin estado"})]})]}),e.jsxs("div",{className:"d-flex flex-column align-items-end",children:[e.jsx("div",{className:`font-11 ${s.un_seen_messages_count>0?"text-success":""}`,children:k}),s.un_seen_messages_count>0&&e.jsx("span",{className:"badge bg-success rounded-pill mt-1",children:s.un_seen_messages_count})]})]})})},s.id)})}),e.jsxs("div",{className:"text-center py-2",children:[i&&e.jsx("div",{className:"spinner-border spinner-border-sm text-primary",role:"status",children:e.jsx("span",{className:"visually-hidden",children:"Loading contacts..."})}),!i&&y.length>=_&&y.length>0&&e.jsx("span",{className:"text-muted",children:"No hay más contactos"})]})]})]})})}),e.jsx("div",{className:`col-xl-${R?6:9} col-lg-${R?8:12}`,children:e.jsx("div",{className:"conversation-list-card card",children:f?e.jsx(e.Fragment,{children:e.jsx(Ie,{leadId:f,containerRef:z,theme:A,contactDetails:R,setContactDetails:$})}):e.jsx("div",{className:"card-body d-flex align-items-center justify-content-center",style:{height:"calc(100vh - 184px)"},children:e.jsxs("div",{className:"text-center",children:[e.jsx("img",{src:"/assets/img/icon.svg",alt:`Logo ${T.APP_NAME}`,className:"mb-2",style:{width:60,height:60,objectFit:"contain"}}),e.jsxs("h4",{className:"text-muted",children:["Módulo de chat de ",T.APP_NAME]}),e.jsx("p",{className:"text-muted",children:"Selecciona un contacto para empezar a interactuar"})]})})})}),R&&e.jsx("div",{className:"col-xl-3 col-lg-12",children:e.jsx("div",{className:"card contact-details-card mb-xl-0",children:e.jsx("div",{className:"card-body scroll-hidden",style:{height:"calc(100vh - 186px)",overflowY:"auto"},children:e.jsx(Oe,{...R})})})})]})})};Ce((r,p)=>{Re(r).render(e.jsx(Be,{...p}))});
