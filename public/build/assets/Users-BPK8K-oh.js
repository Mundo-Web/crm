var B=Object.defineProperty;var F=(n,i,r)=>i in n?B(n,i,{enumerable:!0,configurable:!0,writable:!0,value:r}):n[i]=r;var R=(n,i,r)=>F(n,typeof i!="symbol"?i+"":i,r);import{m as O,r as o,j as e,G as y,C as V,c as H}from"./CreateReactScript-FT9riFD6.js";import{B as G,i as N,A as L}from"./Adminto-TN_zr-G5.js";import{M}from"./Modal-CvgTmxtu.js";import{t as S,S as z}from"./sweetalert2.esm.all-BLfQoUmi.js";import{U as J}from"./UsersRest-eX6fqMc4.js";import"./Logout-Djwh9QSR.js";class C extends G{constructor(){super(...arguments);R(this,"path","atalaya/users");R(this,"invite",async r=>{try{const{status:s,result:t}=await O.Fetch(`/api/${this.path}/invite`,{method:"POST",body:JSON.stringify(r)});if(!s)throw new Error((t==null?void 0:t.message)||"Ocurrio un error inesperado");return{status:!0,data:t.data,summary:t.summary}}catch(s){return{status:!1,message:s.message}}});R(this,"deleteInvitation",async r=>{try{const{status:s,result:t}=await O.Fetch(`/api/${this.path}/external/${r}`,{method:"DELETE"});if(!s)throw new Error((t==null?void 0:t.message)??"Ocurrio un error inesperado");return{status:!0}}catch(s){return{status:!1,message:s.message}}})}}const q=new C,k=({relative_id:n,fullname:i,email:r,match:s,setUsers:t,setInvitations:h})=>{const[u,d]=o.useState(!1),[g,v]=o.useState(!1),m=async()=>{d(!0);const{status:a,message:c,data:l,summary:p}=await q.invite({match:s,email:r});if(d(!1),!a)return S(c??"Ocurrió un error inesperado",{icon:e.jsx("i",{className:"mdi mdi-alert text-danger"})});v(!0),console.log(p),p!=null&&p.external?h(b=>b.some(w=>w.email===l.email)?b.map(w=>w.email===l.email?l:w):[...b,l]):t(b=>[...b,l])},x=a=>n?e.jsx(e.Fragment,{children:a}):e.jsx(N,{content:"Invitar usuario a Atalaya",children:a});return e.jsx("div",{className:"card border mb-0",children:e.jsxs("div",{className:"card-body p-2 d-flex align-items-center gap-2",children:[e.jsx("img",{src:`//${y.APP_DOMAIN}/api/profile/thumbnail/${n}`,onError:a=>{a.target.src=`//${y.APP_DOMAIN}/assets/img/user-404.svg`},className:"rounded-circle",alt:i,width:"40",height:"40"}),e.jsxs("div",{className:"flex-grow-1",children:[e.jsx("h5",{className:"mt-0 mb-1",children:i}),e.jsx("div",{className:"text-muted",children:r})]}),x(e.jsx("button",{className:"btn btn-white btn-sm rounded-pill",onClick:()=>m(),disabled:u||g,children:u?e.jsx("i",{className:"mdi mdi-loading mdi-spin"}):g?e.jsx("i",{className:"mdi mdi-email-check"}):e.jsx("i",{className:`mdi ${n?"mdi-account-plus":"mdi mdi-email-send"}`})}))]})})},K=new J,P=new C,Q=({roles:n,match:i,setUsers:r,...s})=>{var m,x;const[t,h]=o.useState(!1),u=async(a,c)=>{await K.assignRole({role:a.id,user:c.id})&&location.reload()},d=async()=>{h(!0);const{status:a,message:c}=await P.invite({match:i,email:s.email});if(h(!1),!a)return S(c??"Ocurrió un error inesperado",{icon:e.jsx("i",{className:"mdi mdi-alert text-danger"})})},g=async()=>{const{isConfirmed:a}=await z.fire({title:"¿Estás seguro?",text:`${s.name} será eliminado de la gestión de ${y.APP_NAME}. Esta acción no se puede deshacer.`,icon:"warning",showCancelButton:!0,confirmButtonColor:"#3085d6",cancelButtonColor:"#d33",confirmButtonText:"¡Sí, eliminar!",cancelButtonText:"Cancelar"});if(!a)return;const c=await P.delete(s.id);if(!c)return S(c.message??"Ocurrió un error inesperado",{icon:e.jsx("i",{className:"mdi mdi-alert text-danger"})});r(l=>l.filter(p=>p.id!==s.id))},v=((x=(m=s.service_user)==null?void 0:m.roles)==null?void 0:x[0])??{name:s.is_owner?"Owner":"Sin rol"};return e.jsx("div",{className:"card mb-0",style:{width:"360px"},children:e.jsx("div",{className:"card-body widget-user",children:e.jsxs("div",{className:"d-flex align-items-center gap-2 w-100",children:[e.jsx("div",{className:"flex-shrink-0 avatar-lg",children:e.jsx("img",{src:`//${y.APP_DOMAIN}/api/profile/thumbnail/${s.relative_id}`,onError:a=>{a.target.src=`//${y.APP_DOMAIN}/assets/img/user-404.svg`},className:"img-fluid rounded-circle",alt:"user"})}),e.jsxs("div",{className:"flex-grow-1",children:[e.jsxs("div",{className:"overflow-hidden",style:{width:"228px"},children:[e.jsxs("h5",{className:"mt-0 mb-1 text-truncate",children:[s.name," ",s.lastname]}),e.jsx("p",{className:"d-inline-block text-muted mb-2 font-13 text-truncate w-100",children:s.email})]}),e.jsxs("div",{className:"d-flex gap-1",children:[s.is_owner?e.jsxs("div",{className:"btn btn-white btn-sm",children:[e.jsx("i",{className:"mdi mdi-crown me-1 text-blue"}),"Owner"]}):e.jsxs("div",{className:"btn-group",children:[e.jsxs("button",{className:"btn btn-white btn-sm dropdown-toggle",type:"button","data-bs-toggle":"dropdown","aria-haspopup":"true","aria-expanded":"false",children:[v.name," ",e.jsx("i",{className:"mdi mdi-chevron-down"})]}),e.jsxs("div",{className:"dropdown-menu",children:[n.map((a,c)=>e.jsx(N,{content:`Asignar rol ${a.name}`,children:e.jsxs("a",{className:"dropdown-item",href:"#",onClick:()=>u(a,s),children:[e.jsx("i",{className:"mdi mdi-account-convert me-2"}),a.name]})},c)),e.jsx("div",{className:"dropdown-divider"}),e.jsxs("a",{className:"dropdown-item",href:"#",children:[e.jsx("i",{className:"mdi mdi-plus me-2"}),"Nuevo rol"]})]})]}),!s.invitation_accepted&&e.jsx(N,{content:"Reenviar invitación",children:e.jsx("button",{className:"btn btn-sm btn-white rounded-pill",onClick:()=>d(),disabled:t,children:t?e.jsx("i",{className:"mdi mdi-loading mdi-spin"}):e.jsx("i",{className:"mdi mdi-email-send text-primary"})})}),!s.is_owner&&e.jsx(N,{content:"Eliminar usuario",children:e.jsx("button",{className:"btn btn-sm btn-white rounded-pill",onClick:()=>g(),children:e.jsx("i",{className:"mdi mdi-delete text-danger"})})})]})]})]})})},`user-${s.id}`)},U=new C,W=({id:n,email:i,created_at:r,updated_at:s,setInvitations:t,match:h})=>{const[u,d]=o.useState(!1),g=async()=>{d(!0);const{status:m,message:x,data:a}=await U.invite({match:h,email:i});if(d(!1),!m)return S(x??"Ocurrió un error inesperado",{icon:e.jsx("i",{className:"mdi mdi-alert text-danger"})});t(c=>c.map(l=>l.email===a.email?a:l))},v=async()=>{d(!0);const{status:m,message:x}=await U.deleteInvitation(n);if(d(!1),!m)return S(x??"Ocurrió un error inesperado",{icon:e.jsx("i",{className:"mdi mdi-alert text-danger"})});t(a=>a.filter(c=>c.id!==n))};return e.jsxs("tr",{children:[e.jsx("td",{valign:"middle",children:i}),e.jsx("td",{valign:"middle",children:moment(r).subtract(5,"hours").format("lll")}),e.jsx("td",{valign:"middle",children:moment(s).subtract(5,"hours").format("lll")}),e.jsx("td",{children:e.jsxs("div",{className:"d-flex gap-1",children:[e.jsx(N,{content:"Reenviar",children:e.jsx("button",{className:"btn btn-xs btn-white waves-effect",type:"button",onClick:()=>g(),disabled:u,children:u?e.jsx("i",{className:"mdi mdi-loading mdi-spin"}):e.jsx("i",{className:"mdi mdi-email-send text-primary"})})}),e.jsx(N,{content:"Eliminar",children:e.jsx("button",{className:"btn btn-xs btn-white waves-effect",type:"button",onClick:()=>v(),disabled:u,children:e.jsx("i",{className:"mdi mdi-delete text-danger"})})})]})})]})},X=({modalRef:n,invitations:i,setInvitations:r,match:s})=>e.jsx(M,{modalRef:n,title:"Invitaciones externas",hideFooter:!0,onSubmit:t=>t.preventDefault(),size:"lg",children:e.jsx("div",{style:{minHeight:"360px"},children:e.jsxs("table",{className:"table table-sm mb-0",children:[e.jsx("thead",{className:"table-light",children:e.jsxs("tr",{children:[e.jsx("th",{children:"Correo"}),e.jsx("th",{children:"Primer envío"}),e.jsx("th",{children:"Último envío"}),e.jsx("th",{children:"Acciones"})]})}),e.jsx("tbody",{children:i.map((t,h)=>e.jsx(W,{...t,setInvitations:r,match:s},h))})]})})}),D=new C,Y=n=>{const{users:i,invitations:r,roles:s,match:t}=n,[h,u]=o.useState(i),[d,g]=o.useState(r);console.log(d);const v=o.useRef(),m=o.useRef(null),x=o.useRef(),[a,c]=o.useState([]),[l,p]=o.useState(""),[b,A]=o.useState(null),[w,I]=o.useState(!1),T=async f=>{const{data:j,summary:E}=await D.paginate({searchValue:f});I(!1),c(j),A((E==null?void 0:E.isValid)??null)},_=f=>{const j=f.target.value;p(j),m.current&&(D.controller.abort("Nothing"),clearTimeout(m.current)),c([]),I(!1),!(!j||j.length<3)&&(I(!0),m.current=setTimeout(()=>{T(j)},300))};return o.useEffect(()=>{d.length==0&&$(x.current).modal("hide")},[d]),o.useEffect(()=>()=>{m.current&&clearTimeout(m.current)},[]),e.jsx(e.Fragment,{children:e.jsxs(L,{...n,title:"Usuarios",floatEnd:e.jsxs("div",{className:"d-flex gap-2",children:[d.length>0&&e.jsx(N,{content:"Invitaciones externas",children:e.jsxs("button",{className:"btn btn-sm btn-light position-relative",onClick:()=>$(x.current).modal("show"),children:[e.jsx("i",{className:"mdi mdi-history"}),e.jsxs("span",{className:"position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger",children:[d.length,e.jsx("span",{className:"visually-hidden",children:"external invitations"})]})]})}),e.jsxs("button",{className:"btn btn-sm btn-primary",onClick:()=>$(v.current).modal("show"),children:[e.jsx("i",{className:"mdi mdi-account-plus me-1"}),"Invitar"]})]}),children:[e.jsx("div",{className:"d-flex flex-wrap align-items-center justify-content-center",style:{minHeight:"calc(100vh - 235px)",maxHeight:"max-content"},children:e.jsx("div",{className:"d-flex flex-wrap align-items-center justify-content-center gap-2",children:h.map((f,j)=>e.jsx(Q,{...f,roles:s,match:t,setUsers:u},`user-${j}`))})}),e.jsxs(M,{modalRef:v,title:"Invita usuarios",hideFooter:!0,onSubmit:f=>f.preventDefault(),onClose:()=>p(""),children:[e.jsx("input",{type:"text",className:"form-control",placeholder:"Ingresa nombre o correo",value:l,onChange:_}),l.length<3?e.jsx("div",{className:"text-center text-muted p-2 mt-2",children:"Ingresa al menos 3 caracteres"}):e.jsx(e.Fragment,{children:w?e.jsxs("div",{className:"text-center p-2 mt-2",children:[e.jsx("div",{className:"spinner-border text-primary",role:"status",children:e.jsx("span",{className:"visually-hidden",children:"Loading..."})}),e.jsx("p",{className:"mt-2 text-muted mb-0",children:"Buscando usuarios..."})]}):a.length>0||b?e.jsxs("div",{className:"d-flex flex-column gap-2 mt-2",children:[a.map((f,j)=>e.jsx(k,{...f,match:t,setUsers:u},`found-${j}`)),b===!0&&e.jsx(k,{fullname:l.split("@")[0],email:l,match:t,setUsers:u,setInvitations:g},`found-${l}`)]}):l&&e.jsx("div",{className:"card card-body p-2 mt-2 text-center mb-0",children:"No se encontraron resultados"})})]}),e.jsx(X,{modalRef:x,invitations:d,setInvitations:g,match:t})]})})};V((n,i)=>{H(n).render(e.jsx(Y,{...i}))});
