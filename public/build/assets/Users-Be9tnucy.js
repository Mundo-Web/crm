var A=Object.defineProperty;var k=(a,t,s)=>t in a?A(a,t,{enumerable:!0,configurable:!0,writable:!0,value:s}):a[t]=s;var N=(a,t,s)=>k(a,typeof t!="symbol"?t+"":t,s);import{m as U,r as m,j as e,G as w,C as O,c as E}from"./CreateReactScript-9UX3kXBD.js";import{U as F}from"./UsersRest-DE27vXo1.js";import{B as P,i as p,A as _}from"./Adminto-C-Pv7Jhd.js";import{M as T}from"./Modal-D0pWPGeP.js";import"./sweetalert2.esm.all-CVcmmqxW.js";class y extends P{constructor(){super(...arguments);N(this,"path","atalaya/users");N(this,"invite",async s=>{try{const{status:c,result:n}=await U.Fetch(`/api/${this.path}/invite`,{method:"POST",body:JSON.stringify(s)});if(!c)throw new Error((n==null?void 0:n.message)||"Ocurrio un error inesperado");return{status:!0}}catch(c){return{status:!1,message:c.message}}})}}const D=new y,b=({relative_id:a,fullname:t,email:s,match:c})=>{const[n,x]=m.useState(!1),d=async()=>{x(!0);const r=await D.invite({match:c,email:s});x(!1),console.log(r)},u=r=>a?e.jsx(e.Fragment,{children:r}):e.jsx(p,{content:"Invitar usuario a Atalaya",children:r});return e.jsx("div",{className:"card border mb-0",children:e.jsxs("div",{className:"card-body p-2 d-flex align-items-center gap-2",children:[e.jsx("img",{src:`//${w.APP_DOMAIN}/api/profile/thumbnail/${a}`,className:"rounded-circle",alt:t,width:"40",height:"40"}),e.jsxs("div",{className:"flex-grow-1",children:[e.jsx("h5",{className:"mt-0 mb-1",children:t}),e.jsx("div",{className:"text-muted",children:s})]}),u(e.jsx("button",{className:"btn btn-white btn-sm rounded-pill",onClick:()=>d(),disabled:n,children:n?e.jsx("i",{className:"mdi mdi-loading mdi-spin"}):e.jsx("i",{className:`mdi  ${a?"mdi-account-plus":"mdi mdi-email-send"}`})}))]})})},M=({roles:a,match:t,...s})=>{var u,r;const[c,n]=m.useState(!1),x=async()=>{n(!0);const i=await atalayaUsersRest.invite({match:t,email:s.email});n(!1),console.log(i)},d=((r=(u=s.service_user)==null?void 0:u.roles)==null?void 0:r[0])??{name:s.is_owner?"Owner":"Sin rol"};return e.jsx("div",{className:"card mb-0",style:{width:"360px"},children:e.jsx("div",{className:"card-body widget-user",children:e.jsxs("div",{className:"d-flex align-items-center gap-2 w-100",children:[e.jsx("div",{className:"flex-shrink-0 avatar-lg",children:e.jsx("img",{src:`//${w.APP_DOMAIN}/api/profile/thumbnail/${s.relative_id}`,className:"img-fluid rounded-circle",alt:"user"})}),e.jsxs("div",{className:"flex-grow-1",children:[e.jsxs("div",{className:"overflow-hidden",style:{width:"228px"},children:[e.jsxs("h5",{className:"mt-0 mb-1 text-truncate",children:[s.name," ",s.lastname]}),e.jsx("p",{className:"d-inline-block text-muted mb-2 font-13 text-truncate w-100",children:s.email})]}),e.jsxs("div",{className:"d-flex gap-1",children:[s.is_owner?e.jsxs("div",{className:"btn btn-white btn-sm",children:[e.jsx("i",{className:"mdi mdi-crown me-1 text-blue"}),"Owner"]}):e.jsxs("div",{className:"btn-group",children:[e.jsxs("button",{className:"btn btn-white btn-sm dropdown-toggle",type:"button","data-bs-toggle":"dropdown","aria-haspopup":"true","aria-expanded":"false",children:[d.name," ",e.jsx("i",{className:"mdi mdi-chevron-down"})]}),e.jsxs("div",{className:"dropdown-menu",children:[a.map((i,h)=>e.jsx(p,{content:`Asignar rol ${i.name}`,children:e.jsxs("a",{className:"dropdown-item",href:"#",onClick:()=>onAssignRoleClicked(i,s),children:[e.jsx("i",{className:"mdi mdi-account-convert me-2"}),i.name]})},h)),e.jsx("div",{className:"dropdown-divider"}),e.jsxs("a",{className:"dropdown-item",href:"#",children:[e.jsx("i",{className:"mdi mdi-plus me-2"}),"Nuevo rol"]})]})]}),!s.invitation_accepted&&e.jsx(p,{content:"Reenviar invitaciÃ³n",children:e.jsx("button",{className:"btn btn-sm btn-white rounded-pill",onClick:()=>x(),disabled:c,children:c?e.jsx("i",{className:"mdi mdi-loading mdi-spin"}):e.jsx("i",{className:"mdi mdi-email-send text-primary"})})}),!s.is_owner&&e.jsx(p,{content:"Eliminar usuario",children:e.jsx("button",{className:"btn btn-sm btn-white rounded-pill",onClick:()=>onDeleteClicked(s),children:e.jsx("i",{className:"mdi mdi-delete text-danger"})})})]})]})]})})},`user-${s.id}`)},v=new y;new F;const V=a=>{const{users:t,roles:s,APP_DOMAIN:c,match:n}=a,x=m.useRef(),d=m.useRef(null),[u,r]=m.useState([]),[i,h]=m.useState(""),[f,R]=m.useState(null),[S,j]=m.useState(!1),C=async o=>{const{data:l,summary:g}=await v.paginate({searchValue:o});j(!1),r(l),R((g==null?void 0:g.isValid)??null)},I=o=>{const l=o.target.value;h(l),d.current&&(v.controller.abort("Nothing"),clearTimeout(d.current)),r([]),j(!1),!(!l||l.length<3)&&(j(!0),d.current=setTimeout(()=>{C(l)},300))};return m.useEffect(()=>()=>{d.current&&clearTimeout(d.current)},[]),e.jsx(e.Fragment,{children:e.jsxs(_,{...a,title:"Usuarios",floatEnd:e.jsxs("button",{className:"btn btn-sm btn-primary",onClick:()=>$(x.current).modal("show"),children:[e.jsx("i",{className:"mdi mdi-account-plus me-1"}),"Invitar"]}),children:[e.jsx("div",{className:"d-flex flex-wrap align-items-center justify-content-center",style:{minHeight:"calc(100vh - 235px)",maxHeight:"max-content"},children:e.jsx("div",{className:"d-flex flex-wrap align-items-center justify-content-center gap-2",children:t.map((o,l)=>e.jsx(M,{...o,roles:s,match:n},`user-${l}`))})}),e.jsxs(T,{modalRef:x,title:"Invita usuarios",hideFooter:!0,onSubmit:o=>o.preventDefault(),onClose:()=>h(""),children:[e.jsx("input",{type:"text",className:"form-control",placeholder:"Ingresa nombre o correo",value:i,onChange:I}),i.length<3?e.jsx("div",{className:"text-center text-muted p-2 mt-2",children:"Ingresa al menos 3 caracteres"}):e.jsx(e.Fragment,{children:S?e.jsxs("div",{className:"text-center p-2 mt-2",children:[e.jsx("div",{className:"spinner-border text-primary",role:"status",children:e.jsx("span",{className:"visually-hidden",children:"Loading..."})}),e.jsx("p",{className:"mt-2 text-muted mb-0",children:"Buscando usuarios..."})]}):u.length>0||f?e.jsxs("div",{className:"d-flex flex-column gap-2 mt-2",children:[u.map((o,l)=>e.jsx(b,{...o,match:n},`found-${l}`)),f===!0&&e.jsx(e.Fragment,{children:e.jsx(b,{fullname:i.split("@")[0],email:i,match:n},`found-${i}`)})]}):i&&e.jsx("div",{className:"card card-body p-2 mt-2 text-center mb-0",children:"No se encontraron resultados"})})]})]})})};O((a,t)=>{E(a).render(e.jsx(V,{...t}))});
