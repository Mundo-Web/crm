var me=Object.defineProperty;var ce=(d,s,m)=>s in d?me(d,s,{enumerable:!0,configurable:!0,writable:!0,value:m}):d[s]=m;var w=(d,s,m)=>ce(d,typeof s!="symbol"?s+"":s,m);import{m as C,C as oe,c as de,R as e,r as l}from"./CreateReactScript-BzwrR0sZ.js";import{A as ie,i as g}from"./Adminto-DuoVWNzw.js";import{C as A}from"./auto-tSUxE9xa.js";import{D as ue}from"./DropdownEnd-D3wnIJPX.js";import{D as M}from"./DropdownItem-uEebZ_C2.js";import{P as D,D as he,A as Ee}from"./DateRange-B2oybGRb.js";import{N as o}from"./Number2Currency-e57Tgsuk.js";import"./server.browser-CLYKlTOS.js";class x{}w(x,"revenue",async s=>{const{result:m}=await C.Fetch(`/api/dashboard/${s}`);return(m==null?void 0:m.data)??[]}),w(x,"lastRevenues",async()=>{const{result:s}=await C.Fetch("/api/dashboard/last-revenues");return(s==null?void 0:s.data)??[]});class I{}w(I,"get",async s=>{const{result:m}=await C.Fetch(`/api/remainings-history/${s}`);return(m==null?void 0:m.data)??0});const be=({finishedProjectStatus:d})=>{const s=l.useRef(),m=l.useRef(null),_=l.useRef(null),S=l.useRef(null),[P,j]=l.useState("Reporte mensual"),[k,L]=l.useState("monthly"),[Y,B]=l.useState([]),[u,W]=l.useState({last:0,actual:0}),[q,V]=l.useState(moment({month:moment().month()-1}).format("MMMM Y")),[T,H]=l.useState([]),[K,G]=l.useState(0),[z,J]=l.useState(0),[Q,U]=l.useState([]),[h,X]=l.useState(0),[p,Z]=l.useState(0),[ee,te]=l.useState(0),[ae,ne]=l.useState(!1),[E,y]=l.useState("all");l.useEffect(()=>{m.current&&m.current.destroy(),m.current=new A(s.current,{type:"bar",data:{labels:Y.map(t=>{switch(k){case"daily":return moment(t.date).format("DD MMM");case"weekly":const n=Number(String(t.week).slice(0,4)),a=Number(String(t.week).slice(4,6)),r=moment().year(n).week(a+1).startOf("week").isoWeekday(0),c=moment().year(n).week(a+1).endOf("week").isoWeekday(6),b=r.format("D"),f=c.format("D"),R=r.format("MMM"),F=c.format("MMM");return R==F?`${b} - ${f} ${R}`:`${b} ${R} - ${f} ${F}`;case"annually":return t.year;default:return moment({year:t.year,month:t.month-1}).format("MMMM Y")}}),datasets:[{label:P,data:Y.map(t=>t.total)}]}})},[Y]),l.useEffect(()=>{x.revenue(k).then(t=>{B(t)})},[k]),l.useEffect(()=>{x.lastRevenues().then(t=>{const n={last:0,actual:0};t.forEach(a=>{a.month==moment().month()+1?n.actual=Number(a.total):a.month==moment().month()&&(V(moment({month:a.month-1}).format("MMMM Y")),n.last=Number(a.total))}),W(n)}),D.paginate({sort:[{selector:"ends_at",desc:!1}],requireTotalCount:!0,skip:0,take:100}).then(({data:t=[],totalCount:n})=>{let a={};t.forEach(({status:{name:c,color:b}})=>{let f=c;a[f]?a[f].cantidad++:a[f]={estado:c,color:b,cantidad:1}});let r=Object.values(a);new A(_.current,{type:"doughnut",data:{labels:Object.keys(a),datasets:[{data:r.map(c=>c.cantidad)||[],backgroundColor:r.map(c=>c.color)||[],hoverOffset:4}],backgroundColor:"transparent"},options:{plugins:{legend:{display:!1}}}}),G(n),H(t)}),D.paginate({requireTotalCount:!0,ignoreData:!0,filter:[["projects.status","=","1"],"and",["projects.starts_at",">=",moment().format("YYYY-MM-[01]")],"and",["projects.starts_at","<",moment().add(1,"month").format("YYYY-MM-[01]")]]}).then(({totalCount:t})=>{J(t)}),D.paginate({sort:[{selector:"!remaining_amount",desc:!0}],isLoadingAll:!0,filter:[["!remaining_amount",">",0],"and",["projects.status","=",!0]]}).then(({data:t})=>{U(t||[]),Z(t.reduce((n,{cost:a})=>n+Number(a),0)),X(t.reduce((n,{remaining_amount:a})=>n+Number(a),0))}),I.get(moment().format("MM-YYYY")).then(t=>{te(t.remaining_amount)})},[null]),l.useEffect(()=>{const t=Math.round(h/p*100)||0;S.current.value=t,t&&$(S.current).knob()},[h,p]);const v=t=>{const n=t.target.getAttribute("data-value"),a=t.target.textContent;L(n),j(a)},se=moment().daysInMonth(),le=moment().format("DD"),O=u.actual*se/le,i=O/u.last-1,N=()=>{const t=moment(),n={delayed:[],thisMonth:[],future:{}};return T.forEach(a=>{const r=moment(a.ends_at);if(r.isBefore(t,"day"))n.delayed.push(a);else if(r.isSame(t,"month")&&r.isSame(t,"year"))n.thisMonth.push(a);else{const c=r.format("MMMM YYYY");n.future[c]||(n.future[c]=[]),n.future[c].push(a)}}),n},re=()=>{const t=moment();let n=T;switch(ae&&(n=n.filter(a=>Number(a.remaining_amount)>0)),E){case"delayed":return n.filter(a=>moment(a.ends_at).isBefore(t,"day"));case"thisMonth":return n.filter(a=>{const r=moment(a.ends_at);return r.isSame(t,"month")&&r.isSame(t,"year")&&!r.isBefore(t,"day")});default:if(E.startsWith("month_")){const a=E.replace("month_","");return n.filter(r=>moment(r.ends_at).format("MMMM YYYY")===a)}return n}};return e.createElement(e.Fragment,null,e.createElement("div",{className:"row"},e.createElement("div",{className:"col-xl-3 col-md-6"},e.createElement("div",{className:"card"},e.createElement("div",{className:"card-body"},e.createElement("h4",{className:"header-title mt-0 mb-4"},"Ingresos - Mes anterior"),e.createElement("div",{className:"widget-chart-1"},e.createElement("div",{className:"widget-detail-1 text-end"},e.createElement("h2",{className:"fw-normal pt-1 mb-1"}," S/. ",o(u==null?void 0:u.last)," "),e.createElement("p",{className:"text-muted mb-1"},q)))))),e.createElement("div",{className:"col-xl-3 col-md-6"},e.createElement("div",{className:"card"},e.createElement("div",{className:"card-body"},e.createElement("h4",{className:"header-title mt-0 mb-3"},"Ingresos - Mes actual"),e.createElement("div",{className:"widget-box-2"},e.createElement("div",{className:"widget-detail-2 text-end"},e.createElement(g,{content:`Es probable que tengamos ${(Math.abs(i)*100).toFixed(2)}% ${i>=0?"mas":"menos"} de ingresos respecto al mes anterior`},e.createElement("span",{className:`badge bg-${i>0?"success":"danger"} rounded-pill float-start mt-3`},Math.round(i*100)||0,"% ",e.createElement("i",{className:`mdi mdi-trending-${i>0?"up":"down"}`})," ")),e.createElement("h3",{className:"fw-normal mt-1 mb-1"}," S/. ",o(u==null?void 0:u.actual)," "),e.createElement("p",{className:"text-muted mb-3"},moment().format("MMMM Y"))),e.createElement(g,{content:e.createElement("p",{className:"text-center mb-0"},"Para este mes de ",moment().format("MMMM Y")," se espera que tengamos S/. ",o(O)),allowHTML:!0,arrow:!0},e.createElement("div",{className:`progress progress-bar-alt-${i>0?"success":"danger"} progress-sm`},e.createElement("div",{className:`progress-bar bg-${i>0?"success":"danger"}`,role:"progressbar","aria-valuenow":i*100,"aria-valuemin":"0","aria-valuemax":"100",style:{width:`${Math.abs(i*100)}%`}},e.createElement("span",{className:"visually-hidden"},Math.round(i*100)||0,"%")))))))),e.createElement("div",{className:"col-xl-3 col-md-6"},e.createElement("div",{className:"card"},e.createElement("div",{className:"card-body"},e.createElement("div",{className:"dropdown float-end"},e.createElement(g,{content:"Ver proyectos",arrow:!0},e.createElement("a",{href:"/projects",className:"arrow-none card-drop"},e.createElement("i",{className:"mdi mdi-arrow-top-right"})))),e.createElement("h4",{className:"header-title mt-0 mb-4"},"Proyectos en curso"),e.createElement("div",{className:"widget-chart-1"},e.createElement("div",{className:"widget-chart-box-1 float-start",dir:"ltr"},e.createElement("div",{style:{display:"inline",width:"70px",height:"70px"}},e.createElement("canvas",{ref:_,width:"62",height:"62",style:{width:"70px",height:"70px"}}))),e.createElement("div",{className:"widget-detail-1 text-end"},e.createElement("h2",{className:"fw-normal pt-0 mb-1"}," ",K," "),e.createElement("p",{className:"text-muted mb-1"},z," nuevos este mes")))))),e.createElement("div",{className:"col-xl-3 col-md-6"},e.createElement("div",{className:"card"},e.createElement("div",{className:"card-body"},e.createElement("div",{className:"dropdown float-end"},e.createElement(g,{content:"Ver proyectos",arrow:!0},e.createElement("a",{href:"/projects",className:"arrow-none card-drop"},e.createElement("i",{className:"mdi mdi-arrow-top-right"})))),e.createElement("h4",{className:"header-title mt-0 mb-3"},"Deuda al ",moment().startOf("month").format("D [de] MMMM")),e.createElement("div",{className:"widget-box-2"},e.createElement(g,{content:e.createElement(e.Fragment,null,"Deuda restante al ",Number(h/p*100).toFixed(2),"%",e.createElement("p",{className:"mb-0"},e.createElement("b",null,"Deuda restante"),": S/. ",o(h)),e.createElement("p",{className:"mb-0"},e.createElement("b",null,"Costo total"),": S/. ",o(p))),arrow:!0,allowHTML:!0},e.createElement("div",{className:"float-start",dir:"ltr"},e.createElement("input",{ref:S,"data-plugin":"knob","data-width":"70","data-height":"70","data-fgcolor":"#f05050","data-bgcolor":"#f0505033",defaultValue:String(Math.round(h/p*100)||0),"data-skin":"tron","data-angleloffset":"180","data-readonly":!0,"data-thickness":".15",style:{outline:"none",border:"none"}}))),e.createElement("div",{className:"widget-detail-2 text-end"},e.createElement("h3",{className:"fw-normal pt-1 mb-1"}," S/. ",o(ee)," "),e.createElement("p",{className:"text-muted mb-3"}," S/. ",o(h)," hasta hoy"))))))),e.createElement("div",{className:"row"},e.createElement("div",{className:"col-xl-5 col-md-6 col-sm-12"},e.createElement("div",{className:"card"},e.createElement("div",{className:"card-header"},e.createElement(ue,null,e.createElement(M,{onClick:v,"data-value":"daily"},"Reporte diario"),e.createElement(M,{onClick:v,"data-value":"weekly"},"Reporte semanal"),e.createElement(M,{onClick:v,"data-value":"monthly"},"Reporte mensual"),e.createElement(M,{onClick:v,"data-value":"annually"},"Reporte anual")),e.createElement("h4",{className:"header-title mb-0"},"Ingresos - ",P)),e.createElement("div",{className:"card-body",style:{height:"300px",width:"100%"}},e.createElement("canvas",{ref:s,width:"100%"})))),e.createElement("div",{className:"col-xl-7 col-md-6 col-sm-12"},e.createElement("div",{className:"card"},e.createElement("div",{className:"card-header"},e.createElement("h4",{className:"header-title mb-0"},e.createElement("span",{className:"float-end text-danger"},e.createElement("small",{className:"fa fa-arrow-circle-down"})," S/. ",o(h)),"Pendientes de pago")),e.createElement("div",{className:"card-body",style:{height:"300px",overflow:"auto"}},e.createElement("div",{className:"table-responsive"},e.createElement("table",{className:"table table-bordered table-sm table-striped mb-0"},e.createElement("thead",null,e.createElement("tr",null,e.createElement("th",null,"Cliente"),e.createElement("th",null,"Fecha fin"),e.createElement("th",null,"Costo total"),e.createElement("th",null,"Debe"))),e.createElement("tbody",null,Q.map(({id:t,client:n,type:a,remaining_amount:r,cost:c,ends_at:b})=>e.createElement("tr",{key:`remaining-project-${t}`},e.createElement("td",null,e.createElement("b",{className:"d-block"},n.tradename),e.createElement("small",null,a.name)),e.createElement("td",null,moment(b).format("DD/MM/YYYY")),e.createElement("td",null,e.createElement("div",{style:{width:"max-content"}},"S/. ",o(c))),e.createElement("td",null,e.createElement("div",{className:"text-danger",style:{width:"max-content"}},e.createElement("small",{className:"fa fa-arrow-circle-down"})," S/. ",o(r)))))))))))),e.createElement("div",{className:"row"},e.createElement("div",{className:"col-12"},e.createElement("div",{className:"card"},e.createElement("div",{className:"card-header"},e.createElement("div",{className:"dropdown float-end"},e.createElement(g,{content:"Ver proyectos",arrow:!0},e.createElement("a",{href:"/projects",className:"arrow-none card-drop"},e.createElement("i",{className:"mdi mdi-arrow-top-right"})))),e.createElement("h4",{className:"header-title mt-0 mb-0"},"Proyectos pendientes"),e.createElement("div",{className:"mt-2 d-flex gap-1 flex-wrap"},N().delayed.length>0&&e.createElement("button",{className:`btn btn-xs ${E==="delayed"?"btn-danger":"btn-soft-danger"}`,onClick:()=>y("delayed")},"Atrasados (",N().delayed.length,")"),N().thisMonth.length>0&&e.createElement("button",{className:`btn btn-xs ${E==="thisMonth"?"btn-primary":"btn-soft-primary"}`,onClick:()=>y("thisMonth")},"Este mes (",N().thisMonth.length,")"),Object.entries(N().future).map(([t,n])=>e.createElement("button",{key:t,className:`btn btn-xs ${E===`month_${t}`?"btn-success":"btn-soft-success"}`,onClick:()=>y(`month_${t}`)},t," (",n.length,")")),E!=="all"&&e.createElement("button",{className:"btn btn-xs btn-soft-secondary",onClick:()=>y("all")},"Mostrar todos"))),e.createElement("div",{className:"card-body",style:{height:"360px",overflow:"auto"}},e.createElement("div",{className:"form-check form-switch mb-2 align-content-center"},e.createElement("input",{className:"form-check-input",type:"checkbox",id:"showDebtOnly",onChange:t=>ne(t.target.checked),style:{cursor:"pointer"}}),e.createElement("label",{className:"form-check-label",htmlFor:"showDebtOnly",style:{cursor:"pointer"}},"Solo mostrar proyectos con deuda")),e.createElement("div",{className:"table-responsive"},e.createElement("table",{className:"table table-sm table-bordered table-striped mb-0"},e.createElement("thead",null,e.createElement("tr",null,e.createElement("th",null,"Cliente"),e.createElement("th",null,"Fecha de desarrollo"),e.createElement("th",null,"Estado"),e.createElement("th",null,"Costo total"),e.createElement("th",null,"Debe"),e.createElement("th",null,"Asignado a"))),e.createElement("tbody",null,re().map((t,n)=>{const a=t.users.map(r=>r.relative_id);return e.createElement("tr",{key:`project-${n}`,style:{backgroundColor:t.is_alert?"rgba(255,91,91,.18)":"unset"}},e.createElement("td",{className:`${moment(t.ends_at).isBefore(moment())?"text-danger":""}`,style:{boxShadow:t.is_alert?"unset":""}},e.createElement("b",{className:"d-block"},t.client.tradename),e.createElement("small",null,t.name)),e.createElement("td",{style:{boxShadow:t.is_alert?"unset":""}},he(t.starts_at,t.ends_at)),e.createElement("td",{style:{boxShadow:t.is_alert?"unset":""}},e.createElement("span",{className:"badge",style:{backgroundColor:t.status.color}},t.status.name)),e.createElement("td",{style:{boxShadow:t.is_alert?"unset":""}},"S/. ",o(t.cost)),e.createElement("td",{style:{boxShadow:t.is_alert?"unset":""}},"S/. ",o(t.remaining_amount)),e.createElement("td",{style:{boxShadow:t.is_alert?"unset":""}},Ee(a)))})))))))))};oe((d,s)=>{if(!s.can("dashboard","root","all","list"))return location.href="/leads";de(d).render(e.createElement(ie,{...s,title:`Dashboard - ${moment().format("MMMM YYYY")}`},e.createElement(be,{...s})))});
