var I=Object.defineProperty;var k=(r,e,s)=>e in r?I(r,e,{enumerable:!0,configurable:!0,writable:!0,value:s}):r[e]=s;var g=(r,e,s)=>k(r,typeof e!="symbol"?e+"":e,s);import{j as t,m as a,r as l}from"./CreateReactScript-9UX3kXBD.js";import{D as q}from"./Dropdown-Ck__q3jI.js";import{D as U}from"./DropdownItem-CsqtTpd2.js";import{P as J,U as E}from"./DateRange-BrrDmhPV.js";import{S as M}from"./index-yz4sAZmo.js";import{M as _}from"./Modal-D0pWPGeP.js";import{I as R}from"./InputFormGroup-DwkqbD4D.js";import{i as z}from"./Adminto-B61UoQno.js";import{T as C}from"./TippyButton-DgN9s_cP.js";import{S as D,a as G}from"./SetSelectValue-l9Z74XX6.js";const re=({statuses:r,finishedProjectStatus:e,data:s,onChange:i})=>{const c=async(o,u)=>{if(u===e){const{isConfirmed:p}=await M.fire({title:"¿Estás seguro de marcar este proyecto como terminado?",text:"Este proyecto podras verlo en a ventana de proyectos a partir de ahora",icon:"warning",showCancelButton:!0,confirmButtonText:"Continuar",cancelButtonText:"Cancelar"});if(!p)return}await J.projectStatus(o,u)&&i()};return t.jsx(t.Fragment,{children:t.jsx(q,{className:"btn btn-xs btn-light rounded-pill",title:s.status.name,tippy:"Actualizar estado",icon:{icon:"fa fa-circle",color:s.status.color},children:r.map(({id:o,name:u,color:m})=>t.jsxs(U,{onClick:()=>c(s.id,o),children:[t.jsx("i",{className:"fa fa-circle",style:{color:m}})," ",u]},o))})})};class y{}g(y,"paginate",async e=>{const{result:s}=await a.Fetch("/api/payments/paginate",{method:"POST",headers:{Accept:"application/json","Content-Type":"application/json"},body:JSON.stringify(e)});return s}),g(y,"byProject",async e=>{const{result:s}=await a.Fetch(`/api/payments/project/${e}`);return(s==null?void 0:s.data)??[]}),g(y,"save",async e=>{try{const{status:s,result:i}=await a.Fetch("/api/payments",{method:"POST",body:JSON.stringify(e)});if(!s)throw new Error((i==null?void 0:i.message)||"Ocurrio un error inesperado");return a.Notify.add({icon:"/assets/img/logo-login.svg",title:"Correcto",body:i.message,type:"success"}),!0}catch(s){return a.Notify.add({icon:"/assets/img/logo-login.svg",title:"Error",body:s.message,type:"danger"}),!1}}),g(y,"status",async({id:e,status:s})=>{try{const{status:i,result:c}=await a.Fetch("/api/payments/status",{method:"PATCH",body:JSON.stringify({id:e,status:s})});if(!i)throw new Error((c==null?void 0:c.message)??"Ocurrio un error inesperado");return a.Notify.add({icon:"/assets/img/logo-login.svg",title:"Correcto",body:c.message,type:"success"}),!0}catch(i){return a.Notify.add({icon:"/assets/img/logo-login.svg",title:"Error",body:i.message,type:"danger"}),!1}}),g(y,"delete",async e=>{try{const{status:s,result:i}=await a.Fetch(`/api/payments/${e}`,{method:"DELETE"});if(!s)throw new Error((i==null?void 0:i.message)??"Ocurrio un error inesperado");return a.Notify.add({icon:"/assets/img/logo-login.svg",title:"Correcto",body:i.message,type:"success"}),!0}catch(s){return a.Notify.add({icon:"/assets/img/logo-login.svg",title:"Error",body:s.message,type:"danger"}),!1}});const se=({can:r,dataLoaded:e,setDataLoaded:s,grid2refresh:i})=>{const c=l.useRef(),o=l.useRef(),u=l.useRef(),m=l.useRef(),p=l.useRef(),f=l.useRef(),[x,j]=l.useState([]),[v,w]=l.useState(!1),[N,S]=l.useState(Number(e==null?void 0:e.remaining_amount));l.useEffect(()=>{e.id&&B(),$(c.current).on("hidden.bs.modal",()=>{s({}),j([]),w(!1),o.current.value=null,u.current.value=null,m.current.value=null,f.current.value=null})},[e]);const B=async()=>{const n=await y.byProject(e==null?void 0:e.id);j(n),S(Number(e==null?void 0:e.remaining_amount)),u.current.value=(e==null?void 0:e.id)||null,$(c.current).modal("show")},A=async n=>{n.preventDefault();const h={id:o.current.value||void 0,payment_id:u.current.value,project_id:e.id,payment_type:m.current.value,amount:f.current.value,date:p.current.value};await y.save(h)&&(o.current.value=null,p.current.value=null,m.current.value=null,f.current.value=null,await P(),i.refresh())},P=async()=>{const n=await y.byProject(e.id),h=n.reduce((O,Y)=>Number(O)+Number(Y.amount),0),b={...e,total_payments:h,remaining_amount:e.cost-h};s(b),j(n)},T=async n=>{o.current.value=n.id,m.current.value=n.payment_type,f.current.value=n.amount,p.current.value=n.date||moment(n.created_at).format("YYYY-MM-DD"),S(Number(e==null?void 0:e.remaining_amount)+Number(n.amount)),w(!0)},F=async n=>{const{isConfirmed:h}=await M.fire({title:"Estas seguro de eliminar este pago?",text:"No podras revertir esto!",icon:"warning",showCancelButton:!0,confirmButtonText:"Continuar",cancelButtonText:"Cancelar"});!h||!await y.delete(n)||(await P(),i.refresh())};return t.jsxs(_,{modalRef:c,title:`Pagos de ${e==null?void 0:e.name} - S/.${e==null?void 0:e.cost}`,onSubmit:A,hideButtonSubmit:!0,children:[t.jsxs("div",{className:`row ${!r("projects","all","addpayment","editpayment")&&"d-none"}`,children:[t.jsx("input",{ref:u,type:"hidden"}),t.jsx("input",{ref:o,type:"hidden"}),t.jsx(R,{eRef:m,label:"Concepto",col:"col-12",required:!0}),t.jsx(R,{eRef:p,type:"date",label:"Fecha",col:"col-md-7",required:!0}),t.jsxs("div",{className:"form-group col-md-5",children:[t.jsxs("label",{children:["Monto ",t.jsx("b",{className:"text-danger",children:"*"})]}),t.jsxs("div",{className:"input-group",children:[t.jsx("input",{ref:f,type:"number",className:"form-control",placeholder:`Max: ${N}`,min:0,max:N||0,step:.01}),t.jsx(z,{content:v?"Actualizar pago":"Agregar pago",children:t.jsx("button",{className:"btn input-group-text btn-dark waves-effect waves-light",type:"submit",children:t.jsx("i",{className:`fa ${v?"fa-save":"fa-plus"}`})})})]})]})]}),t.jsx("hr",{className:"mb-2 mt-0"}),t.jsxs("table",{className:"table table-bordered table-sm table-responsive table-striped mb-2",children:[t.jsx("thead",{children:t.jsxs("tr",{children:[r("projects","all","editpayment","deletepayment")&&t.jsx("th",{}),t.jsx("th",{children:"Concepto"}),t.jsx("th",{children:"Fecha"}),t.jsx("th",{children:"Monto"})]})}),t.jsx("tbody",{children:x.map(n=>(n.date||(n.date=moment(n.created_at).format("YYYY-MM-DD")),n)).sort((n,h)=>new Date(n.date)-new Date(h.date)).map(n=>t.jsxs("tr",{children:[r("projects","all","editpayment","deletepayment")&&t.jsx("td",{children:t.jsxs("div",{className:"d-flex align-items-center gap-1",children:[r("projects","all","editpayment")&&t.jsx(C,{title:"Editar pago",className:"btn btn-xs btn-soft-primary",type:"button",onClick:()=>T(n),children:t.jsx("i",{className:"fa fa-pen"})}),r("projects","all","deletepayment")&&t.jsx(C,{title:"Eliminar pago",className:"btn btn-xs btn-soft-danger",type:"button",onClick:()=>F(n.id),children:t.jsx("i",{className:"fa fa-trash"})})]})}),t.jsx("td",{children:n.payment_type}),t.jsx("td",{children:moment(n.date).format("LL")}),t.jsxs("td",{children:["S/.",n.amount]})]},`project-payment-${n.id}`))})]}),t.jsx("table",{className:"table table-bordered table-sm table-responsive table-striped mb-0",style:{width:"max-content",float:"right"},children:t.jsxs("tbody",{children:[t.jsxs("tr",{children:[t.jsx("th",{colSpan:3,className:"text-end",children:"Pagado"}),t.jsxs("td",{children:["S/.",e==null?void 0:e.total_payments]})]}),t.jsxs("tr",{children:[t.jsx("th",{colSpan:3,className:"text-end",children:"Por pagar"}),t.jsxs("td",{children:["S/.",e==null?void 0:e.remaining_amount]})]})]})})]})},ne=({dataLoaded:r,setDataLoaded:e,grid2refresh:s})=>{var p;const i=l.useRef(),c=l.useRef(),o=l.useRef();l.useEffect(()=>{r.id&&u(),$(i.current).on("hidden.bs.modal",()=>{c.current.value=null,D(o.current,null,null),e({})})},[r]);const u=async()=>{const f=await E.byProject(r==null?void 0:r.id);c.current.value=(r==null?void 0:r.id)||null,D(o.current,f,"id","fullname"),$(i.current).modal("show")},m=async f=>{f.preventDefault();const x={project_id:c.current.value,users:$(o.current).val()};await E.massiveByProject(x)&&($(i.current).modal("hide"),s.refresh())};return t.jsx(_,{modalRef:i,title:"Asignar usuarios al proyecto",onSubmit:m,children:t.jsxs("div",{id:"assign-users-container",children:[t.jsxs("p",{children:["Que usuarios deseas asignar al proyecto ",t.jsx("b",{children:r==null?void 0:r.name})," de ",t.jsx("b",{children:(p=r==null?void 0:r.client)==null?void 0:p.name})]}),t.jsx("input",{ref:c,type:"hidden"}),t.jsx(G,{eRef:o,label:"Usuarios a asignar",col:"col-12",dropdownParent:"#assign-users-container",searchAPI:"/api/users/paginate",searchBy:"fullname",multiple:!0})]})})};export{ne as A,re as P,se as a};
