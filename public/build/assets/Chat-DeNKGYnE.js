import{r as n,j as e,C as Se,c as ke,L as X,G as q}from"./CreateReactScript-DcwmeAVN.js";import{W as Ce,M as Re,u as oe,a as Ee,A as $e,i as Q}from"./Adminto-C2tpzC-o.js";import{L as le}from"./LeadsRest-BtHf6UdV.js";import{H as Le}from"./HtmlContent-B-JChW0o.js";import{w as De,A as Z}from"./ArrayJoin-6-TTvUmN.js";import"./Logout-CMhpjQt5.js";import"./sweetalert2.esm.all-BB4SRWjP.js";const Me=new Ce,ce=new Re,Ae=new le,Te=({leadId:y,theme:g})=>{const Y=n.useRef(),k=n.useRef(),B=n.useRef(),C=n.useRef(),f=n.useRef(),A=n.useRef(),w=n.useRef(),R=n.useRef(),[i,T]=n.useState(null),[b,O]=n.useState(!0),[j,F]=n.useState([]),[h,G]=n.useState(!0),{socket:$}=oe(),[E,L]=n.useState(!1),[H,I]=n.useState(!1),[_,z]=n.useState(null),[s,r]=n.useState(null),[d,l]=n.useState(""),[N,p]=n.useState(!1),[u,J]=n.useState(null),[D,P]=n.useState(null),[U,W]=n.useState(!1),[ee,me]=n.useState(3),[K,ue]=n.useState([]),V=n.useRef(!1);n.useEffect(()=>()=>{s&&URL.revokeObjectURL(s)},[s]),n.useEffect(()=>()=>{u&&u.getTracks().forEach(t=>t.stop())},[u]),n.useEffect(()=>{if(!h)return;const t=setInterval(()=>{const a=3+Math.floor(Math.random()*5);me(a),ue(Array.from({length:a},()=>Math.random()>.5))},1500);return()=>clearInterval(t)},[h]);const te=(t=!0)=>{const a=R.current;a&&a.scrollTo({top:a.scrollHeight,behavior:t?"smooth":"auto"})},he=()=>{const t=R.current;return t?t.scrollTop+t.clientHeight>=t.scrollHeight-60:!0};n.useEffect(()=>{!h&&j.length&&te(!1)},[h,j.length]),n.useEffect(()=>{if(!(!$||!i))return $.on("message.created",t=>{if(t.wa_id!=(i==null?void 0:i.contact_phone))return;const{id:a,microtime:c}=t;F(o=>o.find(S=>S.id===a)?o.map(S=>S.id===a?{...S,...t}:S):[...o,t].sort((S,v)=>S.microtime-v.microtime));const x=j.reduce((o,m)=>Math.max(o,m.microtime),0);c>x&&ve(c),he()&&!V.current&&setTimeout(()=>te(!0),100)}),()=>{$.off("message.created")}},[$,i,j]),n.useEffect(()=>{if(h)return;const t=R.current;if(!t)return;const a=()=>{t.scrollTop===0&&(V.current=!0,re())};return t.addEventListener("scroll",a),()=>t.removeEventListener("scroll",a)},[R,h]),n.useEffect(()=>{const t=a=>{w.current&&!w.current.contains(a.target)&&p(!1)};return document.addEventListener("mousedown",t),()=>document.removeEventListener("mousedown",t)},[]),n.useEffect(()=>{U&&u&&f.current&&(f.current.srcObject=u)},[U,u]);const pe=async()=>{try{const t=await navigator.mediaDevices.getUserMedia({audio:!0}),a=new MediaRecorder(t),c=[];a.ondataavailable=x=>c.push(x.data),a.onstop=()=>{const x=new Blob(c,{type:"audio/webm"});z(x),r(URL.createObjectURL(x)),t.getTracks().forEach(o=>o.stop())},a.start(),C.current=a,I(!0)}catch(t){console.error("Error accessing microphone:",t)}},xe=()=>{C.current&&C.current.state!=="inactive"&&C.current.stop(),I(!1)},se=()=>{C.current&&C.current.state!=="inactive"&&C.current.stop(),I(!1),z(null),s&&URL.revokeObjectURL(s),r(null)},ae=async t=>{if(t.preventDefault(),!i)return;const a=d.trim();!a&&!_&&!D||(L(!0),_?console.warn("Audio upload not implemented yet"):D?console.warn("Camera image upload not implemented yet"):await Me.send(i.id,a),l(""),z(null),s&&URL.revokeObjectURL(s),r(null),P(null),W(!1),L(!1))},ge=t=>{t.target.files[0]&&(console.warn("File upload not implemented yet"),t.target.value="")},fe=async()=>{try{const t=await navigator.mediaDevices.getUserMedia({video:!0});J(t),W(!0),p(!1)}catch(t){console.error("Error accessing camera:",t)}},ne=()=>{u&&(u.getTracks().forEach(t=>t.stop()),J(null)),W(!1),P(null)},be=()=>{const t=A.current,a=f.current;if(!t||!a)return;t.width=a.videoWidth,t.height=a.videoHeight,t.getContext("2d").drawImage(a,0,0),t.toBlob(x=>{P(x),ne()},"image/jpeg",.95)},je=()=>d.trim()||_||D;let ie=!1;const Ne=async()=>{O(!0);const t=await Ae.get(y);if(O(!1),!t){T(null);return}T(t)},re=async()=>{var o;if(!i||!y)return;const t=R.current,a=t?t.scrollHeight:0,c=j.filter(m=>m.wa_id==i.contact_phone).sort((m,M)=>m.microtime-M.microtime)[0]??{microtime:(Date.now()+5*60*60*1e3)*1e3};G(!0);const x=await ce.paginate({summary:{contact_phone:i.contact_phone},filter:[["microtime","<",c.microtime],"and",["wa_id","contains",i.contact_phone]],sort:[{selector:"microtime",desc:!0}],skip:0,take:40});if(G(!1),((o=x.data)==null?void 0:o.length)>0){if(F(m=>{const M=new Set(m.map(v=>v.id));return[...(x.data??[]).filter(v=>!M.has(v.id)),...m].sort((v,_e)=>v.microtime-_e.microtime)}),t){const m=t.scrollHeight;t.scrollTop=m-a}V.current=!1}},ve=async t=>{i&&await ce.paginate({summary:{contact_phone:i.contact_phone},filter:[["microtime","<=",t],"and",["wa_id","contains",i.contact_phone]],sort:[{selector:"microtime",desc:!0}],skip:0,take:40})};n.useEffect(()=>{T(null),F([]),y&&Ne()},[y]),n.useEffect(()=>{F([]),!(!y&&!i)&&re()},[i,y]);const ye=()=>e.jsx(e.Fragment,{children:Array.from({length:ee}).map((t,a)=>{const c=1+Math.floor(Math.random()*3);return e.jsx("li",{className:K[a]?"odd":"",style:{marginBottom:a<ee-1?"0px":"24px",marginTop:a>0&&K[a]===K[a-1]?"3px":"12px"},children:e.jsx("div",{className:"message-list",children:e.jsx("div",{className:"conversation-text",children:e.jsx("div",{className:`ctext-wrap ${K[a]?`message-out-${g}`:`message-in-${g}`}`,style:{boxShadow:"rgba(11, 20, 26, 0.13) 0px 1px 0.5px 0px",padding:"6px 8px",width:"300px"},children:e.jsxs("div",{className:"placeholder-glow",children:[Array.from({length:c}).map((x,o)=>e.jsx("span",{className:`placeholder ${o===c-1?"col-6 ms-0":"col-12"} `},o)),e.jsx("span",{className:"placeholder time float-end col-1",style:{fontSize:"10px",marginLeft:"6px",marginTop:"8px !important"}})]})})})})},a)})}),we=()=>e.jsxs("div",{className:"d-flex flex-column align-items-center justify-content-center text-center px-4",style:{height:"calc(100vh - 260px)"},children:[e.jsx("div",{className:"mb-3",children:e.jsx("i",{className:"mdi mdi-account-off-outline text-muted",style:{fontSize:"4rem"}})}),e.jsx("h5",{className:"text-muted mb-2",children:"Este contacto no existe en la empresa seleccionada"}),e.jsx("p",{className:"text-muted mb-3",children:"Por favor, elige otro contacto desde la lista o intenta refrescar la página si crees que debería estar aquí."}),e.jsxs("button",{className:"btn btn-outline-primary",onClick:()=>window.location.reload(),children:[e.jsx("i",{className:"mdi mdi-refresh me-1"}),"Refrescar página"]})]});return e.jsxs(e.Fragment,{children:[e.jsx("div",{className:`card-header ${g=="light"?"bg-white":"bg-light"}`,style:{cursor:"pointer"},onClick:()=>(i==null?void 0:i.id)&&(window.location.href=`/lead/${i.id}`),children:e.jsxs("div",{className:"d-flex align-items-center",children:[!b&&i&&e.jsx("img",{src:`/api/whatsapp/profile/${i.contact_phone}`,className:"rounded-circle avatar-sm bg-light me-2",alt:i.contact_name,style:{padding:0,border:"none"},onError:t=>{var a;t.target.src=`//${((a=window.Global)==null?void 0:a.APP_DOMAIN)||location.host}/api/profile/thumbnail/null`}}),b&&e.jsx("div",{className:"placeholder-glow",children:e.jsx("div",{className:"rounded-circle avatar-sm bg-light me-2 placeholder",style:{width:32,height:32}})}),e.jsxs("div",{className:`flex-grow-1 ${b?"placeholder-glow":""}`,children:[e.jsx("h5",{className:`mt-0 mb-1 text-truncate ${b?"placeholder col-3":""}`,children:i==null?void 0:i.contact_name}),e.jsxs("p",{className:`d-block font-13 text-muted mb-0 ${b?"placeholder col-2":""}`,children:[e.jsx("i",{className:"mdi mdi-phone me-1 font-11"}),i==null?void 0:i.contact_phone]})]}),!b&&i&&e.jsx("div",{className:"ms-2",children:e.jsx("i",{className:"mdi mdi-arrow-top-right text-muted",style:{fontSize:"1.2rem"}})})]})}),e.jsxs("div",{className:"card-body p-0 position-relative border",style:{backgroundColor:g=="light"?"rgb(245, 241, 235)":"rgb(22, 23, 23)"},children:[e.jsx("div",{className:"position-absolute",style:{top:0,right:0,bottom:0,left:0,backgroundImage:"url(/assets/img/doodles.png)",backgroundRepeat:"repeat",zIndex:0,opacity:g=="light"?1:.0625}}),e.jsx("section",{className:"d-flex flex-column position-relative",style:{height:"calc(100vh - 260px)",zIndex:1},children:!i&&!b?we():e.jsxs(e.Fragment,{children:[e.jsxs("ul",{ref:R,className:"conversation-list flex-grow-1 px-3 pt-3",style:{overflowY:"auto",scrollBehavior:"smooth",position:"relative"},children:[h&&j.length===0&&ye(),j.map((t,a)=>{var M;const c=t.role!=="Human",x=ie===c?"3px":"12px";ie=c;let o=((M=t.message)==null?void 0:M.replace(/\{\{.*?\}\}/gs,""))||"",m="";return o.startsWith("/attachment:")&&(m=o.split(`
`)[0],o=o.replace(m,"")),t.role=="Form"?e.jsx("li",{children:e.jsx("div",{className:"chat-day-title mt-3 mb-0",children:e.jsx("small",{className:"title badge badge-soft-dark rounded-pill",children:o})})},a):e.jsx("li",{className:c?"odd":"",style:{marginBottom:a<j.length-1?"0px":"24px",marginTop:x},children:e.jsx("div",{className:"message-list",children:e.jsx("div",{className:"conversation-text",children:e.jsxs("div",{className:`ctext-wrap ${c?`message-out-${g}`:`message-in-${g}`}`,style:{boxShadow:"rgba(11, 20, 26, 0.13) 0px 1px 0.5px 0px",padding:"6px 8px"},children:[t.campaign&&e.jsxs("div",{className:"rounded p-2 mb-2",style:{backgroundColor:"rgba(240, 240, 240, 0.125)",cursor:t.campaign.link?"pointer":"default",maxWidth:"240px"},onClick:()=>{t.campaign.link&&window.open(t.campaign.link,"_blank")},children:[e.jsxs("div",{className:"d-flex gap-1",style:{maxWidth:"100%"},children:[e.jsx("div",{className:"fw-bold",children:t.campaign.code}),e.jsx("div",{className:"small text-truncate",children:t.campaign.title})]}),e.jsx("small",{className:"d-block text-truncate",style:{maxWidth:300},children:t.campaign.link})]}),m&&e.jsxs(e.Fragment,{children:[e.jsx("img",{src:m.replace("/attachment:",""),className:"mb-1",alt:"attachment",style:{minWidth:"300px",width:"100%",maxWidth:"100%",minHeight:"200px",maxHeight:"300px",borderRadius:"4px",objectFit:"cover"},onError:S=>{const v=S.target;v&&v.parentNode&&(v.style.display="none")}}),e.jsx("div",{className:"d-flex justify-content-end",children:e.jsxs("a",{className:"btn btn-xs btn-light mb-1 text-nowrap d-flex text-end",href:m.replace("/attachment:",""),target:"_blank",rel:"noreferrer",download:!0,children:[e.jsx("i",{className:"mdi mdi-download me-1"}),e.jsx("span",{children:"Descargar adjunto"})]})}),!o.trim()&&e.jsx("span",{className:"time mt-0 float-end",style:{fontSize:"10px",marginLeft:"6px",marginTop:"8px !important"},children:moment(t.created_at).subtract(5,"hours").format("HH:mm")})]}),o.trim()&&e.jsx(Le,{className:"text-start font-14",html:De(o+`<span class="time mt-0 float-end" style="font-size: 10px; margin-left: 6px; margin-top: 8px !important">${moment(t.created_at).subtract(5,"hours").format("HH:mm")}</span>`)})]})})})},a)})]}),e.jsx("form",{className:"p-2 pt-0 conversation-input",onSubmit:ae,children:e.jsxs("label",{className:`row g-0 align-items-end p-1 ${g=="dark"?"bg-light":"bg-white"}`,htmlFor:"message-input",style:{borderRadius:"24px"},children:[e.jsxs("div",{className:"col-auto mt-0",children:[e.jsxs("div",{className:"dropup",ref:w,children:[e.jsx("button",{type:"button",className:"btn btn-light btn-sm dropdown-toggle","data-bs-toggle":"dropdown","aria-expanded":N,onClick:()=>p(!N),disabled:E||H,title:"Adjuntar archivo",style:{borderRadius:"50%",width:"38px",height:"38px",padding:0},children:e.jsx("i",{className:`mdi ${N?"mdi-close":"mdi-plus"}`})}),e.jsxs("div",{className:"dropdown-menu mb-1",children:[e.jsxs("button",{className:"dropdown-item",href:"#",onClick:t=>{var a,c;t.preventDefault(),(a=k.current)==null||a.setAttribute("accept",".pdf,.doc,.docx"),(c=k.current)==null||c.click()},children:[e.jsx("i",{className:"mdi mdi-file-document me-2",style:{color:"#7F66FF"}}),"Documentos"]}),e.jsxs("button",{className:"dropdown-item",href:"#",onClick:t=>{var a,c;t.preventDefault(),(a=k.current)==null||a.setAttribute("accept","image/*,video/*"),(c=k.current)==null||c.click()},children:[e.jsx("i",{className:"mdi mdi-image me-2",style:{color:"#007BFC"}}),"Fotos y videos"]}),e.jsxs("button",{className:"dropdown-item",href:"#",onClick:t=>{t.preventDefault(),fe()},children:[e.jsx("i",{className:"mdi mdi-camera me-2",style:{color:"#FF2E74"}}),"Cámara"]}),e.jsxs("button",{className:"dropdown-item",href:"#",onClick:t=>{var a,c;t.preventDefault(),(a=k.current)==null||a.setAttribute("accept","audio/*"),(c=k.current)==null||c.click()},children:[e.jsx("i",{className:"mdi mdi-headphones me-2",style:{color:"#FB6533"}}),"Audio"]})]})]}),e.jsx("input",{ref:k,type:"file",className:"d-none",onChange:ge})]}),e.jsx("div",{className:"col mt-0",children:H?e.jsxs("div",{className:"d-flex align-items-center justify-content-center bg-light rounded-pill",style:{minHeight:"38px"},children:[e.jsx("span",{className:"text-danger me-2",children:"●"})," Grabando..."]}):_?e.jsx("div",{className:"d-flex align-items-center bg-light rounded-pill px-2",style:{minHeight:"38px"},children:e.jsx("audio",{ref:B,src:s,className:"me-2",controls:!0,controlsList:"nodownload",style:{height:"30px"}})}):D?e.jsx("div",{className:"d-flex align-items-center bg-light rounded-pill px-2",style:{minHeight:"38px"},children:e.jsx("span",{className:"me-2",children:"📷 Foto capturada"})}):e.jsx("textarea",{ref:Y,id:"message-input",className:"form-control w-100",placeholder:"Ingrese su mensaje aquí",rows:1,style:{minHeight:"38px",maxHeight:"188px",fieldSizing:"content",resize:"none",border:"none",backgroundColor:"transparent"},disabled:E||!!_||!!D,value:d,onChange:t=>l(t.target.value),onKeyDown:t=>{t.key==="Enter"&&!t.shiftKey&&(t.preventDefault(),je()&&ae(t))}})}),e.jsx("div",{className:"col-auto mt-0",children:D&&!U?e.jsxs(e.Fragment,{children:[e.jsx("button",{type:"button",className:"btn btn-danger btn-sm me-1",onClick:()=>P(null),style:{borderRadius:"50%",width:"38px",height:"38px",padding:0},title:"Descartar foto",children:e.jsx("i",{className:"mdi mdi-delete"})}),e.jsx("button",{type:"submit",className:"btn btn-success btn-sm",disabled:E,style:{borderRadius:"50%",width:"38px",height:"38px",padding:0},title:"Enviar foto",children:e.jsx("i",{className:"mdi mdi-send"})})]}):_&&!H?e.jsxs(e.Fragment,{children:[e.jsx("button",{type:"button",className:"btn btn-danger btn-sm me-1",onClick:se,style:{borderRadius:"50%",width:"38px",height:"38px",padding:0},title:"Descartar audio",children:e.jsx("i",{className:"mdi mdi-delete"})}),e.jsx("button",{type:"submit",className:"btn btn-success btn-sm",disabled:E,style:{borderRadius:"50%",width:"38px",height:"38px",padding:0},title:"Enviar audio",children:e.jsx("i",{className:"mdi mdi-send"})})]}):H?e.jsxs(e.Fragment,{children:[e.jsx("button",{type:"button",className:"btn btn-warning btn-sm me-1",onClick:xe,style:{borderRadius:"50%",width:"38px",height:"38px",padding:0},title:"Pausar grabación",children:e.jsx("i",{className:"mdi mdi-pause"})}),e.jsx("button",{type:"button",className:"btn btn-danger btn-sm",onClick:se,style:{borderRadius:"50%",width:"38px",height:"38px",padding:0},title:"Descartar grabación",children:e.jsx("i",{className:"mdi mdi-delete"})})]}):e.jsx(e.Fragment,{children:d.trim()?e.jsx("button",{type:"submit",className:"btn btn-primary btn-sm",disabled:E,style:{borderRadius:"50%",width:"38px",height:"38px",padding:0},children:E?e.jsx("i",{className:"mdi mdi-spin mdi-loading"}):e.jsx("i",{className:"mdi mdi-send"})}):e.jsx("button",{type:"button",className:"btn btn-outline-primary btn-sm",onClick:pe,disabled:E,style:{borderRadius:"50%",width:"38px",height:"38px",padding:0},title:"Grabar audio",children:e.jsx("i",{className:"mdi mdi-microphone"})})})})]})})]})}),U&&e.jsx("div",{className:"position-fixed top-0 start-0 w-100 h-100 d-flex align-items-center justify-content-center",style:{backgroundColor:"rgba(0,0,0,0.8)",zIndex:9999},children:e.jsxs("div",{className:"card",style:{width:"90%",maxWidth:"500px"},children:[e.jsxs("div",{className:"card-header d-flex justify-content-between align-items-center",children:[e.jsx("h5",{className:"mb-0",children:"Cámara"}),e.jsx("button",{type:"button",className:"btn btn-sm btn-outline-secondary",onClick:ne,children:e.jsx("i",{className:"mdi mdi-close"})})]}),e.jsxs("div",{className:"card-body p-0",children:[e.jsx("video",{ref:f,autoPlay:!0,playsInline:!0,muted:!0,className:"w-100",style:{maxHeight:"400px"}}),e.jsx("canvas",{ref:A,className:"d-none"})]}),e.jsx("div",{className:"card-footer d-flex justify-content-center",children:e.jsxs("button",{type:"button",className:"btn btn-primary btn-lg rounded-pill",onClick:be,children:[e.jsx("i",{className:"mdi mdi-camera me-2"}),"Tomar foto"]})})]})})]})]})},de=new le;de.paginateSufix=null;const Fe=({users:y,activeLeadId:g,...Y})=>{const k=Local.get("adminto_settings")??{},[B,C]=n.useState(k.theme??"light"),[f,A]=n.useState([]),[w,R]=n.useState(g),[i,T]=Ee(X.business_id,[X.service_user.id]),[b,O]=n.useState(!1),[j,F]=n.useState(0),[h,G]=n.useState(""),[$,E]=n.useState(null),{socket:L}=oe(),H=n.useRef(),I=n.useRef(),_=async(s=!1)=>{if(b)return;O(!0);const r={fields:["clients.id","clients.contact_name","clients.contact_phone","clients.last_message","clients.last_message_microtime","clients.assigned_to"],withCount:["unSeenMessages"],with:["assigned"],sort:[{selector:"last_message_microtime",desc:!0}],skip:0,take:40,requireTotalCount:!0},d=[["clients.last_message_microtime","isnotnull"]];if(i.length&&d.push(Z(i.map(p=>["clients.assigned_to","=",p]),"or")),h){const p=[["clients.contact_name","=",h],["clients.contact_name","contains",h],["clients.contact_phone","contains",h]];d.push(Z(p,"or"))}if(s&&f.length>0){const p=Math.min(...f.map(u=>u.last_message_microtime));d.push(["clients.last_message_microtime","<",p])}r.filter=Z(d,"and");const{data:l,totalCount:N}=await de.paginate(r);A(s?p=>[...p,...l??[]]:l??[]),F(((l==null?void 0:l.length)??0)+(N??0)),O(!1)},z=s=>{const r=s.target.value;G(r),$&&clearTimeout($),E(setTimeout(()=>{_(!1)},500))};return n.useEffect(()=>{_(!1)},[i]),n.useEffect(()=>{const s=r=>{r.key==="Escape"&&R(null)};return window.addEventListener("keydown",s),()=>window.removeEventListener("keydown",s)},[]),n.useEffect(()=>{if(L)return L.on("client.updated",s=>{A(r=>{const d=r.findIndex(l=>l.id===s.id);if(d!==-1){const l=[...r];return l[d]={...l[d],...s},l}return!i.length||i.includes(s.assigned_to)?[...r,s]:r})}),()=>{L.off("client.updated")}},[L,i]),n.useEffect(()=>{const s=I.current;if(!s)return;const r=()=>{s.scrollTop+s.clientHeight>=s.scrollHeight-10&&f.length<j&&_(!0)};return s.addEventListener("scroll",r),()=>s.removeEventListener("scroll",r)},[f,b,i,j,h]),n.useEffect(()=>{w?history.pushState({},"",`/chat/${w}`):history.pushState({},"","/chat")},[w]),e.jsx($e,{...Y,title:"Chat",showTitle:!1,setThemeParent:C,children:e.jsxs("div",{className:"row",children:[e.jsx("div",{className:"col-xl-3 col-lg-4",children:e.jsx("div",{className:"card chat-list-card mb-xl-0",children:e.jsxs("div",{className:"card-body p-0",children:[e.jsxs("div",{className:"p-2",children:[e.jsxs("div",{className:"d-flex w-100 gap-0 align-items-center",style:{overflowX:"auto"},children:[y.map(s=>e.jsx(Q,{content:`${s.name} ${s.lastname}`,children:e.jsx("div",{onClick:()=>{const r=[...i],d=s.service_user.id,l=r.indexOf(d);l>-1?r.splice(l,1):r.push(d),T(r)},className:`rounded-pill ${i.includes(s.service_user.id)?"bg-purple":""}`,style:{cursor:"pointer",padding:"2px",marginRight:"2px"},children:e.jsx("img",{className:"avatar-xs rounded-circle",src:`//${q.APP_DOMAIN}/api/profile/thumbnail/${s.relative_id}`,alt:s.name,style:{objectFit:"cover",objectPosition:"center"}})})},s.id)),i.length>0&&e.jsx(Q,{content:"Limpiar filtros",children:e.jsx("button",{className:"btn btn-xs btn-soft-danger ms-1 rounded-pill",onClick:()=>T([]),children:e.jsx("i",{className:"mdi mdi-trash-can-outline"})})})]}),e.jsx("hr",{className:"my-2"}),e.jsxs("div",{className:"search-box chat-search-box",children:[e.jsx("input",{type:"text",className:"form-control",placeholder:"Buscar lead por nombre o número...",value:h,onChange:z}),e.jsx("i",{className:"mdi mdi-magnify search-icon"})]})]}),e.jsx("hr",{className:"my-0"}),e.jsxs("div",{ref:I,style:{overflowY:"auto",height:"calc(100vh - 300px)"},children:[e.jsx("ul",{className:"list-unstyled chat-list mb-0",children:f.sort((s,r)=>new Date(r.last_message_microtime)-new Date(s.last_message_microtime)).map(s=>{var p;const r=new Date((s.last_message_microtime??0)/1e3),d=new Date;d.setHours(0,0,0,0);const l=new Date(d);l.setDate(l.getDate()-1);let N;if(r>=d)N=r.toLocaleString("es-ES",{hour:"2-digit",minute:"2-digit"});else if(r>=l)N="Ayer";else{const u=["Domingo","Lunes","Martes","Miércoles","Jueves","Viernes","Sábado"];if(Math.floor((new Date-r)/(1e3*60*60*24))<=6)N=u[r.getDay()];else{const P=String(r.getDate()).padStart(2,"0"),U=String(r.getMonth()+1).padStart(2,"0"),W=r.getFullYear();N=`${P}/${U}/${W}`}}return e.jsx("li",{className:`${s.unread?"unread":""} ${w==s.id?"bg-light":""}`,children:e.jsx("a",{onClick:u=>{R(s.id),u.stopPropagation()},style:{cursor:"pointer"},children:e.jsxs("div",{className:"d-flex",children:[e.jsxs("div",{className:`position-relative flex-shrink-0 chat-user-img ${s.online?"active":""} align-self-center me-2`,children:[e.jsx("img",{src:`/api/whatsapp/profile/${s.contact_phone}`,className:"rounded-circle avatar-sm bg-light",alt:s.name,style:{padding:0,border:"none"},onError:u=>{u.target.src=`//${q.APP_DOMAIN}/api/profile/thumbnail/null`}}),s.assigned_to&&((p=s.assigned)==null?void 0:p.relative_id)&&(i.length===0||i.length>1||i[0]!==X.service_user.id)&&e.jsx(Q,{content:`${s.assigned.name} ${s.assigned.lastname}`,children:e.jsx("img",{className:"position-absolute rounded-pill",src:`//${q.APP_DOMAIN}/api/profile/thumbnail/${s.assigned.relative_id}`,alt:s.assigned.fullname,style:{right:"-4px",bottom:"-4px",objectFit:"cover",objectPosition:"center",padding:0,border:`2px solid ${B=="light"?"#ffffff":"#313844"}`,width:"18px",aspectRatio:1}})},s.assigned.id)]}),e.jsxs("div",{className:"flex-grow-1 overflow-hidden",children:[e.jsx("h5",{className:`text-truncate font-14 mt-0 mb-1 ${s.un_seen_messages_count>0?"fw-bold":""}`,children:s.contact_name}),e.jsx("p",{className:`text-truncate mb-0 ${s.un_seen_messages_count>0?"fw-bold":""}`,title:s.last_message??void 0,style:{color:s.un_seen_messages_count>0?B=="light"?"#343a40":"#f7f7f7":void 0},children:s.last_message??e.jsx("i",{className:"text-muted",children:"Sin mensaje"})})]}),e.jsxs("div",{className:"d-flex flex-column align-items-end",children:[e.jsx("div",{className:`font-11 ${s.un_seen_messages_count>0?"text-success":""}`,children:N}),s.un_seen_messages_count>0&&e.jsx("span",{className:"badge bg-success rounded-pill mt-1",children:s.un_seen_messages_count})]})]})})},s.id)})}),e.jsxs("div",{className:"text-center py-2",children:[b&&e.jsx("div",{className:"spinner-border spinner-border-sm text-primary",role:"status",children:e.jsx("span",{className:"visually-hidden",children:"Loading contacts..."})}),!b&&f.length>=j&&f.length>0&&e.jsx("span",{className:"text-muted",children:"No hay más contactos"})]})]})]})})}),e.jsx("div",{className:"col-xl-9 col-lg-8",children:e.jsx("div",{className:"conversation-list-card card",children:w?e.jsx(e.Fragment,{children:e.jsx(Te,{leadId:w,containerRef:H,theme:B})}):e.jsx("div",{className:"card-body d-flex align-items-center justify-content-center",style:{height:"calc(100vh - 184px)"},children:e.jsxs("div",{className:"text-center",children:[e.jsx("img",{src:"/assets/img/icon.svg",alt:`Logo ${q.APP_NAME}`,className:"mb-2",style:{width:60,height:60,objectFit:"contain"}}),e.jsxs("h4",{className:"text-muted",children:["Módulo de chat de ",q.APP_NAME]}),e.jsx("p",{className:"text-muted",children:"Selecciona un contacto para empezar a interactuar"})]})})})})]})})};Se((y,g)=>{ke(y).render(e.jsx(Fe,{...g}))});
