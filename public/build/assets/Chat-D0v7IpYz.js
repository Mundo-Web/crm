import{C as A,c as E,j as e,r as a,G as m}from"./CreateReactScript-e3GvmO1h.js";import{W as M,A as R,u as C,i as b}from"./Adminto-CI_nj0HS.js";import{L as P}from"./LeadsRest-KH0vtPDl.js";import{M as I}from"./MessagesRest-dzcsw4TV.js";import"./Logout-C-9LAAR-.js";import"./sweetalert2.esm.all-CMZyvfN1.js";new M;const y=new P;y.paginateSufix=null;const D=new I,F=({users:x})=>{const[l,w]=a.useState([]),[o,p]=a.useState(null),[h,j]=a.useState([]),[u,g]=a.useState([]),[_,f]=a.useState(!0),[L,N]=a.useState(!1),{socket:d}=C(),v=a.useRef(),n=l.find(s=>s.id==o);u.filter(s=>s.wa_id==(n==null?void 0:n.contact_phone));const k=async()=>{f(!0);const{data:s}=await y.paginate({limit:40});w(s??[]),f(!1)},S=async()=>{if(!n||L)return;N(!0);const s=u.sort((c,r)=>r.microtime-c.microtime)[0]??{microtime:0},t=await D.paginate({filter:[["microtime",">",s.microtime],"and",["wa_id","contains",n.contact_phone]],sort:[{selector:"microtime",desc:!1}]});g(c=>[...c,...t.data??[]].sort((r,i)=>r.microtime-i.microtime)),N(!1)};return a.useEffect(()=>{k()},[]),a.useEffect(()=>{const s=t=>{t.key==="Escape"&&p(null)};return window.addEventListener("keydown",s),()=>window.removeEventListener("keydown",s)},[]),a.useEffect(()=>{o&&(g([]),S())},[o]),a.useEffect(()=>{if(d)return d.on("message",s=>{const{wa_id:t}=s;g(c=>c.find(i=>i.wa_id===t)?c.map(i=>i.wa_id===t?{...i,...s}:i):[...c,s].sort((i,$)=>i.microtime-$.microtime))}),()=>{d.off("message")}},[d]),a.useEffect(()=>{if(!v.current)return;const s=v.current;s.scrollTop=s.scrollHeight},[u]),e.jsxs("div",{className:"row",children:[e.jsx("div",{className:"col-xl-3 col-lg-4",children:e.jsx("div",{className:"card chat-list-card mb-xl-0",children:e.jsxs("div",{className:"card-body p-0",children:[e.jsxs("div",{className:"p-2",children:[e.jsxs("div",{className:"d-flex w-100 gap-0 align-items-center",children:[x.map(s=>e.jsx(b,{content:`${s.name} ${s.lastname}`,children:e.jsx("div",{onClick:()=>{const t=[...h],c=s.service_user.id,r=t.indexOf(c);r>-1?t.splice(r,1):t.push(c),j(t)},className:`rounded-pill ${h.includes(s.service_user.id)?"bg-purple":""}`,style:{cursor:"pointer",padding:"2px",marginRight:"2px"},children:e.jsx("img",{className:"avatar-xs rounded-circle",src:`//${m.APP_DOMAIN}/api/profile/thumbnail/${s.relative_id}`,alt:s.name,style:{objectFit:"cover",objectPosition:"center"}})})},s.id)),h.length>0&&e.jsx(b,{content:"Limpiar filtros",children:e.jsx("button",{className:"btn btn-xs btn-soft-danger ms-1 rounded-pill",onClick:()=>j([]),children:e.jsx("i",{className:"mdi mdi-trash-can-outline"})})})]}),e.jsx("hr",{className:"my-2"}),e.jsxs("div",{className:"search-box chat-search-box",children:[e.jsx("input",{type:"text",className:"form-control",placeholder:"Buscar lead por nombre o número..."}),e.jsx("i",{className:"mdi mdi-magnify search-icon"})]})]}),e.jsx("hr",{className:"my-0"}),e.jsx("div",{style:{overflowY:"auto"},children:_?e.jsxs("div",{className:"text-center py-4",style:{height:"calc(100vh - 300px)"},children:[e.jsx("div",{className:"spinner-border text-primary",role:"status",children:e.jsx("span",{className:"visually-hidden",children:"Loading contacts..."})}),e.jsx("p",{className:"mt-2 mb-0 text-muted",children:"Cargando contactos..."})]}):e.jsx("ul",{className:"list-unstyled chat-list mb-0",style:{height:"calc(100vh - 300px)"},children:l.sort((s,t)=>new Date(t.last_message_at)-new Date(s.last_message_at)).map(s=>e.jsx("li",{className:`${s.unread?"unread":""} ${o==s.id?"bg-light":""}`,children:e.jsx("a",{onClick:t=>{p(s.id),t.stopPropagation()},className:"cursor-pointer",style:{borderLeft:`4px solid ${s.status.color}`},children:e.jsxs("div",{className:"d-flex",children:[e.jsx("div",{className:`flex-shrink-0 chat-user-img ${s.online?"active":""} align-self-center me-2`,children:s.avatar?e.jsx("img",{src:`//${m.APP_DOMAIN}/api/profile/thumbnail/${s.avatar}`,className:"rounded-circle avatar-sm",alt:s.name}):e.jsx("span",{className:`avatar-title rounded-circle bg-soft-${s.color} text-${s.color}`,children:e.jsx("i",{className:"mdi mdi-account"})})}),e.jsxs("div",{className:"flex-grow-1 overflow-hidden",children:[e.jsxs("h5",{className:"text-truncate font-14 mt-0 mb-1",children:[s.name," ",e.jsx("small",{className:"text-muted fw-normal",children:s.contact_phone})]}),e.jsx("p",{className:"text-truncate mb-0",children:s.last_message??"Sin mensaje"})]}),e.jsx("div",{className:"font-11",children:s.last_time})]})})},s.id))})})]})})}),e.jsx("div",{className:"col-xl-9 col-lg-8",children:e.jsx("div",{className:"conversation-list-card card",children:n?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"card-header",children:e.jsx("div",{className:"d-flex",children:e.jsxs("div",{className:"flex-grow-1",children:[e.jsx("h5",{className:"mt-0 mb-1 text-truncate",children:n.name}),e.jsxs("p",{className:"font-13 text-muted mb-0",children:[e.jsx("i",{className:"mdi mdi-phone me-1 font-11"})," ",n.contact_phone]})]})})}),e.jsx("div",{className:"card-body p-0 position-relative",style:{backgroundColor:"var(--bs-body-bg)",backgroundImage:"url(/assets/img/doodles.png)",backgroundRepeat:"repeat",backgroundPosition:"contain",backgroundOpacity:.5},children:e.jsxs("div",{className:"text-center py-4",style:{height:"calc(100vh - 345px)"},children:[e.jsx("div",{className:"spinner-border text-primary",role:"status",children:e.jsx("span",{className:"visually-hidden",children:"Loading messages..."})}),e.jsx("p",{className:"mt-2 mb-0 text-muted",children:"Cargando mensajes..."})]})})]}):e.jsx("div",{className:"card-body d-flex align-items-center justify-content-center",style:{height:"calc(100vh - 184px)"},children:e.jsxs("div",{className:"text-center",children:[e.jsx("img",{src:"/assets/img/icon.svg",alt:`Logo ${m.APP_NAME}`,className:"mb-2",style:{width:60,height:60,objectFit:"contain"}}),e.jsxs("h4",{className:"text-muted",children:["Módulo de chat de ",m.APP_NAME]}),e.jsx("p",{className:"text-muted",children:"Selecciona un contacto para empezar a interactuar"})]})})})})]})};A((x,l)=>{E(x).render(e.jsx(R,{...l,title:"Chat",showTitle:!1,children:e.jsx(F,{...l})}))});
