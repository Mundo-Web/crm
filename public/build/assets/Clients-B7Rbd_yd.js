var oe=Object.defineProperty;var ie=(m,n,u)=>n in m?oe(m,n,{enumerable:!0,configurable:!0,writable:!0,value:u}):m[n]=u;var B=(m,n,u)=>(ie(m,typeof n!="symbol"?n+"":n,u),u);import{S as X,B as me,A as ue,i as I}from"./Adminto-KIgIzgqO.js";import{r as s,R as e,m as S,C as de,c as fe}from"./CreateReactScript-Cr76lECz.js";import{M as O,T as j}from"./TextareaFormGroup-DpQiZCGF.js";import{C as L,L as pe}from"./LeadsRest-B-pSwUCG.js";import{I as N}from"./InputFormGroup-DfllSyoc.js";import{S as z,a as Ee}from"./SetSelectValue-CfjBp_ib.js";import{D as P}from"./DropdownItem-Dd6zonp_.js";import{D as ge}from"./DropdownEnd-CXnHC35Z.js";import{P as be,a as ve,A as he}from"./AssignUsersModal-Bl8oiU9-.js";import{R as y}from"./ReactAppend-BUdEshxq.js";import{P as ye,A as we,N as Ne,D as Re}from"./Assigneds-DaZioEBi.js";import{T as xe}from"./Table-DyL-cwJJ.js";import{T as w}from"./TippyButton-ltdZXQxe.js";import{D as Ce}from"./DxBox-CyhaKWwR.js";import{D as K}from"./Dropdown-BfY1-Jpp.js";import"./server.browser-Dt1gYAOJ.js";const De=({can:m,client:n,setClient:u,grid2refresh:h,page:l})=>{const o=s.useRef(),i=s.useRef(),g=s.useRef(),f=s.useRef(),b=s.useRef(),v=s.useRef(),[_,R]=s.useState([]),[A,C]=s.useState(!1);s.useEffect(()=>{n.id&&k(),$(o.current).on("hidden.bs.modal",()=>{u({}),R([]),C(!1),g.current.value=null,z(f.current,null,null),b.current.value=null,v.current.value=null})},[n]);const k=async()=>{const r=await L.byClient(n==null?void 0:n.id);R(r),$(o.current).modal("show")},T=async r=>{r.preventDefault();const p={id:g.current.value||void 0,type_id:f.current.value,client_id:n.id,name:b.current.value,description:v.current.value};await L.save(p)&&($(i.current).modal("hide"),g.current.value=null,z(f.current,null,null),b.current.value=null,v.current.value=null,await D(),$(h.current).dxDataGrid("instance").refresh())},D=async()=>{const r=await L.byClient(n.id);R(r)},q=async r=>{g.current.value=r.id,z(f.current,r.type.id,r.type.name),b.current.value=r.name,v.current.value=r.description,$(i.current).modal("show"),C(!0)},F=async r=>{const{isConfirmed:p}=await X.fire({title:"Estas seguro de eliminar esta nota?",text:"No podras revertir esto!",icon:"warning",showCancelButton:!0,confirmButtonText:"Continuar",cancelButtonText:"Cancelar"});!p||!await L.delete(r)||(await D(),$(h.current).dxDataGrid("instance").refresh())};return e.createElement(e.Fragment,null,e.createElement(O,{modalRef:o,title:`Notas de ${(n==null?void 0:n.tradename)||(n==null?void 0:n.name)||(n==null?void 0:n.contact_name)}`,size:"full-width",isStatic:!0,hideFooter:!0},e.createElement("div",{style:{height:"calc(100vh - 180px)",overflowY:"auto"}},e.createElement("div",{className:"text-center"},e.createElement("button",{className:"btn btn-primary",type:"button",onClick:()=>$(i.current).modal("show")},"Agregar nota")),e.createElement("hr",{className:"my-2"}),e.createElement("div",{className:"d-flex flex-wrap flex-row justify-content-center gap-2"},_.sort((r,p)=>new Date(p.created_at)-new Date(r.created_at)).map((r,p)=>{const x=moment(r.created_at),J=moment().diff(x,"hours")>12?x.format("lll"):x.fromNow();return e.createElement("div",{key:`note-${p}`,className:"card text-white bg-purple mb-0",style:{width:"100%",maxWidth:"300px",height:"max-content"}},e.createElement("div",{className:"card-body p-2"},e.createElement("div",{className:"d-flex align-items-center border-bottom border-white pb-1 mb-1"},e.createElement("div",{className:"avatar-sm me-2 mb-1"},e.createElement("img",{src:`/api/profile/thumbnail/${r.user.relative_id}?v=${new Date(r.user.updated_at).getTime()}`,className:"img-fluid rounded-circle",alt:"user"})),e.createElement("div",{className:"flex-grow-1 overflow-hidden"},e.createElement("h5",{className:"text-white m-0"},r.user.name," ",r.user.lastname),e.createElement("p",{className:"text-white-50 m-0 font-13 text-truncate"},J)),m(l,"root","all","editnotes","deletenotes")&&e.createElement(ge,null,m(l,"root","all","editnotes")&&e.createElement(P,{onClick:()=>q(r)},"Editar"),m(l,"root","all","deletenotes")&&e.createElement(P,{onClick:()=>F(r.id)},"Eliminar"))),e.createElement("blockquote",{className:"card-bodyquote mb-0"},r.name&&e.createElement("b",null,r.name),e.createElement("p",{className:"mb-1"},r.description))))})))),e.createElement(O,{modalRef:i,title:A?"Editar nota":"Agregar nota",size:"sm",onSubmit:T},e.createElement("div",{id:"note-crud-container"},e.createElement("input",{ref:g,type:"hidden"}),e.createElement(Ee,{eRef:f,label:"Tipo de nota",col:"col-12",dropdownParent:"#note-crud-container",searchAPI:"/api/types/paginate",searchBy:"name",filter:["table_id","=","c81ad4fb-a895-4f4c-b4b3-5989a7a66a85"],required:!0}),e.createElement(N,{eRef:b,label:"Titulo de la nota"}),e.createElement(j,{eRef:v,label:"Descripcion de la nota",required:!0}))))};class H extends me{constructor(){super(...arguments);B(this,"path","clients")}}B(H,"assign",async(u,h)=>{try{const{status:l,result:o}=await S.Fetch("/api/clients/assign",{method:h?"PUT":"DELETE",body:JSON.stringify({id:u})});if(!l)throw new Error((o==null?void 0:o.message)??"Ocurrio un error inesperado");return S.Notify.add({icon:"/assets/img/logo-login.svg",title:"Correcto",body:o.message,type:"success"}),!0}catch(l){return S.Notify.add({icon:"/assets/img/logo-login.svg",title:"Error",body:l.message,type:"danger"}),!1}}),B(H,"clientStatus",async(u,h)=>{try{const{status:l,result:o}=await S.Fetch("/api/clients/client-status",{method:"PATCH",body:JSON.stringify({client:u,status:h})});if(!l)throw new Error((o==null?void 0:o.message)??"Ocurrio un error inesperado");return S.Notify.add({icon:"/assets/img/logo-login.svg",title:"Correcto",body:o.message,type:"success"}),!0}catch(l){return S.Notify.add({icon:"/assets/img/logo-login.svg",title:"Error",body:l.message,type:"danger"}),!1}});const G=new H,Q=new pe,Se=({projectStatuses:m,clientStatuses:n,manageStatuses:u,session:h,can:l,defaultClientStatus:o})=>{const i=s.useRef(),g=s.useRef(),f=s.useRef(),b=s.useRef(),v=s.useRef(),_=s.useRef(),R=s.useRef(),A=s.useRef(),C=s.useRef(),k=s.useRef(),T=s.useRef(),D=s.useRef(),[q,F]=s.useState(!1),[r,p]=s.useState({}),[x,M]=s.useState({}),[V,J]=s.useState({}),[Z,ee]=s.useState({});s.useState([]);const W=t=>{t!=null&&t.id?F(!0):F(!1),$('[href="#client-data"]').addClass("active"),$('[href="#contact-data"]').removeClass("active"),$("#client-data").addClass("active"),$("#contact-data").removeClass("active"),f.current.value=(t==null?void 0:t.id)||null,b.current.value=(t==null?void 0:t.ruc)||null,v.current.value=(t==null?void 0:t.name)||null,_.current.value=(t==null?void 0:t.tradename)||null,R.current.value=(t==null?void 0:t.web_url)||null,A.current.value=(t==null?void 0:t.message)||"Cliente creado desde Atalaya",C.current.value=(t==null?void 0:t.contact_name)||null,k.current.value=(t==null?void 0:t.contact_phone)||null,T.current.value=(t==null?void 0:t.contact_email)||null,D.current.value=(t==null?void 0:t.contact_address)||null,$(g.current).modal("show")},te=async t=>{t.preventDefault();const a={id:f.current.value||void 0,ruc:b.current.value,name:v.current.value,tradename:_.current.value,web_url:R.current.value,message:A.current.value??"Cliente creado desde Atalaya",contact_name:C.current.value??"",contact_phone:k.current.value??"",contact_email:T.current.value??"",contact_address:D.current.value??"",status_id:f.current.value?void 0:o};await G.save(a)&&($(i.current).dxDataGrid("instance").refresh(),$(g.current).modal("hide"))},ae=async t=>{const{isConfirmed:a}=await X.fire({title:"Estas seguro de eliminar este lead?",text:"No podras revertir esta accion!",icon:"warning",showCancelButton:!0,confirmButtonText:"Continuar",cancelButtonText:"Cancelar"});!a||!await G.delete(t)||$(i.current).dxDataGrid("instance").refresh()},Y=async(t,a)=>{await G.assign(t,a)&&$(i.current).dxDataGrid("instance").refresh()},ne=async(t,a)=>{await Q.leadStatus({lead:t,status:a}),$(i.current).dxDataGrid("instance").refresh()},re=async(t,a)=>{await Q.manageStatus({lead:t.id,status:a.id}),$(i.current).dxDataGrid("instance").refresh()};return e.createElement(e.Fragment,null,e.createElement(xe,{gridRef:i,title:"Clientes",rest:G,toolBar:t=>{t.unshift({widget:"dxButton",location:"after",options:{icon:"refresh",hint:"Refrescar tabla",onClick:()=>$(i.current).dxDataGrid("instance").refresh()}}),l("clients","root","all","create")&&t.unshift({widget:"dxButton",location:"after",options:{icon:"plus",hint:"Nuevo registro",onClick:()=>W()}})},columns:[l("projects","root","all","list")?{dataField:"id",caption:"ID",dataType:"number",cellTemplate:(t,{data:a,value:d,...E})=>{y(t,e.createElement(w,{className:"btn btn-xs btn-white",title:`Ver ${a.projects_count} proyectos`,onClick:()=>{E.component.collapseAll(-1),E.component.expandRow(E.row.data)}},e.createElement("i",{className:"fas fa-shapes"})," ",a.projects_count))},sortOrder:"desc"}:null,{dataField:"ruc",caption:"RUC"},{dataField:"tradename",caption:"Nombre comercial",width:250,cellTemplate:(t,{data:a})=>{y(t,e.createElement("div",{className:"d-flex align-items-center"},a.assigned_to&&e.createElement(I,{content:`Atendido por ${a.assigned.name} ${a.assigned.lastname}`},e.createElement("img",{className:"avatar-xs rounded-circle me-1",src:`/api/profile/thumbnail/${a.assigned.relative_id}`,alt:a.assigned.name})),e.createElement("div",null,a.tradename)))}},{dataField:"name",caption:"Razon social",visible:!1},{dataField:"contact_phone",caption:"Telefono"},{dataField:"contact_email",caption:"Correo"},l("leads","root","all","changestatus")?{dataField:"status.name",caption:"Estado del cliente",dataType:"string",cellTemplate:(t,{data:a})=>{t.attr("style","overflow: visible"),y(t,e.createElement(K,{className:"btn btn-xs btn-white rounded-pill",title:a.status.name,icon:{icon:"fa fa-circle",color:a.status.color},tippy:"Actualizar estado"},n.map(({id:d,name:E,color:c})=>e.createElement(P,{key:d,onClick:()=>ne(a.id,d)},e.createElement("i",{className:"fa fa-circle",style:{color:c}})," ",E))))}}:null,l("leads","root","all","changestatus")?{dataField:"manage_status.name",caption:"Estado de gestion",dataType:"string",cellTemplate:(t,{data:a})=>{var d,E;t.attr("style","overflow: visible"),y(t,e.createElement(K,{className:"btn btn-xs btn-white rounded-pill",title:(d=a==null?void 0:a.manage_status)==null?void 0:d.name,icon:{icon:"fa fa-circle",color:(E=a==null?void 0:a.manage_status)==null?void 0:E.color},tippy:"Actualizar estado"},u.map((c,U)=>e.createElement(P,{key:`status-${U}`,onClick:()=>re(a,c)},e.createElement("i",{className:"fa fa-circle",style:{color:c.color}})," ",c.name))))}}:null,l("projects","root","all","list","update","changestatus","delete")?{caption:"Acciones",width:235,cellTemplate:(t,{data:a})=>{t.attr("style","display: flex; gap: 4px; overflow: visible"),l("clients","root","all","update")&&y(t,e.createElement(w,{className:"btn btn-xs btn-soft-primary",title:"Editar",onClick:()=>W(a)},e.createElement("i",{className:"fa fa-pen"}))),a.assigned_to?a.assigned_to==h.id&&y(t,e.createElement(w,{className:"btn btn-xs btn-soft-danger",title:"Dejar de atender",onClick:()=>Y(a.id,!1)},e.createElement("i",{className:"fas fa-hands-wash"}))):y(t,e.createElement(w,{className:"btn btn-xs btn-soft-dark",title:"Atender lead",onClick:()=>Y(a.id,!0)},e.createElement("i",{className:"fas fa-hands-helping"}))),l("clients","root","all","delete")&&y(t,e.createElement(w,{className:"btn btn-xs btn-soft-danger",title:"Eliminar",onClick:()=>ae(a.id)},e.createElement("i",{className:"fa fa-trash-alt"})))},allowFiltering:!1,allowExporting:!1}:null],masterDetail:{enabled:!1,template:async(t,{data:a,component:d})=>{t.css("padding","10px"),t.css("overflow","visible"),t.css("background-color","#323a46");let{data:E}=await ye.paginate({filter:["client_id","=",a.id],isLoadingAll:!0});t.append(Ce([e.createElement(e.Fragment,null,e.createElement(w,{title:"Cerrar tabla",className:"btn btn-xs btn-soft-danger waves-effect mb-1",onClick:()=>d.collapseAll(-1)},e.createElement("i",{className:"fa fa-times"})),e.createElement("table",{className:"table table-dark table-sm table-bordered mb-0",style:{width:"100%"}},e.createElement("thead",null,e.createElement("tr",null,e.createElement("th",{scope:"col"},"Tipo"),e.createElement("th",{scope:"col"},"Asignados"),e.createElement("th",{scope:"col"},"Costo"),e.createElement("th",{scope:"col"},"Pagos"),e.createElement("th",{scope:"col"},"Fecha de desarrollo"),e.createElement("th",{scope:"col"},"Estado del proyecto"),e.createElement("th",{scope:"col"},"Acciones"))),e.createElement("tbody",null,E.map(c=>{const U=(c.total_payments/c.cost*100).toFixed(2),se=Number(c.total_payments).toLocaleString("en-US",{maximumFractionDigits:2,minimumFractionDigits:2}),le=Number(c.cost-c.total_payments).toLocaleString("en-US",{maximumFractionDigits:2,minimumFractionDigits:2}),ce=(c.users||"").split("|").filter(Boolean);return e.createElement("tr",{key:`project-${c.id}`},e.createElement("td",{valign:"middle"},c.type.name),e.createElement("td",{valign:"middle"},we(ce)),e.createElement("td",{valign:"middle"},`S/. ${Ne(c.cost)}`),e.createElement("td",{valign:"middle"},e.createElement("p",{className:"mb-0 d-flex justify-content-between"},e.createElement("b",{className:"text-success"},e.createElement("i",{className:"fa fa-arrow-circle-up"})," S/. ",se),e.createElement("b",{className:"float-end text-danger"},e.createElement("i",{className:"fa fa-arrow-circle-down"})," S/. ",le)),e.createElement("div",{className:"progress progress-bar-alt-primary progress-sm mt-0 mb-0",style:{width:"200px"}},e.createElement("div",{className:"progress-bar bg-primary progress-animated wow animated",role:"progressbar","aria-valuenow":c.total_payments,"aria-valuemin":"0","aria-valuemax":c.cost,style:{width:`${U}%`,visibility:"visible",animationName:"animationProgress"}}))),e.createElement("td",{valign:"middle"},Re(c.starts_at,c.ends_at)),e.createElement("td",{valign:"middle"},e.createElement(be,{can:l,statuses:m,data:c,onChange:()=>{$(i.current).dxDataGrid("instance").refresh()}})),e.createElement("td",null,l("projects","root","all","assignUsers")&&e.createElement(w,{className:"btn btn-xs btn-soft-info me-1",title:"Asignar usuarios",icon:"fa fa-user-plus",onClick:()=>M(c)},e.createElement("i",{className:"fa fa-user-plus"})),l("projects","root","all","addpayment")&&e.createElement(w,{className:"btn btn-xs btn-soft-success",title:"Ver/Agregar pagos",icon:"fas fa-money-check-alt",onClick:()=>p(c)},e.createElement("i",{className:"fas fa-money-check-alt"}))))}))))]))}}}),e.createElement(O,{modalRef:g,title:q?"Editar cliente":"Agregar cliente",onSubmit:te,size:"md"},e.createElement("input",{ref:f,type:"hidden"}),e.createElement("ul",{className:"nav nav-pills navtab-bg nav-justified"},e.createElement("li",{className:"nav-item"},e.createElement(I,{content:"Datos del negocio"},e.createElement("a",{href:"#client-data","data-bs-toggle":"tab","aria-expanded":"false",className:"nav-link active"},"Negocio"))),e.createElement("li",{className:"nav-item"},e.createElement(I,{content:"Datos de contacto"},e.createElement("a",{href:"#contact-data","data-bs-toggle":"tab","aria-expanded":"true",className:"nav-link"},"Contacto")))),e.createElement("div",{className:"tab-content"},e.createElement("div",{className:"tab-pane active",id:"client-data"},e.createElement("div",{className:"row"},e.createElement(N,{eRef:b,label:"RUC",col:"col-4",required:!0}),e.createElement(N,{eRef:_,label:"Nombre comercial",col:"col-8",required:!0}),e.createElement(N,{eRef:v,label:"Razon social",col:"col-md-6",required:!0}),e.createElement(N,{eRef:R,label:"URL Web",col:"col-md-6"}),e.createElement(j,{eRef:A,label:"Mensaje",col:"col-12",required:!0}))),e.createElement("div",{className:"tab-pane show",id:"contact-data"},e.createElement("div",{className:"row"},e.createElement(N,{eRef:C,label:"Nombre de contacto",col:"col-6"}),e.createElement(N,{eRef:k,label:"Celular de contacto",type:"tel",col:"col-6"}),e.createElement(N,{eRef:T,label:"Email de contacto",col:"col-12",type:"email"}),e.createElement(j,{eRef:D,label:"Direccion de contacto",col:"col-12"}))))),e.createElement(ve,{can:l,dataLoaded:r,setDataLoaded:p,grid2refresh:V}),e.createElement(De,{can:l,client:Z,setClient:ee,grid2refresh:i,page:"clients"}),e.createElement(he,{dataLoaded:x,setDataLoaded:M,grid2refresh:$(i.current).dxDataGrid("instance")}))};de((m,n)=>{if(!n.can("clients","root","all","list"))return location.href="/";fe(m).render(e.createElement(ue,{...n,title:"Clientes"},e.createElement(Se,{...n})))});
