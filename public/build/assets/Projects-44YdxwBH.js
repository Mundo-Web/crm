import{C as V,c as U,j as r,r as s,m as O}from"./CreateReactScript-DSh221L4.js";import{A as z,S as d}from"./Adminto-CxkkDmWv.js";import{P as Q,a as H,A as J}from"./AssignUsersModal-D4kibo_v.js";import{N as K}from"./Number2Currency-e57Tgsuk.js";import{a as P,S as k}from"./SetSelectValue-HiwDtLZy.js";import{P as x,A as W,D as X}from"./DateRange-BR06WS9i.js";import{M as Z}from"./Modal-D-tXYeXz.js";import{T as ee,D as M}from"./DxPanelButton-aij2gTJV.js";import{D as l}from"./DxButton-CsjWvhyj.js";import{I as u}from"./InputFormGroup-DsuG1yrP.js";import{T as te}from"./TextareaFormGroup-CVonM_0b.js";import{D as f}from"./DxBox-ccwwFBft.js";import{S as re}from"./SelectFormGroup-D827EBoU.js";import{S as se}from"./SubdomainsRest-BQJQOo4t.js";import"./Dropdown-7dNvA4Pv.js";import"./DropdownItem-BOKSg5Pi.js";import"./TippyButton-BY7aP8sy.js";import"./server.browser-DoheiHq8.js";const oe=new se,ne=new x,ie=({statuses:m,finishedProjectStatus:c,can:n})=>{const i=s.useRef(),g=s.useRef(),b=s.useRef(),y=s.useRef(),h=s.useRef(),j=s.useRef(),v=s.useRef(),R=s.useRef(),w=s.useRef(),_=s.useRef(),D=s.useRef(),F=s.useRef(),[E,N]=s.useState(!1),[B,C]=s.useState({}),[G,T]=s.useState({}),A=e=>{var t,o,a,p,S;e!=null&&e.id?N(!0):N(!1),y.current.value=(e==null?void 0:e.id)||null,$(b.current).val(((t=e==null?void 0:e.status)==null?void 0:t.id)??null).trigger("change"),k(h.current,(o=e==null?void 0:e.client)==null?void 0:o.id,(a=e==null?void 0:e.client)==null?void 0:a.name),k(j.current,(p=e==null?void 0:e.type)==null?void 0:p.id,(S=e==null?void 0:e.type)==null?void 0:S.name),v.current.value=(e==null?void 0:e.name)||null,R.current.value=(e==null?void 0:e.description)||null,w.current.value=e==null?void 0:e.cost,_.current.value=e!=null&&e.sign_at?moment(e.sign_at).format("YYYY-MM-DD"):null,D.current.value=e!=null&&e.starts_at?moment(e.starts_at).format("YYYY-MM-DD"):null,F.current.value=e!=null&&e.ends_at?moment(e.ends_at).format("YYYY-MM-DD"):null,$(g.current).modal("show")},Y=async e=>{e.preventDefault();const t={status_id:b.current.value,id:y.current.value||void 0,client_id:h.current.value,type_id:j.current.value,name:v.current.value,description:R.current.value,cost:w.current.value??void 0,sign_at:_.current.value??void 0,starts_at:D.current.value,ends_at:F.current.value};await x.save(t)&&($(i.current).dxDataGrid("instance").refresh(),$(g.current).modal("hide"))},L=async({id:e,field:t,value:o})=>{await ne.boolean({id:e,field:t,value:o})&&$(i.current).dxDataGrid("instance").refresh()},q=async e=>{const{isConfirmed:t}=await d.fire({title:"¿Estás seguro de archivar este proyecto?",text:"Aún podrás verlo en la ventana de archivados",icon:"warning",showCancelButton:!0,confirmButtonText:"Continuar",cancelButtonText:"Cancelar"});!t||!await x.delete(e)||$(i.current).dxDataGrid("instance").refresh()},I=async e=>{const{isConfirmed:t}=await d.fire({title:"¿Estás seguro de agregar páginas?",text:"Esta acción creará un correlativo de páginas para el proyecto.",icon:"warning",showCancelButton:!0,confirmButtonText:"Sí, agregar",cancelButtonText:"Cancelar"});if(!t)return;const o=await oe.save({project_id:e.id,name:e.client.tradename});if(!o){d.fire("Error","No se pudo crear la página.","error");return}d.fire("Éxito","Página creada exitosamente.","success"),$(i.current).dxDataGrid("instance").refresh(),location.href=`/pages/${o.correlative}`};return r.jsxs(r.Fragment,{children:[r.jsx(ee,{gridRef:i,title:"Proyectos En Curso",rest:x,exportable:!0,toolBar:e=>{e.unshift(M({className:"btn btn-xs btn-soft-dark",text:"Actualizar",title:"Refrescar tabla",icon:"fas fa-undo-alt",onClick:()=>$(i.current).dxDataGrid("instance").refresh()})),n("projects","all","create")&&e.unshift(M({className:"btn btn-xs btn-soft-primary",text:"Nuevo",title:"Agregar registro",icon:"fa fa-plus",onClick:()=>A()}))},filterValue:void 0,columns:[{dataField:"client.tradename",caption:"Nombre comercial",filterValue:O.GET.client||void 0,fixed:!0,fixedPosition:"left",cellTemplate:(e,{data:t})=>{t.is_alert&&e.parents(".dx-row").children().attr("style","background-color: rgba(255,91,91,.18) !important;"),e.text(t.client.tradename)}},{dataField:"type.name",caption:"Tipo",visible:!1},{dataField:"name",caption:"Proyecto"},{dataField:"users",caption:"Asignados",dataType:"string",cellTemplate:(e,{data:t})=>{const o=t.users.map(a=>a.relative_id);e.append(f([{height:"36px",children:W(o)}]))},allowExporting:!1,allowFiltering:!1},n("projects","root","all","addpayment")&&{dataField:"cost",caption:"Costo total",dataType:"number",cellTemplate:(e,{data:t})=>{e.text(`S/. ${K(t.cost)}`)}},n("projects","root","all","addpayment")&&{dataField:"remaining_amount",caption:"Debe",dataType:"number",cellTemplate:(e,{data:t})=>{const o=(t.total_payments/t.cost*100).toFixed(2),a=Number(t.total_payments).toLocaleString("en-US",{maximumFractionDigits:2,minimumFractionDigits:2}),p=Number(t.cost-t.total_payments).toLocaleString("en-US",{maximumFractionDigits:2,minimumFractionDigits:2});e.append(f([r.jsxs(r.Fragment,{children:[r.jsxs("p",{className:"mb-0 d-flex justify-content-between",children:[r.jsxs("b",{className:"text-success",children:[r.jsx("i",{className:"fa fa-arrow-circle-up"})," S/. ",a]}),r.jsxs("b",{className:"float-end text-danger",children:[r.jsx("i",{className:"fa fa-arrow-circle-down"})," S/. ",p]})]}),r.jsx("div",{className:"progress progress-bar-alt-primary progress-sm mt-0 mb-0",style:{width:"200px"},children:r.jsx("div",{className:"progress-bar bg-primary progress-animated wow animated animated animated",role:"progressbar","aria-valuenow":t.total_payments,"aria-valuemin":"0","aria-valuemax":t.cost,style:{width:`${o}%`,visibility:"visible",animationName:"animationProgress"}})})]})],!1))},allowExporting:!1},{dataField:"starts_at",caption:"Fecha inicio proyecto",dataType:"date",format:"yyyy-MM-dd",cellTemplate:(e,{data:t})=>{e.text(moment(t.starts_at).format("LL"))}},{dataField:"ends_at",caption:"Fecha fin proyecto",dataType:"date",format:"yyyy-MM-dd",cellTemplate:(e,{data:t})=>{e.append(f([{width:"200px",height:"30px",children:X(t.starts_at,t.ends_at)}]))},sortOrder:"asc"},{dataField:"last_payment_date",caption:"Fecha ultimo pago",dataType:"date",format:"yyyy-MM-dd",cellTemplate:(e,{data:t})=>{if(!(t!=null&&t.last_payment_date))return e.html('<i class="text-muted">- No hay pagos -</i>');e.text(moment(t==null?void 0:t.last_payment_date).format("LL"))}},n("projects","root","all","changestatus")?{dataField:"status.name",caption:"Estado del proyecto",dataType:"string",cellTemplate:(e,{data:t})=>{e.attr("style",`overflow: visible; ${t.is_alert&&"background-color: rgba(255,91,91,.18)!important;"}`),e.append(f([{height:"28px",children:r.jsx(Q,{can:n,statuses:m,finishedProjectStatus:c,data:t,onChange:()=>{$(i.current).dxDataGrid("instance").refresh()}})}]))}}:null,{caption:"Acciones",cellTemplate:(e,{data:t})=>{n("projects","root","all","update")&&e.append(l({className:"btn btn-xs btn-soft-primary",title:"Editar",icon:"fa fa-pen",onClick:()=>A(t)})),e.append(l({className:"btn btn-xs btn-soft-danger",title:t.is_alert?"Quitar alerta":"Alertar proyecto",icon:`fa fa-bell${t.is_alert?"-slash":""}`,onClick:()=>L({id:t.id,field:"is_alert",value:!t.is_alert})})),n("projects","root","all","assignUsers")&&e.append(l({className:"btn btn-xs btn-soft-info",title:"Asignar usuarios",icon:"fa fa-user-plus",onClick:()=>T(t)})),n("projects","root","all","addpayment")&&e.append(l({className:"btn btn-xs btn-soft-success",title:"Ver/Agregar pagos",icon:"fas fa-money-check-alt",onClick:()=>C(t)})),n("pages","root","all","create")&&(t.subdomain?e.append(l({className:"btn btn-xs btn-dark-success",title:"Ver páginas",icon:"fas fa-window-restore",onClick:()=>location.href=`/pages/${t.subdomain.correlative}`})):e.append(l({className:"btn btn-xs btn-dark-success",title:"Agregar páginas",icon:"fas fa-window-restore",onClick:()=>I(t)}))),n("projects","root","all","delete")&&e.append(l({className:"btn btn-xs btn-soft-dark",title:"Archivar",icon:"mdi mdi-archive",onClick:()=>q(t.id)}))},allowFiltering:!1,allowExporting:!1}]}),r.jsx(Z,{modalRef:g,title:E?"Editar proyecto":"Agregar proyecto",onSubmit:Y,children:r.jsxs("div",{className:"row",id:"project-crud-container",children:[r.jsx("div",{className:"col-12",children:r.jsx("div",{className:"row justify-content-center",children:r.jsx(re,{eRef:b,label:"Estado del proyecto",dropdownParent:"#project-crud-container",col:"col-md-6 col-sm-12",required:!0,children:m.map((e,t)=>r.jsx("option",{value:e.id,children:e.name},`status-${t}`))})})}),r.jsx("input",{ref:y,type:"hidden"}),r.jsx(P,{eRef:h,label:"Cliente",col:"col-12",dropdownParent:"#project-crud-container",searchAPI:"/api/clients/paginate",searchBy:"tradename",required:!0}),r.jsx(P,{eRef:j,label:"Tipo del proyecto",col:"col-md-4",dropdownParent:"#project-crud-container",searchAPI:"/api/types/paginate",searchBy:"name",filter:["table_id","=","cd8bd48f-c73c-4a62-9935-024139f3be5f"],required:!0}),r.jsx(u,{eRef:v,label:"Nombre del proyecto",col:"col-md-8",required:!0}),r.jsx(te,{eRef:R,label:"Descripcion del proyecto",col:"col-12"}),r.jsx(u,{eRef:w,label:"Costo",col:"col-md-6",type:"number",step:.01,required:!0}),r.jsx(u,{eRef:_,label:"Fecha firma",col:"col-md-6",type:"date"}),r.jsx(u,{eRef:D,label:"Fecha inicio",col:"col-md-6",type:"date",required:!0}),r.jsx(u,{eRef:F,label:"Fecha fin",col:"col-md-6",type:"date",required:!0})]})}),r.jsx(H,{can:n,dataLoaded:B,setDataLoaded:C,grid2refresh:$(i.current).dxDataGrid("instance")}),r.jsx(J,{dataLoaded:G,setDataLoaded:T,grid2refresh:$(i.current).dxDataGrid("instance")})]})};V((m,c)=>{if(!c.can("projects","root","all","list"))return location.href="/";U(m).render(r.jsx(z,{...c,title:"Proyectos en curso",children:r.jsx(ie,{...c})}))});
