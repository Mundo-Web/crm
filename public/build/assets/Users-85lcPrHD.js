var U=Object.defineProperty;var E=(t,a,i)=>a in t?U(t,a,{enumerable:!0,configurable:!0,writable:!0,value:i}):t[a]=i;var w=(t,a,i)=>E(t,typeof a!="symbol"?a+"":a,i);import{m as B,r as l,j as e,G as y,C as T,c as P}from"./CreateReactScript-9UX3kXBD.js";import{B as _,i as v,A as F}from"./Adminto-C-Pv7Jhd.js";import{M}from"./Modal-D0pWPGeP.js";import{t as S,S as D}from"./sweetalert2.esm.all-CVcmmqxW.js";import{U as V}from"./UsersRest-DE27vXo1.js";class C extends _{constructor(){super(...arguments);w(this,"path","atalaya/users");w(this,"invite",async i=>{try{const{status:s,result:c}=await B.Fetch(`/api/${this.path}/invite`,{method:"POST",body:JSON.stringify(i)});if(!s)throw new Error((c==null?void 0:c.message)||"Ocurrio un error inesperado");return{status:!0}}catch(s){return{status:!1,message:s.message}}})}}const G=new C,R=({relative_id:t,fullname:a,email:i,match:s})=>{const[c,x]=l.useState(!1),[h,m]=l.useState(!1),j=async()=>{x(!0);const{status:n,message:p}=await G.invite({match:s,email:i});if(x(!1),!n)return S(p??"Ocurrió un error inesperado",{icon:e.jsx("i",{className:"mdi mdi-alert text-danger"})});m(!0)},f=n=>t?e.jsx(e.Fragment,{children:n}):e.jsx(v,{content:"Invitar usuario a Atalaya",children:n});return e.jsx("div",{className:"card border mb-0",children:e.jsxs("div",{className:"card-body p-2 d-flex align-items-center gap-2",children:[e.jsx("img",{src:`//${y.APP_DOMAIN}/api/profile/thumbnail/${t}`,className:"rounded-circle",alt:a,width:"40",height:"40"}),e.jsxs("div",{className:"flex-grow-1",children:[e.jsx("h5",{className:"mt-0 mb-1",children:a}),e.jsx("div",{className:"text-muted",children:i})]}),f(e.jsx("button",{className:"btn btn-white btn-sm rounded-pill",onClick:()=>j(),disabled:c||h,children:c?e.jsx("i",{className:"mdi mdi-loading mdi-spin"}):h?e.jsx("i",{className:"mdi mdi-email-check"}):e.jsx("i",{className:`mdi ${t?"mdi-account-plus":"mdi mdi-email-send"}`})}))]})})},H=new V,I=new C,J=({roles:t,match:a,setUsers:i,...s})=>{var n,p;const[c,x]=l.useState(!1),h=async(r,d)=>{await H.assignRole({role:r.id,user:d.id})&&location.reload()},m=async()=>{x(!0);const{status:r,message:d}=await I.invite({match:a,email:s.email});if(x(!1),!r)return S(d??"Ocurrió un error inesperado",{icon:e.jsx("i",{className:"mdi mdi-alert text-danger"})})},j=async()=>{const{isConfirmed:r}=await D.fire({title:"¿Estás seguro?",text:`${s.name} será eliminado de la gestión de ${y.APP_NAME}. Esta acción no se puede deshacer.`,icon:"warning",showCancelButton:!0,confirmButtonColor:"#3085d6",cancelButtonColor:"#d33",confirmButtonText:"¡Sí, eliminar!",cancelButtonText:"Cancelar"});if(!r)return;const d=await I.delete(s.id);if(!d)return S(d.message??"Ocurrió un error inesperado",{icon:e.jsx("i",{className:"mdi mdi-alert text-danger"})});i(N=>N.filter(g=>g.id!==s.id))},f=((p=(n=s.service_user)==null?void 0:n.roles)==null?void 0:p[0])??{name:s.is_owner?"Owner":"Sin rol"};return e.jsx("div",{className:"card mb-0",style:{width:"360px"},children:e.jsx("div",{className:"card-body widget-user",children:e.jsxs("div",{className:"d-flex align-items-center gap-2 w-100",children:[e.jsx("div",{className:"flex-shrink-0 avatar-lg",children:e.jsx("img",{src:`//${y.APP_DOMAIN}/api/profile/thumbnail/${s.relative_id}`,className:"img-fluid rounded-circle",alt:"user"})}),e.jsxs("div",{className:"flex-grow-1",children:[e.jsxs("div",{className:"overflow-hidden",style:{width:"228px"},children:[e.jsxs("h5",{className:"mt-0 mb-1 text-truncate",children:[s.name," ",s.lastname]}),e.jsx("p",{className:"d-inline-block text-muted mb-2 font-13 text-truncate w-100",children:s.email})]}),e.jsxs("div",{className:"d-flex gap-1",children:[s.is_owner?e.jsxs("div",{className:"btn btn-white btn-sm",children:[e.jsx("i",{className:"mdi mdi-crown me-1 text-blue"}),"Owner"]}):e.jsxs("div",{className:"btn-group",children:[e.jsxs("button",{className:"btn btn-white btn-sm dropdown-toggle",type:"button","data-bs-toggle":"dropdown","aria-haspopup":"true","aria-expanded":"false",children:[f.name," ",e.jsx("i",{className:"mdi mdi-chevron-down"})]}),e.jsxs("div",{className:"dropdown-menu",children:[t.map((r,d)=>e.jsx(v,{content:`Asignar rol ${r.name}`,children:e.jsxs("a",{className:"dropdown-item",href:"#",onClick:()=>h(r,s),children:[e.jsx("i",{className:"mdi mdi-account-convert me-2"}),r.name]})},d)),e.jsx("div",{className:"dropdown-divider"}),e.jsxs("a",{className:"dropdown-item",href:"#",children:[e.jsx("i",{className:"mdi mdi-plus me-2"}),"Nuevo rol"]})]})]}),!s.invitation_accepted&&e.jsx(v,{content:"Reenviar invitación",children:e.jsx("button",{className:"btn btn-sm btn-white rounded-pill",onClick:()=>m(),disabled:c,children:c?e.jsx("i",{className:"mdi mdi-loading mdi-spin"}):e.jsx("i",{className:"mdi mdi-email-send text-primary"})})}),!s.is_owner&&e.jsx(v,{content:"Eliminar usuario",children:e.jsx("button",{className:"btn btn-sm btn-white rounded-pill",onClick:()=>j(),children:e.jsx("i",{className:"mdi mdi-delete text-danger"})})})]})]})]})})},`user-${s.id}`)},k=new C,L=t=>{const{users:a,roles:i,match:s}=t,[c,x]=l.useState(a),h=l.useRef(),m=l.useRef(null),[j,f]=l.useState([]),[n,p]=l.useState(""),[r,d]=l.useState(null),[N,g]=l.useState(!1),A=async u=>{const{data:o,summary:b}=await k.paginate({searchValue:u});g(!1),f(o),d((b==null?void 0:b.isValid)??null)},O=u=>{const o=u.target.value;p(o),m.current&&(k.controller.abort("Nothing"),clearTimeout(m.current)),f([]),g(!1),!(!o||o.length<3)&&(g(!0),m.current=setTimeout(()=>{A(o)},300))};return l.useEffect(()=>()=>{m.current&&clearTimeout(m.current)},[]),e.jsx(e.Fragment,{children:e.jsxs(F,{...t,title:"Usuarios",floatEnd:e.jsxs("button",{className:"btn btn-sm btn-primary",onClick:()=>$(h.current).modal("show"),children:[e.jsx("i",{className:"mdi mdi-account-plus me-1"}),"Invitar"]}),children:[e.jsx("div",{className:"d-flex flex-wrap align-items-center justify-content-center",style:{minHeight:"calc(100vh - 235px)",maxHeight:"max-content"},children:e.jsx("div",{className:"d-flex flex-wrap align-items-center justify-content-center gap-2",children:c.map((u,o)=>e.jsx(J,{...u,roles:i,match:s,setUsers:x},`user-${o}`))})}),e.jsxs(M,{modalRef:h,title:"Invita usuarios",hideFooter:!0,onSubmit:u=>u.preventDefault(),onClose:()=>p(""),children:[e.jsx("input",{type:"text",className:"form-control",placeholder:"Ingresa nombre o correo",value:n,onChange:O}),n.length<3?e.jsx("div",{className:"text-center text-muted p-2 mt-2",children:"Ingresa al menos 3 caracteres"}):e.jsx(e.Fragment,{children:N?e.jsxs("div",{className:"text-center p-2 mt-2",children:[e.jsx("div",{className:"spinner-border text-primary",role:"status",children:e.jsx("span",{className:"visually-hidden",children:"Loading..."})}),e.jsx("p",{className:"mt-2 text-muted mb-0",children:"Buscando usuarios..."})]}):j.length>0||r?e.jsxs("div",{className:"d-flex flex-column gap-2 mt-2",children:[j.map((u,o)=>e.jsx(R,{...u,match:s},`found-${o}`)),r===!0&&e.jsx(R,{fullname:n.split("@")[0],email:n,match:s},`found-${n}`)]}):n&&e.jsx("div",{className:"card card-body p-2 mt-2 text-center mb-0",children:"No se encontraron resultados"})})]})]})})};T((t,a)=>{P(t).render(e.jsx(L,{...a}))});
